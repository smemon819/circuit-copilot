<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Circuit Copilot — AI Circuit Design Assistant</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <meta name="description"
        content="AI-powered circuit design assistant. Describe circuits in plain English and get schematics, simulations, Arduino code, and BOM instantly. Powered by Groq LLaMA 3.3 70B.">
    <meta name="keywords" content="circuit design, AI, schematic generator, Arduino, electronics, simulation, BOM">
    <meta name="author" content="Circuit Copilot">
    <meta property="og:title" content="Circuit Copilot — AI Circuit Design Assistant">
    <meta property="og:description"
        content="Describe circuits in plain English → get schematics, simulations, Arduino code, and BOM instantly.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Circuit Copilot — AI Circuit Design">
    <meta name="twitter:description"
        content="AI-powered circuit design: schematics, simulations, Arduino code & BOM from natural language.">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;600;700;800&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ── THEME VARIABLES ──────────────────────────────────────────────────── */
        [data-theme="dark"] {
            --bg: #07090f;
            --bg2: #0d1120;
            --bg3: #121828;
            --panel: rgba(10, 15, 28, 0.7);
            --panel-hdr: rgba(18, 24, 40, 0.85);
            --border: rgba(28, 45, 74, 0.8);
            --border2: rgba(36, 53, 80, 0.8);
            --accent: #00c8f0;
            --accent2: #00f090;
            --accent3: #ff7043;
            --warn: #ffb300;
            --purple: #a855f7;
            --text: #c4d4e8;
            --text-dim: #6a8aaa;
            --text-hi: #eaf4ff;
            --shadow: 0 8px 32px rgba(0, 0, 0, .5);
            --input-bg: rgba(6, 10, 18, 0.8);
            --chat-user: linear-gradient(135deg, rgba(0, 30, 68, 0.9), rgba(0, 51, 102, 0.9));
            --chat-asst: rgba(18, 24, 40, 0.85);
        }

        [data-theme="light"] {
            --bg: #f0f4f8;
            --bg2: #e4eaf2;
            --bg3: #d8e2ee;
            --panel: rgba(255, 255, 255, 0.8);
            --panel-hdr: rgba(240, 244, 248, 0.9);
            --border: rgba(192, 207, 224, 0.8);
            --border2: rgba(168, 189, 212, 0.8);
            --accent: #0077aa;
            --accent2: #007744;
            --accent3: #cc4400;
            --warn: #bb7700;
            --purple: #7722cc;
            --text: #1a2a3a;
            --text-dim: #6a8aaa;
            --text-hi: #0a1a2a;
            --shadow: 0 8px 32px rgba(0, 0, 0, .1);
            --input-bg: rgba(255, 255, 255, 0.9);
            --chat-user: linear-gradient(135deg, rgba(204, 228, 255, 0.9), rgba(170, 212, 255, 0.9));
            --chat-asst: rgba(232, 240, 248, 0.9);
        }

        /* ── BASE ─────────────────────────────────────────────────────────────── */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            min-height: 100vh;
            transition: background .3s, color .3s;
        }

        [data-theme="dark"] body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background-image:
                linear-gradient(rgba(0, 200, 240, .022) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 200, 240, .022) 1px, transparent 1px);
            background-size: 48px 48px;
        }

        .app {
            position: relative;
            z-index: 1;
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 16px 24px;
            animation: fade-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fade-up {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 {
            animation-delay: 0.1s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .stagger-2 {
            animation-delay: 0.2s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .stagger-3 {
            animation-delay: 0.3s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .workspace>.panel:nth-child(1) {
            animation-delay: 0.1s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .workspace>.panel:nth-child(2) {
            animation-delay: 0.2s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .workspace>.panel:nth-child(3) {
            animation-delay: 0.3s;
            opacity: 0;
            animation: fade-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--border2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent);
        }

        /* ── HEADER ───────────────────────────────────────────────────────────── */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 50;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 11px;
        }

        .logo-badge {
            width: 40px;
            height: 40px;
            border-radius: 9px;
            font-size: 18px;
            background: linear-gradient(135deg, var(--bg3), var(--bg2));
            border: 1.5px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 18px rgba(0, 200, 240, .25);
            animation: pulse 3s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(0, 200, 240, .15);
            }

            50% {
                box-shadow: 0 0 25px rgba(0, 200, 240, .45);
            }
        }

        .logo-info h1 {
            font-size: 1.1rem;
            color: var(--accent);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-weight: 800;
        }

        .logo-info p {
            font-size: .62rem;
            color: var(--text-dim);
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .hdr-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent2);
            animation: blink 2s infinite;
            flex-shrink: 0;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .3;
            }
        }

        .status-txt {
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            color: var(--accent2);
        }

        /* ── THEME TOGGLE ─────────────────────────────────────────────────────── */
        .theme-toggle {
            width: 50px;
            height: 26px;
            border-radius: 13px;
            background: var(--bg3);
            border: 1px solid var(--border2);
            cursor: pointer;
            position: relative;
            transition: background .3s;
            flex-shrink: 0;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            transition: transform .3s;
        }

        [data-theme="light"] .theme-toggle::after {
            transform: translateX(24px);
            background: var(--warn);
        }

        .theme-icons {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
            font-size: 10px;
            pointer-events: none;
        }

        /* ── BUTTONS ──────────────────────────────────────────────────────────── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-family: 'Syne', sans-serif;
            font-size: .78rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            letter-spacing: .5px;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--bg3), var(--bg2));
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(0, 200, 240, .35);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--bg2), var(--bg3));
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 200, 240, .2);
        }

        .btn-primary:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: .68rem;
            background: var(--bg3);
            border: 1px solid var(--border2);
            color: var(--text-dim);
        }

        .btn-sm:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-green {
            background: var(--bg3);
            color: var(--accent2);
            border: 1px solid var(--accent2);
            font-size: .72rem;
            padding: 6px 11px;
        }

        .btn-green:hover {
            box-shadow: 0 0 15px rgba(0, 240, 144, .3);
            transform: translateY(-1px);
        }

        .btn-orange {
            background: var(--bg3);
            color: var(--accent3);
            border: 1px solid var(--accent3);
            font-size: .72rem;
            padding: 6px 11px;
        }

        .btn-orange:hover {
            box-shadow: 0 0 15px rgba(255, 112, 67, .3);
            transform: translateY(-1px);
        }

        .btn-purple {
            background: var(--bg3);
            color: var(--purple);
            border: 1px solid var(--purple);
            font-size: .72rem;
            padding: 6px 11px;
        }

        .btn-purple:hover {
            box-shadow: 0 0 15px rgba(168, 85, 247, .3);
            transform: translateY(-1px);
        }

        /* ── PROJECT BAR ──────────────────────────────────────────────────────── */
        .project-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 9px 14px;
            margin-bottom: 13px;
        }

        .project-bar label {
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            color: var(--text-dim);
            white-space: nowrap;
        }

        .project-bar input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Syne', sans-serif;
            font-size: .95rem;
            font-weight: 700;
            color: var(--text-hi);
            min-width: 0;
        }

        .project-bar input::placeholder {
            color: var(--text-dim);
        }

        /* ── TABS ─────────────────────────────────────────────────────────────── */
        .tabs {
            display: flex;
            gap: 3px;
            margin-bottom: 14px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 11px;
            padding: 4px;
            overflow: visible;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-family: 'Syne', sans-serif;
            font-size: .74rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text);
            background: var(--bg3);
        }

        .tab.active {
            background: var(--bg3);
            color: var(--accent);
            border: 1px solid var(--border2);
            box-shadow: 0 0 14px rgba(0, 200, 240, .18);
        }

        /* Mega Menu Dropdown */
        .tab-dropdown {
            position: relative;
            display: inline-block;
            flex: 1;
            min-width: 100px;
        }

        .tab-dropdown-btn {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-family: 'Syne', sans-serif;
            font-size: .74rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
        }

        .tab-dropdown:hover .tab-dropdown-btn,
        .tab-dropdown-btn.active {
            color: var(--text);
            background: var(--bg3);
        }

        .tab-dropdown-content {
            display: none;
            position: absolute;
            background: var(--bg2);
            min-width: 200px;
            box-shadow: var(--shadow);
            z-index: 100;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 8px;
            top: 100%;
            right: 0;
            margin-top: 4px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            flex-direction: column;
            gap: 4px;
        }

        .tab-dropdown:hover .tab-dropdown-content {
            display: flex;
            animation: fade-up 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .tab-dropdown-content .tab {
            justify-content: flex-start;
            text-align: left;
            padding: 10px;
        }

        /* ── WORKSPACE ────────────────────────────────────────────────────────── */
        .workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            align-items: start;
        }

        @media(max-width:800px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }

        /* ── DASHBOARD ───────────────────────────────────────────────────────── */
        .dash-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-top: 10px;
        }

        .dash-skills-grid {
            grid-template-columns: 1.2fr 1fr;
        }

        @media(max-width: 768px) {
            .dash-skills-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--bg2);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all .3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(0, 200, 240, 0.15);
        }

        .stat-val {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--accent);
            font-family: 'Syne', sans-serif;
            margin: 8px 0;
        }

        .stat-lbl {
            font-size: .74rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .skill-box {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .skill-row {
            margin-bottom: 12px;
        }

        .skill-hdr {
            display: flex;
            justify-content: space-between;
            font-size: .72rem;
            margin-bottom: 6px;
        }

        .skill-name {
            color: var(--text-hi);
            font-weight: 600;
        }

        .skill-pct {
            color: var(--accent2);
            font-family: 'JetBrains Mono', monospace;
        }

        .skill-bar {
            height: 6px;
            background: var(--bg3);
            border-radius: 3px;
            overflow: hidden;
        }

        .skill-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            transition: width .5s ease-out;
        }

        .achieve-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .badge-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg3);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            filter: grayscale(1);
            opacity: .3;
            transition: all .3s;
            position: relative;
            cursor: help;
        }

        .badge-icon.unlocked {
            filter: grayscale(0);
            opacity: 1;
            border-color: var(--warn);
            box-shadow: 0 0 15px rgba(255, 179, 0, .3);
        }

        .badge-icon:hover .badge-tip {
            display: block;
        }

        .badge-tip {
            display: none;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg);
            border: 1px solid var(--accent);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: .62rem;
            color: var(--text);
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
        }

        /* ── BREADBOARD VIEW ──────────────────────────────────────────────────── */
        .bb-container {
            background: #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            border: 4px solid #bdbdbd;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .bb-grid {
            display: grid;
            grid-template-rows: repeat(12, 12px);
            gap: 4px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            min-width: 800px;
        }

        .bb-row {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .bb-hole {
            width: 8px;
            height: 8px;
            background: #cecece;
            border-radius: 2px;
        }

        .bb-hole.active {
            background: var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }

        .bb-rail-red {
            height: 2px;
            background: #ff5252;
            width: 100%;
            margin: 4px 0;
        }

        .bb-rail-blue {
            height: 2px;
            background: #448aff;
            width: 100%;
            margin: 4px 0;
        }

        .guide-step {
            background: var(--bg2);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .guide-num {
            font-weight: 800;
            color: var(--accent);
            margin-right: 8px;
            font-family: 'Syne', sans-serif;
        }

        .guide-txt {
            font-size: .78rem;
            color: var(--text);
            line-height: 1.4;
        }

        .bb-pin {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg3);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: .7rem;
            color: var(--accent2);
        }

        /* ── AI AUDIT ─────────────────────────────────────────────────────────── */
        .audit-results {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .audit-item {
            padding: 12px 16px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            border-bottom: 1px solid var(--border);
        }

        .audit-item:last-child {
            border-bottom: none;
        }

        .audit-warn {
            background: rgba(255, 179, 0, 0.05);
        }

        .audit-err {
            background: rgba(255, 82, 82, 0.05);
        }

        .audit-tip {
            background: rgba(0, 200, 240, 0.05);
        }

        .audit-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .audit-content h5 {
            font-size: .78rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-hi);
        }

        .audit-content p {
            font-size: .74rem;
            color: var(--text);
            line-height: 1.4;
        }

        .btn-warn {
            background: var(--bg2);
            color: var(--warn);
            border: 1px solid var(--warn);
        }

        .btn-warn:hover {
            background: var(--warn);
            color: var(--bg);
            box-shadow: 0 0 15px rgba(255, 179, 0, .3);
        }

        /* ── VIRTUAL PROBE ───────────────────────────────────────────────────── */
        .probe-tip {
            position: fixed;
            background: var(--panel);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            font-size: .74rem;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            min-width: 140px;
            pointer-events: auto;
        }

        .probe-tip h6 {
            color: var(--accent);
            font-size: .6rem;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .probe-val {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-hi);
            font-family: 'JetBrains Mono', monospace;
        }

        .probe-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }

        .probe-node {
            cursor: crosshair;
            transition: background .2s;
        }

        .probe-node:hover {
            background: var(--bg3);
        }

        .probed {
            border-left: 3px solid var(--accent) !important;
            padding-left: 8px !important;
        }

        /* ── CHALLENGE UI ────────────────────────────────────────────────────── */
        .challenge-box {
            background: var(--bg2);
            border: 1px solid var(--accent3);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .challenge-title {
            font-size: .8rem;
            color: var(--accent3);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .challenge-desc {
            font-size: .76rem;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .challenge-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border-radius: 6px;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: .74rem;
            outline: none;
            margin-bottom: 10px;
        }

        /* ── FLASHCARDS ─────────────────────────────────────────────────────── */
        .flash-wrap {
            perspective: 1000px;
            width: 100%;
            height: 200px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .flash-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flash-wrap.flipped .flash-inner {
            transform: rotateY(180deg);
        }

        .flash-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, .2);
        }

        .flash-front {
            background: var(--bg2);
        }

        .flash-back {
            background: var(--bg3);
            transform: rotateY(180deg);
            text-align: center;
        }

        .flash-sym {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .flash-name {
            font-size: 1rem;
            color: var(--accent);
            font-weight: 700;
        }

        .flash-desc {
            font-size: .74rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* ── TAB SCROLLER ────────────────────────────────────────────────────── */
        .tabs-scroller {
            position: sticky;
            top: 60px;
            background: var(--bg);
            z-index: 45;
            border-bottom: 1px solid var(--border);
        }

        /* ── PANELS ───────────────────────────────────────────────────────────── */
        .panel {
            background: var(--panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        }

        .panel-hdr {
            padding: 12px 16px;
            background: var(--panel-hdr);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            color: var(--accent);
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .panel-body {
            padding: 13px;
        }

        /* ── INPUT ────────────────────────────────────────────────────────────── */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        textarea {
            width: 100%;
            min-height: 80px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-hi);
            font-family: 'JetBrains Mono', monospace;
            font-size: .84rem;
            padding: 10px;
            resize: vertical;
            line-height: 1.65;
            transition: all .2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 200, 240, .1);
        }

        textarea::placeholder {
            color: var(--text-dim);
        }

        .chat-input-row {
            display: flex;
            gap: 7px;
            margin-top: 8px;
            align-items: flex-end;
        }

        .chat-input-row textarea {
            min-height: 52px;
            flex: 1;
        }

        /* ── VOICE ────────────────────────────────────────────────────────────── */
        .voice-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1.5px solid var(--border2);
            background: var(--bg3);
            color: var(--text-dim);
            font-size: .95rem;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            border-color: var(--accent2);
            color: var(--accent2);
        }

        .voice-btn.recording {
            border-color: #ff4444;
            color: #ff4444;
            background: rgba(255, 68, 68, .1);
            animation: rec-pulse 1s ease-in-out infinite;
        }

        @keyframes rec-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 68, 68, .4);
            }

            50% {
                box-shadow: 0 0 0 7px rgba(255, 68, 68, 0);
            }
        }

        /* ── CHAT ─────────────────────────────────────────────────────────────── */
        .chat-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 420px;
            overflow-y: auto;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            scroll-behavior: smooth;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .chat-area::-webkit-scrollbar {
            width: 3px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--border2);
        }

        .msg {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: .88rem;
            line-height: 1.65;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .msg.user {
            align-self: flex-end;
            background: var(--chat-user);
            border: 1px solid var(--border2);
            color: var(--text-hi);
            border-bottom-right-radius: 4px;
            max-width: 85%;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .msg.assistant {
            align-self: flex-start;
            background: var(--chat-asst);
            border: 1px solid var(--border);
            color: var(--text);
            border-bottom-left-radius: 4px;
            max-width: 95%;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .msg.assistant h1,
        .msg.assistant h2,
        .msg.assistant h3 {
            color: var(--accent);
            margin: 7px 0 4px;
            font-size: .95em;
        }

        .msg.assistant strong {
            color: var(--accent2);
        }

        .msg.assistant code {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: .8em;
            color: var(--accent3);
        }

        .msg.assistant pre {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
            margin: 7px 0;
        }

        .msg.assistant pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--accent2);
            font-size: .82rem;
        }

        .msg.assistant ul,
        .msg.assistant ol {
            padding-left: 16px;
            margin: 5px 0;
        }

        .msg.assistant p {
            margin: 4px 0;
        }

        .msg.assistant table {
            width: 100%;
            border-collapse: collapse;
            font-size: .8rem;
            margin: 7px 0;
        }

        .msg.assistant th {
            background: var(--bg3);
            color: var(--accent);
            padding: 5px 8px;
            border: 1px solid var(--border);
        }

        .msg.assistant td {
            padding: 4px 8px;
            border: 1px solid var(--border);
        }

        /* ── CHIPS ────────────────────────────────────────────────────────────── */
        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 6px;
        }

        .chip {
            padding: 3px 9px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: .68rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all .15s;
            font-family: 'JetBrains Mono', monospace;
        }

        .chip:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg2);
        }

        /* ── LOADING ──────────────────────────────────────────────────────────── */
        .loading {
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: .76rem;
            padding: 10px 0;
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 15px;
            height: 15px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ── SKELETON LOADERS ────────────────────────────────────────────────── */
        .skeleton-wrap {
            padding: 12px 0;
        }

        .skeleton-line {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.4s ease-in-out infinite;
        }

        .skeleton-line:nth-child(1) {
            width: 85%;
        }

        .skeleton-line:nth-child(2) {
            width: 70%;
        }

        .skeleton-line:nth-child(3) {
            width: 92%;
        }

        .skeleton-line:nth-child(4) {
            width: 60%;
        }

        .skeleton-line:nth-child(5) {
            width: 78%;
        }

        .skeleton-img {
            height: 180px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.4s ease-in-out infinite;
        }

        @keyframes skeleton-pulse {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* ── OUTPUTS ──────────────────────────────────────────────────────────── */
        .schematic-img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 160px;
            color: var(--text-dim);
            gap: 8px;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 2rem;
            opacity: .28;
        }

        .placeholder p {
            font-size: .76rem;
        }

        .error-msg {
            color: #ff6b6b;
            background: rgba(255, 107, 107, .07);
            border: 1px solid rgba(255, 107, 107, .25);
            border-radius: 6px;
            padding: 7px 11px;
            font-size: .76rem;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 6px;
        }

        /* ── SIM ──────────────────────────────────────────────────────────────── */
        .sim-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 9px;
            margin-bottom: 10px;
        }

        @media(max-width:580px) {
            .sim-grid {
                grid-template-columns: 1fr;
            }
        }

        .sim-card {
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
        }

        .sim-card h4 {
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            color: var(--accent);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 7px;
        }

        .node-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
            font-size: .8rem;
        }

        .node-row:last-child {
            border-bottom: none;
        }

        .node-name {
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            font-size: .76rem;
        }

        .node-val {
            color: var(--accent2);
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .power-bar-wrap {
            margin: 3px 0;
        }

        .power-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: .74rem;
            margin-bottom: 2px;
        }

        .power-bar {
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .power-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width .8s ease;
        }

        .sim-summary {
            background: var(--bg2);
            border: 1px solid var(--border2);
            border-radius: 8px;
            padding: 11px 13px;
            font-size: .84rem;
            line-height: 1.6;
            margin-bottom: 11px;
        }

        .sim-warning {
            display: flex;
            gap: 8px;
            background: rgba(255, 179, 0, .06);
            border: 1px solid rgba(255, 179, 0, .22);
            border-radius: 7px;
            padding: 8px 11px;
            font-size: .8rem;
            margin-bottom: 5px;
            color: var(--warn);
        }

        /* ── CANVAS ───────────────────────────────────────────────────────────── */
        .anim-wrap {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 11px;
            background: var(--input-bg);
        }

        #flowCanvas {
            display: block;
            width: 100%;
        }

        #waveCanvas {
            display: block;
            width: 100%;
        }

        /* ── FALSTAD ──────────────────────────────────────────────────────────── */
        .falstad-wrap {
            margin-top: 10px;
        }

        .falstad-wrap iframe {
            width: 100%;
            height: 320px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .falstad-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            margin-bottom: 7px;
            background: var(--bg3);
            border: 1px solid var(--accent);
            border-radius: 7px;
            color: var(--accent);
            font-size: .75rem;
            font-weight: 700;
            text-decoration: none;
            transition: all .2s;
        }

        .falstad-link:hover {
            box-shadow: 0 0 16px rgba(0, 200, 240, .3);
            transform: translateY(-1px);
        }

        /* ── BOM ──────────────────────────────────────────────────────────────── */
        .bom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: .78rem;
        }

        .bom-table th {
            background: var(--bg3);
            color: var(--accent);
            padding: 6px 9px;
            border: 1px solid var(--border);
            text-align: left;
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .bom-table td {
            padding: 5px 9px;
            border: 1px solid var(--border);
            vertical-align: top;
        }

        .bom-table tr:nth-child(even) td {
            background: var(--bg2);
        }

        .bom-table td a {
            color: var(--accent);
            text-decoration: none;
            font-size: .74rem;
        }

        .bom-table td a:hover {
            text-decoration: underline;
        }

        .bom-meta {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 9px;
            font-size: .78rem;
        }

        .bom-meta span {
            color: var(--text-dim);
        }

        .bom-meta strong {
            color: var(--accent2);
        }

        /* ── QUIZ ─────────────────────────────────────────────────────────────── */
        .quiz-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .quiz-q {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text-hi);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quiz-opt {
            padding: 11px 15px;
            border-radius: 8px;
            border: 1px solid var(--border2);
            background: var(--bg3);
            color: var(--text);
            font-size: .88rem;
            cursor: pointer;
            transition: all .2s;
            text-align: left;
            font-family: 'Syne', sans-serif;
        }

        .quiz-opt:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg2);
        }

        .quiz-opt.correct {
            border-color: var(--accent2);
            color: var(--accent2);
            background: rgba(0, 240, 144, .08);
        }

        .quiz-opt.wrong {
            border-color: #ff6b6b;
            color: #ff6b6b;
            background: rgba(255, 107, 107, .08);
        }

        .quiz-opt:disabled {
            cursor: default;
        }

        .quiz-explain {
            margin-top: 14px;
            padding: 12px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: .84rem;
            line-height: 1.6;
            color: var(--text);
        }

        .quiz-explain strong {
            color: var(--accent2);
        }

        .quiz-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quiz-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: .8rem;
            color: var(--accent);
        }

        .quiz-level {
            display: flex;
            gap: 6px;
        }

        .level-btn {
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--bg3);
            color: var(--text-dim);
            font-size: .7rem;
            cursor: pointer;
            font-family: 'Syne', sans-serif;
        }

        .level-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg2);
        }

        .quiz-progress {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 2px;
            transition: width .4s;
        }

        /* ── WAVEFORM ─────────────────────────────────────────────────────────── */
        .wave-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }

        .wave-controls label {
            font-family: 'JetBrains Mono', monospace;
            font-size: .7rem;
            color: var(--text-dim);
        }

        .wave-controls input[type=range] {
            width: 100px;
            accent-color: var(--accent);
        }

        .wave-controls select {
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: .76rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .wave-stat {
            font-family: 'JetBrains Mono', monospace;
            font-size: .72rem;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 3px 8px;
            color: var(--accent2);
        }

        /* ── SAVED ────────────────────────────────────────────────────────────── */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .saved-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 9px 12px;
            gap: 8px;
        }

        .saved-item-info {
            flex: 1;
            min-width: 0;
        }

        .saved-item-name {
            font-weight: 700;
            color: var(--text-hi);
            font-size: .84rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .saved-item-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: .66rem;
            color: var(--text-dim);
        }

        /* ── LEARN ────────────────────────────────────────────────────────────── */
        .learn-output {
            font-size: .88rem;
            line-height: 1.75;
        }

        .learn-output h2 {
            color: var(--accent2);
            font-size: .95rem;
            margin: 13px 0 5px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 3px;
        }

        .learn-output h3 {
            color: var(--accent);
            font-size: .88rem;
            margin: 9px 0 4px;
        }

        .learn-output strong {
            color: var(--accent2);
        }

        .learn-output code {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 1px 5px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: .8em;
            color: var(--accent3);
        }

        .learn-output pre {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
            margin: 7px 0;
        }

        .learn-output pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--accent2);
        }

        .learn-output ul,
        .learn-output ol {
            padding-left: 18px;
            margin: 5px 0;
        }

        .learn-output p {
            margin: 5px 0;
        }

        /* ── META TAGS ────────────────────────────────────────────────────────── */
        .meta-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 7px;
        }

        .meta-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: .68rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: .64rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .badge-ok {
            background: rgba(0, 240, 144, .1);
            color: var(--accent2);
            border: 1px solid rgba(0, 240, 144, .25);
        }

        .badge-warn {
            background: rgba(255, 179, 0, .1);
            color: var(--warn);
            border: 1px solid rgba(255, 179, 0, .25);
        }

        .badge-info {
            background: rgba(0, 200, 240, .1);
            color: var(--accent);
            border: 1px solid rgba(0, 200, 240, .25);
        }

        .slabel {
            font-family: 'JetBrains Mono', monospace;
            font-size: .65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 6px;
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 11px 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ── TEMPLATES ────────────────────────────────────────────────────────── */
        .tpl-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }

        .tpl-card {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            transition: all .2s;
            cursor: default;
        }

        .tpl-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 200, 240, .15);
        }

        .tpl-card h3 {
            color: var(--text-hi);
            font-size: .95rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tpl-card p {
            font-size: .78rem;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .tpl-card .tpl-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        /* ── COMPONENT REFERENCE ──────────────────────────────────────────────── */
        .ref-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .ref-card {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all .15s;
        }

        .ref-card:hover {
            border-color: var(--accent);
            background: var(--bg2);
        }

        .ref-card h4 {
            font-size: .82rem;
            color: var(--text-hi);
            margin-bottom: 3px;
        }

        .ref-card .ref-formula {
            font-family: 'JetBrains Mono', monospace;
            font-size: .72rem;
            color: var(--accent2);
        }

        .ref-card .ref-vals {
            font-size: .68rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .ref-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 0;
            color: var(--accent);
            font-size: .78rem;
            font-weight: 700;
            border: none;
            background: none;
            font-family: 'Syne', sans-serif;
        }

        .ref-toggle:hover {
            color: var(--accent2);
        }

        /* ── SHORTCUTS MODAL ──────────────────────────────────────────────────── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
        }

        .modal h2 {
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal .close-modal {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .modal .close-modal:hover {
            color: var(--accent);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: .82rem;
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        .shortcut-key {
            display: inline-flex;
            gap: 4px;
        }

        .shortcut-key kbd {
            background: var(--bg3);
            border: 1px solid var(--border2);
            border-radius: 4px;
            padding: 2px 7px;
            font-family: 'JetBrains Mono', monospace;
            font-size: .72rem;
            color: var(--accent);
            min-width: 22px;
            text-align: center;
        }

        footer {
            text-align: center;
            padding: 18px 0 10px;
            color: var(--text-dim);
            font-size: .66rem;
            font-family: 'JetBrains Mono', monospace;
            border-top: 1px solid var(--border);
            margin-top: 24px;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }



        /* ── ONBOARDING TOUR ──────────────────────────────────────────────── */
        .tour-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .65);
            z-index: 300;
            transition: opacity .3s;
        }

        .tour-spotlight {
            position: absolute;
            border-radius: 10px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, .6), 0 0 0 3px var(--accent), 0 0 20px var(--accent);
            transition: all .4s ease;
            z-index: 301;
        }

        .tour-tooltip {
            position: absolute;
            background: var(--panel);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 16px 20px;
            max-width: 320px;
            z-index: 302;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .5);
        }

        .tour-tooltip h3 {
            font-size: .9rem;
            color: var(--accent);
            margin-bottom: 6px;
        }

        .tour-tooltip p {
            font-size: .78rem;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .tour-tooltip .tour-btns {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .tour-tooltip .tour-btns button {
            padding: 5px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg3);
            color: var(--text);
            font-size: .72rem;
            cursor: pointer;
            font-family: 'Syne', sans-serif;
        }

        .tour-tooltip .tour-btns .tour-next {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 700;
        }

        .tour-step-counter {
            font-size: .64rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ── OHM'S LAW CALCULATOR ────────────────────────────────────────── */
        .ohm-calc {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }

        .ohm-calc h4 {
            font-size: .76rem;
            color: var(--accent);
            margin-bottom: 10px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ohm-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .ohm-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .ohm-field label {
            font-size: .66rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .ohm-field input {
            padding: 7px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-size: .82rem;
            font-family: 'JetBrains Mono', monospace;
            outline: none;
            transition: border-color .2s;
        }

        .ohm-field input:focus {
            border-color: var(--accent);
        }

        .ohm-field input.computed {
            border-color: var(--accent2);
            background: rgba(0, 240, 144, .05);
        }

        /* ── CALCULATOR WIDGET ───────────────────────────────────────────── */
        .calc-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .calc-tab {
            padding: 4px 10px;
            font-size: .64rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg3);
            color: var(--text-dim);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }

        .calc-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 700;
        }

        .calc-group {
            display: none;
        }

        .calc-group.active {
            display: block;
        }

        .calc-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .calc-row .ohm-field {
            flex: 1;
        }

        .ohm-result {
            grid-column: 1/-1;
            padding: 8px;
            background: var(--bg3);
            border-radius: 6px;
            font-size: .74rem;
            color: var(--accent2);
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            min-height: 28px;
        }

        /* ── CIRCUIT HISTORY ─────────────────────────────────────────────── */
        .history-section {
            margin-top: 16px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .history-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-hdr h4 {
            font-size: .72rem;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 5px;
            transition: border-color .2s;
            cursor: pointer;
        }

        .history-item:hover {
            border-color: var(--accent);
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-name {
            font-size: .78rem;
            font-weight: 600;
            color: var(--text-hi);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-time {
            font-size: .6rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .history-del {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: .9rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .history-del:hover {
            color: #ff6b6b;
            background: rgba(255, 107, 107, .1);
        }

        /* ── CONFETTI CANVAS ─────────────────────────────────────────────── */
        #confetti-canvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 400;
        }

        /* ── TAB BADGES ───────────────────────────────────────────────────────── */
        .tab {
            position: relative;
        }

        .tab-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 7px;
            height: 7px;
            background: var(--accent2);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--accent2);
            display: none;
            animation: badge-pulse 2s infinite;
        }

        @keyframes badge-pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: .5;
                transform: scale(1.2);
            }
        }

        /* ── MOBILE RESPONSIVE ────────────────────────────────────────────────── */
        @media (max-width: 768px) {
            .app {
                padding: 0 10px 20px;
            }

            header {
                padding: 10px 0;
            }

            .logo-info h1 {
                font-size: .95rem;
            }

            .logo-badge {
                width: 34px;
                height: 34px;
                font-size: 16px;
            }

            .hdr-right {
                gap: 5px;
            }

            .status-txt {
                display: none;
            }

            /* Hide on very small for space */

            .tabs {
                display: flex;
                overflow-x: auto;
                flex-wrap: nowrap;
                gap: 8px;
                padding-bottom: 8px;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                flex: 0 0 auto;
                padding: 6px 12px;
                font-size: .7rem;
            }

            .workspace {
                min-height: 400px;
                flex-direction: column;
                gap: 15px;
            }

            .panel {
                width: 100%;
            }

            .chat-input-row {
                gap: 5px;
            }

            .btn {
                padding: 6px 12px;
                font-size: .72rem;
            }

            .project-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .project-name {
                width: 100%;
                font-size: .8rem;
            }

            .modal {
                width: 95%;
                padding: 15px;
            }

            .tour-tooltip {
                max-width: 280px;
                left: 10px !important;
                right: 10px !important;
            }
        }

        /* ── HARDWARE BRIDGE (SERIAL) ───────────────────────────────────────── */
        .serial-monitor {
            background: #05070a;
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 250px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: .75rem;
            color: var(--accent2);
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .serial-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center;
        }

        .serial-plotter {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 12px;
        }

        /* ── LAB MODE ────────────────────────────────────────────────────────── */
        body.lab-mode {
            background: #000;
            color: #fff;
            font-size: 1.2rem;
        }

        body.lab-mode .panel {
            background: #111;
            border: 2px solid #555;
        }

        body.lab-mode h1,
        body.lab-mode h2,
        body.lab-mode h3,
        body.lab-mode h4,
        body.lab-mode h5 {
            color: var(--accent2);
            font-size: 1.4rem;
        }

        body.lab-mode .tab,
        body.lab-mode .btn,
        body.lab-mode .guide-num {
            transform: scale(1.1);
            font-weight: 800;
        }

        body.lab-mode .workspace {
            gap: 30px;
        }

        body.lab-mode .guide-txt {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        body.lab-mode .meta-tag {
            font-size: .9rem !important;
            padding: 4px 10px;
        }

        /* ── GALLERY ─────────────────────────────────────────────────────────── */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 10px 0;
        }

        .gallery-card {
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform .2s, border-color .2s;
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .gallery-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #000;
            border-bottom: 1px solid var(--border);
        }

        .gallery-info {
            padding: 15px;
        }

        .gallery-title {
            font-weight: 700;
            color: var(--text-hi);
            font-size: .9rem;
            margin-bottom: 5px;
        }

        .gallery-desc {
            font-size: .7rem;
            color: var(--text-dim);
            height: 3em;
            overflow: hidden;
            margin-bottom: 12px;
        }

        @media (max-width: 480px) {
            .logo-info p {
                display: none;
            }

            .hdr-right {
                justify-content: flex-end;
                width: 100%;
            }
        }

        /* ── SVG SCHEMATIC RENDERER ──────────────────────────────────────────────── */
        #sch-svg {
            background: #07090f;
            border-radius: 8px;
        }

        .svg-wire {
            stroke: #3a7bd5;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
        }

        .svg-wire-pwr {
            stroke: #e05555;
        }

        .svg-wire-gnd {
            stroke: #55aa55;
        }

        .svg-comp-group {
            cursor: pointer;
            transition: filter .15s;
        }

        .svg-comp-group:hover {
            filter: drop-shadow(0 0 4px #00c8f0);
        }

        .stream-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: var(--accent);
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink .7s steps(1) infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0
            }
        }

        .diff-beginner {
            background: #1a3a1a;
            color: #4caf50;
            border: 1px solid #2d5a2d;
        }

        .diff-intermediate {
            background: #3a2a00;
            color: #ff9800;
            border: 1px solid #5a3f00;
        }

        .diff-advanced {
            background: #3a0010;
            color: #f44336;
            border: 1px solid #5a0018;
        }

        #img2ckt-modal {
            position: fixed;
            inset: 0;
            background: rgba(7, 9, 15, .88);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        #img2ckt-modal.show {
            display: flex;
        }

        .img-modal-box {
            background: var(--card);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 28px 36px;
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        #img2ckt-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        @media (max-width:768px) {
            .split-layout {
                flex-direction: column !important
            }

            .panel {
                min-width: 100% !important
            }

            .tabs-nav {
                overflow-x: auto;
                scrollbar-width: none
            }

            .tabs-nav::-webkit-scrollbar {
                display: none
            }

            .tab {
                padding: 7px 8px;
                font-size: .6rem;
                white-space: nowrap
            }

            .btn {
                font-size: .65rem;
                padding: 5px 9px
            }

            .persona-row {
                flex-wrap: wrap;
                gap: 6px
            }
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- HEADER -->
        <header>
            <div class="logo">
                <div class="logo-badge">⚡</div>
                <div class="logo-info">
                    <h1>Circuit Copilot</h1>
                    <p>v4 · AI Design Assistant</p>
                </div>
            </div>
            <div class="hdr-right">
                <div class="status-dot"></div>
                <span class="status-txt" id="status-txt">ONLINE · llama-3.3-70b · v4.0</span>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <div class="theme-icons"><span>🌙</span><span>☀️</span></div>
                </button>
                <button class="btn btn-sm btn-lab"
                    style="font-size:.66rem;background:var(--bg3);border:1px solid var(--accent2);color:var(--accent2)"
                    onclick="toggleLabMode()" title="Workbench Mode">🔬 LAB MODE</button>
                <button class="btn btn-sm" style="font-size:.66rem" id="btn-collab" onclick="startCollab()">🤝
                    Collab</button>
                <button class="btn btn-sm" style="font-size:.66rem" onclick="saveCircuit()">💾 Save</button>
                <button class="btn btn-orange" onclick="exportPDF()">📄 PDF</button>
                <button class="btn btn-sm" style="font-size:.66rem" onclick="toggleShortcuts()"
                    title="Keyboard shortcuts (?)">⌨️</button>
            </div>
        </header>

        <!-- PROJECT BAR -->
        <div class="project-bar">
            <label>PROJECT:</label>
            <input type="text" id="project-name" placeholder="Untitled Circuit — click to rename" />
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab" onclick="switchTab('dashboard',this)"><span>📊</span>Dashboard<span
                    class="tab-badge"></span></button>
            <button class="tab active" onclick="switchTab('schematic',this)"><span>🔌</span>Schematic<span
                    class="tab-badge"></span></button>
            <button class="tab" onclick="switchTab('breadboard',this)"><span>🛠️</span>Breadboard<span
                    class="tab-badge"></span></button>
            <button class="tab" onclick="switchTab('simulate',this)"><span>📊</span>Simulate<span
                    class="tab-badge"></span></button>
            <button class="tab" onclick="switchTab('waveform',this)"><span>〰️</span>Waveform<span
                    class="tab-badge"></span></button>
            <button class="tab" onclick="switchTab('bom',this)"><span>🧾</span>BOM<span
                    class="tab-badge"></span></button>
            <div class="tab-dropdown">
                <button class="tab-dropdown-btn"><span>⚙️</span>More Tools ▾</button>
                <div class="tab-dropdown-content">
                    <button class="tab" onclick="switchTab('components',this)"><span>🧩</span>Parts<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('debug',this)"><span>🔍</span>Debug<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('arduino',this)"><span>💻</span>Arduino<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('learn',this)"><span>📚</span>Learn<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('quiz',this)"><span>🎯</span>Quiz & Challenges<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('templates',this)"><span>📋</span>Templates<span
                            class="tab-badge"></span></button>
                    <button class="tab" onclick="switchTab('saved',this)"><span>🗂️</span>Saved<span
                            class="tab-badge"></span></button>
                    <button class="tab" id="tab-btn-gallery"
                        onclick="switchTab('gallery',this)"><span>🌍</span>Community<span
                            class="tab-badge"></span></button>
                    <button class="tab" id="tab-btn-architect"
                        onclick="switchTab('architect',this)"><span>🧩</span>Architect<span
                            class="tab-badge"></span></button>
                </div>
            </div>
        </div>

        <!-- ═══ DASHBOARD ════════════════════════════════════════════════════════ -->
        <div id="tab-dashboard" class="tab-content">
            <div class="workspace" style="display:block;">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// LEARNING DASHBOARD</span></div>
                    <div class="panel-body">
                        <div class="dash-grid">
                            <div class="stat-card">
                                <div class="stat-lbl">Circuits Built</div>
                                <div class="stat-val" id="dash-circuits">0</div>
                                <p style="font-size:.64rem;color:var(--text-dim)">Keep designing!</p>
                            </div>
                            <div class="stat-card">
                                <div class="stat-lbl">Quiz Score</div>
                                <div class="stat-val" id="dash-quiz">0</div>
                                <p style="font-size:.64rem;color:var(--text-dim)">Master electronics</p>
                            </div>
                            <div class="stat-card">
                                <div class="stat-lbl">Daily Streak</div>
                                <div class="stat-val" id="dash-streak">0</div>
                                <p style="font-size:.64rem;color:var(--text-dim)">Don't break the chain!</p>
                            </div>
                        </div>

                        <div class="dash-grid dash-skills-grid">
                            <div class="skill-box">
                                <h4
                                    style="font-size:.76rem;color:var(--accent);margin-bottom:12px;text-transform:uppercase;">
                                    Skills &
                                    Proficiency</h4>
                                <div class="skill-row">
                                    <div class="skill-hdr"><span class="skill-name">Digital Logic</span><span
                                            class="skill-pct" id="skill-digital-pct">0%</span></div>
                                    <div class="skill-bar">
                                        <div class="skill-fill" id="skill-digital" style="width:0%"></div>
                                    </div>
                                </div>
                                <div class="skill-row">
                                    <div class="skill-hdr"><span class="skill-name">Analog Components</span><span
                                            class="skill-pct" id="skill-analog-pct">0%</span></div>
                                    <div class="skill-bar">
                                        <div class="skill-fill" id="skill-analog" style="width:0%"></div>
                                    </div>
                                </div>
                                <div class="skill-row">
                                    <div class="skill-hdr"><span class="skill-name">Microcontrollers</span><span
                                            class="skill-pct" id="skill-mcu-pct">0%</span></div>
                                    <div class="skill-bar">
                                        <div class="skill-fill" id="skill-mcu" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="skill-box">
                                <h4
                                    style="font-size:.76rem;color:var(--accent);margin-bottom:12px;text-transform:uppercase;">
                                    Achievements</h4>
                                <div class="achieve-grid" id="achievements">
                                    <!-- Badges will be generated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ SCHEMATIC ═══════════════════════════════════════════════════════ -->
        <div id="tab-schematic" class="tab-content active">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// DESCRIBE CIRCUIT</span>
                        <label class="btn btn-sm"
                            style="cursor:pointer;font-size:.64rem;display:inline-flex;align-items:center;gap:4px;"
                            title="Upload photo of circuit — AI will identify it">
                            📸 Photo→Circuit
                            <input type="file" id="img-upload" accept="image/*" style="display:none"
                                onchange="handleImageUpload(event)" />
                        </label>
                    </div>
                    <div class="panel-body">
                        <div class="slabel">Describe in English — or upload a circuit photo above:</div>
                        <div class="chat-area" id="sch-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="sch-input"
                                placeholder="e.g. LED circuit with 220Ω resistor and 9V battery"></textarea>
                            <button class="voice-btn" id="sch-voice"
                                onclick="toggleVoice('sch-input','sch-voice')">🎤</button>
                            <button class="btn btn-primary" id="sch-btn" onclick="runSchematic()">⚡ Generate</button>
                        </div>
                        <div id="persona-row" style="margin-top:8px; display:flex; gap:6px; align-items:center;">
                            <span style="font-size:.64rem;color:var(--text-dim)">AI PERSONA:</span>
                            <select id="ai-persona" class="btn btn-sm"
                                style="font-size:.64rem; background:var(--bg3); border-color:var(--border)">
                                <option value="general">🤖 General Assistant</option>
                                <option value="analog">🔈 Analog Expert</option>
                                <option value="embedded">📟 Embedded Engineer</option>
                                <option value="power">⚡ Power Specialist</option>
                            </select>
                        </div>
                        <div style="margin-top:6px;margin-bottom:4px;">
                            <button id="gen-all-btn" onclick="generateAll()" style="
                background:linear-gradient(135deg,#1a4a8a,#0a2a5a,#1a6a4a);
                background-size:200% 200%;animation:shimmer 2.5s linear infinite;
                color:#fff;border:1px solid #3a7bd5;border-radius:6px;
                padding:8px 18px;font-size:.75rem;font-family:'JetBrains Mono',monospace;
                cursor:pointer;width:100%;letter-spacing:.5px;font-weight:600;
              ">🚀 Generate All — Schematic + Sim + BOM + Arduino</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('sch','LED with 220Ω resistor and 9V battery')">LED
                                circuit</span>
                            <span class="chip" onclick="qs('sch','LED with button switch and 5V')">+ Button</span>
                            <span class="chip" onclick="qs('sch','NPN transistor switching a 12V relay')">Transistor
                                relay</span>
                            <span class="chip" onclick="qs('sch','Voltage divider 10kΩ and 4.7kΩ')">Voltage
                                divider</span>
                            <span class="chip" onclick="openCalculator('led')"
                                style="border-color:#4caf50;color:#4caf50;">🔧 LED Calc</span>
                            <span class="chip" onclick="openCalculator('timer555')"
                                style="border-color:#ff9800;color:#ff9800;">🔧 555 Calc</span>
                        </div>
                        <div class="loading" id="sch-loading">
                            <div class="spinner"></div>Generating...
                        </div>
                        <div id="sch-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// SCHEMATIC OUTPUT</span>
                        <div style="display:flex;gap:4px;flex-wrap:wrap;">
                            <button class="btn btn-sm" id="sch-share" style="display:none" onclick="shareCircuit()">🔗
                                Share</button>
                            <button class="btn btn-sm" id="sch-screenshot" style="display:none"
                                onclick="screenshotCircuit()">📸</button>
                            <button class="btn btn-sm" id="sch-dl" style="display:none" onclick="dlSchematic()">↓
                                PNG</button>
                            <button class="btn btn-sm btn-warn" id="sch-audit" style="display:none"
                                onclick="runAudit('sch')">🔍 Scan</button>
                            <button class="btn btn-sm" id="sch-eda" style="display:none" onclick="exportNetlist()">📦
                                Netlist</button>
                            <button class="btn btn-sm btn-purple" id="sch-kicad" style="display:none"
                                onclick="exportKiCad()">📐
                                KiCad</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="sch-ph" class="placeholder">
                            <div class="placeholder-icon">📐</div>
                            <p>Your schematic renders here</p>
                            <p style="font-size:.68rem;color:var(--text-dim);margin-top:4px;">Try: "LED with 220Ω
                                resistor and 9V battery"</p>
                        </div>
                        <!-- SVG schematic renderer (primary) -->
                        <div id="sch-svg-wrap"
                            style="display:none;position:relative;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;">
                            <svg id="sch-svg" width="100%" style="min-height:260px;display:block;"></svg>
                            <div id="sch-svg-title"
                                style="position:absolute;top:8px;left:12px;font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--accent);letter-spacing:1px;">
                            </div>
                            <div id="sch-svg-badge"
                                style="position:absolute;top:8px;right:12px;font-size:.62rem;padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;">
                            </div>
                        </div>
                        <!-- PNG fallback (shown if SVG fails or user toggles) -->
                        <img id="sch-img" class="schematic-img" style="display:none" />
                        <div id="sch-meta" class="meta-tags" style="display:none"></div>
                        <div id="sch-audit-out" class="audit-results" style="display:none"></div>
                        <div id="sch-desc"
                            style="margin-top:8px;font-size:.8rem;color:var(--text-dim);display:none;line-height:1.6;">
                        </div>
                        <div id="falstad-wrap" style="display:none" class="falstad-wrap">
                            <div class="divider"></div>
                            <div class="slabel">🔗 Falstad Interactive Simulator</div>
                            <a id="falstad-link" class="falstad-link" href="#" target="_blank">↗ Open in Falstad
                                (external)</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ BREADBOARD ═══════════════════════════════════════════════════════ -->
        <div id="tab-breadboard" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// WIRING GUIDE</span></div>
                    <div class="panel-body">
                        <div id="bb-instructions">
                            <div class="placeholder">
                                <div class="placeholder-icon">🛠️</div>
                                <p>Generate a schematic first to see wiring steps.</p>
                            </div>
                        </div>
                        <div id="bb-loading" class="loading" style="display:none;margin-top:10px;">
                            <div class="spinner"></div>Generating wiring guide...
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// VIRTUAL BREADBOARD</span></div>
                    <div class="panel-body">
                        <div class="bb-container">
                            <div id="bb-visual" class="bb-grid">
                                <!-- Javascript will populate this -->
                                <p style="color:#666;font-size:.7rem;text-align:center;">Prototyping guide appears here
                                </p>
                            </div>
                        </div>
                        <p style="font-size:.62rem;color:var(--text-dim);margin-top:10px;text-align:center;">Standard
                            830-point
                            Breadboard Layout (Full Size)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ SIMULATE ════════════════════════════════════════════════════════ -->
        <div id="tab-simulate" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// DC SIMULATION</span></div>
                    <div class="panel-body">
                        <div class="chat-area" id="sim-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="sim-input"
                                placeholder="e.g. 9V battery, 220Ω resistor, red LED in series"></textarea>
                            <button class="voice-btn" id="sim-voice"
                                onclick="toggleVoice('sim-input','sim-voice')">🎤</button>
                            <button class="btn btn-primary" id="sim-btn" onclick="runSimulate()">▶</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('sim','9V battery, 220Ω resistor, red LED')">LED
                                circuit</span>
                            <span class="chip"
                                onclick="qs('sim','5V supply, 10kΩ and 4.7kΩ voltage divider')">Divider</span>
                            <span class="chip"
                                onclick="qs('sim','12V, 1kΩ base resistor, BC547, 470Ω load')">Transistor</span>
                        </div>
                        <div class="loading" id="sim-loading">
                            <div class="spinner"></div>Running DC analysis...
                        </div>
                        <div id="sim-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// RESULTS</span></div>
                    <div class="panel-body">
                        <div id="sim-ph" class="placeholder">
                            <div class="placeholder-icon">📊</div>
                            <p>Results appear here</p>
                        </div>
                        <div id="sim-out" style="display:none">
                            <div class="slabel">⚡ Current Flow</div>
                            <div class="anim-wrap"><canvas id="flowCanvas" height="90"></canvas></div>
                            <div id="sim-summary" class="sim-summary"></div>
                            <div class="sim-grid">
                                <div class="sim-card">
                                    <h4>Node Voltages</h4>
                                    <div id="sim-nodes"></div>
                                </div>
                                <div class="sim-card">
                                    <h4>Power (mW)</h4>
                                    <div id="sim-power"></div>
                                </div>
                            </div>
                            <div id="sim-audit-out" class="audit-results" style="display:none"></div>
                            <div class="sim-card" style="margin-bottom:10px;">
                                <h4>Currents</h4>
                                <div id="sim-branches"></div>
                            </div>
                            <div id="sim-warns"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ WAVEFORM ═════════════════════════════════════════════════════════ -->
        <div id="tab-waveform" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// WAVEFORM GENERATOR</span></div>
                    <div class="panel-body">
                        <div class="slabel">Configure your AC/signal waveform:</div>
                        <div class="wave-controls">
                            <label>Type:</label>
                            <select id="w-type" onchange="drawWave()">
                                <option value="sine">Sine</option>
                                <option value="square">Square</option>
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="pwm">PWM</option>
                            </select>
                            <label>Freq:</label>
                            <input type="range" id="w-freq" min="1" max="200" value="50"
                                oninput="updateWaveLabel();drawWave()" />
                            <span class="wave-stat" id="w-freq-lbl">50 Hz</span>
                            <label>Amp:</label>
                            <input type="range" id="w-amp" min="1" max="24" value="5"
                                oninput="updateWaveLabel();drawWave()" />
                            <span class="wave-stat" id="w-amp-lbl">5 V</span>
                            <label>DC Offset:</label>
                            <input type="range" id="w-offset" min="-12" max="12" value="0"
                                oninput="updateWaveLabel();drawWave()" />
                            <span class="wave-stat" id="w-offset-lbl">0 V</span>
                            <label>Duty:</label>
                            <input type="range" id="w-duty" min="5" max="95" value="50"
                                oninput="updateWaveLabel();drawWave()" />
                            <span class="wave-stat" id="w-duty-lbl">50 %</span>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                            <span class="wave-stat" id="w-period">Period: 20.0 ms</span>
                            <span class="wave-stat" id="w-vrms">Vrms: 3.54 V</span>
                            <span class="wave-stat" id="w-vpp">Vpp: 10.0 V</span>
                        </div>
                        <div class="slabel">Ask AI about this waveform:</div>
                        <div class="chat-input-row">
                            <textarea id="wave-input"
                                placeholder="e.g. What happens if I apply this 50Hz signal to an RC low-pass filter?"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('wave-input','wave-voice')"
                                id="wave-voice">🎤</button>
                            <button class="btn btn-primary" id="wave-btn"
                                onclick="runChat('components','wave','wave-output','wave-ph')">→</button>
                        </div>
                        <div class="loading" id="wave-loading">
                            <div class="spinner"></div>Analyzing...
                        </div>
                        <div id="wave-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// OSCILLOSCOPE</span></div>
                    <div class="panel-body">
                        <div class="slabel">Live waveform preview:</div>
                        <div class="anim-wrap" style="margin-bottom:12px;">
                            <canvas id="waveCanvas" height="200"></canvas>
                        </div>
                        <div id="wave-ph" class="placeholder" style="min-height:80px;">
                            <div class="placeholder-icon">〰️</div>
                            <p>AI analysis appears here</p>
                        </div>
                        <div id="wave-output" class="msg assistant" style="display:none;max-width:100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ BOM ══════════════════════════════════════════════════════════════ -->
        <div id="tab-bom" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// BILL OF MATERIALS</span></div>
                    <div class="panel-body">
                        <div class="chat-area" id="bom-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="bom-input"
                                placeholder="e.g. LED blinker with 555 timer, 9V battery, breadboard"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('bom-input','bom-voice')"
                                id="bom-voice">🎤</button>
                            <button class="btn btn-primary" id="bom-btn" onclick="runBOM()">🧾</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('bom','555 timer LED blinker on breadboard')">555
                                blinker</span>
                            <span class="chip" onclick="qs('bom','Arduino Uno, DHT11 sensor, 16x2 LCD display')">Temp
                                monitor</span>
                            <span class="chip"
                                onclick="qs('bom','Simple LED circuit 9V battery 220 ohm resistor')">Basic LED</span>
                            <span class="chip" onclick="generateShoppingCart()"
                                style="border-color:#ff6600;color:#ff9933;">🛒 Shop List</span>
                        </div>
                        <div class="loading" id="bom-loading">
                            <div class="spinner"></div>Generating BOM...
                        </div>
                        <div id="bom-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// PARTS LIST</span>
                        <button class="btn btn-green" id="bom-dl" style="display:none" onclick="dlBOM()">↓ CSV</button>
                    </div>
                    <div class="panel-body">
                        <div id="bom-ph" class="placeholder">
                            <div class="placeholder-icon">🧾</div>
                            <p>Parts list with pricing</p>
                        </div>
                        <div id="bom-out" style="display:none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ COMPONENTS ═══════════════════════════════════════════════════════ -->
        <div id="tab-components" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// COMPONENT ADVISOR</span></div>
                    <div class="panel-body">
                        <div class="chat-area" id="comp-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="comp-input" placeholder="e.g. What resistor for a red LED on 5V?"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('comp-input','comp-voice')"
                                id="comp-voice">🎤</button>
                            <button class="btn btn-primary" id="comp-btn"
                                onclick="runChat('components','comp','comp-out','comp-ph')">→</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('comp','Resistor for red LED on 5V')">LED resistor</span>
                            <span class="chip"
                                onclick="qs('comp','Best capacitor for 100Hz power supply filter')">Filter cap</span>
                            <span class="chip" onclick="qs('comp','NPN transistor for 500mA load switching')">NPN
                                switch</span>
                        </div>
                        <div class="loading" id="comp-loading">
                            <div class="spinner"></div>Finding parts...
                        </div>
                        <div id="comp-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// RECOMMENDATIONS</span></div>
                    <div class="panel-body">
                        <div id="comp-ph" class="placeholder">
                            <div class="placeholder-icon">🧩</div>
                            <p>Recommendations here</p>
                        </div>
                        <div id="comp-out" class="msg assistant" style="display:none;max-width:100%;"></div>
                        <div class="divider"></div>
                        <button class="ref-toggle" onclick="toggleRef()" id="ref-toggle-btn">▶ Component
                            Reference</button>
                        <div id="comp-ref" style="display:none">
                            <div class="ref-grid">
                                <div class="ref-card"
                                    onclick="qs('comp','What resistor do I need for a red LED on 5V?')">
                                    <h4>⚡ Resistor</h4>
                                    <div class="ref-formula">V = I × R</div>
                                    <div class="ref-vals">Common: 220Ω, 1kΩ, 4.7kΩ, 10kΩ</div>
                                </div>
                                <div class="ref-card" onclick="qs('comp','Best capacitor for power supply filtering?')">
                                    <h4>⚡ Capacitor</h4>
                                    <div class="ref-formula">Q = C × V</div>
                                    <div class="ref-vals">Common: 100nF, 10µF, 100µF, 1000µF</div>
                                </div>
                                <div class="ref-card"
                                    onclick="qs('comp','Explain NPN transistor for switching a motor')">
                                    <h4>🔀 Transistor (NPN)</h4>
                                    <div class="ref-formula">Ic = β × Ib</div>
                                    <div class="ref-vals">Common: 2N2222, BC547, TIP120</div>
                                </div>
                                <div class="ref-card" onclick="qs('comp','Best LED for indicator light on 3.3V?')">
                                    <h4>💡 LED</h4>
                                    <div class="ref-formula">Vf ≈ 2V (red), 3.2V (blue)</div>
                                    <div class="ref-vals">Typical: 20mA, 2V–3.3V forward</div>
                                </div>
                                <div class="ref-card"
                                    onclick="qs('comp','Which diode for reverse polarity protection?')">
                                    <h4>🔒 Diode</h4>
                                    <div class="ref-formula">Vf ≈ 0.7V (silicon)</div>
                                    <div class="ref-vals">Common: 1N4007, 1N5819 (Schottky)</div>
                                </div>
                                <div class="ref-card" onclick="qs('comp','Best voltage regulator for 5V from 12V?')">
                                    <h4>📐 Voltage Regulator</h4>
                                    <div class="ref-formula">P = (Vin - Vout) × I</div>
                                    <div class="ref-vals">Common: 7805, LM1117, AMS1117</div>
                                </div>
                                <div class="ref-card" onclick="qs('comp','What inductor for a 5V buck converter?')">
                                    <h4>🌀 Inductor</h4>
                                    <div class="ref-formula">V = L × dI/dt</div>
                                    <div class="ref-vals">Common: 10µH, 47µH, 100µH</div>
                                </div>
                                <div class="ref-card"
                                    onclick="qs('comp','Best MOSFET for 12V motor control from Arduino?')">
                                    <h4>🔌 MOSFET</h4>
                                    <div class="ref-formula">Rds(on) × I² = Power loss</div>
                                    <div class="ref-vals">Logic-level: IRLZ44N, IRF3205</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ DEBUG ════════════════════════════════════════════════════════════ -->
        <div id="tab-debug" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// CIRCUIT DEBUGGER</span></div>
                    <div class="panel-body">
                        <div class="chat-area" id="debug-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="debug-input"
                                placeholder="e.g. My LED burned out when I used 9V directly"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('debug-input','debug-voice')"
                                id="debug-voice">🎤</button>
                            <button class="btn btn-primary" id="debug-btn"
                                onclick="runChat('debug','debug','debug-out','debug-ph')">→</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('debug','Connected 9V directly to LED, it burned')">LED
                                burned</span>
                            <span class="chip"
                                onclick="qs('debug','Arduino resets when I run a motor on pin 9')">Arduino
                                resets</span>
                            <span class="chip" onclick="qs('debug','7805 voltage regulator gets extremely hot')">Hot
                                regulator</span>
                        </div>
                        <div class="loading" id="debug-loading">
                            <div class="spinner"></div>Diagnosing...
                        </div>
                        <div id="debug-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// DIAGNOSIS</span></div>
                    <div class="panel-body">
                        <div id="debug-ph" class="placeholder">
                            <div class="placeholder-icon">🔍</div>
                            <p>Diagnosis here</p>
                        </div>
                        <div id="debug-out" class="msg assistant" style="display:none;max-width:100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ ARDUINO ══════════════════════════════════════════════════════════ -->
        <div id="tab-arduino" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// CODE GENERATOR</span></div>
                    <div class="panel-body">
                        <div class="chat-area" id="ard-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="ard-input"
                                placeholder="e.g. Blink LED on pin 13 every 500ms, faster when button pressed"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('ard-input','ard-voice')"
                                id="ard-voice">🎤</button>
                            <button class="btn btn-primary" id="ard-btn"
                                onclick="runChat('arduino','ard','ard-out','ard-ph')">→</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('ard','Blink LED on pin 13 every 500ms')">LED blink</span>
                            <span class="chip"
                                onclick="qs('ard','Read DHT11 temp and humidity, print to serial')">DHT11</span>
                            <span class="chip"
                                onclick="qs('ard','HC-SR04 ultrasonic sensor, buzzer alert under 20cm')">Ultrasonic</span>
                            <span class="chip" onclick="qs('ard','Servo sweep 0-180 when button pressed')">Servo</span>
                        </div>
                        <div class="loading" id="ard-loading">
                            <div class="spinner"></div>Writing code...
                        </div>
                        <div id="ard-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// GENERATED CODE</span>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <button class="btn btn-sm" id="ard-copy" style="display:none" onclick="copyArduino()">📋
                                Copy</button>
                            <button class="btn btn-green" id="ard-dl" style="display:none" onclick="dlArduino()">↓
                                .ino</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="ard-ph" class="placeholder">
                            <div class="placeholder-icon">💻</div>
                            <p>Code appears here</p>
                        </div>
                        <div id="ard-out" class="msg assistant" style="display:none;max-width:100%;"></div>
                    </div>
                </div>
                <div class="panel" style="grid-column: 1 / -1;">
                    <div class="panel-hdr">
                        <span class="panel-title">// HARDWARE BRIDGE (WEB-SERIAL)</span>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm" id="btn-serial-connect" onclick="connectSerial()">🔌 Connect
                                Device</button>
                            <button class="btn btn-sm btn-warn" onclick="clearSerial()">🗑️ Clear</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="serial-monitor" id="serial-out">Connect a device to see serial output...</div>
                        <canvas class="serial-plotter" id="serial-plot"></canvas>
                        <div class="serial-controls">
                            <input type="text" id="serial-input" placeholder="Type message to device..."
                                style="flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;outline:none;"
                                onkeydown="if(event.key==='Enter')sendSerial()" />
                            <button class="btn btn-primary" onclick="sendSerial()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ LEARN ════════════════════════════════════════════════════════════ -->
        <div id="tab-learn" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// LEARN ELECTRONICS</span></div>
                    <div class="panel-body">
                        <!-- FLASHCARDS -->
                        <div class="panel" style="margin-top:20px;">
                            <div class="panel-hdr"><span class="panel-title">// COMPONENT FLASHCARDS</span></div>
                            <div class="panel-body">
                                <div class="flash-wrap" id="flash-card" onclick="this.classList.toggle('flipped')">
                                    <div class="flash-inner">
                                        <div class="flash-face flash-front">
                                            <div class="flash-sym" id="flash-sym">🔋</div>
                                            <div class="flash-name" id="flash-name">Battery</div>
                                            <p style="font-size:.64rem;color:var(--text-dim);margin-top:10px;">Click to
                                                reveal...</p>
                                        </div>
                                        <div class="flash-face flash-back">
                                            <div class="flash-desc" id="flash-desc">Stores chemical energy and converts
                                                it to electrical
                                                energy. Provides the voltage source for the circuit.</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:10px;">
                                    <button class="btn btn-secondary" style="flex:1" onclick="prevFlash()">Back</button>
                                    <button class="btn btn-primary" style="flex:1" onclick="nextFlash()">Next
                                        Card</button>
                                </div>
                            </div>
                        </div>

                        <!-- GUIDED PROJECTS -->
                        <div class="panel" style="margin-top:20px;">
                            <div class="panel-hdr"><span class="panel-title">// GUIDED PROJECTS</span></div>
                            <div class="panel-body">
                                <p style="font-size:.64rem;color:var(--text-dim);margin-bottom:12px;">Step-by-step
                                    builds for common
                                    circuits.</p>
                                <div class="examples" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                    <button class="chip" style="text-align:left;height:auto;padding:8px;"
                                        onclick="qs('learn','Guide me through building an Arduino Weather Station with DHT11')">🌡️
                                        Project
                                        1: Weather Station</button>
                                    <button class="chip" style="text-align:left;height:auto;padding:8px;"
                                        onclick="qs('learn','Show me how to make a 555 Timer PWM Motor Controller')">⚙️
                                        Project 2: Motor
                                        Control</button>
                                    <button class="chip" style="text-align:left;height:auto;padding:8px;"
                                        onclick="qs('learn','Step-by-step guide for a dark-activated night light with LDR')">🌙
                                        Project 3:
                                        Night Light</button>
                                    <button class="chip" style="text-align:left;height:auto;padding:8px;"
                                        onclick="qs('learn','How to build a simple Class A Audio Amplifier?')">🔊
                                        Project 4: Audio
                                        Amp</button>
                                </div>
                            </div>
                        </div>

                        <div class="chat-area" id="learn-chat"></div>
                        <div class="chat-input-row">
                            <textarea id="learn-input" placeholder="e.g. How does a capacitor work?"></textarea>
                            <button class="voice-btn" onclick="toggleVoice('learn-input','learn-voice')"
                                id="learn-voice">🎤</button>
                            <button class="btn btn-purple" id="learn-btn"
                                onclick="runChat('learn','learn','learn-out','learn-ph')">📚</button>
                        </div>
                        <div class="examples">
                            <span class="chip" onclick="qs('learn','How does a capacitor work?')">Capacitors</span>
                            <span class="chip" onclick="qs('learn','Explain Ohms Law with examples')">Ohm's Law</span>
                            <span class="chip" onclick="qs('learn','What is PWM?')">PWM</span>
                            <span class="chip"
                                onclick="qs('learn','Why does a transistor act like a switch?')">Transistors</span>
                            <span class="chip" onclick="qs('learn','Difference between AC and DC?')">AC vs DC</span>
                        </div>
                        <div class="loading" id="learn-loading">
                            <div class="spinner"></div>Explaining...
                        </div>
                        <div id="learn-error"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// EXPLANATION</span></div>
                    <div class="panel-body">
                        <div id="learn-ph" class="placeholder">
                            <div class="placeholder-icon">📚</div>
                            <p>Explanations here</p>
                        </div>
                        <div id="learn-out" class="learn-output" style="display:none"></div>
                        <div class="ohm-calc">
                            <div class="calc-tabs">
                                <div class="calc-tab active" onclick="switchCalc('ohm',this)">OHM'S LAW</div>
                                <div class="calc-tab" onclick="switchCalc('led',this)">LED RESISTOR</div>
                                <div class="calc-tab" onclick="switchCalc('555',this)">555 TIMER</div>
                            </div>

                            <!-- OHM'S LAW -->
                            <div id="calc-ohm" class="calc-group active">
                                <div class="ohm-grid">
                                    <div class="ohm-field"><label>Voltage (V)</label><input type="number" id="ohm-v"
                                            placeholder="—" oninput="calcOhm()"></div>
                                    <div class="ohm-field"><label>Current (A)</label><input type="number" id="ohm-i"
                                            placeholder="—" oninput="calcOhm()"></div>
                                    <div class="ohm-field"><label>Resistance (Ω)</label><input type="number" id="ohm-r"
                                            placeholder="—" oninput="calcOhm()"></div>
                                    <div class="ohm-field"><label>Power (W)</label><input type="number" id="ohm-p"
                                            placeholder="—" readonly></div>
                                </div>
                                <div class="ohm-result" id="ohm-result">Enter any 2 values</div>
                            </div>

                            <!-- LED RESISTOR -->
                            <div id="calc-led" class="calc-group">
                                <div class="ohm-grid">
                                    <div class="ohm-field"><label>Supply (V)</label><input type="number" id="led-vs"
                                            value="5" oninput="calcLED()"></div>
                                    <div class="ohm-field"><label>LED Vf (V)</label><input type="number" id="led-vf"
                                            value="2" oninput="calcLED()"></div>
                                    <div class="ohm-field"><label>LED If (mA)</label><input type="number" id="led-if"
                                            value="20" oninput="calcLED()"></div>
                                    <div class="ohm-field"><label>Resistor (Ω)</label><input type="number" id="led-r"
                                            readonly></div>
                                </div>
                                <div class="ohm-result" id="led-result">Use 150Ω resistor</div>
                            </div>

                            <!-- 555 TIMER -->
                            <div id="calc-555" class="calc-group">
                                <div class="ohm-grid">
                                    <div class="ohm-field"><label>R1 (Ω)</label><input type="number" id="555-r1"
                                            value="1000" oninput="calc555()"></div>
                                    <div class="ohm-field"><label>R2 (Ω)</label><input type="number" id="555-r2"
                                            value="10000" oninput="calc555()"></div>
                                    <div class="ohm-field"><label>Cap (µF)</label><input type="number" id="555-c"
                                            value="10" oninput="calc555()"></div>
                                </div>
                                <div class="ohm-result" id="555-result">F: 6.8 Hz · Duty: 52%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ QUIZ ══════════════════════════════════════════════════════════════ -->
        <div id="tab-quiz" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// CIRCUIT QUIZ</span></div>
                    <div class="panel-body">
                        <div class="quiz-meta">
                            <span class="quiz-score" id="quiz-score">Score: 0 / 0</span>
                            <div class="quiz-level">
                                <button class="level-btn active" onclick="setLevel('beginner',this)">Beginner</button>
                                <button class="level-btn" onclick="setLevel('intermediate',this)">Intermediate</button>
                                <button class="level-btn" onclick="setLevel('advanced',this)">Advanced</button>
                            </div>
                            <button class="btn btn-sm"
                                style="font-size:.62rem;color:var(--accent3);border-color:var(--accent3)"
                                onclick="resetQuizStats()">↺ Reset</button>
                            <button class="btn btn-sm" onclick="loadQuiz()">↺ New Question</button>
                        </div>
                        <div class="quiz-progress">
                            <div class="quiz-progress-fill" id="quiz-prog" style="width:0%"></div>
                        </div>
                        <div id="quiz-area">
                            <div class="placeholder">
                                <div class="placeholder-icon">🎯</div>
                                <p>Click "New Question" to start the quiz!</p>
                            </div>
                        </div>
                        <div class="loading" id="quiz-loading" style="margin-top:8px;">
                            <div class="spinner"></div>Loading question...
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// YOUR STATS</span></div>
                    <div class="panel-body">
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            <div class="sim-card">
                                <h4>Session Stats</h4>
                                <div class="node-row"><span class="node-name">Questions answered</span><span
                                        class="node-val" id="stat-total">0</span></div>
                                <div class="node-row"><span class="node-name">Correct</span><span class="node-val"
                                        style="color:var(--accent2)" id="stat-correct">0</span></div>
                                <div class="node-row"><span class="node-name">Accuracy</span><span class="node-val"
                                        id="stat-acc">—</span></div>
                                <div class="node-row"><span class="node-name">Current streak</span><span
                                        class="node-val" style="color:var(--warn)" id="stat-streak">0 🔥</span></div>
                            </div>

                            <!-- CHALLENGES -->
                            <div class="panel" style="margin-top:15px; border: 1px solid var(--accent3);">
                                <div class="panel-hdr"><span class="panel-title" style="color:var(--accent3)">// DESIGN
                                        CHALLENGES</span></div>
                                <div class="panel-body">
                                    <div id="challenge-setup">
                                        <p style="font-size:.7rem;color:var(--text-dim);margin-bottom:10px;">Apply your
                                            knowledge to AI
                                            design prompts.</p>
                                        <button class="btn btn-orange" style="width:100%;font-size:.7rem;"
                                            onclick="genChallenge()">Generate
                                            Challenge</button>
                                    </div>
                                    <div id="challenge-box" style="display:none">
                                        <div class="challenge-box">
                                            <div class="challenge-title"><span>🏆</span> <span id="chall-title">Design
                                                    Task</span></div>
                                            <div class="challenge-desc" id="chall-desc"></div>
                                            <textarea class="challenge-input" id="chall-input"
                                                placeholder="Explain your solution..."></textarea>
                                            <button class="btn btn-primary" style="width:100%"
                                                onclick="submitChallenge()">Submit</button>
                                        </div>
                                        <div id="chall-result" class="msg assistant"
                                            style="display:none;font-size:.7rem;margin-top:8px;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="sim-card">
                                <h4>Topic History</h4>
                                <div id="quiz-history"
                                    style="font-size:.76rem;color:var(--text-dim);line-height:1.8;font-family:'JetBrains Mono',monospace;">
                                    No questions yet.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ TEMPLATES ═════════════════════════════════════════════════════════ -->
        <div id="tab-templates" class="tab-content">
            <div class="workspace" style="grid-template-columns:1fr;">
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// CIRCUIT TEMPLATES</span>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <span
                                style="font-size:.62rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">28
                                circuits · 7 categories</span>
                            <button class="btn btn-sm" onclick="openCalculator('ohm')"
                                style="background:linear-gradient(135deg,#1a2a00,#0a3a1a);border-color:#2a6a2a;color:#4caf50;">🔧
                                Calc</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:14px;">28 battle-tested circuits
                            — search, filter by category, load and customize. Use 🔧 Calc for instant math.</p>
                        <div class="tpl-grid" id="tpl-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ SAVED ═════════════════════════════════════════════════════════════ -->
        <div id="tab-saved" class="tab-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// SAVED CIRCUITS</span>
                        <button class="btn btn-sm" onclick="loadSavedList()">↺ Refresh</button>
                    </div>
                    <div class="panel-body">
                        <p style="font-size:.76rem;color:var(--text-dim);margin-bottom:11px;">Saved for this session.
                            Export PDF for
                            permanent records.</p>
                        <div id="saved-list" class="saved-list">
                            <div class="placeholder">
                                <div class="placeholder-icon">🗂️</div>
                                <p>No circuits saved yet</p>
                            </div>
                        </div>
                        <div class="history-section">
                            <div class="history-hdr">
                                <h4>📋 Circuit History (Local)</h4>
                                <button class="btn btn-sm" onclick="clearCircuitHistory()"
                                    style="font-size:.6rem;">Clear All</button>
                            </div>
                            <div id="circuit-history"></div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// LOADED CIRCUIT</span></div>
                    <div class="panel-body">
                        <div id="loaded-ph" class="placeholder">
                            <div class="placeholder-icon">📂</div>
                            <p>Select a circuit to load</p>
                        </div>
                        <div id="loaded-out" style="display:none">
                            <img id="loaded-img" class="schematic-img" style="margin-bottom:9px;" />
                            <div id="loaded-desc" style="font-size:.8rem;color:var(--text-dim);line-height:1.6;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ ARCHITECT ═════════════════════════════════════════════════════════ -->
        <div id="tab-architect" class="tab-content">
            <div class="workspace" style="display:grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// DEFINE CUSTOM COMPONENT</span></div>
                    <div class="panel-body">
                        <div class="ohm-field" style="margin-bottom:12px;">
                            <label>PART NAME</label>
                            <input type="text" id="arc-name" placeholder="e.g. MySens-V1" />
                        </div>
                        <div class="ohm-field" style="margin-bottom:12px;">
                            <label>CATEGORY</label>
                            <select id="arc-type" class="btn"
                                style="width:100%;text-align:left;background:var(--input-bg);border-color:var(--border)">
                                <option value="ic">Integrated Circuit (IC)</option>
                                <option value="sensor">Sensor Module</option>
                                <option value="mcu">Microcontroller</option>
                                <option value="transistor">Transistor / FET</option>
                                <option value="other">Other / Custom</option>
                            </select>
                        </div>
                        <div class="ohm-field" style="margin-bottom:12px;">
                            <label>PINOUT (Comma-separated)</label>
                            <input type="text" id="arc-pins" placeholder="VCC, GND, SDA, SCL" />
                        </div>
                        <div class="ohm-field" style="margin-bottom:15px;">
                            <label>SPECIFICATIONS / NOTES</label>
                            <textarea id="arc-specs" placeholder="Operating voltage, physical dimensions, etc."
                                style="width:100%;height:80px;background:var(--input-bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:.75rem;outline:none;"></textarea>
                        </div>
                        <button class="btn btn-primary" style="width:100%" onclick="saveCustomPart()">✨ Register
                            Component</button>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-hdr"><span class="panel-title">// YOUR CUSTOM LIBRARY</span></div>
                    <div class="panel-body">
                        <div id="arc-list" class="dash-grid" style="grid-template-columns: 1fr;">
                            <p style="font-size:.72rem;color:var(--text-dim);text-align:center;">No custom components
                                defined yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ GALLERY ═══════════════════════════════════════════════════════════ -->
        <div id="tab-gallery" class="tab-content">
            <div class="workspace" style="display:block;">
                <div class="panel">
                    <div class="panel-hdr">
                        <span class="panel-title">// 🏆 COMMUNITY LEADERBOARD</span>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <input id="gallery-search" type="text" placeholder="Search circuits..." style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:5px 10px;
                       color:var(--text);font-size:.72rem;width:140px;" oninput="filterGallery(this.value)" />
                            <button class="btn btn-sm" onclick="loadGallery()">🔄 Refresh</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
                            <div
                                style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 16px;flex:1;min-width:120px;">
                                <div
                                    style="font-size:.62rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">
                                    CIRCUITS SHARED</div>
                                <div id="gallery-count"
                                    style="font-size:1.4rem;font-weight:700;color:var(--accent);font-family:'JetBrains Mono',monospace;">
                                    —</div>
                            </div>
                            <div
                                style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 16px;flex:1;min-width:120px;">
                                <div
                                    style="font-size:.62rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">
                                    COMMUNITY VOTES</div>
                                <div id="gallery-votes"
                                    style="font-size:1.4rem;font-weight:700;color:#ffaa44;font-family:'JetBrains Mono',monospace;">
                                    —</div>
                            </div>
                            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 16px;flex:1;min-width:120px;cursor:pointer;"
                                onclick="shareCircuitURL()">
                                <div
                                    style="font-size:.62rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">
                                    SHARE YOURS</div>
                                <div style="font-size:1.4rem;">🔗</div>
                            </div>
                        </div>
                        <div id="gallery-list" class="gallery-grid">
                            <div class="loading visible">
                                <div class="spinner"></div> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══ SHORTCUTS MODAL ═══════════════════════════════════════════════════ -->
        <div class="modal-overlay" id="shortcuts-modal" onclick="if(event.target===this)toggleShortcuts()">
            <div class="modal" style="position:relative">
                <button class="close-modal" onclick="toggleShortcuts()">✕</button>
                <h2>⌨️ Keyboard Shortcuts</h2>
                <div class="shortcut-row"><span>Switch tabs</span><span
                        class="shortcut-key"><kbd>1</kbd>–<kbd>0</kbd></span>
                </div>
                <div class="shortcut-row"><span>Save circuit</span><span
                        class="shortcut-key"><kbd>Ctrl</kbd><kbd>S</kbd></span>
                </div>
                <div class="shortcut-row"><span>Export PDF</span><span
                        class="shortcut-key"><kbd>Ctrl</kbd><kbd>E</kbd></span>
                </div>
                <div class="shortcut-row"><span>Submit input</span><span
                        class="shortcut-key"><kbd>Ctrl</kbd><kbd>↵</kbd></span>
                </div>
                <div class="shortcut-row"><span>Toggle theme</span><span
                        class="shortcut-key"><kbd>Ctrl</kbd><kbd>D</kbd></span>
                </div>
                <div class="shortcut-row"><span>Show shortcuts</span><span class="shortcut-key"><kbd>?</kbd></span>
                </div>
            </div>
        </div>

        <footer>CIRCUIT COPILOT v4.0 · Groq LLaMA 3.3 70B · FastAPI · <a
                href="https://github.com/smemon819/circuit-copilot" target="_blank">GitHub</a> · Free &amp; Open Source
            · Press <kbd
                style="background:var(--bg3);border:1px solid var(--border2);border-radius:3px;padding:1px 5px;font-family:'JetBrains Mono',monospace;font-size:.6rem;">?</kbd>
            for shortcuts</footer>
    </div><!-- .app -->
    <canvas id="confetti-canvas"></canvas>
    <div id="tour-overlay"></div>
    <div id="probe-tip" class="probe-tip">
        <h6 id="probe-title">Node Probe</h6>
        <div id="probe-content">
            <div class="probe-val" id="probe-val">0.00 V</div>
        </div>
        <div class="probe-actions">
            <button class="btn btn-sm" onclick="pinToWaveform()">〰️ Pin to Waveform</button>
            <button class="btn btn-sm" onclick="closeProbe()">✕ Close</button>
        </div>
    </div>

    <script>
        // ── STATE ──────────────────────────────────────────────────────────────────
        let currentCid = null;
        let deviceId = localStorage.getItem('cc_device_id');
        if (!deviceId) {
            deviceId = 'd_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
            localStorage.setItem('cc_device_id', deviceId);
        }
        let collabSocket = null;
        const S = {
            sch: { history: [], lastImage: null, lastSchema: null },
            sim: { history: [], lastSim: null },
            bom: { history: [], lastBom: null },
            comp: { history: [] }, debug: { history: [] },
            ard: { history: [], lastCode: '' },
            learn: { history: [] }, wave: { history: [] },
            breadboard: { history: [], lastGuide: null },
            probes: [], // { name: string, val: string, unit: string, color: string }
            stats: JSON.parse(localStorage.getItem('cc_stats') || 'null') || {
                circuits: 0,
                digital: 0,
                analog: 0,
                mcu: 0,
                achievements: []
            }
        };
        function saveStats() { localStorage.setItem('cc_stats', JSON.stringify(S.stats)); }
        let pdfData = {};

        // Quiz state — load from localStorage
        let quiz = JSON.parse(localStorage.getItem('cc_quiz') || 'null') || { score: 0, total: 0, streak: 0, level: 'beginner', history: [], current: null };
        function saveQuiz() { localStorage.setItem('cc_quiz', JSON.stringify({ score: quiz.score, total: quiz.total, streak: quiz.streak, level: quiz.level, history: quiz.history.slice(0, 20) })); }
        function resetQuizStats() { quiz = { score: 0, total: 0, streak: 0, level: quiz.level, history: [], current: null }; saveQuiz(); updateQuizUI(); document.getElementById('quiz-area').innerHTML = '<div class="placeholder"><div class="placeholder-icon">🎯</div><p>Stats reset! Click "New Question" to start.</p></div>'; }
        function updateQuizUI() { document.getElementById('quiz-score').textContent = `Score: ${quiz.score} / ${quiz.total}`; document.getElementById('stat-total').textContent = quiz.total; document.getElementById('stat-correct').textContent = quiz.score; document.getElementById('stat-acc').textContent = quiz.total ? Math.round((quiz.score / quiz.total) * 100) + '%' : '—'; document.getElementById('stat-streak').textContent = quiz.streak + (quiz.streak >= 3 ? ' 🔥' : ''); document.getElementById('quiz-prog').style.width = Math.min(100, quiz.total * 10) + '%'; document.getElementById('quiz-history').innerHTML = quiz.history.length ? quiz.history.slice(0, 8).map(h => `${h.correct ? '✅' : '❌'} ${h.q}`).join('<br>') : 'No questions yet.'; }
        // Restore quiz UI on load
        setTimeout(updateQuizUI, 100);

        // ── THEME ──────────────────────────────────────────────────────────────────
        function toggleTheme() {
            const html = document.documentElement;
            html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            localStorage.setItem('theme', html.getAttribute('data-theme'));
        }
        (function () { const t = localStorage.getItem('theme'); if (t) document.documentElement.setAttribute('data-theme', t); })();

        // ── TABS ───────────────────────────────────────────────────────────────────
        function switchTab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            btn.classList.add('active');
            // Hide badge when visiting tab
            updateTabBadge(name, false);
            if (name === 'dashboard') renderDashboard();
            if (name === 'breadboard') initBreadboard();
            if (name === 'saved') loadSavedList();
            if (name === 'gallery') loadGallery();
            if (name === 'architect') renderArchitect();
            if (name === 'waveform') { setTimeout(() => { drawWave(); }, 100); }
        }

        // ── DASHBOARD ─────────────────────────────────────────────────────────────
        const ACHIEVEMENTS = [
            { id: 'first_cir', icon: '🔋', title: 'First Circuit', desc: 'Generate your first schematic', req: s => s.circuits >= 1 },
            { id: 'designer', icon: '🎨', title: 'Designer', desc: 'Generate 5 schematics', req: s => s.circuits >= 5 },
            { id: 'engineer', icon: '🏗️', title: 'Circuit Engineer', desc: 'Generate 20 schematics', req: s => s.circuits >= 20 },
            { id: 'quiz_intro', icon: '📝', title: 'Quizzer', desc: 'Answer 5 quiz questions', req: (s, q) => q.total >= 5 },
            { id: 'streak_3', icon: '🔥', title: 'On Fire', desc: 'Get a 3-question streak', req: (s, q) => q.streak >= 3 },
            { id: 'perfectionist', icon: '💎', title: 'Perfectionist', desc: 'Reach 100% accuracy (min 10 q)', req: (s, q) => q.total >= 10 && q.score === q.total },
            { id: 'digital_master', icon: '🎛️', title: 'Digital Master', desc: 'Get 10 digital logic questions correct', req: s => s.digital >= 10 },
            { id: 'analog_master', icon: '📈', title: 'Analog Master', desc: 'Get 10 analog questions correct', req: s => s.analog >= 10 },
            { id: 'mcu_master', icon: '💻', title: 'MCU Master', desc: 'Get 10 microcontroller questions correct', req: s => s.mcu >= 10 }
        ];

        function renderDashboard() {
            document.getElementById('dash-circuits').textContent = S.stats.circuits;
            document.getElementById('dash-quiz').textContent = quiz.score + ' / ' + quiz.total;
            document.getElementById('dash-streak').textContent = quiz.streak;

            // Skills
            const updateSkill = (id, val) => {
                const pct = Math.min(100, Math.floor((val / 10) * 100)); // 10 is "mastery" for now
                document.getElementById(`skill-${id}-pct`).textContent = pct + '%';
                document.getElementById(`skill-${id}`).style.width = pct + '%';
            };
            updateSkill('digital', S.stats.digital);
            updateSkill('analog', S.stats.analog);
            updateSkill('mcu', S.stats.mcu);

            // Achievements
            const achieveContainer = document.getElementById('achievements');
            achieveContainer.innerHTML = ACHIEVEMENTS.map(a => {
                const unlocked = S.stats.achievements.includes(a.id) || a.req(S.stats, quiz);
                if (unlocked && !S.stats.achievements.includes(a.id)) {
                    S.stats.achievements.push(a.id);
                    saveStats();
                    showToast(`🏆 Achievement Unlocked: ${a.title}!`);
                }
                return `
          <div class="badge-icon ${unlocked ? 'unlocked' : ''}">
            ${a.icon}
            <div class="badge-tip"><strong>${a.title}</strong><br>${a.desc}</div>
          </div>
        `;
            }).join('');
        }
        setTimeout(() => {
            renderDashboard();
            renderFlash();
        }, 200);

        // ── FLASHCARDS ────────────────────────────────────────────────────────────
        const FLASH_DECK = [
            { sym: '🔋', name: 'Battery', desc: 'Voltage source. Stores energy chemically. DC power.' },
            { sym: '〰️', name: 'Resistor', desc: 'Limits current flow. Measured in Ohms (Ω). V=IR.' },
            { sym: '🎚️', name: 'Potentiometer', desc: 'Variable resistor. Used for volume, dimming, etc.' },
            { sym: '🥛', name: 'Capacitor', desc: 'Stores charge in an electric field. Blocks DC, passes AC.' },
            { sym: '🌀', name: 'Inductor', desc: 'Stores energy in a magnetic field. Resists changes in current.' },
            { sym: '🔌', name: 'Diode', desc: 'One-way valve for current. Forward voltage drop ~0.7V.' },
            { sym: '💡', name: 'LED', desc: 'Light Emitting Diode. Specialized diode that emits light.' },
            { sym: '🔀', name: 'Transistor', desc: 'Electronic switch or amplifier. NPN/PNP types.' },
            { sym: '💻', name: 'Integrated Circuit', desc: 'Miniaturized circuit containing thousands of components.' },
            { sym: '🔊', name: 'Buzzer', desc: 'Converts electrical energy to sound. Active or passive.' }
        ];
        let flashIdx = 0;
        function renderFlash() {
            const c = FLASH_DECK[flashIdx];
            document.getElementById('flash-sym').textContent = c.sym;
            document.getElementById('flash-name').textContent = c.name;
            document.getElementById('flash-desc').textContent = c.desc;
            document.getElementById('flash-card').classList.remove('flipped');
        }
        function nextFlash() { flashIdx = (flashIdx + 1) % FLASH_DECK.length; renderFlash(); }
        function prevFlash() { flashIdx = (flashIdx - 1 + FLASH_DECK.length) % FLASH_DECK.length; renderFlash(); }

        // ── CHALLENGES ────────────────────────────────────────────────────────────
        async function genChallenge() {
            const btn = document.querySelector('button[onclick="genChallenge()"]');
            btn.disabled = true; btn.textContent = 'Generating...';
            try {
                const res = await fetch('/api/learn', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: [], prompt: 'Generate a short electronics design challenge for a beginner/intermediate student. Format exactly as:\nTitle: [short challenge title]\nDescription: [2-3 sentence challenge with specific requirements the student must meet]' })
                });
                const data = await res.json();
                const text = data.result || '';
                const tMatch = text.match(/Title:\s*(.*?)(?:\n|$)/i);
                const dMatch = text.match(/Description:\s*([\s\S]*)/i);
                document.getElementById('chall-title').textContent = tMatch ? tMatch[1].trim() : 'Design Challenge';
                document.getElementById('chall-desc').textContent = dMatch ? dMatch[1].trim().substring(0, 400) : text;
                document.getElementById('challenge-box').style.display = 'block';
                document.getElementById('chall-result').style.display = 'none';
                document.getElementById('chall-input').value = '';
            } catch (e) { showToast('❌ Failed to generate challenge'); }
            finally { btn.disabled = false; btn.textContent = 'Generate New Challenge'; }
        }

        async function submitChallenge() {
            const ans = document.getElementById('chall-input').value.trim();
            if (!ans) return;
            const resEl = document.getElementById('chall-result');
            resEl.style.display = 'block'; resEl.innerHTML = '<div class="spinner"></div> Validating...';
            try {
                const res = await fetch('/api/debug', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: [], prompt: `Evaluate this student design challenge answer.\nChallenge: ${document.getElementById('chall-desc').textContent}\nStudent answer: ${ans}\nBe encouraging, technically precise, and give specific improvements.` })
                });
                const data = await res.json();
                resEl.innerHTML = marked.parse(data.result || 'No response');
                fireConfetti(); S.stats.mcu++; saveStats(); renderDashboard();
            } catch (e) { resEl.textContent = 'Validation failed — please try again'; }
        }

        // ── TAB BADGES ─────────────────────────────────────────────────────────────
        function updateTabBadge(name, on) {
            const tab = document.querySelector(`.tab[onclick*="'${name}'"]`);
            if (!tab) return;
            const badge = tab.querySelector('.tab-badge');
            if (badge) badge.style.display = on ? 'block' : 'none';
        }

        // ── AUTO-SAVE DRAFTS ───────────────────────────────────────────────────────
        function initAutoSave() {
            const ids = ['sch-input', 'sim-input', 'bom-input', 'comp-input', 'debug-input', 'ard-input', 'learn-input'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => localStorage.setItem('cc_draft_' + id, el.value));
                const s = localStorage.getItem('cc_draft_' + id);
                if (s) el.value = s;
            });
            const p = document.getElementById('project-name');
            p.addEventListener('input', () => localStorage.setItem('cc_draft_pname', p.value));
            const sp = localStorage.getItem('cc_draft_pname');
            if (sp) p.value = sp;
        }
        setTimeout(initAutoSave, 500);

        // ── HELPERS ────────────────────────────────────────────────────────────────
        const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        function appendMsg(chatId, role, content) {
            const chat = document.getElementById(chatId);
            if (!chat) return;
            const d = document.createElement('div');
            d.className = `msg ${role}`;
            d.innerHTML = role === 'assistant' ? marked.parse(content) : esc(content);
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
        }
        function setLoading(p, on) {
            const b = document.getElementById(p + '-btn'); if (b) b.disabled = on;
            const l = document.getElementById(p + '-loading'); if (l) l.classList.toggle('visible', on);
            // Show skeleton in placeholder
            const phMap = { sch: 'sch-ph', sim: 'sim-ph', bom: 'bom-ph', comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph' };
            const ph = document.getElementById(phMap[p]);
            if (ph && on) {
                ph._origHTML = ph._origHTML || ph.innerHTML;
                ph.innerHTML = `<div class="skeleton-wrap">${p === 'sch' ? '<div class="skeleton-img"></div>' : ''}<div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div></div>`;
                ph.style.display = 'flex';
            } else if (ph && !on && ph._origHTML) {
                ph.innerHTML = ph._origHTML;
            }
        }

        // ── TOAST NOTIFICATIONS ───────────────────────────────────────────────────
        function showToast(msg, duration = 3000) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px;';
                document.body.appendChild(container);
            }
            const t = document.createElement('div');
            t.style.cssText = 'background:var(--panel);border:1px solid var(--accent);border-radius:8px;padding:10px 16px;font-size:.78rem;color:var(--text);font-family:Syne,sans-serif;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:skeleton-pulse .8s ease-in-out;';
            t.textContent = msg;
            container.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity .3s'; setTimeout(() => t.remove(), 300); }, duration);
        }

        // ── FETCH WITH RETRY ──────────────────────────────────────────────────────
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const res = await fetch(url, options);
                    if (res.status === 429 && attempt < maxRetries) {
                        const wait = Math.pow(2, attempt + 1);
                        showToast(`⏳ Rate limited — retrying in ${wait}s... (${attempt + 1}/${maxRetries})`);
                        await new Promise(r => setTimeout(r, wait * 1000));
                        continue;
                    }
                    return res;
                } catch (e) {
                    if (attempt < maxRetries) {
                        const wait = Math.pow(2, attempt + 1);
                        showToast(`⚠ Network error — retrying in ${wait}s...`);
                        await new Promise(r => setTimeout(r, wait * 1000));
                        continue;
                    }
                    throw e;
                }
            }
        }
        function showErr(p, msg) {
            const el = document.getElementById(p + '-error');
            if (el) el.innerHTML = msg ? `<div class="error-msg">⚠ ${msg}</div>` : '';
        }
        function qs(p, text) {
            const el = document.getElementById(p + '-input'); if (!el) return;
            el.value = text;
            const dispatch = { sch: runSchematic, sim: runSimulate, bom: runBOM };
            if (dispatch[p]) dispatch[p]();
            else {
                const ep = { comp: 'components', debug: 'debug', ard: 'arduino', learn: 'learn', wave: 'components' }[p];
                const outId = { comp: 'comp-out', debug: 'debug-out', ard: 'ard-out', learn: 'learn-out', wave: 'wave-output' }[p];
                const phId = { comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph', wave: 'wave-ph' }[p];
                if (ep) runChat(ep, p, outId, phId);
            }
        }

        // ── VOICE ─────────────────────────────────────────────────────────────────
        let recog = null, activeInput = null;
        function toggleVoice(inputId, btnId) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) { alert('Voice not supported. Use Chrome.'); return; }
            const btn = document.getElementById(btnId);
            if (recog && activeInput === inputId) { recog.stop(); return; }
            recog = new SR(); recog.continuous = false; recog.interimResults = false; recog.lang = 'en-US';
            activeInput = inputId; btn.classList.add('recording');
            recog.onresult = e => {
                document.getElementById(inputId).value = e.results[0][0].transcript;
                btn.classList.remove('recording'); activeInput = null;
            };
            recog.onerror = recog.onend = () => { btn.classList.remove('recording'); activeInput = null; };
            recog.start();
        }

        // ── SCHEMATIC ─────────────────────────────────────────────────────────────
        async function runSchematic() {
            const input = document.getElementById('sch-input');
            const prompt = input.value.trim(); if (!prompt) return;
            appendMsg('sch-chat', 'user', prompt);
            S.sch.history.push({ role: 'user', content: prompt });
            input.value = ''; setLoading('sch', true); showErr('sch', '');
            try {
                const res = await fetchWithRetry('/api/schematic', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history: S.sch.history.slice(-10) })
                });
                const data = await res.json(); if (data.error) throw new Error(data.error);
                S.sch.lastImage = data.image; S.sch.lastSchema = data.schema;
                // Render beautiful SVG schematic (primary view)
                renderSVGSchematic(data.schema);
                // Also store PNG for PDF export
                const img = document.getElementById('sch-img');
                img.src = 'data:image/png;base64,' + data.image;
                document.getElementById('sch-ph').style.display = 'none';
                document.getElementById('sch-dl').style.display = 'inline-flex';
                document.getElementById('sch-share').style.display = 'inline-flex';
                document.getElementById('sch-screenshot').style.display = 'inline-flex';
                document.getElementById('sch-eda').style.display = 'inline-flex'; // Show EDA button
                const meta = document.getElementById('sch-meta'); meta.style.display = 'flex'; meta.innerHTML = '';
                if (data.difficulty) meta.innerHTML += `<span class="meta-tag badge-info">${data.difficulty}</span>`;
                if (data.use_case) meta.innerHTML += `<span class="meta-tag" style="font-size:.66rem;color:var(--text-dim);background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 7px;">${data.use_case}</span>`;
                const desc = document.getElementById('sch-desc');
                if (data.description) { desc.textContent = '► ' + data.description; desc.style.display = 'block'; }
                if (data.falstad_url) {
                    document.getElementById('falstad-link').href = data.falstad_url;
                    document.getElementById('falstad-wrap').style.display = 'block';
                }
                S.sch.history.push({ role: 'assistant', content: data.assistant_message || data.description });
                appendMsg('sch-chat', 'assistant', data.description || 'Schematic generated!');
                document.dispatchEvent(new CustomEvent('schematic-ready'));
                const vBtn2 = document.getElementById('sch-validate'); if (vBtn2) vBtn2.style.display = 'inline-flex';
                pdfData.schematic_image = data.image; pdfData.schematic_description = data.description;
                pdfData.components = data.schema?.components || [];
                pdfData.project_name = document.getElementById('project-name').value || 'Circuit Report';
            } catch (e) { showErr('sch', e.message); }
            finally { setLoading('sch', false); }
        }
        document.getElementById('sch-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runSchematic(); } });

        // ── SIMULATE ──────────────────────────────────────────────────────────────
        async function runSimulate() {
            const input = document.getElementById('sim-input');
            const prompt = input.value.trim(); if (!prompt) return;
            appendMsg('sim-chat', 'user', prompt);
            S.sim.history.push({ role: 'user', content: prompt });
            input.value = ''; setLoading('sim', true); showErr('sim', '');
            try {
                const res = await fetchWithRetry('/api/simulate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history: S.sim.history.slice(-6) })
                });
                const data = await res.json(); if (data.error) throw new Error(data.error);
                S.sim.lastSim = data.simulation; pdfData.simulation = data.simulation;
                renderSim(data.simulation);
                appendMsg('sim-chat', 'assistant', data.simulation.summary || 'Done.');
                S.sim.history.push({ role: 'assistant', content: data.simulation.summary });
            } catch (e) { showErr('sim', e.message); }
            finally { setLoading('sim', false); }
        }
        document.getElementById('sim-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runSimulate(); } });

        function renderSim(sim) {
            document.getElementById('sim-ph').style.display = 'none';
            document.getElementById('sim-out').style.display = 'block';
            document.getElementById('sim-summary').textContent = sim.summary || '';
            document.getElementById('sim-nodes').innerHTML = (sim.nodes || []).map(n =>
                `<div class="node-row probe-node" onclick="openProbe(event, '${n.name}', '${n.voltage}', 'V')">
          <span class="node-name">${n.name}</span>
          <span class="node-val">${n.voltage} ${n.unit}</span>
        </div>`
            ).join('');
            const maxP = Math.max(...(sim.power || []).map(p => p.power), 1);
            document.getElementById('sim-power').innerHTML = (sim.power || []).map(p => {
                const pct = Math.min(100, (p.power / maxP) * 100).toFixed(1);
                const c = p.status === 'OK' ? 'var(--accent2)' : 'var(--warn)';
                return `<div class="power-bar-wrap">
      <div class="power-bar-label">
        <span style="font-size:.74rem">${p.component} <span class="badge ${p.status === 'OK' ? 'badge-ok' : 'badge-warn'}">${p.status}</span></span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:${c}">${p.power} ${p.unit}</span>
      </div>
      <div class="power-bar"><div class="power-bar-fill" style="width:${pct}%;background:${c}"></div></div>
    </div>`;
            }).join('');
            document.getElementById('sim-branches').innerHTML = (sim.branches || []).map(b =>
                `<div class="node-row probe-node" onclick="openProbe(event, '${b.name}', '${b.current}', '${b.unit}')">
          <span class="node-name">${b.name}</span>
          <span class="node-val">${b.current} ${b.unit}</span>
        </div>`
            ).join('');
            document.getElementById('sim-warns').innerHTML = (sim.warnings || []).map(w =>
                `<div class="sim-warning">⚠ ${w}</div>`).join('');
            drawFlow(sim);
        }

        function drawFlow(sim) {
            const canvas = document.getElementById('flowCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.offsetWidth || 500; canvas.width = W; canvas.height = 90;
            const nodes = sim.nodes || [], branches = sim.branches || [];
            const current = branches[0]?.current || 0, maxV = sim.supply_voltage || 9;
            const numP = Math.min(22, Math.max(3, Math.round(current / 4)));
            let pts = Array.from({ length: numP }, (_, i) => ({ x: (i / numP) * W, s: 1.1 + (current / 60) }));
            if (window._fAnim) cancelAnimationFrame(window._fAnim);
            function draw() {
                ctx.clearRect(0, 0, W, 90);
                ctx.beginPath(); ctx.moveTo(0, 45); ctx.lineTo(W, 45); ctx.strokeStyle = '#1c3a5a'; ctx.lineWidth = 3; ctx.stroke();
                nodes.forEach((n, i) => {
                    const nx = (i / Math.max(nodes.length - 1, 1)) * (W - 40) + 20;
                    ctx.beginPath(); ctx.arc(nx, 45, 4.5, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0,200,240,${.3 + (n.voltage / (maxV || 1)) * .7})`; ctx.fill();
                    ctx.fillStyle = '#4a8aaa'; ctx.font = '8px JetBrains Mono,monospace';
                    ctx.textAlign = 'center'; ctx.fillText(`${n.voltage}${n.unit}`, nx, 34);
                });
                pts.forEach(p => {
                    const g = ctx.createRadialGradient(p.x, 45, 0, p.x, 45, 5);
                    g.addColorStop(0, '#00f090'); g.addColorStop(1, 'rgba(0,240,144,0)');
                    ctx.beginPath(); ctx.arc(p.x, 45, 3.5, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill();
                    p.x += p.s; if (p.x > W) p.x = 0;
                });
                if (current > 0) {
                    ctx.fillStyle = '#00f090'; ctx.font = 'bold 9px Syne,sans-serif';
                    ctx.textAlign = 'right'; ctx.fillText(`I = ${current} ${branches[0]?.unit || 'mA'}`, W - 5, 66);
                }
                window._fAnim = requestAnimationFrame(draw);
            }
            draw();
        }
        function openProbe(event, name, val, unit) {
            const probeTip = document.getElementById('probe-tip');
            document.getElementById('probe-title').textContent = name;
            document.getElementById('probe-val').textContent = `${val} ${unit}`;
            probeTip.style.display = 'block';
            probeTip.style.left = `${event.clientX + 10}px`;
            probeTip.style.top = `${event.clientY + 10}px`;
            probeTip.dataset.probeName = name;
            probeTip.dataset.probeVal = val;
            probeTip.dataset.probeUnit = unit;
        }

        function closeProbe() {
            document.getElementById('probe-tip').style.display = 'none';
        }

        function pinToWaveform() {
            const probeTip = document.getElementById('probe-tip');
            const name = probeTip.dataset.probeName;
            const val = parseFloat(probeTip.dataset.probeVal);
            const unit = probeTip.dataset.probeUnit;

            if (!name || isNaN(val)) {
                showToast('Invalid probe data.');
                return;
            }

            // Generate a random color for the probe
            const color = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

            // Check if already pinned
            if (S.probes.some(p => p.name === name)) {
                showToast(`Probe "${name}" is already pinned.`);
                return;
            }

            S.probes.push({ name, val, unit, color });
            drawWave(); // Redraw waveform with new probe
            showToast(`Probe "${name}" pinned to waveform.`);
            closeProbe();
        }

        // ── WAVEFORM ──────────────────────────────────────────────────────────────
        function updateWaveLabel() {
            const f = +document.getElementById('w-freq').value;
            const a = +document.getElementById('w-amp').value;
            const o = +document.getElementById('w-offset').value;
            const d = +document.getElementById('w-duty').value;
            document.getElementById('w-freq-lbl').textContent = f + ' Hz';
            document.getElementById('w-amp-lbl').textContent = a + ' V';
            document.getElementById('w-offset-lbl').textContent = o + ' V';
            document.getElementById('w-duty-lbl').textContent = d + ' %';
            document.getElementById('w-period').textContent = 'Period: ' + (1000 / f).toFixed(1) + ' ms';
            const vrms = document.getElementById('w-type').value === 'sine' ? (a / Math.sqrt(2)).toFixed(2) : a.toFixed(2);
            document.getElementById('w-vrms').textContent = 'Vrms: ' + vrms + ' V';
            document.getElementById('w-vpp').textContent = 'Vpp: ' + (a * 2).toFixed(1) + ' V';
        }

        function drawWave() {
            const canvas = document.getElementById('waveCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const W = canvas.offsetWidth || 500; canvas.width = W; canvas.height = 200;
            const type = document.getElementById('w-type').value;
            const freq = +document.getElementById('w-freq').value;
            const amp = +document.getElementById('w-amp').value;
            const offset = +document.getElementById('w-offset').value;
            const duty = (+document.getElementById('w-duty').value) / 100;
            const theme = document.documentElement.getAttribute('data-theme');
            const bgColor = theme === 'light' ? '#ffffff' : '#060a12';
            const gridColor = theme === 'light' ? 'rgba(0,0,0,.08)' : 'rgba(0,200,240,.06)';
            const axisColor = theme === 'light' ? 'rgba(0,0,0,.2)' : 'rgba(0,200,240,.2)';

            ctx.fillStyle = bgColor; ctx.fillRect(0, 0, W, 200);

            // Grid
            ctx.strokeStyle = gridColor; ctx.lineWidth = 1;
            for (let x = 0; x < W; x += W / 10) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 200); ctx.stroke(); }
            for (let y = 0; y < 200; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

            // Axes
            ctx.strokeStyle = axisColor; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(0, 100); ctx.lineTo(W, 100); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 200); ctx.stroke();

            // Voltage labels
            ctx.fillStyle = '#4a8aaa'; ctx.font = '9px JetBrains Mono,monospace'; ctx.textAlign = 'left';
            ctx.fillText(`+${amp}V`, 4, 14); ctx.fillText('0V', 4, 103); ctx.fillText(`-${amp}V`, 4, 196);

            // Waveform
            const cycles = 3;
            const pxPerCycle = W / cycles;
            ctx.strokeStyle = '#00c8f0'; ctx.lineWidth = 2;
            ctx.shadowColor = 'rgba(0,200,240,.5)'; ctx.shadowBlur = 6;
            ctx.beginPath();
            for (let x = 0; x < W; x++) {
                const t = (x / pxPerCycle);
                const phase = t % 1;
                let v = 0;
                if (type === 'sine') v = Math.sin(phase * Math.PI * 2) * amp;
                else if (type === 'square') v = (phase < duty ? 1 : -1) * amp;
                else if (type === 'triangle') v = (phase < 0.5 ? (4 * phase - 1) : (3 - 4 * phase)) * amp;
                else if (type === 'sawtooth') v = (2 * phase - 1) * amp;
                else if (type === 'pwm') v = (phase < duty ? 1 : -1) * amp;
                const y = 100 - ((v + offset) / (amp + Math.abs(offset) + 0.001)) * 90;
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Draw Probes
            if (S.probes.length) {
                S.probes.forEach((p, i) => {
                    // Map probe value to canvas Y coordinate
                    // Assuming waveform canvas range is -amp to +amp, centered at 100px
                    // And the probe value is a DC value
                    const maxWaveAmp = amp + Math.abs(offset); // Max possible amplitude on display
                    const yPos = 100 - (p.val / (maxWaveAmp || 1)) * 90; // Scale to 90px range above/below center

                    ctx.strokeStyle = p.color; ctx.setLineDash([5, 3]); ctx.lineWidth = 1;
                    ctx.beginPath(); ctx.moveTo(0, yPos); ctx.lineTo(W, yPos); ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.fillStyle = p.color; ctx.font = 'bold 9px JetBrains Mono, monospace';
                    ctx.fillText(`PROBE: ${p.name} (${p.val} ${p.unit})`, 10, yPos - 5);
                });
            }
            updateWaveLabel();
        }
        setTimeout(drawWave, 200);
        window.addEventListener('resize', drawWave);

        // ── BOM ───────────────────────────────────────────────────────────────────
        async function runBOM() {
            const input = document.getElementById('bom-input');
            const prompt = input.value.trim(); if (!prompt) return;
            appendMsg('bom-chat', 'user', prompt);
            S.bom.history.push({ role: 'user', content: prompt });
            input.value = ''; setLoading('bom', true); showErr('bom', '');
            try {
                const res = await fetchWithRetry('/api/bom', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history: S.bom.history.slice(-6) })
                });
                const data = await res.json(); if (data.error) throw new Error(data.error);
                S.bom.lastBom = data.bom; pdfData.bom = data.bom;
                renderBOM(data.bom);
                const sum = `${data.bom.items?.length || 0} items · $${(data.bom.total_cost_usd || 0).toFixed(2)} total`;
                appendMsg('bom-chat', 'assistant', sum);
                S.bom.history.push({ role: 'assistant', content: sum });
            } catch (e) { showErr('bom', e.message); }
            finally { setLoading('bom', false); }
        }
        document.getElementById('bom-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runBOM(); } });

        function renderBOM(bom) {
            document.getElementById('bom-ph').style.display = 'none';
            document.getElementById('bom-dl').style.display = 'inline-flex';
            const items = bom.items || [];
            const rows = items.map(it => `<tr>
    <td><strong>${it.ref || ''}</strong></td>
    <td>${it.description || ''}</td>
    <td><code>${it.value || ''}</code></td>
    <td style="text-align:center">${it.quantity || 1}</td>
    <td>$${(it.unit_cost || 0).toFixed(2)}</td>
    <td><strong>$${(it.total_cost || 0).toFixed(2)}</strong></td>
    <td><a href="${it.supplier_url || '#'}" target="_blank">${it.supplier || ''}</a></td>
    <td style="font-size:.72rem;color:var(--text-dim)">${it.notes || ''}</td></tr>`).join('');
            document.getElementById('bom-out').innerHTML = `
    <table class="bom-table">
      <thead><tr><th>Ref</th><th>Description</th><th>Value</th><th>Qty</th><th>Unit$</th><th>Total</th><th>Supplier</th><th>Notes</th></tr></thead>
      <tbody>${rows}
        <tr><td colspan="5" style="text-align:right;font-weight:700">TOTAL</td>
          <td><strong style="color:var(--accent2)">$${(bom.total_cost_usd || 0).toFixed(2)}</strong></td><td colspan="2"></td></tr>
      </tbody></table>
    <div class="bom-meta">
      ${bom.difficulty ? `<span>Difficulty: <strong>${bom.difficulty}</strong></span>` : ''}
      ${bom.estimated_build_time ? `<span>Build time: <strong>${bom.estimated_build_time}</strong></span>` : ''}
      ${bom.tools_needed?.length ? `<span>Tools: <strong>${bom.tools_needed.join(', ')}</strong></span>` : ''}
    </div>`;
            document.getElementById('bom-out').style.display = 'block';

            setTimeout(enhanceBOMWithPriceLinks, 100);
        }

        // ── GENERIC STREAMING CHAT ────────────────────────────────────────────────
        async function runChat(endpoint, prefix, outputId, placeholderId) {
            const input = document.getElementById(prefix + '-input');
            const prompt = input.value.trim(); if (!prompt) return;
            appendMsg(prefix + '-chat', 'user', prompt);
            S[prefix].history.push({ role: 'user', content: prompt });
            input.value = ''; setLoading(prefix, true); showErr(prefix, '');
            const outEl = document.getElementById(outputId);
            const phEl = document.getElementById(placeholderId);
            if (phEl) phEl.style.display = 'none';
            outEl.style.display = 'block';
            outEl.innerHTML = '<span class="stream-cursor">▋</span>';

            // Try streaming endpoint first, fall back to regular
            const streamUrl = '/api/' + endpoint + '/stream';
            let fullText = '';
            try {
                const res = await fetch(streamUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, history: S[prefix].history.slice(-10) })
                });
                if (!res.ok || !res.body) throw new Error('no stream');
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buf = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buf += decoder.decode(value, { stream: true });
                    const parts = buf.split('\n\n');
                    buf = parts.pop();
                    for (const part of parts) {
                        if (!part.startsWith('data: ')) continue;
                        const raw = part.slice(6).trim();
                        if (raw === '[DONE]') break;
                        try {
                            const chunk = JSON.parse(raw);
                            if (chunk.content) {
                                fullText += chunk.content;
                                outEl.innerHTML = marked.parse(fullText) + '<span class="stream-cursor">▋</span>';
                                outEl.scrollTop = outEl.scrollHeight;
                            }
                        } catch { }
                    }
                }
                outEl.innerHTML = marked.parse(fullText);
            } catch (streamErr) {
                // Fall back to regular endpoint
                try {
                    const res2 = await fetchWithRetry('/api/' + endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, history: S[prefix].history.slice(-10) })
                    });
                    const data = await res2.json();
                    if (data.error) throw new Error(data.error);
                    fullText = data.result;
                    outEl.innerHTML = marked.parse(fullText);
                } catch (e) { showErr(prefix, e.message); outEl.innerHTML = ''; return; }
            } finally { setLoading(prefix, false); }

            S[prefix].history.push({ role: 'assistant', content: fullText });
            appendMsg(prefix + '-chat', 'assistant', fullText.substring(0, 160) + (fullText.length > 160 ? '...' : ''));
            if (prefix === 'ard') {
                S.ard.lastCode = fullText; pdfData.arduino_code = fullText;
                document.getElementById('ard-dl').style.display = 'inline-flex'; document.getElementById('ard-copy').style.display = 'inline-flex';
                broadcastUpdate('arduino', fullText);
            }
            updateTabBadge(prefix, true);
        }
        ['comp', 'debug', 'ard', 'learn'].forEach(p => {
            const el = document.getElementById(p + '-input'); if (!el) return;
            el.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const ep = { comp: 'components', debug: 'debug', ard: 'arduino', learn: 'learn' }[p];
                    const out = { comp: 'comp-out', debug: 'debug-out', ard: 'ard-out', learn: 'learn-out' }[p];
                    const ph = { comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph' }[p];
                    runChat(ep, p, out, ph);
                }
            });
        });

        // ── QUIZ ──────────────────────────────────────────────────────────────────
        const QUIZ_BANK = {
            beginner: [
                {
                    q: "What is the purpose of a resistor in an LED circuit?",
                    opts: ["Increase brightness", "Limit current to prevent LED burnout", "Store electrical charge", "Reverse current direction"],
                    ans: 1, topic: 'analog', exp: "LEDs have a very low forward resistance. Without a current-limiting resistor, too much current flows and the LED burns out. Use <strong>Ohm's Law: R = (Vs - Vf) / If</strong> to calculate the right value."
                },
                { q: "What is Ohm's Law?", opts: ["V = I × R", "I = V × R", "R = V × I", "P = V × I"], ans: 0, topic: 'analog', exp: "<strong>V = I × R</strong> (Voltage = Current × Resistance) is the most fundamental law in electronics. It defines the relationship between these three quantities in any resistive circuit." },
                {
                    q: "What is the unit of electrical resistance?",
                    opts: ["Ampere", "Volt", "Ohm (Ω)", "Watt"],
                    ans: 2, topic: 'analog', exp: "Resistance is measured in <strong>Ohms (Ω)</strong>, named after Georg Ohm. 1 Ω means 1 volt produces 1 ampere of current."
                },
                { q: "In a series circuit, how does current behave?", opts: ["It splits between components", "It is the same through all components", "It increases at each component", "It decreases at each component"], ans: 1, topic: 'analog', exp: "In a <strong>series circuit</strong>, current is the same everywhere — there's only one path for current to flow. Voltage, however, splits across each component." },
                { q: "What component stores electrical charge?", opts: ["Resistor", "Inductor", "Capacitor", "Diode"], ans: 2, topic: 'analog', exp: "A <strong>capacitor</strong> stores electrical energy as an electric field between two plates. The amount stored is Q = C × V, where C is capacitance in Farads." },
                { q: "What does an LED stand for?", opts: ["Light Emitting Diode", "Low Energy Device", "Lateral Electronic Driver", "Light Enhancing Detector"], ans: 0, topic: 'analog', exp: "<strong>Light Emitting Diode</strong> — a semiconductor device that emits light when current flows in the forward direction." },
                { q: "What is the function of a diode?", opts: ["Amplify signals", "Allow current to flow in only one direction", "Store energy", "Measure voltage"], ans: 1, topic: 'analog', exp: "A <strong>diode</strong> is a one-way valve for electric current. It allows current to flow from anode to cathode and blocks it in reverse." },
                { q: "What does 'ground' (GND) mean in a circuit?", opts: ["The Earth itself", "A dangerous connection", "The common reference point at 0V", "An insulated wire"], ans: 2, topic: 'analog', exp: "<strong>Ground (GND)</strong> is the common reference point in a circuit, defined as 0 volts." },
                { q: "What happens to total resistance when you add resistors in parallel?", opts: ["It increases", "It stays the same", "It decreases", "It doubles"], ans: 2, topic: 'analog', exp: "In <strong>parallel</strong>, total resistance <em>decreases</em>: 1/Rt = 1/R1 + 1/R2." },
                { q: "What is the purpose of a fuse in a circuit?", opts: ["Increase voltage", "Protect by breaking the circuit on overcurrent", "Store energy", "Amplify signals"], ans: 1, topic: 'analog', exp: "A <strong>fuse</strong> is a safety device that melts if too much current flows, protecting components." },
                { q: "What is the difference between AC and DC?", opts: ["AC is faster than DC", "DC changes direction, AC stays constant", "AC changes direction periodically, DC flows one way", "They are the same thing"], ans: 2, topic: 'analog', exp: "<strong>DC</strong> flows in one direction; <strong>AC</strong> periodically reverses direction." },
                { q: "What is a breadboard used for?", opts: ["Cutting bread", "Permanent circuit mounting", "Temporary prototyping without soldering", "Measuring voltage"], ans: 2, topic: 'analog', exp: "A <strong>breadboard</strong> allows you to build temporary circuits without soldering." },
            ],
            intermediate: [
                { q: "A 9V battery powers an LED (Vf=2V) with a 220Ω resistor. What is the current?", opts: ["9mA", "31.8mA", "40.9mA", "22mA"], ans: 1, topic: 'analog', exp: "I = (9 - 2) / 220 ≈ 31.8mA." },
                { q: "What is the function of a bypass capacitor?", opts: ["Amplify signal", "Filter AC noise from DC power supply", "Store energy for motors", "Block DC current"], ans: 1, topic: 'analog', exp: "Decoupling caps filter high-frequency noise." },
                { q: "In an NPN transistor, what controls the collector current?", opts: ["Emitter voltage", "Base current", "Collector voltage", "Supply voltage"], ans: 1, topic: 'analog', exp: "Small base current controls large collector current." },
                { q: "What is the voltage divider output with 10kΩ and 4.7kΩ from 5V?", opts: ["3.19V", "1.81V", "2.5V", "1.5V"], ans: 1, topic: 'analog', exp: "Vout = 5 × 4.7 / (10 + 4.7) ≈ 1.6V." },
                { q: "What does PWM stand for and what is it used for?", opts: ["Pulse Width Modulation", "Power Wave Management", "Partial Wave Modulation", "Phase Width Measurement"], ans: 0, topic: 'digital', exp: "PWM controls average power by pulsing." },
                { q: "What does Kirchhoff's Current Law (KCL) state?", opts: ["Total voltage is zero", "Current entering node equals current leaving", "Power is conserved", "Resistance increases"], ans: 1, topic: 'analog', exp: "Current sums to zero at a node." },
                { q: "What is the total capacitance of two 100µF capacitors in parallel?", opts: ["50µF", "100µF", "200µF", "10µF"], ans: 2, topic: 'analog', exp: "Parallel capacitance adds: 100+100=200." },
                { q: "What is an op-amp primarily used for?", opts: ["Power regulation", "Signal amplification", "Energy storage", "Current limiting"], ans: 1, topic: 'analog', exp: "Op-amps amplify and process analog signals." },
                { q: "A 555 timer in astable mode produces?", opts: ["DC voltage", "Single pulse", "Continuous square wave", "Sine wave"], ans: 2, topic: 'analog', exp: "Astable 555 produces square waves." },
                { q: "If you connect 3 LEDs in series (Vf=2V each) to 5V?", opts: ["They light", "Only 2 light", "None light", "They blink"], ans: 2, topic: 'analog', exp: "Needs 6V minimum; none will light." },
                { q: "What does a pull-up resistor do?", opts: ["Increases speed", "Holds pin HIGH when idle", "Reduces power", "Amplifies signal"], ans: 1, topic: 'digital', exp: "Holds pin HIGH to prevent floating." },
            ],
            advanced: [
                { q: "Why does a 7805 regulator get hot with 12V in, 500mA out?", opts: ["Faulty", "P=(12-5)×0.5=3.5W heat", "Capacitors", "Load resist"], ans: 1, topic: 'analog', exp: "Linear regulators drop excess voltage as heat." },
                { q: "-3dB frequency of 10kΩ and 10nF filter?", opts: ["15.9 kHz", "1.59 kHz", "159 Hz", "15.9 Hz"], ans: 1, topic: 'analog', exp: "f = 1/(2πRC) ≈ 1.59 kHz." },
                { q: "MOSFET gate needs 10V, Arduino is 5V. Solution?", opts: ["Logic-level MOSFET", "Pull-up", "Increase voltage", "Diode bridge"], ans: 0, topic: 'mcu', exp: "Logic-level FETs (IRLZ44N) switch at 5V." },
                { q: "What is Thévenin's theorem used for?", opts: ["Power loss", "Simplifying complex circuits", "Measuring C", "PCB design"], ans: 1, topic: 'analog', exp: "Reduces circuit to Vth and Rth." },
                { q: "Role of inductor in SMPS?", opts: ["Filter", "Store/release energy", "Amplify", "Protect"], ans: 1, topic: 'analog', exp: "Inductors smooth voltage by energy storage." },
                { q: "Gain of inverting op-amp Rf=100k, Rin=10k?", opts: ["+10", "-10", "+100", "-100"], ans: 1, topic: 'analog', exp: "Av = -Rf/Rin = -10." },
                { q: "Why flyback diode across relay coil?", opts: ["Indicator", "Protect transistor from spikes", "Speed", "Power"], ans: 1, topic: 'analog', exp: "Clamps inductive voltage spikes." },
                { q: "Resonant frequency of 10mH and 100nF?", opts: ["503 Hz", "5.03 kHz", "50.3 kHz", "503 kHz"], ans: 1, topic: 'analog', exp: "f = 1/(2π√(LC)) ≈ 5.03 kHz." },
                { q: "Advantage of differential pair?", opts: ["Power", "Common-mode rejection", "Cost", "Simple"], ans: 1, topic: 'analog', exp: "Rejects noise common to both inputs." },
            ],
        };

        function setLevel(level, btn) {
            quiz.level = level;
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function loadQuiz() {
            const bank = QUIZ_BANK[quiz.level];
            const q = bank[Math.floor(Math.random() * bank.length)];
            quiz.current = q;
            const area = document.getElementById('quiz-area');
            area.innerHTML = `
    <div class="quiz-card">
      <div class="quiz-q">${q.q}</div>
      <div class="quiz-options">
        ${q.opts.map((o, i) => `<button class="quiz-opt" onclick="answerQuiz(${i})">${String.fromCharCode(65 + i)}. ${o}</button>`).join('')}
      </div>
    </div>`;
            // Progress bar
            const pct = Math.min(100, quiz.total * 10);
            document.getElementById('quiz-prog').style.width = pct + '%';
        }

        function answerQuiz(idx) {
            if (!quiz.current) return;
            const q = quiz.current;
            quiz.total++;
            const opts = document.querySelectorAll('.quiz-opt');
            opts.forEach(o => o.disabled = true);
            if (idx === q.ans) {
                opts[idx].classList.add('correct');
                quiz.score++; quiz.streak++;
            } else {
                opts[idx].classList.add('wrong');
                opts[q.ans].classList.add('correct');
                quiz.streak = 0;
            }
            // Explanation
            const card = document.querySelector('.quiz-card');
            const exp = document.createElement('div');
            exp.className = 'quiz-explain';
            exp.innerHTML = (idx === q.ans ? '✅ <strong>Correct!</strong> ' : '❌ <strong>Incorrect.</strong> ') + q.exp;
            card.appendChild(exp);
            // Update stats + persist
            quiz.history.unshift({ q: q.q.substring(0, 40) + '...', correct: idx === q.ans });
            updateQuizUI();
            saveQuiz();
        }

        // ── SAVE/LOAD ─────────────────────────────────────────────────────────────
        async function saveCircuit() {
            const name = document.getElementById('project-name').value.trim() || 'Untitled Circuit';
            const is_public = confirm("🌐 Make this circuit PUBLIC in the Community Gallery?");
            const payload = {
                device_id: deviceId,
                name, is_public,
                schematic_image: S.sch.lastImage,
                schematic_description: document.getElementById('sch-desc').textContent || '',
                components: S.sch.lastSchema?.components || [],
                simulation: S.sim.lastSim, arduino_code: S.ard.lastCode, bom: S.bom.lastBom
            };
            try {
                const res = await fetch('/api/save-circuit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                currentCid = data.id;
                const btn = document.querySelector('.btn-sm');
                const orig = btn.textContent; btn.textContent = '✅ Cloud Saved!';
                setTimeout(() => btn.textContent = orig, 2000);
                if (is_public) loadGallery();
                broadcastUpdate('rename', name);
            } catch (e) { alert('Save failed: ' + e.message); }
        }

        // ── GALLERY LOGIC ─────────────────────────────────────────────────────────
        async function loadGallery() {
            const el = document.getElementById('gallery-list');
            try {
                const res = await fetch('/api/gallery');
                const data = await res.json();
                if (!data.gallery || !data.gallery.length) {
                    el.innerHTML = '<div class="placeholder"><p>No public circuits yet. Be the first to share!</p></div>';
                    return;
                }
                el.innerHTML = data.gallery.map(c => `
          <div class="gallery-card">
            <img class="gallery-img" src="data:image/png;base64,${c.image}" onerror="this.src='https://via.placeholder.com/300x160/0a0f1c/00c8f0?text=Schematic'"/>
            <div class="gallery-info">
              <div class="gallery-title">⚡ ${c.name}</div>
              <div class="gallery-desc">${c.description || 'No description provided.'}</div>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:.6rem;color:var(--text-dim)">${c.saved_at}</span>
                <button class="btn btn-sm btn-primary" onclick="loadFromGallery('${c.id}')">🍴 Fork</button>
              </div>
            </div>
          </div>`).join('');
            } catch (e) { el.innerHTML = '<p>Failed to load gallery.</p>'; }
        }

        async function loadFromGallery(id) {
            try {
                const res = await fetch(`/api/load-circuit/${id}`);
                const data = await res.json();
                S.sch.lastSchema = data.components ? { components: data.components, description: data.schematic_description, title: data.name } : null;
                S.sch.lastImage = data.schematic_image;
                document.getElementById('project-name').value = data.name + " (forked)";
                showToast('🍴 Circuit forked to your workspace!');
                switchTab('schematic', document.querySelectorAll('.tab')[1]);
                if (data.schematic_image) {
                    document.getElementById('sch-img').src = 'data:image/png;base64,' + data.schematic_image;
                    document.getElementById('sch-img').style.display = 'block';
                    document.getElementById('sch-ph').style.display = 'none';
                }
            } catch (e) { showToast('❌ Failed to fork circuit.'); }
        }

        function toggleLabMode() {
            document.body.classList.toggle('lab-mode');
            const active = document.body.classList.contains('lab-mode');
            const btn = document.querySelector('.btn-lab');
            btn.textContent = active ? '🏠 NORMAL MODE' : '🔬 LAB MODE';
            showToast(active ? '🔬 Lab Mode Enabled: High-visibility for the workbench' : '🏠 Returning to Normal Mode');
        }

        async function loadSavedList() {
            try {
                const res = await fetch('/api/list-circuits?device_id=' + deviceId);
                const data = await res.json();
                const el = document.getElementById('saved-list');
                if (!data.circuits.length) {
                    el.innerHTML = '<div class="placeholder"><div class="placeholder-icon">🗂️</div><p>No circuits saved yet</p></div>'; return;
                }
                el.innerHTML = data.circuits.map(c => `
      <div class="saved-item">
        <div class="saved-item-info">
          <div class="saved-item-name">⚡ ${c.name}</div>
          <div class="saved-item-time">${c.saved_at}</div>
        <div style="display:flex;gap:6px;">
            <button class="btn btn-sm" onclick="copyShareLink('${c.id}')">🔗 Share</button>
            <button class="btn btn-sm" onclick="loadCircuit('${c.id}')">Load</button>
        </div>
    </div>`).join('');
            } catch (e) { console.error(e); }
        }

        function copyShareLink(id) {
            const url = window.location.origin + window.location.pathname + '?circuit=' + id;
            navigator.clipboard.writeText(url).then(() => {
                showToast('🔗 Link copied to clipboard!');
            }).catch(() => {
                showToast('⚠ Failed to copy link');
            });
        }

        async function loadCircuit(id) {
            try {
                const res = await fetch(`/api/load-circuit/${id}`);
                const data = await res.json(); if (data.error) { alert(data.error); return; }
                document.getElementById('project-name').value = data.name || '';
                document.getElementById('loaded-ph').style.display = 'none';
                document.getElementById('loaded-out').style.display = 'block';
                const img = document.getElementById('loaded-img');
                if (data.schematic_image) { img.src = 'data:image/png;base64,' + data.schematic_image; img.style.display = 'block'; }
                document.getElementById('loaded-desc').textContent = data.schematic_description || '';
                if (data.schematic_image) { S.sch.lastImage = data.schematic_image; pdfData.schematic_image = data.schematic_image; }
                if (data.simulation) { S.sim.lastSim = data.simulation; pdfData.simulation = data.simulation; }
                if (data.arduino_code) { S.ard.lastCode = data.arduino_code; pdfData.arduino_code = data.arduino_code; }
                if (data.bom) { S.bom.lastBom = data.bom; pdfData.bom = data.bom; }
                pdfData.components = data.components || [];
            } catch (e) { alert('Load failed: ' + e.message); }
        }

        // ── DOWNLOADS ─────────────────────────────────────────────────────────────
        function dlSchematic() { if (!S.sch.lastImage) return; const a = document.createElement('a'); a.href = 'data:image/png;base64,' + S.sch.lastImage; a.download = 'schematic.png'; a.click(); }
        function exportNetlist() {
            if (!S.sch.lastSchema) return;
            const netlist = {
                project: document.getElementById('project-name').value || 'Untitled',
                version: '1.0',
                generated_by: 'Circuit Copilot',
                components: S.sch.lastSchema.components || [],
                connections: S.sch.lastSchema.connections || []
            };
            const blob = new Blob([JSON.stringify(netlist, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = (netlist.project.replace(/\s+/g, '_') || 'circuit') + '_netlist.json'; a.click();
        }
        function dlArduino() {
            const c = S.ard.lastCode; if (!c) return;
            const m = c.match(/```(?:cpp|arduino|ino)?\n([\s\S]*?)```/); const blob = new Blob([m ? m[1] : c], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sketch.ino'; a.click();
        }
        function dlBOM() { if (!S.bom.lastBom) return; const items = S.bom.lastBom.items || []; const hdr = 'Ref,Description,Value,Qty,Unit Cost,Total,Supplier,Part#,Notes\n'; const rows = items.map(i => [i.ref, i.description, i.value, i.quantity, i.unit_cost, i.total_cost, i.supplier, i.part_number || '', i.notes || ''].map(v => `"${v}"`).join(',')).join('\n'); const blob = new Blob([hdr + rows], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bom.csv'; a.click(); }

        // ── PDF ────────────────────────────────────────────────────────────────────
        async function exportPDF() {
            if (!pdfData.schematic_image && !pdfData.simulation && !pdfData.arduino_code && !pdfData.bom) { alert('Generate at least one section first!'); return; }
            pdfData.project_name = document.getElementById('project-name').value || 'Circuit Copilot Report';
            try {
                const res = await fetch('/api/export-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pdfData) });
                if (!res.ok) throw new Error('PDF failed');
                const blob = await res.blob();
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = (pdfData.project_name.replace(/\s+/g, '_') || 'report') + '.pdf'; a.click();
            } catch (e) { alert('PDF error: ' + e.message); }
        }

        // ── TEMPLATES ─────────────────────────────────────────────────────────────
        const TEMPLATES = [
            {
                name: 'Basic LED Circuit', icon: '💡', diff: 'Beginner', color: 'accent2',
                desc: 'Simple LED with current-limiting resistor powered by 9V battery.',
                prompt: 'LED circuit with a 220 ohm resistor and a 9V battery'
            },
            {
                name: 'Voltage Divider', icon: '📐', diff: 'Beginner', color: 'accent2',
                desc: 'Two resistors splitting voltage — fundamental building block.',
                prompt: 'Voltage divider with 10kΩ and 4.7kΩ resistors from 5V supply'
            },
            {
                name: '555 Timer LED Blinker', icon: '⏱️', diff: 'Intermediate', color: 'accent',
                desc: 'Classic astable 555 timer circuit that blinks an LED at ~1Hz.',
                prompt: '555 timer in astable mode blinking an LED at 1Hz with 9V battery'
            },
            {
                name: 'Arduino Temp Sensor', icon: '🌡️', diff: 'Intermediate', color: 'accent',
                desc: 'DHT11 temperature & humidity sensor connected to Arduino Uno.',
                prompt: 'Arduino Uno with DHT11 temperature sensor, 10kΩ pull-up resistor, and 16x2 LCD display'
            },
            {
                name: 'H-Bridge Motor Driver', icon: '⚙️', diff: 'Advanced', color: 'accent3',
                desc: 'Bidirectional DC motor control using 4 transistors or L298N module.',
                prompt: 'H-bridge motor driver using 4 NPN transistors for bidirectional DC motor control with 12V supply'
            },
            {
                name: 'RC Low-Pass Filter', icon: '〰️', diff: 'Intermediate', color: 'accent',
                desc: 'Passes low frequencies, attenuates high — audio and signal filtering.',
                prompt: 'RC low-pass filter with 10kΩ resistor and 100nF capacitor'
            },
            {
                name: 'NPN Transistor Switch', icon: '🔀', diff: 'Beginner', color: 'accent2',
                desc: 'Using a transistor to switch a high-power load from a microcontroller.',
                prompt: 'NPN transistor BC547 switching a 12V relay with 1kΩ base resistor from Arduino 5V pin'
            },
            {
                name: 'LDR Light Sensor', icon: '☀️', diff: 'Beginner', color: 'accent2',
                desc: 'Light-dependent resistor controlling an LED brightness.',
                prompt: 'LDR light sensor voltage divider with 10kΩ resistor, connected to Arduino analog pin A0, controlling LED on pin 9'
            }
        ];

        function renderTemplates() {
            const grid = document.getElementById('tpl-grid');
            grid.innerHTML = TEMPLATES.map((t, i) => `
    <div class="tpl-card">
      <h3>${t.icon} ${t.name}</h3>
      <div class="tpl-meta"><span class="badge badge-${t.diff === 'Beginner' ? 'ok' : t.diff === 'Intermediate' ? 'info' : 'warn'}">${t.diff}</span></div>
      <p>${t.desc}</p>
      <button class="btn btn-primary" style="width:100%" onclick="loadTemplate(${i})">⚡ Load Template</button>
    </div>`).join('');
        }
        function loadTemplate(idx) {
            const t = TEMPLATES[idx];
            document.getElementById('sch-input').value = t.prompt;
            // Switch to schematic tab
            const tabs = document.querySelectorAll('.tab');
            switchTab('schematic', tabs[0]);
            // Flash the input
            const inp = document.getElementById('sch-input');
            inp.style.borderColor = 'var(--accent2)';
            setTimeout(() => inp.style.borderColor = '', 1500);
        }
        setTimeout(renderTemplates, 50);

        // ── COMPONENT REFERENCE TOGGLE ────────────────────────────────────────────
        function toggleRef() {
            const el = document.getElementById('comp-ref');
            const btn = document.getElementById('ref-toggle-btn');
            if (el.style.display === 'none') { el.style.display = 'block'; btn.textContent = '▼ Component Reference'; }
            else { el.style.display = 'none'; btn.textContent = '▶ Component Reference'; }
        }

        // ── SHORTCUTS MODAL ───────────────────────────────────────────────────────
        function toggleShortcuts() {
            const m = document.getElementById('shortcuts-modal');
            m.classList.toggle('visible');
        }

        // ── KEYBOARD SHORTCUTS ────────────────────────────────────────────────────
        document.getElementById('project-name').addEventListener('input', (e) => {
            broadcastUpdate('rename', e.target.value);
        });
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input/textarea
            const active = document.activeElement;
            const isTyping = active && (active.tagName === 'TEXTAREA' || active.tagName === 'INPUT');

            // Ctrl+Enter to submit current active tab input
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) { const btn = activeTab.querySelector('.btn-primary'); if (btn && !btn.disabled) btn.click(); }
                return;
            }
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCircuit(); return; }
            // Ctrl+E to export PDF
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportPDF(); return; }
            // Ctrl+D to toggle theme
            if (e.ctrlKey && e.key === 'd') { e.preventDefault(); toggleTheme(); return; }

            if (isTyping) return; // Below shortcuts only when not typing

            // ? to show shortcuts
            if (e.key === '?') { e.preventDefault(); toggleShortcuts(); return; }
            // Escape to close modal
            if (e.key === 'Escape') { const m = document.getElementById('shortcuts-modal'); if (m.classList.contains('visible')) { toggleShortcuts(); return; } }

            // Number keys 1-0 for tab switching
            const tabMap = {
                '1': 'schematic', '2': 'simulate', '3': 'waveform', '4': 'bom', '5': 'components',
                '6': 'debug', '7': 'arduino', '8': 'learn', '9': 'quiz', '0': 'templates'
            };
            if (tabMap[e.key]) {
                e.preventDefault();
                const tabs = document.querySelectorAll('.tab');
                const idx = Object.keys(tabMap).indexOf(e.key);
                if (tabs[idx]) switchTab(tabMap[e.key], tabs[idx]);
            }
        });

        // ── CIRCUIT SHARING ──────────────────────────────────────────────────────
        function shareCircuit() {
            if (!S.sch.lastSchema) { showToast('⚠ Generate a schematic first!'); return; }
            const data = JSON.stringify(S.sch.lastSchema);
            const encoded = btoa(unescape(encodeURIComponent(data)));
            const url = window.location.origin + window.location.pathname + '#circuit=' + encoded;
            navigator.clipboard.writeText(url).then(() => {
                showToast('🔗 Share link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this share link:', url);
            });
        }

        // Auto-load shared circuit from URL hash
        function loadSharedCircuit() {
            const hash = window.location.hash;
            if (!hash.startsWith('#circuit=')) return;
            try {
                const encoded = hash.slice('#circuit='.length);
                const json = decodeURIComponent(escape(atob(encoded)));
                const schema = JSON.parse(json);
                S.sch.lastSchema = schema;
                // Populate the input with the circuit title and trigger generation
                const input = document.getElementById('sch-input');
                input.value = schema.title || 'Shared circuit';
                showToast('📋 Shared circuit loaded! Click ⚡ to generate.');
                // Switch to schematic tab
                const tabs = document.querySelectorAll('.tab');
                if (tabs[0]) switchTab('schematic', tabs[0]);
            } catch (e) {
                console.error('Failed to load shared circuit:', e);
            }
        }
        setTimeout(loadSharedCircuit, 200);

        // ── SCREENSHOT / SOCIAL SHARE ────────────────────────────────────────────
        function screenshotCircuit() {
            const img = document.getElementById('sch-img');
            if (!img || !img.src || img.style.display === 'none') {
                showToast('⚠ Generate a schematic first!'); return;
            }
            const title = S.sch.lastSchema?.title || 'Circuit Schematic';
            const desc = S.sch.lastSchema?.description || '';

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = 560;

            // Background
            ctx.fillStyle = '#0a0f1a';
            ctx.fillRect(0, 0, 800, 560);

            // Top bar accent
            const topGrad = ctx.createLinearGradient(0, 0, 800, 0);
            topGrad.addColorStop(0, '#00c8f0');
            topGrad.addColorStop(1, '#00f090');
            ctx.fillStyle = topGrad;
            ctx.fillRect(0, 0, 800, 4);

            // Title
            ctx.fillStyle = '#e8f0ff';
            ctx.font = 'bold 22px Syne, sans-serif';
            ctx.fillText(title, 30, 42);

            // Description
            if (desc) {
                ctx.fillStyle = '#6a8aaa';
                ctx.font = '13px Syne, sans-serif';
                const words = desc.split(' ');
                let line = '', y = 66;
                for (const w of words) {
                    const test = line + w + ' ';
                    if (ctx.measureText(test).width > 740) {
                        ctx.fillText(line, 30, y); y += 18; line = w + ' ';
                    } else { line = test; }
                }
                ctx.fillText(line, 30, y);
            }

            // Schematic image
            const sImg = new Image();
            sImg.crossOrigin = 'anonymous';
            sImg.onload = () => {
                const imgY = 90;
                const maxW = 740, maxH = 400;
                let w = sImg.width, h = sImg.height;
                const scale = Math.min(maxW / w, maxH / h);
                w *= scale; h *= scale;
                const x = (800 - w) / 2;
                ctx.drawImage(sImg, x, imgY, w, h);

                // Bottom branding bar
                ctx.fillStyle = '#0d1220';
                ctx.fillRect(0, 520, 800, 40);
                ctx.fillStyle = '#00c8f0';
                ctx.font = 'bold 13px JetBrains Mono, monospace';
                ctx.fillText('⚡ CIRCUIT COPILOT', 30, 545);
                ctx.fillStyle = '#4a6a8a';
                ctx.font = '11px JetBrains Mono, monospace';
                ctx.textAlign = 'right';
                ctx.fillText('AI-Powered Circuit Design', 770, 545);
                ctx.textAlign = 'left';

                // Download
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (title.replace(/\s+/g, '_') || 'circuit') + '_share.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('📸 Screenshot saved!');
                });
            };
            sImg.src = img.src;
        }

        // ── FEATURE 2: CHAT HISTORY PERSISTENCE ──────────────────────────────────
        function saveChatHistory(chatId) {
            const chat = document.getElementById(chatId);
            if (!chat) return;
            const msgs = Array.from(chat.querySelectorAll('.msg')).slice(-20).map(m => ({
                role: m.classList.contains('user') ? 'user' : 'assistant',
                html: m.innerHTML
            }));
            localStorage.setItem('cc_chat_v2_' + chatId, JSON.stringify(msgs));
        }
        function restoreChatHistory(chatId) {
            const saved = JSON.parse(localStorage.getItem('cc_chat_v2_' + chatId) || '[]');
            const chat = document.getElementById(chatId);
            if (!chat || !saved.length) return;
            saved.forEach(m => {
                const d = document.createElement('div');
                d.className = 'msg ' + m.role;
                d.innerHTML = m.html;
                chat.appendChild(d);
            });
            chat.scrollTop = chat.scrollHeight;
        }
        function clearChatHistory(chatId) {
            const chat = document.getElementById(chatId);
            if (chat) chat.innerHTML = '';
            localStorage.removeItem('cc_chat_v2_' + chatId);
            showToast('🗑 Chat cleared');
        }
        // Patch appendMsg to auto-save
        const _origAppendMsg = appendMsg;
        appendMsg = function (chatId, role, content) {
            _origAppendMsg(chatId, role, content);
            saveChatHistory(chatId);
        };
        // Restore all chat histories on load
        ['sch-chat', 'sim-chat', 'bom-chat', 'comp-chat', 'debug-chat', 'ard-chat', 'learn-chat'].forEach(id => restoreChatHistory(id));

        // ── FEATURE 3: CIRCUIT HISTORY (localStorage) ──────────────────────────────
        function getCircuitHistory() {
            return JSON.parse(localStorage.getItem('cc_circuit_history') || '[]');
        }
        function addToCircuitHistory(title, schema) {
            const history = getCircuitHistory();
            history.unshift({
                id: Date.now(),
                title: title || 'Untitled',
                schema: schema,
                time: new Date().toLocaleString()
            });
            // Keep last 20
            localStorage.setItem('cc_circuit_history', JSON.stringify(history.slice(0, 20)));
            renderCircuitHistory();
        }
        function renderCircuitHistory() {
            const el = document.getElementById('circuit-history');
            if (!el) return;
            const history = getCircuitHistory();
            if (!history.length) {
                el.innerHTML = '<p style="font-size:.72rem;color:var(--text-dim);text-align:center;padding:8px;">No circuit history yet</p>';
                return;
            }
            el.innerHTML = history.map(h => `
        <div class="history-item" onclick="loadFromHistory(${h.id})">
          <div class="history-item-info">
            <div class="history-item-name">⚡ ${h.title}</div>
            <div class="history-item-time">${h.time}</div>
          </div>
          <button class="history-del" onclick="event.stopPropagation();deleteFromHistory(${h.id})" title="Delete">✕</button>
        </div>`).join('');
        }
        function loadFromHistory(id) {
            const h = getCircuitHistory().find(c => c.id === id);
            if (!h) return;
            S.sch.lastSchema = h.schema;
            const input = document.getElementById('sch-input');
            input.value = h.schema.title || h.title;
            showToast('📋 Loaded: ' + h.title);
            const tabs = document.querySelectorAll('.tab');
            if (tabs[0]) switchTab('schematic', tabs[0]);
        }
        function deleteFromHistory(id) {
            const history = getCircuitHistory().filter(c => c.id !== id);
            localStorage.setItem('cc_circuit_history', JSON.stringify(history));
            renderCircuitHistory();
            showToast('🗑 Removed from history');
        }
        function clearCircuitHistory() {
            localStorage.removeItem('cc_circuit_history');
            renderCircuitHistory();
            showToast('🗑 History cleared');
        }
        // ── CALCULATORS ──────────────────────────────────────────────────────────
        function switchCalc(type, btn) {
            document.querySelectorAll('.calc-tab').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.calc-group').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('calc-' + type).classList.add('active');
        }
        function calcLED() {
            const vs = +document.getElementById('led-vs').value;
            const vf = +document.getElementById('led-vf').value;
            const im = +document.getElementById('led-if').value;
            const res = (vs - vf) / (im / 1000);
            document.getElementById('led-r').value = res > 0 ? Math.ceil(res) : 0;
            document.getElementById('led-result').textContent = res > 0 ? `Use ${Math.ceil(res)}Ω resistor (Nearest standard: ${getStandardRes(res)}Ω)` : 'Invalid values';
        }
        function getStandardRes(r) {
            const e24 = [1.0, 1.1, 1.2, 1.3, 1.5, 1.6, 1.8, 2.0, 2.2, 2.4, 2.7, 3.0, 3.3, 3.6, 3.9, 4.3, 4.7, 5.1, 5.6, 6.2, 6.8, 7.5, 8.2, 9.1];
            const mag = Math.pow(10, Math.floor(Math.log10(r)));
            const val = r / mag;
            let closest = e24[0];
            let diff = Math.abs(val - closest);
            for (let v of e24) {
                if (Math.abs(val - v) < diff) { diff = Math.abs(val - v); closest = v; }
            }
            return Math.round(closest * mag);
        }
        function calc555() {
            const r1 = +document.getElementById('555-r1').value;
            const r2 = +document.getElementById('555-r2').value;
            const c = +document.getElementById('555-c').value * 1e-6;
            if (!r1 || !r2 || !c) return;
            const freq = 1.44 / ((r1 + 2 * r2) * c);
            const duty = ((r1 + r2) / (r1 + 2 * r2)) * 100;
            document.getElementById('555-result').textContent = `Freq: ${freq < 1000 ? freq.toFixed(1) + ' Hz' : (freq / 1000).toFixed(2) + ' kHz'} · Duty: ${duty.toFixed(1)}%`;
        }

        // ── ARCHITECT LOGIC ──────────────────────────────────────────────────────
        let customParts = JSON.parse(localStorage.getItem('cc_custom_parts') || '[]');
        function saveCustomPart() {
            const name = document.getElementById('arc-name').value.trim();
            const type = document.getElementById('arc-type').value;
            const pins = document.getElementById('arc-pins').value.trim();
            const specs = document.getElementById('arc-specs').value.trim();
            if (!name || !pins) { showToast('⚠ Name and Pins are required!'); return; }

            const part = { id: Date.now(), name, type, pins, specs };
            customParts.unshift(part);
            localStorage.setItem('cc_custom_parts', JSON.stringify(customParts));
            renderArchitect();
            showToast('✨ Component added to library!');
            // Clear fields
            document.getElementById('arc-name').value = '';
            document.getElementById('arc-pins').value = '';
            document.getElementById('arc-specs').value = '';
        }
        function renderArchitect() {
            const list = document.getElementById('arc-list');
            if (!customParts.length) {
                list.innerHTML = '<p style="font-size:.72rem;color:var(--text-dim);text-align:center;">No custom components defined yet.</p>';
                return;
            }
            list.innerHTML = customParts.map(p => `
        <div class="audit-item audit-tip" style="margin-bottom:8px;border-left:4px solid var(--accent)">
          <div class="audit-icon">IC</div>
          <div class="audit-content">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h5>${p.name} <small style="color:var(--text-dim)">(${p.type})</small></h5>
              <button class="btn btn-sm" onclick="deletePart(${p.id})" style="padding:2px 6px;">✕</button>
            </div>
            <p><strong>Pins:</strong> ${p.pins}</p>
            <p style="font-style:italic;margin-top:4px;">${p.specs || 'No specs provided.'}</p>
          </div>
        </div>`).join('');
        }
        function deletePart(id) {
            customParts = customParts.filter(p => p.id !== id);
            localStorage.setItem('cc_custom_parts', JSON.stringify(customParts));
            renderArchitect();
        }
        setTimeout(renderArchitect, 250);

        // ── FUNCTION PATCHING (Inject Custom Parts into AI Prompt) ────────────────
        const _origRunSchematic = window.runSchematic;
        window.runSchematic = async function () {
            // Temporarily modify the global prompt or context if needed
            // Here we'll append the custom parts library to the user prompt internally
            const input = document.getElementById('sch-input');
            const originalVal = input.value;
            const persona = document.getElementById('ai-persona').value;
            const expertise = {
                analog: "Focus on signal integrity, analog filtering, and biasing.",
                embedded: "Focus on microcontroller pinouts, firmware compatibility, and decoupling.",
                power: "Focus on voltage regulation, current capacity, and thermal management."
            }[persona] || "";

            if (expertise) input.value += ` [PERSONA: ${persona.toUpperCase()} - ${expertise}]`;

            if (customParts.length) {
                const partsInfo = customParts.map(p => `[CUSTOM PART: Name: ${p.name}, Pins: ${p.pins}, Specs: ${p.specs}]`).join(' ');
                input.value += ` (You can use these custom components from my library: ${partsInfo})`;
            }

            await _origRunSchematic();

            input.value = originalVal; // Restore UI
            if (S.sch.lastSchema) {
                broadcastUpdate('schematic', {
                    schema: S.sch.lastSchema,
                    image: S.sch.lastImage,
                    desc: document.getElementById('sch-desc').textContent
                });
                document.getElementById('sch-audit').style.display = 'inline-flex';
                document.getElementById('sch-eda').style.display = 'inline-flex';
                addToCircuitHistory(S.sch.lastSchema.title || document.getElementById('sch-input').value, S.sch.lastSchema);
                S.stats.circuits++;
                saveStats();
                if (document.getElementById('tab-dashboard').classList.contains('active')) renderDashboard();
                renderBreadboard(S.sch.lastSchema);
            }
            updateTabBadge('schematic', true);
        };

        // ── BREADBOARD LOGIC ──────────────────────────────────────────────────────
        function initBreadboard() {
            const visual = document.getElementById('bb-visual');
            if (visual.innerHTML.includes('bb-row')) return; // Already init
            visual.innerHTML = '';
            // Draw rails and grid
            for (let r = 0; r < 12; r++) {
                if (r === 2 || r === 9) { // Rails
                    const rail = document.createElement('div');
                    rail.className = r === 2 ? 'bb-rail-red' : 'bb-rail-blue';
                    visual.appendChild(rail);
                    continue;
                }
                const row = document.createElement('div');
                row.className = 'bb-row';
                for (let c = 0; c < 30; c++) {
                    const hole = document.createElement('div');
                    hole.className = 'bb-hole';
                    hole.id = `bb-${r}-${c}`;
                    row.appendChild(hole);
                    if (c === 14) row.appendChild(document.createElement('div')).style.width = '20px';
                }
                visual.appendChild(row);
            }
        }

        async function renderBreadboard(schema) {
            document.getElementById('bb-instructions').innerHTML = '';
            document.getElementById('bb-loading').style.display = 'flex';
            try {
                const res = await fetch('/api/breadboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: [], schema: schema })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const bb = data.breadboard || {};
                const steps = bb.steps || [];
                const routing = bb.routing || [];

                const out = document.getElementById('bb-instructions');
                out.innerHTML = steps.map((s, i) => `
                    <div class="guide-step">
                      <span class="guide-num">#${i + 1}</span>
                      <span class="guide-txt">${s.replace(/^\d+[\.\)]\s*/, '')}</span>
                    </div>`).join('') || '<p style="color:var(--text-dim);font-size:.8rem">No steps generated.</p>';

                document.querySelectorAll('.bb-hole').forEach(h => h.classList.remove('active'));

                const getHoleParams = (coord) => {
                    if (!coord) return null;
                    coord = coord.toLowerCase();
                    // Maps exactly to our DOM grid structure
                    if (coord.includes('top_+')) return { r: 0, c: Math.floor(Math.random() * 30) };
                    if (coord.includes('top_-')) return { r: 1, c: Math.floor(Math.random() * 30) };
                    if (coord.includes('bottom_+')) return { r: 10, c: Math.floor(Math.random() * 30) };
                    if (coord.includes('bottom_-')) return { r: 11, c: Math.floor(Math.random() * 30) };

                    const rMap = { 'a': 3, 'b': 4, 'c': 5, 'd': 6, 'e': 7, 'f': 8 };
                    const rowChar = coord.charAt(0);
                    const colNum = parseInt(coord.substring(1)) - 1; // 1-based to 0-based columns
                    if (rMap[rowChar] !== undefined && colNum >= 0 && colNum < 30) {
                        return { r: rMap[rowChar], c: colNum };
                    }
                    return null;
                };

                routing.forEach(rt => {
                    const sParams = getHoleParams(rt.start);
                    const eParams = getHoleParams(rt.end);

                    if (sParams) {
                        const h1 = document.getElementById(`bb-${sParams.r}-${sParams.c}`);
                        if (h1) h1.classList.add('active');
                    }
                    if (eParams) {
                        const h2 = document.getElementById(`bb-${eParams.r}-${eParams.c}`);
                        if (h2) h2.classList.add('active');
                    }
                });

            } catch (e) {
                document.getElementById('bb-instructions').innerHTML = '<p style="color:var(--warn)">Failed to generate AI breadboard routing.</p>';
            } finally { document.getElementById('bb-loading').style.display = 'none'; }
        }

        async function runAudit(type) {
            const out = document.getElementById(type + '-audit-out');
            const data = type === 'sch' ? S.sch.lastSchema : S.sim.lastSim;
            if (!data) return;
            out.innerHTML = '<div class="loading visible"><div class="spinner"></div>Analyzing design...</div>';
            out.style.display = 'block';
            try {
                const compSummary = (data.components || []).map(c => `${c.label} ${c.type} ${c.value}`).join(', ');
                const res = await fetch('/api/debug', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: [], prompt: `Perform an AI Design Audit on this circuit.\nComponents: ${compSummary}\nConnections: ${JSON.stringify(data.connections || [])}\n\nIdentify:\n🔴 Critical errors (short circuits, missing resistors, safety issues)\n🟡 Warnings (component stress, inefficiencies)\n🟢 Tips (optimizations, better alternatives)\nBe specific with values and explain each finding.` })
                });
                const json = await res.json();
                const text = json.result || '';
                // Parse into structured audit items from markdown
                const items = [];
                text.split('\n').forEach(line => {
                    const isErr = /🔴|critical|error|danger/i.test(line);
                    const isWarn = /🟡|warning|exceed|stress/i.test(line);
                    const isTip = /🟢|tip|suggest|optim/i.test(line);
                    if ((isErr || isWarn || isTip) && line.trim().length > 10) {
                        items.push({
                            type: isErr ? 'err' : isWarn ? 'warn' : 'tip',
                            icon: isErr ? '🚫' : isWarn ? '⚠️' : '💡', text: line.replace(/🔴|🟡|🟢/g, '').trim()
                        });
                    }
                });
                if (!items.length) {
                    out.innerHTML = `<div class="audit-item audit-tip"><div class="audit-icon">✅</div><div class="audit-content"><h5>Design Looks Good!</h5><p>${text.substring(0, 300)}</p></div></div>`;
                } else {
                    out.innerHTML = items.map(r => `<div class="audit-item audit-${r.type}"><div class="audit-icon">${r.icon}</div><div class="audit-content"><p>${r.text}</p></div></div>`).join('');
                }
            } catch (e) { out.innerHTML = '<p style="padding:10px;font-size:.7rem;color:var(--warn)">Audit failed. Try again.</p>'; }
        }
        const _oldRunSimulate = window.runSimulate;
        window.runSimulate = async function () {
            await _oldRunSimulate();
            if (S.sim.lastSim) {
                document.getElementById('sim-audit').style.display = 'inline-flex';
            }
            updateTabBadge('simulate', true);
        };
        const _oldRunBOM = window.runBOM;
        window.runBOM = async function () {
            await _oldRunBOM();
            updateTabBadge('bom', true);
        };
        const _oldRunChat = window.runChat;
        window.runChat = async function (ep, p, outId, phId) {
            await _oldRunChat(ep, p, outId, phId);
            updateTabBadge(p, true);
        };
        // Render on load
        setTimeout(renderCircuitHistory, 150);

        // ── FEATURE 5: OHM'S LAW CALCULATOR ────────────────────────────────────────
        function calcOhm() {
            const vEl = document.getElementById('ohm-v');
            const iEl = document.getElementById('ohm-i');
            const rEl = document.getElementById('ohm-r');
            const pEl = document.getElementById('ohm-p');
            const res = document.getElementById('ohm-result');
            const v = vEl.value !== '' ? parseFloat(vEl.value) : null;
            const i = iEl.value !== '' ? parseFloat(iEl.value) : null;
            const r = rEl.value !== '' ? parseFloat(rEl.value) : null;
            // Reset computed styles
            [vEl, iEl, rEl, pEl].forEach(el => el.classList.remove('computed'));
            let cv = v, ci = i, cr = r, cp = null;
            if (v !== null && i !== null) {
                cr = i !== 0 ? v / i : Infinity;
                cp = v * i;
                rEl.value = cr === Infinity ? '∞' : cr.toFixed(4);
                rEl.classList.add('computed');
            } else if (v !== null && r !== null) {
                ci = r !== 0 ? v / r : Infinity;
                cp = v * ci;
                iEl.value = ci === Infinity ? '∞' : ci.toFixed(6);
                iEl.classList.add('computed');
            } else if (i !== null && r !== null) {
                cv = i * r;
                cp = cv * i;
                vEl.value = cv.toFixed(4);
                vEl.classList.add('computed');
            } else {
                res.textContent = 'Enter any 2 values to calculate';
                pEl.value = '';
                return;
            }
            if (cp !== null) {
                pEl.value = cp.toFixed(4);
                pEl.classList.add('computed');
            }
            const formula = v !== null && i !== null ? 'V = I × R' : v !== null && r !== null ? 'I = V / R' : 'V = I × R';
            res.textContent = `${formula}  ·  P = ${cp !== null ? cp.toFixed(2) + ' W' : '—'}`;
        }

        // ── FEATURE 6: QUIZ STREAK CONFETTI ──────────────────────────────────────
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            const particles = [];
            const colors = ['#00c8f0', '#00f090', '#ff7043', '#a855f7', '#ffb300', '#ff69b4', '#00ff88'];
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: canvas.width / 2 + (Math.random() - .5) * 200,
                    y: canvas.height / 2,
                    vx: (Math.random() - .5) * 12,
                    vy: -Math.random() * 14 - 4,
                    size: Math.random() * 6 + 3,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rotation: Math.random() * 360,
                    rotSpeed: (Math.random() - .5) * 10,
                    life: 1
                });
            }
            let frame = 0;
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let alive = false;
                particles.forEach(p => {
                    if (p.life <= 0) return;
                    alive = true;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.35;
                    p.rotation += p.rotSpeed;
                    p.life -= 0.012;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * .4);
                    ctx.restore();
                });
                frame++;
                if (alive && frame < 150) requestAnimationFrame(draw);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            requestAnimationFrame(draw);
        }
        // Patch answerQuiz to trigger confetti on streak >= 3
        const _origAnswerQuiz = answerQuiz;
        answerQuiz = function (idx) {
            if (!quiz.current) return;
            const q = quiz.current;
            _origAnswerQuiz(idx);
            if (idx === q.ans) {
                if (q.topic && S.stats[q.topic] !== undefined) {
                    S.stats[q.topic]++;
                    saveStats();
                }
                if (quiz.streak >= 3) {
                    fireConfetti();
                    showToast(`🔥 ${quiz.streak} streak! Keep it up!`, 2500);
                }
            }
            if (document.getElementById('tab-dashboard').classList.contains('active')) renderDashboard();
        };

        // ── HARDWARE BRIDGE (SERIAL) ──────────────────────────────────────────────
        let port, reader, writer, serialPlotData = [];
        async function connectSerial() {
            const btn = document.getElementById('btn-serial-connect');
            try {
                if (port) {
                    await reader.cancel(); await port.close();
                    port = null; btn.textContent = '🔌 Connect Device';
                    showToast('🔌 Disconnected'); return;
                }
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                btn.textContent = '🔴 Disconnect';
                showToast('🔌 Connected to Hardware!');
                readLoop();
            } catch (e) { showToast('❌ Serial Error: ' + e.message); }
        }
        async function readLoop() {
            const out = document.getElementById('serial-out');
            while (port?.readable) {
                reader = port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const text = new TextDecoder().decode(value);
                        out.textContent += text; out.scrollTop = out.scrollHeight;
                        processPlotData(text);
                    }
                } catch (e) { console.error(e); } finally { reader.releaseLock(); }
            }
        }
        async function sendSerial() {
            if (!port || !port.writable) { showToast('⚠ Device not connected'); return; }
            const input = document.getElementById('serial-input');
            const msg = input.value + '\n';
            writer = port.writable.getWriter();
            await writer.write(new TextEncoder().encode(msg));
            writer.releaseLock(); input.value = '';
        }
        function clearSerial() {
            document.getElementById('serial-out').textContent = '';
            serialPlotData = []; drawSerialPlot();
        }
        function processPlotData(text) {
            const lines = text.split('\n');
            lines.forEach(line => {
                const val = parseFloat(line.trim());
                if (!isNaN(val)) {
                    serialPlotData.push(val);
                    if (serialPlotData.length > 200) serialPlotData.shift();
                }
            });
            drawSerialPlot();
        }
        function drawSerialPlot() {
            const canvas = document.getElementById('serial-plot');
            const ctx = canvas.getContext('2d');
            const W = canvas.width = canvas.offsetWidth;
            const H = canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, W, H);
            if (serialPlotData.length < 2) return;
            const max = Math.max(...serialPlotData, 10), min = Math.min(...serialPlotData, 0);
            const range = max - min || 1;
            ctx.beginPath(); ctx.strokeStyle = '#00f090'; ctx.lineWidth = 2;
            serialPlotData.forEach((v, i) => {
                const x = (i / (serialPlotData.length - 1)) * W;
                const y = H - ((v - min) / range) * H;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        async function exportKiCad() {
            const name = document.getElementById('project-name').value.trim() || 'Circuit';
            try {
                const res = await fetch('/api/export-kicad', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, components: S.sch.lastSchema?.components || [] })
                });
                const data = await res.json();
                const blob = new Blob([data.kicad_sch], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = name + '.kicad_sch'; a.click();
                showToast('📦 KiCad Schematic Downloaded!');
            } catch (e) { showToast('❌ Export failed'); }
        }

        // ── CO-PILOT LIVE (COLLABORATION) ─────────────────────────────────────────
        function startCollab() {
            if (!currentCid) {
                showToast('⚠ Please SAVE your circuit first to start collaboration.');
                return;
            }
            if (collabSocket) {
                collabSocket.close();
                collabSocket = null;
                document.getElementById('btn-collab').textContent = '🤝 Collab';
                document.getElementById('btn-collab').classList.remove('btn-green');
                showToast('🤝 Collaboration Session Ended');
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${currentCid}`;
            collabSocket = new WebSocket(wsUrl);

            collabSocket.onopen = () => {
                document.getElementById('btn-collab').textContent = '🟢 Live';
                document.getElementById('btn-collab').classList.add('btn-green');
                showToast('🟢 Co-Pilot Live Active! Others on this project will sync.');
            };

            collabSocket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                handleRemoteUpdate(data);
            };

            collabSocket.onclose = () => {
                document.getElementById('btn-collab').textContent = '🤝 Collab';
                document.getElementById('btn-collab').classList.remove('btn-green');
                collabSocket = null;
            };
        }

        function broadcastUpdate(type, payload) {
            if (collabSocket && collabSocket.readyState === WebSocket.OPEN) {
                collabSocket.send(JSON.stringify({ type, payload, timestamp: Date.now() }));
            }
        }

        function handleRemoteUpdate(data) {
            const { type, payload } = data;
            switch (type) {
                case 'rename':
                    document.getElementById('project-name').value = payload;
                    break;
                case 'schematic':
                    S.sch.lastSchema = payload.schema;
                    S.sch.lastImage = payload.image;
                    if (payload.image) {
                        document.getElementById('sch-img').src = 'data:image/png;base64,' + payload.image;
                        document.getElementById('sch-img').style.display = 'block';
                        document.getElementById('sch-ph').style.display = 'none';
                    }
                    document.getElementById('sch-desc').textContent = payload.desc || '';
                    showToast('⚡ Schematic updated by collaborator');
                    break;
                case 'arduino':
                    S.ard.lastCode = payload;
                    document.getElementById('ard-out').innerHTML = marked.parse(payload);
                    document.getElementById('ard-out').style.display = 'block';
                    document.getElementById('ard-ph').style.display = 'none';
                    document.getElementById('ard-dl').style.display = 'inline-flex'; document.getElementById('ard-copy').style.display = 'inline-flex';
                    showToast('💻 Code updated by collaborator');
                    break;
            }
        }

        // ── FEATURE 4: ONBOARDING TOUR ──────────────────────────────────────────
        const TOUR_STEPS = [
            { target: '#sch-input', title: 'Describe Your Circuit', text: 'Type a circuit description in plain English — the AI will generate a schematic, simulation, and more!' },
            { target: '.tabs', title: 'Explore Tabs', text: 'Switch between Schematic, Simulate, Waveform, BOM, Components, Debug, Arduino, Learn, Quiz, and Templates.' },
            { target: '#tab-templates', title: 'Start from Templates', text: 'Don\'t know where to start? Pick a pre-built template and modify it!', tabSwitch: 'templates' },
            { target: '#tab-quiz', title: 'Test Your Knowledge', text: 'Take the electronics quiz with 41 questions across 3 difficulty levels.', tabSwitch: 'quiz' },
            { target: '.hdr-right', title: 'Status & Theme', text: 'Check API status and toggle dark/light mode. Your preference is saved!' },
            { target: 'footer', title: 'Keyboard Shortcuts', text: 'Press ? anytime to see all keyboard shortcuts. Use number keys 1-0 to switch tabs!' }
        ];
        let tourStep = 0;
        function startTour() {
            if (localStorage.getItem('cc_tour_done')) return;
            tourStep = 0;
            showTourStep();
        }
        function showTourStep() {
            const overlay = document.getElementById('tour-overlay');
            if (tourStep >= TOUR_STEPS.length) {
                overlay.innerHTML = '';
                overlay.style.display = 'none';
                localStorage.setItem('cc_tour_done', '1');
                showToast('🎉 Tour complete! Enjoy Circuit Copilot!');
                // Switch back to schematic tab
                const tabs = document.querySelectorAll('.tab');
                if (tabs[0]) switchTab('schematic', tabs[0]);
                return;
            }
            const step = TOUR_STEPS[tourStep];
            // Switch tab if needed
            if (step.tabSwitch) {
                const tabs = document.querySelectorAll('.tab');
                const tabMap = { 'schematic': 0, 'simulate': 1, 'waveform': 2, 'bom': 3, 'components': 4, 'debug': 5, 'arduino': 6, 'learn': 7, 'quiz': 8, 'templates': 9 };
                const idx = tabMap[step.tabSwitch];
                if (tabs[idx]) switchTab(step.tabSwitch, tabs[idx]);
            }
            setTimeout(() => {
                const target = document.querySelector(step.target);
                if (!target) { tourStep++; showTourStep(); return; }
                const rect = target.getBoundingClientRect();
                overlay.style.display = 'block';
                // Position tooltip below or above target
                const tooltipY = rect.bottom + 12;
                const tooltipX = Math.max(16, Math.min(rect.left, window.innerWidth - 340));
                overlay.innerHTML = `
          <div class="tour-overlay" onclick="skipTour()"></div>
          <div class="tour-spotlight" style="top:${rect.top - 6}px;left:${rect.left - 6}px;width:${rect.width + 12}px;height:${rect.height + 12}px;"></div>
          <div class="tour-tooltip" style="top:${tooltipY}px;left:${tooltipX}px;">
            <div class="tour-step-counter">Step ${tourStep + 1} of ${TOUR_STEPS.length}</div>
            <h3>${step.title}</h3>
            <p>${step.text}</p>
            <div class="tour-btns">
              <button onclick="skipTour()">Skip</button>
              <button class="tour-next" onclick="tourStep++;showTourStep()">${tourStep < TOUR_STEPS.length - 1 ? 'Next →' : 'Finish ✓'}</button>
            </div>
          </div>`;
            }, step.tabSwitch ? 200 : 50);
        }
        function skipTour() {
            const overlay = document.getElementById('tour-overlay');
            overlay.innerHTML = '';
            overlay.style.display = 'none';
            localStorage.setItem('cc_tour_done', '1');
            // Switch back to schematic tab
            const tabs = document.querySelectorAll('.tab');
            if (tabs[0]) switchTab('schematic', tabs[0]);
        }
        // Start tour only if never seen before AND skip if first time (demo handles onboarding)
        // setTimeout(startTour, 800); // Disabled — demo circuit replaces tour intro

        // ══════════════════════════════════════════════════════════════════════════
        // ⚡ SVG SCHEMATIC RENDERER — proper circuit topology layout
        // ══════════════════════════════════════════════════════════════════════════
        function renderSVGSchematic(schema) {
            if (!schema || !schema.components) return;
            const svg = document.getElementById('sch-svg');
            const wrap = document.getElementById('sch-svg-wrap');
            if (!svg || !wrap) return;

            const comps = schema.components || [];
            const conns = schema.connections || [];
            const GRID = 90;     // pixels per grid unit
            const PAD = 48;     // canvas padding
            const CW = 64;     // component width
            const CH = 32;     // component height

            // Find bounding box from x/y coords
            const xs = comps.map(c => c.x || 0);
            const ys = comps.map(c => c.y || 0);
            const maxX = Math.max(...xs, 3);
            const maxY = Math.max(...ys, 2);
            const W = (maxX + 2) * GRID + PAD * 2;
            const H = (maxY + 2) * GRID + PAD * 2;
            svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
            svg.setAttribute('height', Math.max(260, H));

            // Build node position map for wire routing
            const nodePos = {};
            comps.forEach(c => {
                const cx = PAD + (c.x || 0) * GRID + CW / 2;
                const cy = PAD + (c.y || 0) * GRID + CH / 2;
                const id = c.id;
                // Terminal positions based on orientation
                const ori = (c.orientation || 'right').toLowerCase();
                if (ori === 'right' || ori === 'horizontal') {
                    nodePos[id + '.start'] = nodePos[id + '.left'] = nodePos[id + '.anode'] = nodePos[id + '.base'] = { x: cx - CW / 2, y: cy };
                    nodePos[id + '.end'] = nodePos[id + '.right'] = nodePos[id + '.cathode'] = nodePos[id + '.collector'] = { x: cx + CW / 2, y: cy };
                } else if (ori === 'up' || ori === 'vertical') {
                    nodePos[id + '.neg'] = nodePos[id + '.negative'] = nodePos[id + '.bottom'] = { x: cx, y: cy + CH / 2 };
                    nodePos[id + '.pos'] = nodePos[id + '.positive'] = nodePos[id + '.top'] = { x: cx, y: cy - CH / 2 };
                } else {
                    nodePos[id + '.start'] = nodePos[id + '.left'] = { x: cx - CW / 2, y: cy };
                    nodePos[id + '.end'] = nodePos[id + '.right'] = { x: cx + CW / 2, y: cy };
                }
                // Also register by just the component id
                nodePos[id] = { x: cx, y: cy };
            });

            // Determine net colors
            const netColorMap = {};
            (schema.nets || []).forEach(net => {
                const name = (net.name || '').toUpperCase();
                if (/VCC|PWR|V\+|VDD|VBAT/.test(name)) netColorMap[net.name] = '#e05555';
                else if (/GND|GROUND/.test(name)) netColorMap[net.name] = '#55aa55';
                else netColorMap[net.name] = '#3a7bd5';
            });

            // Helper: find net for a connection node
            function getNetColor(nodeId) {
                for (const net of (schema.nets || [])) {
                    if ((net.nodes || []).includes(nodeId)) return netColorMap[net.name] || '#3a7bd5';
                }
                return '#3a7bd5';
            }

            // ── BUILD SVG ────────────────────────────────────────────────────────
            let svgHTML = `
        <defs>
          <filter id="glow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <marker id="arrow" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto">
            <path d="M0,0 L0,6 L6,3 Z" fill="#3a7bd5"/>
          </marker>
        </defs>`;

            // Draw grid dots (subtle)
            for (let gx = 0; gx <= maxX + 1; gx++) {
                for (let gy = 0; gy <= maxY + 1; gy++) {
                    const dx = PAD + gx * GRID;
                    const dy = PAD + gy * GRID;
                    svgHTML += `<circle cx="${dx}" cy="${dy}" r="1.2" fill="#1a2040" opacity="0.5"/>`;
                }
            }

            // Draw wires from connections
            conns.forEach(conn => {
                const from = conn.from; const to = conn.to;
                const fp = nodePos[from]; const tp = nodePos[to];
                if (!fp || !tp) return;
                const color = getNetColor(from) || getNetColor(to) || '#3a7bd5';
                // Orthogonal routing: go horizontal first, then vertical
                if (Math.abs(fp.x - tp.x) > 2 && Math.abs(fp.y - tp.y) > 2) {
                    svgHTML += `<path d="M${fp.x},${fp.y} L${tp.x},${fp.y} L${tp.x},${tp.y}" stroke="${color}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`;
                } else {
                    svgHTML += `<line x1="${fp.x}" y1="${fp.y}" x2="${tp.x}" y2="${tp.y}" stroke="${color}" stroke-width="2" stroke-linecap="round"/>`;
                }
                // Junction dot at corners
                if (Math.abs(fp.x - tp.x) > 2 && Math.abs(fp.y - tp.y) > 2) {
                    svgHTML += `<circle cx="${tp.x}" cy="${fp.y}" r="3" fill="${color}"/>`;
                }
            });

            // Draw components
            comps.forEach(c => {
                const cx = PAD + (c.x || 0) * GRID + CW / 2;
                const cy = PAD + (c.y || 0) * GRID + CH / 2;
                const type = (c.type || 'resistor').toLowerCase();
                const label = c.label || '';
                const value = c.value || '';
                const ori = (c.orientation || 'right').toLowerCase();
                const isVert = ori === 'up' || ori === 'down' || ori === 'vertical';

                let compSVG = '';
                const transform = isVert ? `transform="rotate(-90 ${cx} ${cy})"` : '';

                switch (type) {
                    case 'resistor':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - CW / 2 + 10}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <rect x="${cx - CW / 2 + 10}" y="${cy - 8}" width="${CW - 20}" height="16" fill="#0d1728" stroke="#1e6090" stroke-width="1.5" rx="2"/>
                <line x1="${cx + CW / 2 - 10}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy + 3}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8.5" fill="#8ecfff">${value}</text>
                <text x="${cx}" y="${cy - 13}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                        break;
                    case 'capacitor':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - 8}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <line x1="${cx - 8}" y1="${cy - 12}" x2="${cx - 8}" y2="${cy + 12}" stroke="#8ecfff" stroke-width="3"/>
                <line x1="${cx + 8}" y1="${cy - 12}" x2="${cx + 8}" y2="${cy + 12}" stroke="#8ecfff" stroke-width="3"/>
                <line x1="${cx + 8}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy - 15}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
                <text x="${cx}" y="${cy + 22}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#c8d8e8">${value}</text>
              </g>`;
                        break;
                    case 'led':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - 14}" y2="${cy}" stroke="#e05555" stroke-width="2"/>
                <polygon points="${cx - 14},${cy - 11} ${cx - 14},${cy + 11} ${cx + 10},${cy}" fill="#1a2a00" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="${cx + 10}" y1="${cy - 11}" x2="${cx + 10}" y2="${cy + 11}" stroke="#00ff88" stroke-width="2"/>
                <line x1="${cx + 10}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#55aa55" stroke-width="2"/>
                <line x1="${cx + 4}" y1="${cy - 14}" x2="${cx + 10}" y2="${cy - 20}" stroke="#00ff88" stroke-width="1.5"/>
                <line x1="${cx + 10}" y1="${cy - 14}" x2="${cx + 16}" y2="${cy - 20}" stroke="#00ff88" stroke-width="1.5"/>
                <text x="${cx}" y="${cy + 22}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#00ff88">${label}</text>
                <text x="${cx}" y="${cy - 24}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#c8d8e8">${value}</text>
              </g>`;
                        break;
                    case 'battery':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx}" y1="${cy + CW / 2}" x2="${cx}" y2="${cy + 8}" stroke="#55aa55" stroke-width="2"/>
                <line x1="${cx - 12}" y1="${cy + 8}" x2="${cx + 12}" y2="${cy + 8}" stroke="#55aa55" stroke-width="3"/>
                <line x1="${cx - 7}" y1="${cy + 3}" x2="${cx + 7}" y2="${cy + 3}" stroke="#c8d8e8" stroke-width="1.5"/>
                <line x1="${cx - 12}" y1="${cy - 3}" x2="${cx + 12}" y2="${cy - 3}" stroke="#e05555" stroke-width="3"/>
                <line x1="${cx - 7}" y1="${cy - 8}" x2="${cx + 7}" y2="${cy - 8}" stroke="#c8d8e8" stroke-width="1.5"/>
                <text x="${cx + 16}" y="${cy - 4}" font-family="'JetBrains Mono',monospace" font-size="8" fill="#e05555">+</text>
                <text x="${cx + 16}" y="${cy + 10}" font-family="'JetBrains Mono',monospace" font-size="8" fill="#55aa55">−</text>
                <line x1="${cx}" y1="${cy - 8}" x2="${cx}" y2="${cy - CW / 2}" stroke="#e05555" stroke-width="2"/>
                <text x="${cx + 20}" y="${cy + 2}" font-family="'JetBrains Mono',monospace" font-size="8.5" fill="#c8d8e8">${value}</text>
                <text x="${cx - 20}" y="${cy + 2}" text-anchor="end" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                        break;
                    case 'switch':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - 12}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <circle cx="${cx - 12}" cy="${cy}" r="3" fill="#3a7bd5"/>
                <circle cx="${cx + 12}" cy="${cy}" r="3" fill="#3a7bd5"/>
                <line x1="${cx - 12}" y1="${cy}" x2="${cx + 8}" y2="${cy - 12}" stroke="#c8d8e8" stroke-width="2"/>
                <line x1="${cx + 12}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy - 18}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                        break;
                    case 'diode':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - 12}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <polygon points="${cx - 12},${cy - 10} ${cx - 12},${cy + 10} ${cx + 10},${cy}" fill="#1a1a2a" stroke="#aa88ff" stroke-width="1.5"/>
                <line x1="${cx + 10}" y1="${cy - 10}" x2="${cx + 10}" y2="${cy + 10}" stroke="#aa88ff" stroke-width="2"/>
                <line x1="${cx + 10}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy - 15}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
                <text x="${cx}" y="${cy + 22}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#c8d8e8">${value}</text>
              </g>`;
                        break;
                    case 'transistor':
                        compSVG = `
              <g class="svg-comp-group">
                <circle cx="${cx}" cy="${cy}" r="20" fill="#0d1728" stroke="#1e5080" stroke-width="1.5"/>
                <line x1="${cx - 28}" y1="${cy}" x2="${cx - 20}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <line x1="${cx - 20}" y1="${cy - 14}" x2="${cx - 20}" y2="${cy + 14}" stroke="#c8d8e8" stroke-width="2"/>
                <line x1="${cx - 20}" y1="${cy - 8}" x2="${cx + 8}" y2="${cy - 18}" stroke="#c8d8e8" stroke-width="1.5"/>
                <line x1="${cx - 20}" y1="${cy + 8}" x2="${cx + 8}" y2="${cy + 18}" stroke="#c8d8e8" stroke-width="1.5"/>
                <polygon points="${cx + 4},${cy - 15} ${cx + 8},${cy - 18} ${cx + 8},${cy - 10}" fill="#c8d8e8"/>
                <line x1="${cx + 8}" y1="${cy - 18}" x2="${cx + 8}" y2="${cy - 28}" stroke="#c8d8e8" stroke-width="1.5"/>
                <line x1="${cx + 8}" y1="${cy + 18}" x2="${cx + 8}" y2="${cy + 28}" stroke="#c8d8e8" stroke-width="1.5"/>
                <text x="${cx + 16}" y="${cy + 4}" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                        break;
                    case 'inductor':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - CW / 2 + 8}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <path d="M${cx - CW / 2 + 8},${cy} Q${cx - CW / 2 + 14},${cy - 12} ${cx - CW / 2 + 20},${cy} Q${cx - CW / 2 + 26},${cy - 12} ${cx - CW / 2 + 32},${cy} Q${cx - CW / 2 + 38},${cy - 12} ${cx - CW / 2 + 44},${cy}" stroke="#ffaa44" stroke-width="2" fill="none"/>
                <line x1="${cx + CW / 2 - 8}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy + 18}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
                <text x="${cx}" y="${cy - 15}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#c8d8e8">${value}</text>
              </g>`;
                        break;
                    case 'potentiometer':
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - CW / 2 + 8}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <rect x="${cx - CW / 2 + 8}" y="${cy - 8}" width="${CW - 20}" height="16" fill="#0d1728" stroke="#aa6600" stroke-width="1.5" rx="2"/>
                <line x1="${cx}" y1="${cy - 8}" x2="${cx}" y2="${cy - 20}" stroke="#ffaa44" stroke-width="1.5"/>
                <polygon points="${cx},${cy - 20} ${cx - 5},${cy - 13} ${cx + 5},${cy - 13}" fill="#ffaa44"/>
                <line x1="${cx + CW / 2 - 8}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy + 22}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                        break;
                    case 'ground':
                        compSVG = `
              <g class="svg-comp-group">
                <line x1="${cx}" y1="${cy - 20}" x2="${cx}" y2="${cy}" stroke="#55aa55" stroke-width="2"/>
                <line x1="${cx - 14}" y1="${cy}" x2="${cx + 14}" y2="${cy}" stroke="#55aa55" stroke-width="2.5"/>
                <line x1="${cx - 9}" y1="${cy + 5}" x2="${cx + 9}" y2="${cy + 5}" stroke="#55aa55" stroke-width="2"/>
                <line x1="${cx - 4}" y1="${cy + 10}" x2="${cx + 4}" y2="${cy + 10}" stroke="#55aa55" stroke-width="1.5"/>
                <text x="${cx}" y="${cy + 24}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#55aa55">GND</text>
              </g>`;
                        break;
                    default: // IC / op_amp / unknown — draw as box
                        compSVG = `
              <g class="svg-comp-group" ${transform}>
                <line x1="${cx - CW / 2}" y1="${cy}" x2="${cx - CW / 2 + 8}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <rect x="${cx - CW / 2 + 8}" y="${cy - 14}" width="${CW - 16}" height="28" fill="#0d1728" stroke="#3a7bd5" stroke-width="1.5" rx="3"/>
                <text x="${cx}" y="${cy + 3}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="#8ecfff">${type.toUpperCase().substring(0, 4)}</text>
                <line x1="${cx + CW / 2 - 8}" y1="${cy}" x2="${cx + CW / 2}" y2="${cy}" stroke="#3a7bd5" stroke-width="2"/>
                <text x="${cx}" y="${cy - 18}" text-anchor="middle" font-family="'JetBrains Mono',monospace" font-size="8" fill="#5588aa">${label}</text>
              </g>`;
                }
                svgHTML += compSVG;
            });

            // Net labels
            (schema.nets || []).forEach(net => {
                if (!net.nodes || !net.nodes[0]) return;
                const p = nodePos[net.nodes[0]];
                if (!p) return;
                const color = netColorMap[net.name] || '#3a7bd5';
                svgHTML += `<text x="${p.x + 4}" y="${p.y - 6}" font-family="'JetBrains Mono',monospace" font-size="7.5" fill="${color}" opacity="0.7">${net.name}</text>`;
            });

            svg.innerHTML = svgHTML;

            // Update title + badge
            const titleEl = document.getElementById('sch-svg-title');
            const badgeEl = document.getElementById('sch-svg-badge');
            if (titleEl) titleEl.textContent = (schema.title || 'Circuit').toUpperCase();
            if (badgeEl && schema.difficulty) {
                badgeEl.textContent = schema.difficulty;
                badgeEl.className = '';
                badgeEl.style.cssText = 'position:absolute;top:8px;right:12px;font-size:.62rem;padding:3px 10px;border-radius:4px;font-family:JetBrains Mono,monospace;';
                const d = schema.difficulty.toLowerCase();
                if (d.includes('begin')) { badgeEl.style.background = '#1a3a1a'; badgeEl.style.color = '#4caf50'; }
                else if (d.includes('inter')) { badgeEl.style.background = '#3a2a00'; badgeEl.style.color = '#ff9800'; }
                else { badgeEl.style.background = '#3a0010'; badgeEl.style.color = '#f44336'; }
            }
            wrap.style.display = 'block';
        }

        // ══════════════════════════════════════════════════════════════════════════
        // 📸 IMAGE-TO-CIRCUIT — photo upload → vision AI → schematic
        // ══════════════════════════════════════════════════════════════════════════
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                const base64 = dataUrl.split(',')[1];
                const mimeType = file.type || 'image/jpeg';

                // Show preview modal
                showImageAnalysisModal(dataUrl);

                try {
                    const res = await fetch('/api/image-to-circuit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64, type: mimeType })
                    });
                    const data = await res.json();
                    hideImageModal();
                    if (data.error) { showToast('❌ ' + data.error); return; }

                    // Load result into schematic tab exactly like a normal generation
                    S.sch.lastImage = data.image;
                    S.sch.lastSchema = data.schema;
                    renderSVGSchematic(data.schema);
                    const img = document.getElementById('sch-img');
                    img.src = 'data:image/png;base64,' + data.image;
                    document.getElementById('sch-ph').style.display = 'none';
                    if (data.title) {
                        const descEl = document.getElementById('sch-desc');
                        descEl.innerHTML = `<strong>${data.title}</strong> — ${data.description || ''}<br>
              <span style="color:var(--accent);font-size:.75rem;">
                Confidence: ${data.confidence || 'medium'} · ${data.notes || ''}
              </span>`;
                        descEl.style.display = 'block';
                    }
                    if (data.falstad_url) {
                        document.getElementById('falstad-link').href = data.falstad_url;
                        document.getElementById('falstad-wrap').style.display = 'block';
                    }
                    document.getElementById('sch-audit').style.display = 'inline-flex';
                    // Pre-fill schematic input for follow-up edits
                    document.getElementById('sch-input').value = data.title || 'Identified circuit';
                    S.sch.history.push({ role: 'assistant', content: data.description || 'Circuit identified from image.' });
                    appendMsg('sch-chat', 'assistant', `📸 Identified: **${data.title}** — ${data.description}`);
                    showToast('✅ Circuit identified! Review and refine below.');
                    updateTabBadge('sch', true);
                } catch (err) {
                    hideImageModal();
                    showToast('❌ Failed to analyze image: ' + err.message);
                }
            };
            reader.readAsDataURL(file);
            // Reset input so same file can be re-uploaded
            event.target.value = '';
        }

        function showImageAnalysisModal(previewSrc) {
            let modal = document.getElementById('img2ckt-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'img2ckt-modal';
                modal.innerHTML = `
          <div class="img-modal-box">
            <img id="img2ckt-preview" src="" alt="Circuit preview"/>
            <div style="font-size:.85rem;color:var(--accent);font-family:'JetBrains Mono',monospace;margin-bottom:8px;">
              🔍 Analyzing circuit...
            </div>
            <div style="font-size:.72rem;color:var(--text-dim);">
              AI is identifying components and connections
            </div>
            <div style="margin-top:14px;display:flex;gap:6px;justify-content:center;">
              <div class="spinner"></div>
            </div>
          </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('img2ckt-preview').src = previewSrc;
            modal.classList.add('show');
        }
        function hideImageModal() {
            const modal = document.getElementById('img2ckt-modal');
            if (modal) modal.classList.remove('show');
        }

        // ══════════════════════════════════════════════════════════════════════════
        // 🎬 DEMO CIRCUIT — pre-loaded on first visit
        // ══════════════════════════════════════════════════════════════════════════
        const DEMO_SCHEMA = {
            "components": [
                { "id": "V1", "type": "battery", "value": "9V", "label": "V1", "x": 0, "y": 1, "orientation": "up" },
                { "id": "R1", "type": "resistor", "value": "220Ω", "label": "R1", "x": 1, "y": 0, "orientation": "right" },
                { "id": "LED1", "type": "led", "value": "red 2V", "label": "LED1", "x": 2, "y": 0, "orientation": "right" },
                { "id": "GND1", "type": "ground", "value": "", "label": "GND", "x": 2, "y": 2, "orientation": "down" }
            ],
            "connections": [
                { "from": "V1.pos", "to": "R1.start" },
                { "from": "R1.end", "to": "LED1.anode" },
                { "from": "LED1.cathode", "to": "GND1.top" },
                { "from": "V1.neg", "to": "GND1.top" }
            ],
            "nets": [
                { "name": "VCC", "nodes": ["V1.pos", "R1.start"] },
                { "name": "MID", "nodes": ["R1.end", "LED1.anode"] },
                { "name": "GND", "nodes": ["LED1.cathode", "V1.neg", "GND1.top"] }
            ],
            "title": "LED Circuit (Demo)",
            "description": "Series circuit with 9V battery, 220Ω current-limiting resistor, and red LED. Operating current: (9V − 2V) / 220Ω ≈ 31.8mA. Safe for the LED.",
            "difficulty": "Beginner",
            "use_case": "Learning, power indicators, status lights"
        };

        function loadDemoCircuit() {
            S.sch.lastSchema = DEMO_SCHEMA;
            renderSVGSchematic(DEMO_SCHEMA);
            document.getElementById('sch-ph').style.display = 'none';
            document.getElementById('sch-desc').innerHTML =
                `<strong>${DEMO_SCHEMA.title}</strong> — ${DEMO_SCHEMA.description} ` +
                `<em style="color:var(--accent);font-size:.75rem;">← Demo. Try typing your own circuit below!</em>`;
            document.getElementById('sch-desc').style.display = 'block';
            document.getElementById('sch-audit').style.display = 'inline-flex';
            appendMsg('sch-chat', 'assistant', '👋 Welcome! Here\'s a demo LED circuit. Describe your own circuit below or **upload a photo** to get started!');
        }

        // ══════════════════════════════════════════════════════════════════════════
        // ⚡ GENERATE ALL — one-click: schematic + sim + BOM + Arduino
        // ══════════════════════════════════════════════════════════════════════════
        async function generateAll() {
            const prompt = document.getElementById('sch-input').value.trim();
            if (!prompt) { showToast('⚠ Enter a circuit description first'); return; }
            const btn = document.getElementById('gen-all-btn');
            if (btn) { btn.disabled = true; btn.textContent = '⏳ Generating...'; }

            try {
                showToast('⚡ Generating schematic first...');
                await runSchematic();
                await new Promise(r => setTimeout(r, 800));

                // Pre-fill all inputs
                ['sim-input', 'bom-input', 'ard-input'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = prompt;
                });

                showToast('🔄 Running simulation, BOM & Arduino in parallel...');
                const [simRes, bomRes, ardRes] = await Promise.allSettled([
                    fetch('/api/simulate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, history: [] }) }).then(r => r.json()),
                    fetch('/api/bom', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, history: [] }) }).then(r => r.json()),
                    fetch('/api/arduino', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, history: [] }) }).then(r => r.json()),
                ]);

                if (simRes.status === 'fulfilled' && simRes.value.simulation) {
                    S.sim.lastSim = simRes.value.simulation; pdfData.simulation = simRes.value.simulation;
                    renderSim(simRes.value.simulation); updateTabBadge('sim', true);
                }
                if (bomRes.status === 'fulfilled' && bomRes.value.bom) {
                    S.bom.lastBom = bomRes.value.bom; pdfData.bom = bomRes.value.bom;
                    renderBOM(bomRes.value.bom); updateTabBadge('bom', true);
                }
                if (ardRes.status === 'fulfilled' && ardRes.value.result) {
                    S.ard.lastCode = ardRes.value.result; pdfData.arduino_code = ardRes.value.result;
                    const outEl = document.getElementById('ard-out');
                    if (outEl) { outEl.innerHTML = marked.parse(ardRes.value.result); outEl.style.display = 'block'; }
                    const phEl = document.getElementById('ard-ph');
                    if (phEl) phEl.style.display = 'none';
                    document.getElementById('ard-dl').style.display = 'inline-flex'; document.getElementById('ard-copy').style.display = 'inline-flex';
                    updateTabBadge('ard', true);
                }
                showToast('✅ All generated! Check each tab.');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = '🚀 Generate All'; }
            }
        }

        // ══════════════════════════════════════════════════════════════════════════
        // 📋 COPY ARDUINO CODE
        // ══════════════════════════════════════════════════════════════════════════
        function copyArduino() {
            const code = S.ard.lastCode || '';
            const m = code.match(/```(?:cpp|arduino|ino)?\n([\s\S]*?)```/);
            const clean = m ? m[1] : code;
            navigator.clipboard.writeText(clean)
                .then(() => showToast('✅ Code copied!'))
                .catch(() => showToast('❌ Copy failed'));
        }

        // ══════════════════════════════════════════════════════════════════════════
        // 🔄 INIT — load demo on first visit (don't show tour, show demo instead)
        // ══════════════════════════════════════════════════════════════════════════
        (function initApp() {
            // Load demo circuit after a brief delay so the UI renders first
            setTimeout(() => {
                // Only show demo if no existing circuit loaded
                if (!S.sch.lastSchema) {
                    loadDemoCircuit();
                }
            }, 600);
        })();



        // ══════════════════════════════════════════════════════════════════════════════
        // 🧪 REAL CIRCUIT VALIDATOR — physics-based, no AI hallucination
        // Checks: Ohm's law, LED current, power ratings, voltage divider, short circuits
        // ══════════════════════════════════════════════════════════════════════════════
        const CircuitValidator = {
            // Parse a value string like "220Ω", "4.7kΩ", "100mA", "9V"
            parseValue(str = '') {
                if (!str) return null;
                const s = str.trim().toLowerCase();
                const num = parseFloat(s.replace(/[^0-9.]/g, ''));
                if (isNaN(num)) return null;
                if (s.includes('k') && (s.includes('ω') || s.includes('ohm') || !s.includes('v'))) return num * 1000;
                if (s.includes('m') && s.includes('a')) return num / 1000;  // mA → A
                if (s.includes('µ') || s.includes('u')) return num * 1e-6;
                if (s.includes('n')) return num * 1e-9;
                if (s.includes('k')) return num * 1000;
                if (s.includes('m') && !s.includes('a')) return num * 1e-3;
                return num;
            },

            validate(schema) {
                const issues = [];
                const comps = schema.components || [];
                const conns = schema.connections || [];

                const byType = type => comps.filter(c => c.type === type);
                const batteries = byType('battery');
                const resistors = byType('resistor');
                const leds = byType('led');
                const capacitors = byType('capacitor');
                const transistors = byType('transistor');

                // ── 1. Find supply voltage ─────────────────────────────────────────────
                let Vsupply = null;
                for (const b of batteries) {
                    const v = this.parseValue(b.value);
                    if (v !== null) { Vsupply = v; break; }
                }

                // ── 2. Check LED current limiting ──────────────────────────────────────
                for (const led of leds) {
                    const Vf = led.value && led.value.toLowerCase().includes('blue') ? 3.2
                        : led.value && led.value.toLowerCase().includes('white') ? 3.2
                            : 2.0; // red/yellow/green default

                    // Find resistors connected to this LED (look at connections)
                    const connectedResistors = [];
                    for (const r of resistors) {
                        const rId = r.id;
                        const connectedToLed = conns.some(c =>
                            (c.from && c.from.startsWith(rId) && c.to && c.to.startsWith(led.id)) ||
                            (c.to && c.to.startsWith(rId) && c.from && c.from.startsWith(led.id))
                        );
                        if (connectedToLed) connectedResistors.push(r);
                    }

                    if (connectedResistors.length === 0 && Vsupply !== null) {
                        issues.push({
                            severity: 'critical',
                            icon: '🔴',
                            title: `${led.label || 'LED'}: No current-limiting resistor found`,
                            detail: `LEDs need a series resistor. Without one at ${Vsupply}V, current is limited only by the source and the LED will burn out instantly. Add R = (${Vsupply} − ${Vf}) / 0.02 = ${((Vsupply - Vf) / 0.02 * 1000).toFixed(0)}Ω minimum.`,
                            fix: `Add a ${((Vsupply - Vf) / 0.02 * 1000).toFixed(0)}Ω resistor in series (for 20mA)`
                        });
                    } else if (connectedResistors.length > 0 && Vsupply !== null) {
                        for (const r of connectedResistors) {
                            const R = this.parseValue(r.value);
                            if (R !== null) {
                                const I = (Vsupply - Vf) / R;
                                const Imilli = I * 1000;
                                if (Imilli > 30) {
                                    issues.push({
                                        severity: 'critical', icon: '🔴',
                                        title: `${led.label || 'LED'}: Current too high (${Imilli.toFixed(1)}mA)`,
                                        detail: `With ${r.value} resistor at ${Vsupply}V: I = (${Vsupply} − ${Vf}) / ${R} = ${Imilli.toFixed(1)}mA. Max LED current is typically 20–30mA. This will shorten LED life or cause failure.`,
                                        fix: `Increase ${r.label} to at least ${((Vsupply - Vf) / 0.02 * 1000).toFixed(0)}Ω`
                                    });
                                } else if (Imilli < 1) {
                                    issues.push({
                                        severity: 'warning', icon: '🟡',
                                        title: `${led.label || 'LED'}: Current very low (${Imilli.toFixed(2)}mA)`,
                                        detail: `LED may be too dim. Current is only ${Imilli.toFixed(2)}mA — typical forward current for visible brightness is 5–20mA.`,
                                        fix: `Reduce ${r.label} to ${((Vsupply - Vf) / 0.01 * 1000).toFixed(0)}Ω for 10mA`
                                    });
                                } else {
                                    issues.push({
                                        severity: 'ok', icon: '🟢',
                                        title: `${led.label || 'LED'}: Current looks good (${Imilli.toFixed(1)}mA)`,
                                        detail: `I = (${Vsupply}V − ${Vf}V) / ${r.value} = ${Imilli.toFixed(1)}mA. Within safe 5–20mA range for typical LEDs.`,
                                        fix: null
                                    });
                                }
                            }
                        }
                    }
                }

                // ── 3. Check resistor power dissipation ────────────────────────────────
                if (Vsupply !== null) {
                    for (const r of resistors) {
                        const R = this.parseValue(r.value);
                        if (R !== null) {
                            // Worst case: full supply across resistor
                            const Vr = Vsupply;
                            const P = (Vr * Vr) / R;
                            if (P > 0.25) {
                                issues.push({
                                    severity: P > 1 ? 'critical' : 'warning',
                                    icon: P > 1 ? '🔴' : '🟡',
                                    title: `${r.label || 'Resistor'}: High power dissipation (${(P * 1000).toFixed(0)}mW max)`,
                                    detail: `P = V² / R = ${Vsupply}² / ${r.value} = ${(P * 1000).toFixed(0)}mW worst-case. Standard 1/4W (250mW) resistors may overheat. Use a higher-wattage component or reduce voltage.`,
                                    fix: `Use a ${P > 1 ? '2W' : '0.5W'} rated resistor, or reduce supply voltage`
                                });
                            }
                        }
                    }
                }

                // ── 4. Check voltage divider ratio ─────────────────────────────────────
                if (resistors.length >= 2 && Vsupply !== null) {
                    // Look for two resistors in a voltage divider pattern
                    const r1 = resistors[0], r2 = resistors[1];
                    const R1 = this.parseValue(r1.value), R2 = this.parseValue(r2.value);
                    if (R1 && R2) {
                        const Vout = Vsupply * R2 / (R1 + R2);
                        issues.push({
                            severity: 'info', icon: '💡',
                            title: `Voltage divider: Vout ≈ ${Vout.toFixed(2)}V`,
                            detail: `Vout = ${Vsupply}V × ${r2.value} / (${r1.value} + ${r2.value}) = ${Vout.toFixed(2)}V. Total current: ${((Vsupply / (R1 + R2)) * 1000).toFixed(2)}mA.`,
                            fix: null
                        });
                    }
                }

                // ── 5. Short circuit detection ─────────────────────────────────────────
                for (const conn of conns) {
                    const from = conn.from || ''; const to = conn.to || '';
                    if ((from.includes('.pos') || from.includes('.positive') || from.includes('VCC')) &&
                        (to.includes('.neg') || to.includes('.negative') || to.includes('GND'))) {
                        issues.push({
                            severity: 'critical', icon: '🔴',
                            title: 'Possible short circuit detected',
                            detail: `Direct connection from ${from} to ${to} with no impedance in between. This could short the supply and damage the source.`,
                            fix: 'Add a current-limiting resistor between supply and ground'
                        });
                    }
                }

                // ── 6. No battery / power source ──────────────────────────────────────
                if (batteries.length === 0) {
                    issues.push({
                        severity: 'warning', icon: '🟡',
                        title: 'No power source defined',
                        detail: 'No battery or voltage source found in the schematic. The circuit has no defined supply voltage — calculations cannot be performed.',
                        fix: 'Add a battery or VCC node to the circuit'
                    });
                }

                // ── 7. Transistor base resistor check ─────────────────────────────────
                for (const t of transistors) {
                    const baseResistors = conns
                        .filter(c => c.to && c.to.startsWith(t.id + '.base'))
                        .map(c => c.from?.split('.')[0])
                        .map(id => resistors.find(r => r.id === id))
                        .filter(Boolean);
                    if (baseResistors.length === 0 && Vsupply !== null) {
                        issues.push({
                            severity: 'warning', icon: '🟡',
                            title: `${t.label || 'Transistor'}: No base resistor found`,
                            detail: 'Driving a transistor base directly without a resistor can exceed the base current rating. Add a 1kΩ–10kΩ resistor in series with the base.',
                            fix: 'Add a 1kΩ–4.7kΩ resistor between the control signal and the base'
                        });
                    }
                }

                // ── 8. Capacitor polarity note ─────────────────────────────────────────
                for (const c of capacitors) {
                    if (c.value && (c.value.toLowerCase().includes('µf') || c.value.toLowerCase().includes('uf'))) {
                        const val = this.parseValue(c.value);
                        if (val && val > 1e-6) {
                            issues.push({
                                severity: 'info', icon: '💡',
                                title: `${c.label || 'Capacitor'}: Electrolytic — check polarity`,
                                detail: `Large capacitors (${c.value}) are usually electrolytic and polarized. Ensure the positive terminal connects to higher voltage. Reverse polarity will destroy the component.`,
                                fix: 'Mark + terminal clearly, ensure positive side faces higher voltage'
                            });
                        }
                    }
                }

                return {
                    issues,
                    score: Math.max(0, 100 - issues.filter(i => i.severity === 'critical').length * 30
                        - issues.filter(i => i.severity === 'warning').length * 10),
                    componentCount: comps.length,
                    summary: issues.filter(i => i.severity === 'critical').length > 0
                        ? `⚠ ${issues.filter(i => i.severity === 'critical').length} critical issue(s) found`
                        : issues.filter(i => i.severity === 'warning').length > 0
                            ? `✓ Design valid with ${issues.filter(i => i.severity === 'warning').length} warning(s)`
                            : '✅ Circuit passes all physics checks!'
                };
            }
        };

        // Run validator and display results in the schematic tab
        function runPhysicsValidator() {
            const schema = S.sch.lastSchema;
            if (!schema) { showToast('⚠ Generate a schematic first!'); return; }
            const result = CircuitValidator.validate(schema);
            showValidatorModal(result);
        }

        function showValidatorModal(result) {
            let modal = document.getElementById('validator-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'validator-modal';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(7,9,15,.92);z-index:2000;display:flex;align-items:center;justify-content:center;padding:16px;';
                modal.onclick = e => { if (e.target === modal) modal.remove(); };
                document.body.appendChild(modal);
            }

            const scoreColor = result.score >= 80 ? '#4caf50' : result.score >= 50 ? '#ff9800' : '#f44336';
            const issueRows = result.issues.map(issue => `
        <div style="border:1px solid ${issue.severity === 'critical' ? '#5a0018' : issue.severity === 'warning' ? '#5a3f00' : issue.severity === 'ok' ? '#1a3a1a' : '#1a2a4a'};
             background:${issue.severity === 'critical' ? '#1a0008' : issue.severity === 'warning' ? '#1a1200' : issue.severity === 'ok' ? '#0a1a0a' : '#0a1020'};
             border-radius:8px;padding:12px 14px;margin-bottom:8px;">
          <div style="display:flex;gap:10px;align-items:flex-start;">
            <span style="font-size:1.1rem;flex-shrink:0;">${issue.icon}</span>
            <div>
              <div style="font-weight:600;font-size:.78rem;color:#c8d8e8;margin-bottom:4px;font-family:'JetBrains Mono',monospace;">${issue.title}</div>
              <div style="font-size:.72rem;color:#8090a8;line-height:1.5;">${issue.detail}</div>
              ${issue.fix ? `<div style="margin-top:6px;font-size:.7rem;color:#00c8f0;"><strong>Fix:</strong> ${issue.fix}</div>` : ''}
            </div>
          </div>
        </div>`).join('');

            modal.innerHTML = `
        <div style="background:#0d1120;border:1px solid #1e3a5f;border-radius:14px;padding:28px;max-width:580px;width:100%;max-height:85vh;overflow-y:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="font-family:'JetBrains Mono',monospace;color:#00c8f0;margin:0;font-size:.95rem;letter-spacing:1px;">🧪 CIRCUIT PHYSICS VALIDATOR</h3>
            <button onclick="document.getElementById('validator-modal').remove()" style="background:none;border:none;color:#8090a8;cursor:pointer;font-size:1.2rem;">✕</button>
          </div>
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;padding:16px;background:#07090f;border-radius:10px;border:1px solid #1a2a4a;">
            <div style="text-align:center;">
              <div style="font-size:2.4rem;font-weight:700;color:${scoreColor};font-family:'JetBrains Mono',monospace;">${result.score}</div>
              <div style="font-size:.62rem;color:#5588aa;letter-spacing:1px;">DESIGN SCORE</div>
            </div>
            <div>
              <div style="font-size:.82rem;color:#c8d8e8;margin-bottom:4px;">${result.summary}</div>
              <div style="font-size:.7rem;color:#5588aa;">${result.componentCount} component(s) analyzed · Ohm's Law · Power ratings · Short circuit detection</div>
            </div>
          </div>
          ${issueRows || '<div style="color:#4caf50;padding:12px;text-align:center;font-family:JetBrains Mono,monospace;">✅ No issues found!</div>'}
          <div style="margin-top:16px;text-align:right;">
            <button onclick="document.getElementById('validator-modal').remove()" style="background:#1a3a5a;border:1px solid #3a7bd5;color:#c8d8e8;border-radius:6px;padding:8px 18px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:.75rem;">Close</button>
          </div>
        </div>`;
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🎙️ IMPROVED VOICE INPUT — continuous, interim results, visual feedback
        // ══════════════════════════════════════════════════════════════════════════════
        let voiceSession = null;

        function toggleVoiceImproved(inputId, btnId) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) {
                showToast('🎤 Voice requires Chrome or Edge browser');
                return;
            }
            const btn = document.getElementById(btnId);
            const input = document.getElementById(inputId);

            // If already recording on this input, stop
            if (voiceSession && voiceSession.inputId === inputId) {
                voiceSession.recog.stop();
                voiceSession = null;
                btn.classList.remove('recording');
                btn.title = 'Voice input';
                return;
            }
            // Stop any other active session
            if (voiceSession) {
                voiceSession.recog.stop();
                const prevBtn = document.getElementById(voiceSession.btnId);
                if (prevBtn) prevBtn.classList.remove('recording');
            }

            const recog = new SR();
            recog.continuous = true;        // Keep recording until stopped
            recog.interimResults = true;    // Show partial results in real-time
            recog.lang = 'en-US';
            recog.maxAlternatives = 1;

            const originalPlaceholder = input.placeholder;
            input.placeholder = '🎤 Listening... speak now';
            btn.classList.add('recording');
            btn.title = 'Click to stop recording';

            let finalTranscript = input.value;

            recog.onresult = e => {
                let interim = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const t = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        finalTranscript += (finalTranscript ? ' ' : '') + t;
                    } else {
                        interim = t;
                    }
                }
                input.value = finalTranscript + (interim ? ' ' + interim : '');
                input.scrollTop = input.scrollHeight;
            };

            recog.onerror = e => {
                if (e.error === 'not-allowed') showToast('❌ Microphone permission denied');
                else if (e.error !== 'aborted') showToast('🎤 Voice error: ' + e.error);
                cleanup();
            };

            recog.onend = () => {
                // Auto-restart if session still active (handles natural pauses)
                if (voiceSession && voiceSession.inputId === inputId) {
                    try { recog.start(); } catch { }
                } else {
                    cleanup();
                }
            };

            function cleanup() {
                input.placeholder = originalPlaceholder;
                btn.classList.remove('recording');
                btn.title = 'Voice input';
                if (voiceSession && voiceSession.inputId === inputId) voiceSession = null;
            }

            recog.start();
            voiceSession = { recog, inputId, btnId };
            showToast('🎤 Listening... describe your circuit. Click 🎤 to stop.');
        }

        // Override all voice buttons to use improved version
        // Called after page load — patches all existing onclick="toggleVoice(...)"
        function upgradeVoiceButtons() {
            document.querySelectorAll('.voice-btn').forEach(btn => {
                const originalOnclick = btn.getAttribute('onclick') || '';
                const match = originalOnclick.match(/toggleVoice\('([^']+)',\s*'([^']+)'\)/);
                if (match) {
                    btn.setAttribute('onclick', `toggleVoiceImproved('${match[1]}','${match[2]}')`);
                    btn.title = 'Voice input (continuous)';
                }
            });
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🌐 SHAREABLE CIRCUIT URLs — save-then-share with real permanent links
        // ══════════════════════════════════════════════════════════════════════════════
        async function shareCircuitURL() {
            if (!S.sch.lastSchema) { showToast('⚠ Generate a schematic first!'); return; }

            // First save to DB (publicly) to get a real ID
            showToast('💾 Saving circuit for sharing...');
            try {
                const name = document.getElementById('project-name')?.value || S.sch.lastSchema.title || 'Circuit';
                const res = await fetch('/api/save-circuit', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        is_public: true,
                        schematic_image: S.sch.lastImage,
                        schematic_description: S.sch.lastSchema.description || '',
                        components: S.sch.lastSchema.components || [],
                        simulation: S.sim.lastSim || null,
                        arduino_code: S.ard.lastCode || '',
                        bom: S.bom.lastBom || null,
                    })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const shareURL = `${window.location.origin}${window.location.pathname}?circuit=${data.id}`;
                await navigator.clipboard.writeText(shareURL).catch(() => { });
                showShareModal(shareURL, name, data.id);
            } catch (e) {
                // Fallback to base64 URL if save fails
                const schema = S.sch.lastSchema;
                const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(schema))));
                const url = window.location.origin + window.location.pathname + '#circuit=' + encoded;
                navigator.clipboard.writeText(url).catch(() => { });
                showToast('🔗 Share link copied! (offline mode)');
            }
        }

        function showShareModal(url, name, circuitId) {
            let modal = document.getElementById('share-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'share-modal';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(7,9,15,.92);z-index:2000;display:flex;align-items:center;justify-content:center;padding:16px;';
                modal.onclick = e => { if (e.target === modal) modal.remove(); };
                document.body.appendChild(modal);
            }
            modal.innerHTML = `
        <div style="background:#0d1120;border:1px solid #3a7bd5;border-radius:14px;padding:28px;max-width:480px;width:100%;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="font-family:'JetBrains Mono',monospace;color:#00c8f0;margin:0;font-size:.9rem;">🔗 SHARE CIRCUIT</h3>
            <button onclick="document.getElementById('share-modal').remove()" style="background:none;border:none;color:#8090a8;cursor:pointer;font-size:1.1rem;">✕</button>
          </div>
          <div style="background:#07090f;border-radius:8px;padding:12px;margin-bottom:16px;border:1px solid #1a2a4a;">
            <div style="font-size:.65rem;color:#5588aa;font-family:'JetBrains Mono',monospace;margin-bottom:4px;">CIRCUIT: ${name}</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="share-url-input" value="${url}" readonly style="flex:1;background:#0d1728;border:1px solid #1e3a5f;border-radius:6px;padding:8px;color:#c8d8e8;font-family:'JetBrains Mono',monospace;font-size:.7rem;"/>
              <button onclick="copyShareURL()" style="background:#1a3a5a;border:1px solid #3a7bd5;color:#c8d8e8;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:.7rem;white-space:nowrap;">📋 Copy</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent('Check out this circuit I made with Circuit Copilot! ⚡ ' + name)}&url=${encodeURIComponent(url)}"
               target="_blank" style="flex:1;text-align:center;background:#1a3a5a;border:1px solid #1a90d0;color:#c8d8e8;border-radius:6px;padding:9px;font-size:.72rem;text-decoration:none;font-family:'JetBrains Mono',monospace;">
              🐦 Tweet
            </a>
            <a href="https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent('Circuit I made with Circuit Copilot: ' + name)}"
               target="_blank" style="flex:1;text-align:center;background:#1a3a5a;border:1px solid #ff4400;color:#c8d8e8;border-radius:6px;padding:9px;font-size:.72rem;text-decoration:none;font-family:'JetBrains Mono',monospace;">
              🔥 Reddit
            </a>
            <button onclick="document.getElementById('share-modal').remove()" style="flex:1;background:#0d1728;border:1px solid #1e3a5f;color:#8090a8;border-radius:6px;padding:9px;cursor:pointer;font-size:.72rem;font-family:'JetBrains Mono',monospace;">Close</button>
          </div>
        </div>`;
            showToast('✅ Link copied to clipboard!');
        }

        function copyShareURL() {
            const input = document.getElementById('share-url-input');
            if (!input) return;
            navigator.clipboard.writeText(input.value).then(() => showToast('📋 Link copied!')).catch(() => {
                input.select(); document.execCommand('copy'); showToast('📋 Copied!');
            });
        }

        // Auto-load circuit from ?circuit=ID query param
        async function loadCircuitFromQueryParam() {
            const params = new URLSearchParams(window.location.search);
            const circuitId = params.get('circuit');
            if (!circuitId) return;
            try {
                showToast('⏳ Loading shared circuit...');
                const res = await fetch(`/api/load-circuit/${circuitId}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                if (data.schematic_image) {
                    S.sch.lastImage = data.schematic_image;
                    const img = document.getElementById('sch-img');
                    img.src = 'data:image/png;base64,' + data.schematic_image;
                }
                if (data.components) {
                    S.sch.lastSchema = { components: data.components, title: data.name, description: data.schematic_description };
                    renderSVGSchematic(S.sch.lastSchema);
                    document.getElementById('sch-ph').style.display = 'none';
                    document.getElementById('sch-desc').textContent = '► ' + (data.schematic_description || '');
                    document.getElementById('sch-desc').style.display = 'block';
                }
                if (data.name) {
                    const pnEl = document.getElementById('project-name');
                    if (pnEl) pnEl.value = data.name;
                }
                showToast(`✅ Loaded: "${data.name}" — shared circuit`);
                // Switch to schematic tab
                const tabs = document.querySelectorAll('.tab');
                if (tabs[1]) switchTab('schematic', tabs[1]);
            } catch (e) {
                showToast('❌ Could not load shared circuit');
            }
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🏆 LEADERBOARD — upvotes, top circuits, stats
        // ══════════════════════════════════════════════════════════════════════════════
        const leaderboardState = {
            upvoted: new Set(JSON.parse(localStorage.getItem('cc_upvoted') || '[]'))
        };

        function saveUpvotedState() {
            localStorage.setItem('cc_upvoted', JSON.stringify([...leaderboardState.upvoted]));
        }

        async function loadGallery() {
            const el = document.getElementById('gallery-list');
            el.innerHTML = '<div class="loading visible"><div class="spinner"></div> Loading circuits...</div>';
            try {
                const res = await fetch('/api/gallery');
                const data = await res.json();
                if (!data.gallery || !data.gallery.length) {
                    el.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--text-dim);">
              <div style="font-size:2rem;margin-bottom:12px;">⚡</div>
              <p style="font-size:.85rem;margin-bottom:8px;">No public circuits yet.</p>
              <p style="font-size:.75rem;">Be the first to share! Generate a circuit, then click <strong>🔗 Share</strong>.</p>
            </div>`;
                    return;
                }
                el.innerHTML = data.gallery.map((c, i) => {
                    const hasUpvoted = leaderboardState.upvoted.has(c.id);
                    const votes = parseInt(localStorage.getItem('cc_votes_' + c.id) || '0');
                    const rank = i < 3 ? ['🥇', '🥈', '🥉'][i] : `#${i + 1}`;
                    return `
            <div class="gallery-card" id="gcard-${c.id}">
              <div style="position:relative;">
                <div style="position:absolute;top:8px;left:8px;font-size:1rem;z-index:1;">${rank}</div>
                ${c.image
                            ? `<img class="gallery-img" src="data:image/png;base64,${c.image}" loading="lazy"
                         onerror="this.style.display='none'" style="cursor:pointer;" onclick="galleryPreview('${c.id}')"/>`
                            : `<div class="gallery-img" style="display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:1.5rem;">📐</div>`
                        }
              </div>
              <div class="gallery-info">
                <div class="gallery-title">⚡ ${c.name}</div>
                <div class="gallery-desc">${c.description || 'No description.'}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:6px;flex-wrap:wrap;">
                  <span style="font-size:.6rem;color:var(--text-dim)">${c.saved_at}</span>
                  <div style="display:flex;gap:6px;">
                    <button class="btn btn-sm ${hasUpvoted ? 'btn-primary' : ''}" id="upvote-${c.id}"
                      onclick="upvoteCircuit('${c.id}')" style="font-size:.65rem;padding:4px 10px;">
                      ⚡ ${votes + (hasUpvoted ? 1 : 0)}
                    </button>
                    <button class="btn btn-sm" onclick="copyShareLink('${c.id}')" style="font-size:.65rem;padding:4px 10px;">🔗 Share</button>
                    <button class="btn btn-sm" onclick="loadFromGallery('${c.id}')" style="font-size:.65rem;padding:4px 10px;">🍴 Fork</button>
                  </div>
                </div>
              </div>
            </div>`;
                }).join('');
            } catch (e) { el.innerHTML = '<p style="padding:16px;color:var(--warn)">Failed to load gallery.</p>'; }
            // Update stats
            const allCards = el.querySelectorAll('.gallery-card');
            const countEl = document.getElementById('gallery-count');
            const votesEl = document.getElementById('gallery-votes');
            if (countEl) countEl.textContent = allCards.length;
            if (votesEl) {
                let totalV = 0;
                allCards.forEach((_, i) => {
                    const cards = el.querySelectorAll('[id^="upvote-"]');
                    cards.forEach(b => { totalV += parseInt(b.textContent.replace('⚡', '').trim()) || 0; });
                });
                votesEl.textContent = totalV;
            }
        }

        function filterGallery(query) {
            const cards = document.querySelectorAll('#gallery-list .gallery-card');
            const q = query.toLowerCase();
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = !q || text.includes(q) ? '' : 'none';
            });
        }

        function upvoteCircuit(id) {
            const btn = document.getElementById('upvote-' + id);
            if (!btn) return;
            const hasUpvoted = leaderboardState.upvoted.has(id);
            const currentVotes = parseInt(localStorage.getItem('cc_votes_' + id) || '0');
            if (hasUpvoted) {
                leaderboardState.upvoted.delete(id);
                localStorage.setItem('cc_votes_' + id, String(Math.max(0, currentVotes - 1)));
                btn.classList.remove('btn-primary');
                btn.textContent = `⚡ ${Math.max(0, currentVotes - 1)}`;
            } else {
                leaderboardState.upvoted.add(id);
                localStorage.setItem('cc_votes_' + id, String(currentVotes + 1));
                btn.classList.add('btn-primary');
                btn.textContent = `⚡ ${currentVotes + 1}`;
                showToast('⚡ Upvoted!');
            }
            saveUpvotedState();
        }

        async function loadFromGallery(id) {
            try {
                const res = await fetch(`/api/load-circuit/${id}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                if (data.components) {
                    S.sch.lastSchema = { components: data.components, title: data.name, description: data.schematic_description };
                    S.sch.lastImage = data.schematic_image;
                    renderSVGSchematic(S.sch.lastSchema);
                    document.getElementById('sch-ph').style.display = 'none';
                    if (data.schematic_image) {
                        document.getElementById('sch-img').src = 'data:image/png;base64,' + data.schematic_image;
                    }
                    const desc = document.getElementById('sch-desc');
                    desc.textContent = '► ' + (data.schematic_description || '');
                    desc.style.display = 'block';
                }
                const pnEl = document.getElementById('project-name');
                if (pnEl) pnEl.value = data.name + ' (fork)';
                showToast('🍴 Forked to your workspace!');
                const tabs = document.querySelectorAll('.tab');
                if (tabs[1]) switchTab('schematic', tabs[1]);
            } catch (e) { showToast('❌ Failed to fork: ' + e.message); }
        }

        function galleryPreview(id) {
            const card = document.getElementById('gcard-' + id);
            if (!card) return;
            const img = card.querySelector('.gallery-img');
            if (!img || !img.src) return;
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;display:flex;align-items:center;justify-content:center;cursor:pointer;';
            overlay.onclick = () => overlay.remove();
            overlay.innerHTML = `<img src="${img.src}" style="max-width:90vw;max-height:85vh;border-radius:10px;border:1px solid #3a7bd5;"/>`;
            document.body.appendChild(overlay);
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 💰 COMPONENT PRICE SEARCH (inline, no external API key needed)
        // Uses DigiKey & Mouser search URLs + extracts from BOM data
        // ══════════════════════════════════════════════════════════════════════════════
        function enhanceBOMWithPriceLinks() {
            // Called after BOM renders to inject clickable price search links
            const bomEl = document.getElementById('bom-table');
            if (!bomEl) return;
            const rows = bomEl.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const partNumCell = row.cells[3]; // part number column
                if (!partNumCell) return;
                const part = partNumCell.textContent.trim();
                if (!part || part === '—') return;
                const digiKey = `https://www.digikey.com/en/products/filter?keywords=${encodeURIComponent(part)}`;
                const mouser = `https://www.mouser.com/Search/Refine?Keyword=${encodeURIComponent(part)}`;
                partNumCell.innerHTML = `
          <span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;">${part}</span>
          <div style="margin-top:3px;display:flex;gap:4px;">
            <a href="${digiKey}" target="_blank" style="font-size:.6rem;color:#3a7bd5;text-decoration:none;border:1px solid #1a3a5a;border-radius:3px;padding:1px 5px;">DigiKey ↗</a>
            <a href="${mouser}"  target="_blank" style="font-size:.6rem;color:#ff9800;text-decoration:none;border:1px solid #5a3f00;border-radius:3px;padding:1px 5px;">Mouser ↗</a>
          </div>`;
            });
        }

        // Component quick-search widget in BOM tab
        function openComponentSearch(query) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(7,9,15,.92);z-index:2000;display:flex;align-items:center;justify-content:center;padding:16px;';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };
            const digiKey = `https://www.digikey.com/en/products/filter?keywords=${encodeURIComponent(query)}`;
            const mouser = `https://www.mouser.com/Search/Refine?Keyword=${encodeURIComponent(query)}`;
            const lcsc = `https://www.lcsc.com/search?q=${encodeURIComponent(query)}`;
            const amazon = `https://www.amazon.com/s?k=${encodeURIComponent(query + ' electronic component')}`;
            modal.innerHTML = `
        <div style="background:#0d1120;border:1px solid #3a7bd5;border-radius:14px;padding:24px;max-width:460px;width:100%;">
          <div style="display:flex;justify-content:space-between;margin-bottom:16px;">
            <h3 style="font-family:'JetBrains Mono',monospace;color:#00c8f0;margin:0;font-size:.88rem;">🔍 FIND: ${query}</h3>
            <button onclick="this.closest('[style]').remove()" style="background:none;border:none;color:#8090a8;cursor:pointer;font-size:1.1rem;">✕</button>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            ${[
                    { name: 'DigiKey', url: digiKey, color: '#cc0000', desc: 'Professional supplier, fast shipping' },
                    { name: 'Mouser Electronics', url: mouser, color: '#ff6600', desc: 'Large inventory, good for small quantities' },
                    { name: 'LCSC (budget)', url: lcsc, color: '#0066cc', desc: 'Cheapest option, ships from China' },
                    { name: 'Amazon', url: amazon, color: '#ff9900', desc: 'Fast shipping, often more expensive' },
                ].map(s => `
              <a href="${s.url}" target="_blank" style="display:block;background:#07090f;border:1px solid #1a2a4a;border-radius:8px;padding:12px 14px;text-decoration:none;transition:border-color .2s;"
                 onmouseover="this.style.borderColor='${s.color}'" onmouseout="this.style.borderColor='#1a2a4a'">
                <div style="font-weight:600;color:${s.color};font-size:.78rem;font-family:'JetBrains Mono',monospace;">${s.name} ↗</div>
                <div style="font-size:.68rem;color:#5588aa;margin-top:2px;">${s.desc}</div>
              </a>`).join('')}
          </div>
        </div>`;
            document.body.appendChild(modal);
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🔧 INIT & WIRING — connect all new features on page load
        // ══════════════════════════════════════════════════════════════════════════════
        setTimeout(() => {
            // Upgrade voice buttons
            upgradeVoiceButtons();
            // Load circuit from ?circuit= query param if present
            loadCircuitFromQueryParam();
            // Patch shareCircuit button to use new share modal
            const shareBtn = document.getElementById('sch-share');
            if (shareBtn) shareBtn.setAttribute('onclick', 'shareCircuitURL()');
            // Add physics validator button to schematic output panel header
            const schAuditBtn = document.getElementById('sch-audit');
            if (schAuditBtn && !document.getElementById('sch-validate')) {
                const validateBtn = document.createElement('button');
                validateBtn.id = 'sch-validate';
                validateBtn.className = 'btn btn-sm';
                validateBtn.style.cssText = 'display:none;background:linear-gradient(135deg,#1a2a00,#0a3a1a);border-color:#2a6a2a;color:#4caf50;';
                validateBtn.textContent = '🧪 Validate';
                validateBtn.setAttribute('onclick', 'runPhysicsValidator()');
                schAuditBtn.parentNode.insertBefore(validateBtn, schAuditBtn);
            }
        }, 700);

        // Show validate button when schematic is generated
        const _origRunSch = window.runSchematic;
        // Hook into runSchematic completion to show validate button
        document.addEventListener('schematic-ready', () => {
            const vBtn = document.getElementById('sch-validate');
            if (vBtn) vBtn.style.display = 'inline-flex';
        });



        // ══════════════════════════════════════════════════════════════════════════════
        // 🔧 COMPONENT CALCULATOR SIDEBAR
        // Ohm's Law, LED Resistor, Voltage Divider, RC Time, BJT Bias — instant math
        // ══════════════════════════════════════════════════════════════════════════════
        function openCalculator(type) {
            let modal = document.getElementById('calc-modal');
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = 'calc-modal';
            modal.style.cssText = `position:fixed;inset:0;background:rgba(7,9,15,.9);z-index:2000;
        display:flex;align-items:center;justify-content:center;padding:16px;`;
            modal.onclick = e => { if (e.target === modal) modal.remove(); };

            const calcs = {
                ohm: {
                    title: "⚡ Ohm's Law",
                    desc: "V = I × R — solve for any variable",
                    html: `
            <div class="calc-row"><label>Voltage (V)</label><input id="c-v" type="number" step="any" placeholder="e.g. 9"/></div>
            <div class="calc-row"><label>Current (mA)</label><input id="c-i" type="number" step="any" placeholder="e.g. 20"/></div>
            <div class="calc-row"><label>Resistance (Ω)</label><input id="c-r" type="number" step="any" placeholder="e.g. 220"/></div>
            <div class="calc-hint">Leave ONE field empty — it will be calculated</div>
            <button class="calc-btn" onclick="calcOhm()">Calculate</button>
            <div id="calc-result" class="calc-result"></div>`
                },
                led: {
                    title: "💡 LED Resistor",
                    desc: "R = (Vsupply − Vf) / If",
                    html: `
            <div class="calc-row"><label>Supply Voltage (V)</label><input id="c-vcc" type="number" step="any" value="9"/></div>
            <div class="calc-row"><label>LED Forward Voltage (V)</label>
              <div style="display:flex;gap:6px;align-items:center;">
                <input id="c-vf" type="number" step="any" value="2.0"/>
                <select id="c-led-color" onchange="setLEDVf(this.value)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px;font-size:.72rem;">
                  <option value="2.0">Red/Yellow/Green (2.0V)</option>
                  <option value="2.1">Orange (2.1V)</option>
                  <option value="3.2">Blue/White (3.2V)</option>
                  <option value="3.4">UV (3.4V)</option>
                </select>
              </div>
            </div>
            <div class="calc-row"><label>Target Current (mA)</label><input id="c-if" type="number" step="any" value="20"/></div>
            <button class="calc-btn" onclick="calcLED()">Calculate Resistor</button>
            <div id="calc-result" class="calc-result"></div>`
                },
                divider: {
                    title: "📐 Voltage Divider",
                    desc: "Vout = Vin × R2 / (R1 + R2)",
                    html: `
            <div class="calc-row"><label>Input Voltage Vin (V)</label><input id="c-vin" type="number" step="any" value="9"/></div>
            <div class="calc-row"><label>R1 (Ω)</label><input id="c-r1" type="number" step="any" value="10000"/></div>
            <div class="calc-row"><label>R2 (Ω)</label><input id="c-r2" type="number" step="any" value="4700"/></div>
            <div class="calc-row"><label>Target Vout (V) — optional</label><input id="c-vout" type="number" step="any" placeholder="leave blank to compute"/></div>
            <button class="calc-btn" onclick="calcDivider()">Calculate</button>
            <div id="calc-result" class="calc-result"></div>`
                },
                rc: {
                    title: "〰️ RC Time Constant",
                    desc: "τ = R × C — charge/discharge time",
                    html: `
            <div class="calc-row"><label>Resistance (Ω)</label><input id="c-rc-r" type="number" step="any" value="10000"/></div>
            <div class="calc-row"><label>Capacitance (µF)</label><input id="c-rc-c" type="number" step="any" value="100"/></div>
            <button class="calc-btn" onclick="calcRC()">Calculate</button>
            <div id="calc-result" class="calc-result"></div>`
                },
                timer555: {
                    title: "⏱️ 555 Timer Frequencies",
                    desc: "Astable mode: f = 1.44 / ((R1 + 2×R2) × C)",
                    html: `
            <div class="calc-row"><label>R1 (Ω)</label><input id="c-t-r1" type="number" step="any" value="1000"/></div>
            <div class="calc-row"><label>R2 (Ω)</label><input id="c-t-r2" type="number" step="any" value="10000"/></div>
            <div class="calc-row"><label>Capacitor C (µF)</label><input id="c-t-c" type="number" step="any" value="10"/></div>
            <div class="calc-hint">Or enter a target frequency to get component values:</div>
            <div class="calc-row"><label>Target Frequency (Hz) — optional</label><input id="c-t-freq" type="number" step="any" placeholder="e.g. 1000"/></div>
            <button class="calc-btn" onclick="calc555()">Calculate</button>
            <div id="calc-result" class="calc-result"></div>`
                },
                power: {
                    title: "🔋 Power & Energy",
                    desc: "P = V × I = I²R = V²/R",
                    html: `
            <div class="calc-row"><label>Voltage (V)</label><input id="c-pw-v" type="number" step="any" placeholder="e.g. 12"/></div>
            <div class="calc-row"><label>Current (mA)</label><input id="c-pw-i" type="number" step="any" placeholder="e.g. 500"/></div>
            <div class="calc-row"><label>Resistance (Ω) — optional</label><input id="c-pw-r" type="number" step="any" placeholder="optional"/></div>
            <div class="calc-row"><label>Runtime (hours) — for battery</label><input id="c-pw-h" type="number" step="any" placeholder="e.g. 8"/></div>
            <div class="calc-row"><label>Battery (mAh) — optional</label><input id="c-pw-bat" type="number" step="any" placeholder="e.g. 2000"/></div>
            <button class="calc-btn" onclick="calcPower()">Calculate</button>
            <div id="calc-result" class="calc-result"></div>`
                }
            };

            const c = calcs[type] || calcs.ohm;
            const tabs = Object.keys(calcs).map(k => `
        <button onclick="openCalculator('${k}')" style="padding:6px 12px;font-size:.65rem;cursor:pointer;
          border-radius:5px;border:1px solid ${k === type ? 'var(--accent)' : 'var(--border)'};
          background:${k === type ? 'rgba(0,200,240,.15)' : 'var(--bg3)'};color:${k === type ? 'var(--accent)' : 'var(--text-dim)'};
          font-family:'JetBrains Mono',monospace;white-space:nowrap;">
          ${calcs[k].title.split(' ').slice(0, 2).join(' ')}
        </button>`).join('');

            modal.innerHTML = `
        <div style="background:#0d1120;border:1px solid #3a7bd5;border-radius:14px;padding:28px;
                    max-width:520px;width:100%;max-height:90vh;overflow-y:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="font-family:'JetBrains Mono',monospace;color:#00c8f0;margin:0;font-size:.9rem;">🔧 COMPONENT CALCULATOR</h3>
            <button onclick="document.getElementById('calc-modal').remove()" style="background:none;border:none;color:#8090a8;cursor:pointer;font-size:1.2rem;">✕</button>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;">${tabs}</div>
          <div style="margin-bottom:8px;">
            <div style="font-size:.82rem;color:#c8d8e8;font-weight:600;margin-bottom:2px;">${c.title}</div>
            <div style="font-size:.72rem;color:#5588aa;font-family:'JetBrains Mono',monospace;">${c.desc}</div>
          </div>
          <div class="calc-fields">${c.html}</div>
        </div>`;
            document.body.appendChild(modal);
        }

        // Calculator math functions
        function calcResult(html) {
            const el = document.getElementById('calc-result');
            if (el) el.innerHTML = html;
        }

        function calcOhm() {
            const V = parseFloat(document.getElementById('c-v')?.value);
            const I = parseFloat(document.getElementById('c-i')?.value) / 1000; // mA → A
            const R = parseFloat(document.getElementById('c-r')?.value);
            const have = [!isNaN(V), !isNaN(I * 1000), !isNaN(R)].filter(Boolean).length;
            if (have < 2) return calcResult('<span style="color:#ff9800">Enter at least 2 values</span>');
            let result = '';
            if (isNaN(V)) {
                const vCalc = (I * 1000 / 1000) * R; result = `V = ${(I) * R} V = <strong>${vCalc.toFixed(3)} V</strong>`;
            } else if (isNaN(I * 1000)) {
                const iCalc = V / R * 1000; result = `I = V/R = ${V}/${R} = <strong>${iCalc.toFixed(2)} mA</strong>`;
            } else {
                const rCalc = V / (I); result = `R = V/I = ${V}/${(I * 1000).toFixed(1)}mA = <strong>${rCalc.toFixed(1)} Ω</strong>`;
            }
            const Pv = isNaN(V) ? (I * 1000 / 1000) * R * I : V;
            const Iv = isNaN(I * 1000) ? V / R : I;
            calcResult(`<div class="calc-answer">${result}</div>
        <div style="font-size:.7rem;color:#5588aa;margin-top:8px;">Power: P = ${Pv.toFixed(3)}V × ${(Iv * 1000).toFixed(2)}mA = <strong>${(Pv * Iv * 1000).toFixed(1)} mW</strong></div>`);
        }

        function setLEDVf(v) { const el = document.getElementById('c-vf'); if (el) el.value = v; }

        function calcLED() {
            const Vcc = parseFloat(document.getElementById('c-vcc')?.value);
            const Vf = parseFloat(document.getElementById('c-vf')?.value);
            const If = parseFloat(document.getElementById('c-if')?.value); // mA
            if ([Vcc, Vf, If].some(isNaN)) return calcResult('<span style="color:#ff9800">Fill all fields</span>');
            if (Vcc <= Vf) return calcResult('<span style="color:#f44336">Supply must be > LED forward voltage</span>');
            const R = (Vcc - Vf) / (If / 1000);
            const P = ((Vcc - Vf) * If / 1000) * 1000;
            // Find nearest E12 standard value
            const E12 = [10, 12, 15, 18, 22, 27, 33, 39, 47, 56, 68, 82];
            const mag = Math.pow(10, Math.floor(Math.log10(R)));
            const nearest = E12.map(v => { const vals = [v * mag / 10, v * mag, v * mag * 10]; return vals.find(x => x >= R) || v * mag * 10; })
                .reduce((a, b) => Math.abs(a - R) < Math.abs(b - R) ? a : b);
            calcResult(`<div class="calc-answer">R = (${Vcc} − ${Vf}) / ${If}mA = <strong>${R.toFixed(0)} Ω</strong></div>
        <div style="font-size:.72rem;color:#5588aa;margin-top:6px;">Nearest standard E12 value: <strong style="color:#00c8f0">${nearest} Ω</strong></div>
        <div style="font-size:.72rem;color:#5588aa;">Resistor power: <strong>${P.toFixed(0)} mW</strong> — use ¼W (250mW) resistor</div>
        <div style="font-size:.72rem;color:#5588aa;">Actual current with ${nearest}Ω: <strong>${((Vcc - Vf) / nearest * 1000).toFixed(1)} mA</strong></div>`);
        }

        function calcDivider() {
            const Vin = parseFloat(document.getElementById('c-vin')?.value);
            const R1 = parseFloat(document.getElementById('c-r1')?.value);
            const R2 = parseFloat(document.getElementById('c-r2')?.value);
            const Vout_target = parseFloat(document.getElementById('c-vout')?.value);
            if ([Vin, R1, R2].some(isNaN)) return calcResult('<span style="color:#ff9800">Fill Vin, R1, R2</span>');
            const Vout = Vin * R2 / (R1 + R2);
            const I = Vin / (R1 + R2) * 1000;
            const ratio = (Vout / Vin * 100).toFixed(1);
            let extra = '';
            if (!isNaN(Vout_target)) {
                const R2needed = Vout_target * R1 / (Vin - Vout_target);
                extra = `<div style="margin-top:8px;font-size:.72rem;color:#5588aa;">For Vout=${Vout_target}V: R2 = <strong style="color:#00c8f0">${R2needed.toFixed(0)} Ω</strong></div>`;
            }
            calcResult(`<div class="calc-answer">Vout = ${Vin} × ${R2}/(${R1}+${R2}) = <strong>${Vout.toFixed(3)} V</strong></div>
        <div style="font-size:.72rem;color:#5588aa;margin-top:6px;">Attenuation: ${ratio}% · Current draw: ${I.toFixed(2)} mA</div>${extra}`);
        }

        function calcRC() {
            const R = parseFloat(document.getElementById('c-rc-r')?.value);
            const C = parseFloat(document.getElementById('c-rc-c')?.value) * 1e-6;
            if ([R, C].some(v => isNaN(v))) return calcResult('<span style="color:#ff9800">Fill R and C</span>');
            const tau = R * C;
            const t10 = tau * 2.303; // time to 90%
            const f3db = 1 / (2 * Math.PI * R * C);
            const fmt = v => v >= 1 ? `${v.toFixed(3)} s` : v >= 0.001 ? `${(v * 1000).toFixed(2)} ms` : `${(v * 1e6).toFixed(1)} µs`;
            calcResult(`<div class="calc-answer">τ = R×C = ${R}×${(C * 1e6).toFixed(1)}µF = <strong>${fmt(tau)}</strong></div>
        <div style="font-size:.72rem;color:#5588aa;margin-top:6px;">63.2% charge at τ = ${fmt(tau)}</div>
        <div style="font-size:.72rem;color:#5588aa;">90% charge at 2.3τ = ${fmt(t10)}</div>
        <div style="font-size:.72rem;color:#5588aa;">As low-pass filter: f₋₃dB = <strong>${f3db.toFixed(1)} Hz</strong></div>`);
        }

        function calc555() {
            const R1 = parseFloat(document.getElementById('c-t-r1')?.value);
            const R2 = parseFloat(document.getElementById('c-t-r2')?.value);
            const C = parseFloat(document.getElementById('c-t-c')?.value) * 1e-6;
            const fTarget = parseFloat(document.getElementById('c-t-freq')?.value);
            if (!isNaN(fTarget) && fTarget > 0) {
                // Solve for R2 given R1, C, target freq
                const R2calc = (1.44 / (fTarget * C) - R1) / 2;
                if (R2calc <= 0) return calcResult('<span style="color:#f44336">R1 too large for target freq. Reduce R1.</span>');
                calcResult(`<div class="calc-answer">For f = ${fTarget} Hz:<br>R2 = <strong>${(R2calc / 1000).toFixed(2)} kΩ</strong> (with R1=${(R1 / 1000).toFixed(1)}kΩ, C=${(C * 1e6).toFixed(0)}µF)</div>`);
                return;
            }
            if ([R1, R2, C].some(isNaN)) return calcResult('<span style="color:#ff9800">Fill R1, R2, C</span>');
            const f = 1.44 / ((R1 + 2 * R2) * C);
            const tH = 0.693 * (R1 + R2) * C;
            const tL = 0.693 * R2 * C;
            const duty = tH / (tH + tL) * 100;
            const fmt = v => v >= 1000 ? `${(v / 1000).toFixed(2)} kHz` : `${v.toFixed(2)} Hz`;
            calcResult(`<div class="calc-answer">f = 1.44/((${R1 / 1000}k + 2×${R2 / 1000}k)×${C * 1e6}µF) = <strong>${fmt(f)}</strong></div>
        <div style="font-size:.72rem;color:#5588aa;margin-top:6px;">Period T = ${(1 / f * 1000).toFixed(2)} ms · Duty cycle: ${duty.toFixed(1)}%</div>
        <div style="font-size:.72rem;color:#5588aa;">High: ${(tH * 1000).toFixed(2)} ms · Low: ${(tL * 1000).toFixed(2)} ms</div>
        <div style="font-size:.72rem;color:#00c8f0;margin-top:6px;">💡 For 50% duty: use R1 ≈ 0 and a diode across R2</div>`);
        }

        function calcPower() {
            const V = parseFloat(document.getElementById('c-pw-v')?.value);
            const ImA = parseFloat(document.getElementById('c-pw-i')?.value);
            const R = parseFloat(document.getElementById('c-pw-r')?.value);
            const hrs = parseFloat(document.getElementById('c-pw-h')?.value);
            const bat = parseFloat(document.getElementById('c-pw-bat')?.value);
            const I = ImA / 1000;
            let lines = [];
            if (!isNaN(V) && !isNaN(ImA)) {
                const P = V * I;
                lines.push(`P = V×I = ${V}V × ${ImA}mA = <strong>${(P * 1000).toFixed(0)} mW</strong>`);
                if (!isNaN(hrs)) lines.push(`Energy = ${(P * hrs * 1000).toFixed(0)} mWh over ${hrs}h`);
                if (!isNaN(bat)) lines.push(`Battery life ≈ <strong>${(bat / ImA).toFixed(1)} hours</strong> (${bat}mAh ÷ ${ImA}mA)`);
            }
            if (!isNaN(R) && !isNaN(ImA)) lines.push(`P = I²R = ${ImA}mA² × ${R}Ω = <strong>${(I * I * R * 1000).toFixed(0)} mW</strong>`);
            if (!isNaN(V) && !isNaN(R)) lines.push(`P = V²/R = ${V}²/${R} = <strong>${(V * V / R * 1000).toFixed(0)} mW</strong>`);
            if (!lines.length) return calcResult('<span style="color:#ff9800">Enter V and I at minimum</span>');
            calcResult('<div class="calc-answer">' + lines.join('</div><div style="font-size:.75rem;color:#5588aa;margin-top:5px;">') + '</div>');
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🛒 BOM → SHOPPING CART (Mouser + DigiKey cart URLs)
        // ══════════════════════════════════════════════════════════════════════════════
        function generateShoppingCart() {
            const bom = S.bom?.lastBom;
            if (!bom || !bom.items?.length) { showToast('⚠ Generate a BOM first'); return; }

            // Mouser: https://www.mouser.com/ProjectManager/ProjectInput.aspx
            // DigiKey: https://www.digikey.com/short/zrrtf5z1 (they use cart API)
            // We'll build a Mouser project manager URL and a text list
            const items = bom.items;

            // Build Mouser cart text (downloadable as .txt for upload)
            const mouserLines = ['Mouser Part Number,Quantity'];
            const digiKeyLines = ['Part Number,Quantity,CustomerRef'];
            const readableLines = [`Shopping List: ${bom.project_name || 'Circuit'}\n${'─'.repeat(50)}`];

            items.forEach(it => {
                const pn = (it.part_number || '').replace(/,/g, '');
                const qty = it.quantity || 1;
                if (pn) {
                    mouserLines.push(`${pn},${qty}`);
                    digiKeyLines.push(`${pn},${qty},${it.ref || ''}`);
                }
                readableLines.push(`${it.ref || ''} — ${it.description || ''} (${it.value || ''}) × ${qty}  |  ${it.supplier || ''}: ${pn}  |  $${(it.total_cost || 0).toFixed(2)}`);
            });
            readableLines.push(`\nTotal: $${bom.total_cost_usd?.toFixed(2) || '?'}`);

            showCartModal(bom, mouserLines.join('\n'), digiKeyLines.join('\n'), readableLines.join('\n'));
        }

        function showCartModal(bom, mouserCSV, digiKeyCSV, readable) {
            let modal = document.getElementById('cart-modal');
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = 'cart-modal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(7,9,15,.92);z-index:2000;display:flex;align-items:center;justify-content:center;padding:16px;';
            modal.onclick = e => { if (e.target === modal) modal.remove(); };

            const items = bom.items || [];
            const totalCost = bom.total_cost_usd || 0;

            modal.innerHTML = `
        <div style="background:#0d1120;border:1px solid #3a7bd5;border-radius:14px;padding:28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="font-family:'JetBrains Mono',monospace;color:#00c8f0;margin:0;font-size:.9rem;">🛒 BUILD YOUR CART</h3>
            <button onclick="document.getElementById('cart-modal').remove()" style="background:none;border:none;color:#8090a8;cursor:pointer;font-size:1.2rem;">✕</button>
          </div>
          <div style="background:#07090f;border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid #1a2a4a;">
            <div style="font-size:.72rem;color:#5588aa;font-family:'JetBrains Mono',monospace;">${bom.project_name || 'Circuit'} · ${items.length} parts · <strong style="color:#4caf50">$${totalCost.toFixed(2)} total</strong></div>
          </div>
          <div style="display:grid;gap:10px;margin-bottom:16px;">
            <a href="https://www.mouser.com/ProjectManager/ProjectInput.aspx" target="_blank"
               style="display:flex;align-items:center;gap:12px;background:#1a0a00;border:1px solid #ff6600;border-radius:10px;padding:14px;text-decoration:none;transition:border-color .2s;"
               onmouseover="this.style.background='#2a1400'" onmouseout="this.style.background='#1a0a00'">
              <span style="font-size:1.4rem;">🏪</span>
              <div>
                <div style="font-weight:700;color:#ff6600;font-family:'JetBrains Mono',monospace;font-size:.78rem;">Mouser Electronics ↗</div>
                <div style="font-size:.68rem;color:#5588aa;">Download CSV below → upload to Mouser BOM Tool</div>
              </div>
            </a>
            <a href="https://www.digikey.com/en/mylists/list/new" target="_blank"
               style="display:flex;align-items:center;gap:12px;background:#00001a;border:1px solid #cc0000;border-radius:10px;padding:14px;text-decoration:none;"
               onmouseover="this.style.background='#0a000a'" onmouseout="this.style.background='#00001a'">
              <span style="font-size:1.4rem;">🔴</span>
              <div>
                <div style="font-weight:700;color:#cc0000;font-family:'JetBrains Mono',monospace;font-size:.78rem;">DigiKey ↗</div>
                <div style="font-size:.68rem;color:#5588aa;">Download CSV below → upload to DigiKey My Lists</div>
              </div>
            </a>
            <a href="https://www.lcsc.com/bom" target="_blank"
               style="display:flex;align-items:center;gap:12px;background:#00000a;border:1px solid #0066cc;border-radius:10px;padding:14px;text-decoration:none;">
              <span style="font-size:1.4rem;">🔵</span>
              <div>
                <div style="font-weight:700;color:#3399ff;font-family:'JetBrains Mono',monospace;font-size:.78rem;">LCSC (budget) ↗</div>
                <div style="font-size:.68rem;color:#5588aa;">Cheapest parts, ships from China · BOM upload supported</div>
              </div>
            </a>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="dlText(${JSON.stringify(mouserCSV)},'mouser_bom.csv','text/csv')"
              style="flex:1;background:#1a1000;border:1px solid #ff6600;color:#ff9933;border-radius:7px;padding:9px;cursor:pointer;font-size:.7rem;font-family:'JetBrains Mono',monospace;">
              ↓ Mouser CSV
            </button>
            <button onclick="dlText(${JSON.stringify(digiKeyCSV)},'digikey_bom.csv','text/csv')"
              style="flex:1;background:#0a0010;border:1px solid #cc0000;color:#ff4444;border-radius:7px;padding:9px;cursor:pointer;font-size:.7rem;font-family:'JetBrains Mono',monospace;">
              ↓ DigiKey CSV
            </button>
            <button onclick="dlText(${JSON.stringify(readable)},'shopping_list.txt','text/plain')"
              style="flex:1;background:#0a0a1a;border:1px solid #3a7bd5;color:#8ecfff;border-radius:7px;padding:9px;cursor:pointer;font-size:.7rem;font-family:'JetBrains Mono',monospace;">
              ↓ Text List
            </button>
          </div>
        </div>`;
            document.body.appendChild(modal);
        }

        function dlText(content, filename, mime) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: mime }));
            a.download = filename;
            a.click();
            showToast(`✅ Downloaded ${filename}`);
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 🔄 CIRCUIT MEMORY — iterative refinement ("add a switch to that circuit")
        // ══════════════════════════════════════════════════════════════════════════════
        // Patch runSchematic to inject current schema context when refining
        const _baseRunSchematic = runSchematic;
        async function runSchematic() {
            const input = document.getElementById('sch-input');
            const prompt = input.value.trim();
            if (!prompt) return;

            // If we have an existing schema AND the prompt sounds like a modification, inject context
            const isRefinement = S.sch.lastSchema && /add|remove|change|replace|modify|increase|decrease|make|use|with|instead|also|and a|swap|update/i.test(prompt);

            if (isRefinement) {
                const ctx = JSON.stringify({
                    title: S.sch.lastSchema.title,
                    components: (S.sch.lastSchema.components || []).map(c => ({ id: c.id, type: c.type, value: c.value, label: c.label })),
                    connections: S.sch.lastSchema.connections || []
                });
                // Prepend context to history for this call
                const contextMsg = `Current circuit context:\n${ctx}\n\nUser modification request: ${prompt}`;
                const origVal = input.value;
                // Temporarily set input for the base function to pick up
                input.value = contextMsg;
                await _baseRunSchematic();
                // Don't restore — the new circuit replaces it
                return;
            }
            await _baseRunSchematic();
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 📊 SIMULATION PLAIN-ENGLISH INTERPRETER
        // Translates raw node voltages → what the circuit actually DOES
        // ══════════════════════════════════════════════════════════════════════════════
        function interpretSimulation(sim, schema) {
            if (!sim) return null;
            const comps = schema?.components || [];
            const insights = [];

            // ── LED brightness ─────────────────────────────────────────────────────────
            const leds = comps.filter(c => c.type === 'led');
            const branches = sim.branches || [];
            for (const led of leds) {
                const branch = branches.find(b => b.through && b.through.toLowerCase().includes(led.label?.toLowerCase() || 'led'));
                if (branch) {
                    const mA = branch.current;
                    const brightness = mA < 1 ? 'barely visible' : mA < 5 ? 'dim' : mA < 15 ? 'moderate' : mA < 25 ? 'bright' : 'very bright (check ratings!)';
                    insights.push({ icon: '💡', text: `${led.label || 'LED'} brightness: <strong>${mA?.toFixed(1)} mA → ${brightness}</strong>` });
                }
            }

            // ── Transistor state ───────────────────────────────────────────────────────
            const transistors = comps.filter(c => c.type === 'transistor' || c.type === 'mosfet');
            for (const t of transistors) {
                const vce = sim.nodes?.find(n => n.name?.toLowerCase().includes('collector') || n.name?.toLowerCase().includes('vce'));
                if (vce) {
                    const state = vce.voltage < 0.3 ? 'SATURATED (fully ON — maximum current)' : vce.voltage > 5 ? 'CUT-OFF (fully OFF — no current)' : 'ACTIVE (linear region)';
                    insights.push({ icon: '🔀', text: `${t.label || 'Transistor'} state: <strong>${state}</strong>` });
                }
            }

            // ── Power budget ───────────────────────────────────────────────────────────
            const powerItems = sim.power || [];
            const totalPower = powerItems.reduce((sum, p) => sum + (p.power || 0), 0);
            if (totalPower > 0) {
                const batteryLife = (1000 / totalPower * 1000).toFixed(0); // hours for 1000mAh battery
                insights.push({ icon: '🔋', text: `Total power: <strong>${totalPower.toFixed(0)} mW</strong> — a 1000mAh (9V) battery lasts ~<strong>${batteryLife}h</strong>` });
            }

            // ── Voltage levels interpretation ──────────────────────────────────────────
            const nodes = sim.nodes || [];
            const vcc = nodes.find(n => n.voltage === Math.max(...nodes.map(x => x.voltage)));
            const midNodes = nodes.filter(n => n.voltage > 0.5 && n.voltage < (vcc?.voltage || 9) - 0.5);
            for (const n of midNodes.slice(0, 2)) {
                insights.push({ icon: '📍', text: `Node <strong>${n.name}</strong>: ${n.voltage.toFixed(2)}V — ${n.description || ''}` });
            }

            // ── Frequency / timing (if 555 timer) ─────────────────────────────────────
            const has555 = comps.some(c => c.type === 'ic' || (c.value || '').includes('555'));
            if (has555) {
                insights.push({ icon: '⏱️', text: 'Contains timer IC — use the 555 Calculator (🔧 Calc button) to compute exact frequency' });
            }

            // ── Warnings escalation ────────────────────────────────────────────────────
            for (const w of (sim.warnings || [])) {
                insights.push({ icon: '⚠️', text: `<strong>Warning:</strong> ${w}` });
            }

            return insights;
        }

        // Hook into renderSim to add interpretation panel
        const _baseRenderSim = renderSim;
        function renderSim(sim) {
            _baseRenderSim(sim);
            // Add interpreter panel after a tick
            setTimeout(() => {
                const schema = S.sch.lastSchema;
                const insights = interpretSimulation(sim, schema);
                if (!insights || !insights.length) return;

                const out = document.getElementById('sim-out');
                if (!out) return;
                let interp = document.getElementById('sim-interpret');
                if (!interp) {
                    interp = document.createElement('div');
                    interp.id = 'sim-interpret';
                    interp.style.cssText = 'margin-top:12px;';
                    out.appendChild(interp);
                }
                interp.innerHTML = `
          <div style="font-size:.65rem;color:#5588aa;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-bottom:8px;">⚡ WHAT THIS CIRCUIT DOES</div>
          ${insights.map(ins => `
            <div style="display:flex;gap:10px;align-items:flex-start;background:#07090f;border:1px solid #1a2a4a;
                        border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:.75rem;color:#c8d8e8;line-height:1.5;">
              <span style="flex-shrink:0;font-size:1rem;">${ins.icon}</span>
              <span>${ins.text}</span>
            </div>`).join('')}`;
            }, 50);
        }

        // ══════════════════════════════════════════════════════════════════════════════
        // 📋 EXPANDED TEMPLATES — 20 maker/engineer circuits
        // ══════════════════════════════════════════════════════════════════════════════
        const MAKER_TEMPLATES = [
            // ── Power & Regulation ────────────────────────────────────────────────────
            {
                name: '7805 Voltage Regulator', icon: '⚡', cat: 'Power', diff: 'Intermediate',
                desc: '12V → 5V regulated supply using LM7805. Input/output filter caps included.',
                prompt: 'LM7805 5V voltage regulator circuit with 12V input, 0.1µF and 10µF filter capacitors on input and output'
            },
            {
                name: 'LiPo Charge Circuit', icon: '🔋', cat: 'Power', diff: 'Intermediate',
                desc: 'TP4056 single-cell LiPo battery charger with USB-C input and protection.',
                prompt: 'TP4056 lithium battery charger with 1kΩ programming resistor for 1A charge current, LED indicators for charging and full'
            },
            {
                name: 'Buck Converter (LM2596)', icon: '⬇️', cat: 'Power', diff: 'Advanced',
                desc: 'Efficient step-down switching regulator. Adjustable output 1.2V–37V.',
                prompt: 'LM2596 adjustable buck converter with 10µH inductor, 100µF capacitors, 1N5822 Schottky diode, feedback resistor divider'
            },
            // ── Sensors ───────────────────────────────────────────────────────────────
            {
                name: 'DHT22 Temp/Humidity', icon: '🌡️', cat: 'Sensors', diff: 'Beginner',
                desc: 'DHT22 sensor with 10kΩ pull-up, reading temperature and humidity.',
                prompt: 'DHT22 temperature humidity sensor with 10kΩ pull-up resistor to 3.3V, connected to Arduino digital pin 2'
            },
            {
                name: 'HC-SR04 Ultrasonic', icon: '📡', cat: 'Sensors', diff: 'Beginner',
                desc: 'Ultrasonic distance sensor with voltage divider for 3.3V Arduino.',
                prompt: 'HC-SR04 ultrasonic sensor with voltage divider on Echo pin (1kΩ and 2kΩ) for 3.3V compatibility, Trig on Arduino pin 9, Echo on pin 10'
            },
            {
                name: 'PIR Motion Sensor', icon: '👁️', cat: 'Sensors', diff: 'Beginner',
                desc: 'HC-SR501 PIR motion detector triggering a relay for automation.',
                prompt: 'HC-SR501 PIR motion sensor connected to Arduino pin 7, triggering NPN transistor relay to control 12V load'
            },
            {
                name: 'Current Sensor (ACS712)', icon: '⚡', cat: 'Sensors', diff: 'Intermediate',
                desc: 'Hall effect current sensor measuring AC/DC current up to 30A.',
                prompt: 'ACS712-30A current sensor with 100nF filter capacitor, output to Arduino analog pin A0, 5V supply'
            },
            // ── Motor Control ──────────────────────────────────────────────────────────
            {
                name: 'L298N H-Bridge', icon: '⚙️', cat: 'Motors', diff: 'Intermediate',
                desc: 'L298N dual H-bridge for bidirectional control of 2 DC motors.',
                prompt: 'L298N dual H-bridge motor driver with 2 DC motors, enable pins with PWM from Arduino pins 9,10, direction pins 4,5,6,7, flyback diodes on motor outputs'
            },
            {
                name: 'Servo Motor Control', icon: '🔄', cat: 'Motors', diff: 'Beginner',
                desc: 'Servo motor with PWM signal and decoupling capacitor.',
                prompt: 'Servo motor SG90 connected to Arduino pin 3 (PWM), 100µF decoupling capacitor on 5V supply, controlled by Arduino servo library'
            },
            {
                name: 'Stepper + A4988', icon: '🔩', cat: 'Motors', diff: 'Advanced',
                desc: 'NEMA17 stepper motor with A4988 driver and microstepping.',
                prompt: 'A4988 stepper motor driver with NEMA17 motor, VMOT 12V with 100µF capacitor, logic 5V, STEP and DIR from Arduino pins 2 and 3, MS1/MS2/MS3 for 1/16 microstepping, RST connected to SLP'
            },
            // ── Communication ─────────────────────────────────────────────────────────
            {
                name: 'I2C Bus + Pull-ups', icon: '🔗', cat: 'Comms', diff: 'Intermediate',
                desc: 'I2C bus with proper 4.7kΩ pull-up resistors for SDA and SCL.',
                prompt: 'I2C bus with 4.7kΩ pull-up resistors on SDA and SCL to 3.3V, connecting Arduino to SSD1306 OLED and BMP280 pressure sensor'
            },
            {
                name: 'RS-232 Level Shifter', icon: '📟', cat: 'Comms', diff: 'Advanced',
                desc: 'MAX232 converts TTL serial to RS-232 levels for legacy devices.',
                prompt: 'MAX232 RS-232 to TTL level converter with 4× 100nF charge pump capacitors, connecting Arduino UART to DB9 RS-232 port'
            },
            // ── Signal Processing ──────────────────────────────────────────────────────
            {
                name: 'Op-Amp Comparator', icon: '↕️', cat: 'Signal', diff: 'Intermediate',
                desc: 'LM393 comparator switching output when input crosses threshold.',
                prompt: 'LM393 comparator with 10kΩ voltage divider reference at half supply, LDR input with 10kΩ, 10kΩ pull-up on open-collector output driving LED'
            },
            {
                name: 'Inverting Amplifier', icon: '📈', cat: 'Signal', diff: 'Intermediate',
                desc: 'Op-amp inverting amplifier with gain = -Rf/Rin.',
                prompt: 'LM358 op-amp inverting amplifier with 10kΩ input resistor and 100kΩ feedback resistor for -10 gain, ±12V supply, 0.1µF decoupling caps'
            },
            {
                name: 'Low-Pass Audio Filter', icon: '🎵', cat: 'Signal', diff: 'Beginner',
                desc: 'Passive RC filter cutting frequencies above 3.4kHz (telephone band).',
                prompt: 'RC low-pass filter with 47kΩ resistor and 1µF capacitor, cutoff at 3.4kHz for audio filtering'
            },
            // ── Oscillators & Timing ──────────────────────────────────────────────────
            {
                name: '555 Astable (1Hz LED)', icon: '⏱️', cat: 'Timing', diff: 'Beginner',
                desc: 'Classic 555 timer blinking an LED at 1Hz with 9V battery.',
                prompt: '555 timer in astable mode at 1Hz with R1=1kΩ, R2=68kΩ, C=10µF, LED with 220Ω resistor on output, 9V supply'
            },
            {
                name: '555 Monostable Pulse', icon: '📶', cat: 'Timing', diff: 'Intermediate',
                desc: '555 one-shot generating a fixed-width pulse on button press.',
                prompt: '555 timer monostable with R=100kΩ and C=100µF for 11-second pulse, trigger button with 10kΩ pull-up, output LED with 470Ω resistor'
            },
            // ── Protection & Safety ───────────────────────────────────────────────────
            {
                name: 'Reverse Polarity Protection', icon: '🛡️', cat: 'Protection', diff: 'Beginner',
                desc: 'P-channel MOSFET protecting circuit from reversed power supply.',
                prompt: 'Reverse polarity protection using P-channel MOSFET IRF9540 with 10kΩ gate pull-up resistor between battery and circuit VCC'
            },
            {
                name: 'Overvoltage Crowbar', icon: '⚡', cat: 'Protection', diff: 'Advanced',
                desc: 'Zener + SCR crowbar circuit blowing a fuse on overvoltage.',
                prompt: 'Crowbar overvoltage protection with 5.1V Zener diode, SCR 2N5060, 1kΩ gate resistor, 500mA fuse on input to protect 5V circuit'
            },
            {
                name: 'ESD Protection', icon: '🔌', cat: 'Protection', diff: 'Intermediate',
                desc: 'TVS diodes and series resistors protecting I/O lines.',
                prompt: 'ESD protection circuit with PRTR5V0U2X TVS diode array and 33Ω series resistors on USB D+ and D- lines, 100nF decoupling cap'
            },
        ];

        // Override the original TEMPLATES with maker-grade ones
        // and upgrade renderTemplates to show categories + search
        function renderTemplates() {
            const grid = document.getElementById('tpl-grid');
            if (!grid) return;
            const allTemplates = [...TEMPLATES, ...MAKER_TEMPLATES];

            // Get unique categories
            const cats = ['All', ...new Set(MAKER_TEMPLATES.map(t => t.cat))];
            const diffColors = { 'Beginner': '#4caf50', 'Intermediate': '#ff9800', 'Advanced': '#f44336' };

            grid.innerHTML = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center;">
          <input id="tpl-search" placeholder="🔍 Search templates..." oninput="filterTemplates(this.value)"
            style="flex:1;min-width:180px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;
                   padding:8px 12px;color:var(--text);font-size:.74rem;"/>
          <div style="display:flex;gap:5px;flex-wrap:wrap;" id="tpl-cat-btns">
            ${cats.map(c => `<button onclick="filterTemplatesByCat('${c}',this)"
              class="tpl-cat-btn ${c === 'All' ? 'active' : ''}"
              style="padding:5px 11px;font-size:.63rem;border-radius:5px;cursor:pointer;
                     border:1px solid ${c === 'All' ? 'var(--accent)' : 'var(--border)'};
                     background:${c === 'All' ? 'rgba(0,200,240,.15)' : 'var(--bg3)'};
                     color:${c === 'All' ? 'var(--accent)' : 'var(--text-dim)'};
                     font-family:'JetBrains Mono',monospace;white-space:nowrap;">${c}</button>`).join('')}
          </div>
        </div>
        <div id="tpl-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;">
          ${allTemplates.map((t, i) => `
            <div class="tpl-card" data-cat="${t.cat || 'Basic'}" data-name="${t.name.toLowerCase()}" data-desc="${(t.desc || '').toLowerCase()}"
                 style="cursor:pointer;transition:transform .15s,border-color .15s;" onmouseenter="this.style.transform='translateY(-2px)'" onmouseleave="this.style.transform=''">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:1.3rem;">${t.icon}</span>
                <div>
                  <div style="font-size:.78rem;font-weight:600;color:var(--text);">${t.name}</div>
                  ${t.cat ? `<span style="font-size:.6rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">${t.cat}</span>` : ''}
                </div>
                <span style="margin-left:auto;font-size:.6rem;padding:2px 7px;border-radius:4px;
                             background:${diffColors[t.diff] + '22'};color:${diffColors[t.diff] || '#888'};
                             border:1px solid ${diffColors[t.diff] + '44'};white-space:nowrap;">${t.diff || ''}</span>
              </div>
              <p style="font-size:.72rem;color:var(--text-dim);line-height:1.5;margin-bottom:10px;">${t.desc}</p>
              <button class="btn btn-primary" style="width:100%;font-size:.7rem;" onclick="loadTemplatePrompt(${JSON.stringify(t.prompt).replace(/"/g, '&quot;')})">⚡ Load</button>
            </div>`).join('')}
        </div>`;
        }

        function loadTemplatePrompt(prompt) {
            document.getElementById('sch-input').value = prompt;
            const tabs = document.querySelectorAll('.tab');
            // Find schematic tab
            const schTab = Array.from(tabs).find(t => t.getAttribute('onclick')?.includes("'schematic'"));
            if (schTab) switchTab('schematic', schTab);
            const inp = document.getElementById('sch-input');
            inp.style.borderColor = 'var(--accent)';
            inp.focus();
            setTimeout(() => inp.style.borderColor = '', 1500);
            showToast('✅ Template loaded — press ⚡ Generate to build it!');
        }

        function filterTemplates(q) {
            const cards = document.querySelectorAll('#tpl-cards .tpl-card');
            const qLow = q.toLowerCase();
            cards.forEach(c => {
                const text = (c.dataset.name || '') + ' ' + (c.dataset.desc || '') + ' ' + (c.dataset.cat || '');
                c.style.display = !q || text.includes(qLow) ? '' : 'none';
            });
        }

        function filterTemplatesByCat(cat, btn) {
            document.querySelectorAll('.tpl-cat-btn').forEach(b => {
                b.style.borderColor = 'var(--border)';
                b.style.background = 'var(--bg3)';
                b.style.color = 'var(--text-dim)';
            });
            btn.style.borderColor = 'var(--accent)';
            btn.style.background = 'rgba(0,200,240,.15)';
            btn.style.color = 'var(--accent)';
            const cards = document.querySelectorAll('#tpl-cards .tpl-card');
            cards.forEach(c => {
                c.style.display = cat === 'All' || c.dataset.cat === cat ? '' : 'none';
            });
        }

        // ── INIT: Add calculator button, cart button, re-render templates ──────────
        setTimeout(() => {
            // Add 🔧 Calc button to header
            const headerActions = document.querySelector('.header-actions');
            if (headerActions && !document.getElementById('calc-trigger')) {
                const calcBtn = document.createElement('button');
                calcBtn.id = 'calc-trigger';
                calcBtn.className = 'btn btn-sm';
                calcBtn.style.cssText = 'background:linear-gradient(135deg,#1a2a00,#0a3a1a);border-color:#2a6a2a;color:#4caf50;';
                calcBtn.innerHTML = '🔧 Calc';
                calcBtn.onclick = () => openCalculator('ohm');
                calcBtn.title = 'Component Calculator (Ohm\'s Law, LED, 555 Timer, etc.)';
                headerActions.insertBefore(calcBtn, headerActions.firstChild);
            }

            // Add 🛒 Cart button to BOM panel header
            const bomDlBtn = document.getElementById('bom-dl');
            if (bomDlBtn && !document.getElementById('bom-cart')) {
                const cartBtn = document.createElement('button');
                cartBtn.id = 'bom-cart';
                cartBtn.className = 'btn btn-sm';
                cartBtn.style.cssText = 'display:none;background:linear-gradient(135deg,#1a1000,#2a1400);border-color:#ff6600;color:#ff9933;';
                cartBtn.innerHTML = '🛒 Shop';
                cartBtn.onclick = generateShoppingCart;
                cartBtn.title = 'Generate shopping cart for Mouser / DigiKey';
                bomDlBtn.parentNode.insertBefore(cartBtn, bomDlBtn);
            }

            // Show cart button when BOM is generated
            const _origRenderBOM = renderBOM;
            window.renderBOM = function (bom) {
                _origRenderBOM(bom);
                const cb = document.getElementById('bom-cart');
                if (cb) cb.style.display = 'inline-flex';
            };

            // Re-render templates with new expanded set
            renderTemplates();
        }, 800);

        // CSS for calculator modal
        const calcStyle = document.createElement('style');
        calcStyle.textContent = `
      .calc-row { margin-bottom:10px; }
      .calc-row label { display:block;font-size:.65rem;color:#5588aa;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;margin-bottom:4px; }
      .calc-row input, .calc-row select { width:100%;background:#07090f;border:1px solid #1a3a5a;border-radius:6px;padding:9px 12px;color:#c8d8e8;font-size:.8rem;box-sizing:border-box; }
      .calc-row input:focus { outline:none;border-color:var(--accent); }
      .calc-btn { width:100%;margin-top:8px;background:linear-gradient(135deg,#1a3a5a,#0a2a4a);border:1px solid #3a7bd5;color:#c8d8e8;border-radius:7px;padding:10px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:.78rem;letter-spacing:.5px;transition:background .2s; }
      .calc-btn:hover { background:linear-gradient(135deg,#2a4a6a,#1a3a5a); }
      .calc-result { margin-top:12px;background:#07090f;border:1px solid #1a2a4a;border-radius:8px;padding:12px 14px;font-size:.78rem;color:#c8d8e8;line-height:1.6;min-height:40px; }
      .calc-answer { font-family:'JetBrains Mono',monospace;font-size:.82rem;color:#00c8f0;margin-bottom:4px; }
      .calc-hint { font-size:.66rem;color:#5588aa;font-style:italic;margin-bottom:8px; }
      .calc-fields { animation: fadeIn .2s ease; }
      @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
    `;
        document.head.appendChild(calcStyle);


    </script>
</body>

</html>