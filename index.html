<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Circuit Copilot — AI Circuit Design Assistant</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
  <meta name="description"
    content="AI-powered circuit design assistant. Describe circuits in plain English and get schematics, simulations, Arduino code, and BOM instantly. Powered by Groq LLaMA 3.3 70B.">
  <meta name="keywords" content="circuit design, AI, schematic generator, Arduino, electronics, simulation, BOM">
  <meta name="author" content="Circuit Copilot">
  <meta property="og:title" content="Circuit Copilot — AI Circuit Design Assistant">
  <meta property="og:description"
    content="Describe circuits in plain English → get schematics, simulations, Arduino code, and BOM instantly.">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Circuit Copilot — AI Circuit Design">
  <meta name="twitter:description"
    content="AI-powered circuit design: schematics, simulations, Arduino code & BOM from natural language.">
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;600;700;800&display=swap"
    rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ── THEME VARIABLES ──────────────────────────────────────────────────── */
    [data-theme="dark"] {
      --bg: #07090f;
      --bg2: #0d1120;
      --bg3: #121828;
      --panel: #0a0f1c;
      --border: #1c2d4a;
      --border2: #243550;
      --accent: #00c8f0;
      --accent2: #00f090;
      --accent3: #ff7043;
      --warn: #ffb300;
      --purple: #a855f7;
      --text: #c4d4e8;
      --text-dim: #4a6a8a;
      --text-hi: #eaf4ff;
      --shadow: 0 4px 24px rgba(0, 0, 0, .5);
      --input-bg: #060a12;
      --chat-user: linear-gradient(135deg, #001e44, #003366);
      --chat-asst: #121828;
    }

    [data-theme="light"] {
      --bg: #f0f4f8;
      --bg2: #e4eaf2;
      --bg3: #d8e2ee;
      --panel: #ffffff;
      --border: #c0cfe0;
      --border2: #a8bdd4;
      --accent: #0077aa;
      --accent2: #007744;
      --accent3: #cc4400;
      --warn: #bb7700;
      --purple: #7722cc;
      --text: #1a2a3a;
      --text-dim: #6a8aaa;
      --text-hi: #0a1a2a;
      --shadow: 0 4px 24px rgba(0, 0, 0, .1);
      --input-bg: #ffffff;
      --chat-user: linear-gradient(135deg, #cce4ff, #aad4ff);
      --chat-asst: #e8f0f8;
    }

    /* ── BASE ─────────────────────────────────────────────────────────────── */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      min-height: 100vh;
      transition: background .3s, color .3s;
    }

    [data-theme="dark"] body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        linear-gradient(rgba(0, 200, 240, .022) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 200, 240, .022) 1px, transparent 1px);
      background-size: 48px 48px;
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    /* ── HEADER ───────────────────────────────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 50;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 11px;
    }

    .logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 9px;
      font-size: 18px;
      background: linear-gradient(135deg, var(--bg3), var(--bg2));
      border: 1.5px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(0, 200, 240, .25);
      animation: pulse 3s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 10px rgba(0, 200, 240, .15);
      }

      50% {
        box-shadow: 0 0 25px rgba(0, 200, 240, .45);
      }
    }

    .logo-info h1 {
      font-size: 1.1rem;
      color: var(--accent);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-weight: 800;
    }

    .logo-info p {
      font-size: .62rem;
      color: var(--text-dim);
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent2);
      animation: blink 2s infinite;
      flex-shrink: 0;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .3;
      }
    }

    .status-txt {
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      color: var(--accent2);
    }

    /* ── THEME TOGGLE ─────────────────────────────────────────────────────── */
    .theme-toggle {
      width: 50px;
      height: 26px;
      border-radius: 13px;
      background: var(--bg3);
      border: 1px solid var(--border2);
      cursor: pointer;
      position: relative;
      transition: background .3s;
      flex-shrink: 0;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      transition: transform .3s;
    }

    [data-theme="light"] .theme-toggle::after {
      transform: translateX(24px);
      background: var(--warn);
    }

    .theme-icons {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 5px;
      font-size: 10px;
      pointer-events: none;
    }

    /* ── BUTTONS ──────────────────────────────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-family: 'Syne', sans-serif;
      font-size: .78rem;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      letter-spacing: .5px;
      text-transform: uppercase;
    }

    .btn-primary {
      background: var(--bg3);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .btn-primary:hover {
      box-shadow: 0 0 18px rgba(0, 200, 240, .3);
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: .68rem;
      background: var(--bg3);
      border: 1px solid var(--border2);
      color: var(--text-dim);
    }

    .btn-sm:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-green {
      background: var(--bg3);
      color: var(--accent2);
      border: 1px solid var(--accent2);
      font-size: .72rem;
      padding: 6px 11px;
    }

    .btn-green:hover {
      box-shadow: 0 0 15px rgba(0, 240, 144, .3);
      transform: translateY(-1px);
    }

    .btn-orange {
      background: var(--bg3);
      color: var(--accent3);
      border: 1px solid var(--accent3);
      font-size: .72rem;
      padding: 6px 11px;
    }

    .btn-orange:hover {
      box-shadow: 0 0 15px rgba(255, 112, 67, .3);
      transform: translateY(-1px);
    }

    .btn-purple {
      background: var(--bg3);
      color: var(--purple);
      border: 1px solid var(--purple);
      font-size: .72rem;
      padding: 6px 11px;
    }

    .btn-purple:hover {
      box-shadow: 0 0 15px rgba(168, 85, 247, .3);
      transform: translateY(-1px);
    }

    /* ── PROJECT BAR ──────────────────────────────────────────────────────── */
    .project-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 14px;
      margin-bottom: 13px;
    }

    .project-bar label {
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .project-bar input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: 'Syne', sans-serif;
      font-size: .95rem;
      font-weight: 700;
      color: var(--text-hi);
      min-width: 0;
    }

    .project-bar input::placeholder {
      color: var(--text-dim);
    }

    /* ── TABS ─────────────────────────────────────────────────────────────── */
    .tabs {
      display: flex;
      gap: 3px;
      margin-bottom: 14px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: 4px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
    }

    .tabs::-webkit-scrollbar {
      height: 2px;
    }

    .tabs::-webkit-scrollbar-thumb {
      background: var(--border2);
    }

    .tab {
      flex: 1;
      min-width: 80px;
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text-dim);
      font-family: 'Syne', sans-serif;
      font-size: .74rem;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      white-space: nowrap;
      scroll-snap-align: start;
    }

    .tab:hover {
      color: var(--text);
      background: var(--bg3);
    }

    .tab.active {
      background: var(--bg3);
      color: var(--accent);
      border: 1px solid var(--border2);
      box-shadow: 0 0 14px rgba(0, 200, 240, .18);
    }

    /* ── WORKSPACE ────────────────────────────────────────────────────────── */
    .workspace {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items: start;
    }

    @media(max-width:800px) {
      .workspace {
        grid-template-columns: 1fr;
      }
    }

    /* ── DASHBOARD ───────────────────────────────────────────────────────── */
    .dash-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: transform .2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      border-color: var(--accent);
    }

    .stat-val {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--accent);
      font-family: 'Syne', sans-serif;
      margin: 8px 0;
    }

    .stat-lbl {
      font-size: .74rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .skill-box {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .skill-row {
      margin-bottom: 12px;
    }

    .skill-hdr {
      display: flex;
      justify-content: space-between;
      font-size: .72rem;
      margin-bottom: 6px;
    }

    .skill-name {
      color: var(--text-hi);
      font-weight: 600;
    }

    .skill-pct {
      color: var(--accent2);
      font-family: 'JetBrains Mono', monospace;
    }

    .skill-bar {
      height: 6px;
      background: var(--bg3);
      border-radius: 3px;
      overflow: hidden;
    }

    .skill-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .5s ease-out;
    }

    .achieve-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .badge-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--bg3);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      filter: grayscale(1);
      opacity: .3;
      transition: all .3s;
      position: relative;
      cursor: help;
    }

    .badge-icon.unlocked {
      filter: grayscale(0);
      opacity: 1;
      border-color: var(--warn);
      box-shadow: 0 0 15px rgba(255, 179, 0, .3);
    }

    .badge-icon:hover .badge-tip {
      display: block;
    }

    .badge-tip {
      display: none;
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg);
      border: 1px solid var(--accent);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: .62rem;
      color: var(--text);
      white-space: nowrap;
      z-index: 100;
      pointer-events: none;
    }

    /* ── BREADBOARD VIEW ──────────────────────────────────────────────────── */
    .bb-container {
      background: #e0e0e0;
      border-radius: 15px;
      padding: 25px;
      border: 4px solid #bdbdbd;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .bb-grid {
      display: grid;
      grid-template-rows: repeat(12, 12px);
      gap: 4px;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      min-width: 800px;
    }

    .bb-row {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .bb-hole {
      width: 8px;
      height: 8px;
      background: #cecece;
      border-radius: 2px;
    }

    .bb-hole.active {
      background: var(--accent);
      box-shadow: 0 0 5px var(--accent);
    }

    .bb-rail-red {
      height: 2px;
      background: #ff5252;
      width: 100%;
      margin: 4px 0;
    }

    .bb-rail-blue {
      height: 2px;
      background: #448aff;
      width: 100%;
      margin: 4px 0;
    }

    .guide-step {
      background: var(--bg2);
      border-left: 3px solid var(--accent);
      padding: 10px 14px;
      margin-bottom: 10px;
      border-radius: 0 8px 8px 0;
    }

    .guide-num {
      font-weight: 800;
      color: var(--accent);
      margin-right: 8px;
      font-family: 'Syne', sans-serif;
    }

    .guide-txt {
      font-size: .78rem;
      color: var(--text);
      line-height: 1.4;
    }

    .bb-pin {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg3);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: .7rem;
      color: var(--accent2);
    }

    /* ── AI AUDIT ─────────────────────────────────────────────────────────── */
    .audit-results {
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .audit-item {
      padding: 12px 16px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      border-bottom: 1px solid var(--border);
    }

    .audit-item:last-child {
      border-bottom: none;
    }

    .audit-warn {
      background: rgba(255, 179, 0, 0.05);
    }

    .audit-err {
      background: rgba(255, 82, 82, 0.05);
    }

    .audit-tip {
      background: rgba(0, 200, 240, 0.05);
    }

    .audit-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .audit-content h5 {
      font-size: .78rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-hi);
    }

    .audit-content p {
      font-size: .74rem;
      color: var(--text);
      line-height: 1.4;
    }

    .btn-warn {
      background: var(--bg2);
      color: var(--warn);
      border: 1px solid var(--warn);
    }

    .btn-warn:hover {
      background: var(--warn);
      color: var(--bg);
      box-shadow: 0 0 15px rgba(255, 179, 0, .3);
    }

    /* ── VIRTUAL PROBE ───────────────────────────────────────────────────── */
    .probe-tip {
      position: fixed;
      background: var(--panel);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 12px;
      font-size: .74rem;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;
      min-width: 140px;
      pointer-events: auto;
    }

    .probe-tip h6 {
      color: var(--accent);
      font-size: .6rem;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .probe-val {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--text-hi);
      font-family: 'JetBrains Mono', monospace;
    }

    .probe-actions {
      margin-top: 8px;
      display: flex;
      gap: 5px;
    }

    .probe-node {
      cursor: crosshair;
      transition: background .2s;
    }

    .probe-node:hover {
      background: var(--bg3);
    }

    .probed {
      border-left: 3px solid var(--accent) !important;
      padding-left: 8px !important;
    }

    /* ── CHALLENGE UI ────────────────────────────────────────────────────── */
    .challenge-box {
      background: var(--bg2);
      border: 1px solid var(--accent3);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }

    .challenge-title {
      font-size: .8rem;
      color: var(--accent3);
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .challenge-desc {
      font-size: .76rem;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .challenge-input {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 6px;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: .74rem;
      outline: none;
      margin-bottom: 10px;
    }

    /* ── FLASHCARDS ─────────────────────────────────────────────────────── */
    .flash-wrap {
      perspective: 1000px;
      width: 100%;
      height: 200px;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .flash-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flash-wrap.flipped .flash-inner {
      transform: rotateY(180deg);
    }

    .flash-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .2);
    }

    .flash-front {
      background: var(--bg2);
    }

    .flash-back {
      background: var(--bg3);
      transform: rotateY(180deg);
      text-align: center;
    }

    .flash-sym {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .flash-name {
      font-size: 1rem;
      color: var(--accent);
      font-weight: 700;
    }

    .flash-desc {
      font-size: .74rem;
      color: var(--text-dim);
      line-height: 1.4;
    }

    /* ── TAB SCROLLER ────────────────────────────────────────────────────── */
    .tabs-scroller {
      position: sticky;
      top: 60px;
      background: var(--bg);
      z-index: 45;
      border-bottom: 1px solid var(--border);
    }

    /* ── PANELS ───────────────────────────────────────────────────────────── */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .panel-hdr {
      padding: 10px 13px;
      background: var(--bg3);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      color: var(--accent);
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .panel-body {
      padding: 13px;
    }

    /* ── INPUT ────────────────────────────────────────────────────────────── */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-hi);
      font-family: 'JetBrains Mono', monospace;
      font-size: .84rem;
      padding: 10px;
      resize: vertical;
      line-height: 1.65;
      transition: all .2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 200, 240, .1);
    }

    textarea::placeholder {
      color: var(--text-dim);
    }

    .chat-input-row {
      display: flex;
      gap: 7px;
      margin-top: 8px;
      align-items: flex-end;
    }

    .chat-input-row textarea {
      min-height: 52px;
      flex: 1;
    }

    /* ── VOICE ────────────────────────────────────────────────────────────── */
    .voice-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid var(--border2);
      background: var(--bg3);
      color: var(--text-dim);
      font-size: .95rem;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .voice-btn:hover {
      border-color: var(--accent2);
      color: var(--accent2);
    }

    .voice-btn.recording {
      border-color: #ff4444;
      color: #ff4444;
      background: rgba(255, 68, 68, .1);
      animation: rec-pulse 1s ease-in-out infinite;
    }

    @keyframes rec-pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(255, 68, 68, .4);
      }

      50% {
        box-shadow: 0 0 0 7px rgba(255, 68, 68, 0);
      }
    }

    /* ── CHAT ─────────────────────────────────────────────────────────────── */
    .chat-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      scroll-behavior: smooth;
    }

    .chat-area::-webkit-scrollbar {
      width: 3px;
    }

    .chat-area::-webkit-scrollbar-thumb {
      background: var(--border2);
    }

    .msg {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: .84rem;
      line-height: 1.6;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--chat-user);
      border: 1px solid var(--border2);
      color: var(--text-hi);
      border-bottom-right-radius: 3px;
      max-width: 88%;
    }

    .msg.assistant {
      align-self: flex-start;
      background: var(--chat-asst);
      border: 1px solid var(--border);
      color: var(--text);
      border-bottom-left-radius: 3px;
      max-width: 100%;
    }

    .msg.assistant h1,
    .msg.assistant h2,
    .msg.assistant h3 {
      color: var(--accent);
      margin: 7px 0 4px;
      font-size: .95em;
    }

    .msg.assistant strong {
      color: var(--accent2);
    }

    .msg.assistant code {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'JetBrains Mono', monospace;
      font-size: .8em;
      color: var(--accent3);
    }

    .msg.assistant pre {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      overflow-x: auto;
      margin: 7px 0;
    }

    .msg.assistant pre code {
      background: none;
      border: none;
      padding: 0;
      color: var(--accent2);
      font-size: .82rem;
    }

    .msg.assistant ul,
    .msg.assistant ol {
      padding-left: 16px;
      margin: 5px 0;
    }

    .msg.assistant p {
      margin: 4px 0;
    }

    .msg.assistant table {
      width: 100%;
      border-collapse: collapse;
      font-size: .8rem;
      margin: 7px 0;
    }

    .msg.assistant th {
      background: var(--bg3);
      color: var(--accent);
      padding: 5px 8px;
      border: 1px solid var(--border);
    }

    .msg.assistant td {
      padding: 4px 8px;
      border: 1px solid var(--border);
    }

    /* ── CHIPS ────────────────────────────────────────────────────────────── */
    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 6px;
    }

    .chip {
      padding: 3px 9px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: .68rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: all .15s;
      font-family: 'JetBrains Mono', monospace;
    }

    .chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--bg2);
    }

    /* ── LOADING ──────────────────────────────────────────────────────────── */
    .loading {
      display: none;
      align-items: center;
      gap: 8px;
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      font-size: .76rem;
      padding: 10px 0;
    }

    .loading.visible {
      display: flex;
    }

    .spinner {
      width: 15px;
      height: 15px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ── SKELETON LOADERS ────────────────────────────────────────────────── */
    .skeleton-wrap {
      padding: 12px 0;
    }

    .skeleton-line {
      height: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.4s ease-in-out infinite;
    }

    .skeleton-line:nth-child(1) {
      width: 85%;
    }

    .skeleton-line:nth-child(2) {
      width: 70%;
    }

    .skeleton-line:nth-child(3) {
      width: 92%;
    }

    .skeleton-line:nth-child(4) {
      width: 60%;
    }

    .skeleton-line:nth-child(5) {
      width: 78%;
    }

    .skeleton-img {
      height: 180px;
      border-radius: 8px;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--bg3) 25%, var(--border) 50%, var(--bg3) 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.4s ease-in-out infinite;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* ── OUTPUTS ──────────────────────────────────────────────────────────── */
    .schematic-img {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 160px;
      color: var(--text-dim);
      gap: 8px;
      text-align: center;
    }

    .placeholder-icon {
      font-size: 2rem;
      opacity: .28;
    }

    .placeholder p {
      font-size: .76rem;
    }

    .error-msg {
      color: #ff6b6b;
      background: rgba(255, 107, 107, .07);
      border: 1px solid rgba(255, 107, 107, .25);
      border-radius: 6px;
      padding: 7px 11px;
      font-size: .76rem;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 6px;
    }

    /* ── SIM ──────────────────────────────────────────────────────────────── */
    .sim-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 9px;
      margin-bottom: 10px;
    }

    @media(max-width:580px) {
      .sim-grid {
        grid-template-columns: 1fr;
      }
    }

    .sim-card {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
    }

    .sim-card h4 {
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    .node-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      font-size: .8rem;
    }

    .node-row:last-child {
      border-bottom: none;
    }

    .node-name {
      color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
      font-size: .76rem;
    }

    .node-val {
      color: var(--accent2);
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .power-bar-wrap {
      margin: 3px 0;
    }

    .power-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: .74rem;
      margin-bottom: 2px;
    }

    .power-bar {
      height: 5px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .power-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width .8s ease;
    }

    .sim-summary {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 11px 13px;
      font-size: .84rem;
      line-height: 1.6;
      margin-bottom: 11px;
    }

    .sim-warning {
      display: flex;
      gap: 8px;
      background: rgba(255, 179, 0, .06);
      border: 1px solid rgba(255, 179, 0, .22);
      border-radius: 7px;
      padding: 8px 11px;
      font-size: .8rem;
      margin-bottom: 5px;
      color: var(--warn);
    }

    /* ── CANVAS ───────────────────────────────────────────────────────────── */
    .anim-wrap {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 11px;
      background: var(--input-bg);
    }

    #flowCanvas {
      display: block;
      width: 100%;
    }

    #waveCanvas {
      display: block;
      width: 100%;
    }

    /* ── FALSTAD ──────────────────────────────────────────────────────────── */
    .falstad-wrap {
      margin-top: 10px;
    }

    .falstad-wrap iframe {
      width: 100%;
      height: 320px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .falstad-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      margin-bottom: 7px;
      background: var(--bg3);
      border: 1px solid var(--accent);
      border-radius: 7px;
      color: var(--accent);
      font-size: .75rem;
      font-weight: 700;
      text-decoration: none;
      transition: all .2s;
    }

    .falstad-link:hover {
      box-shadow: 0 0 16px rgba(0, 200, 240, .3);
      transform: translateY(-1px);
    }

    /* ── BOM ──────────────────────────────────────────────────────────────── */
    .bom-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
    }

    .bom-table th {
      background: var(--bg3);
      color: var(--accent);
      padding: 6px 9px;
      border: 1px solid var(--border);
      text-align: left;
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .bom-table td {
      padding: 5px 9px;
      border: 1px solid var(--border);
      vertical-align: top;
    }

    .bom-table tr:nth-child(even) td {
      background: var(--bg2);
    }

    .bom-table td a {
      color: var(--accent);
      text-decoration: none;
      font-size: .74rem;
    }

    .bom-table td a:hover {
      text-decoration: underline;
    }

    .bom-meta {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 9px;
      font-size: .78rem;
    }

    .bom-meta span {
      color: var(--text-dim);
    }

    .bom-meta strong {
      color: var(--accent2);
    }

    /* ── QUIZ ─────────────────────────────────────────────────────────────── */
    .quiz-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .quiz-q {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-hi);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quiz-opt {
      padding: 11px 15px;
      border-radius: 8px;
      border: 1px solid var(--border2);
      background: var(--bg3);
      color: var(--text);
      font-size: .88rem;
      cursor: pointer;
      transition: all .2s;
      text-align: left;
      font-family: 'Syne', sans-serif;
    }

    .quiz-opt:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--bg2);
    }

    .quiz-opt.correct {
      border-color: var(--accent2);
      color: var(--accent2);
      background: rgba(0, 240, 144, .08);
    }

    .quiz-opt.wrong {
      border-color: #ff6b6b;
      color: #ff6b6b;
      background: rgba(255, 107, 107, .08);
    }

    .quiz-opt:disabled {
      cursor: default;
    }

    .quiz-explain {
      margin-top: 14px;
      padding: 12px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: .84rem;
      line-height: 1.6;
      color: var(--text);
    }

    .quiz-explain strong {
      color: var(--accent2);
    }

    .quiz-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quiz-score {
      font-family: 'JetBrains Mono', monospace;
      font-size: .8rem;
      color: var(--accent);
    }

    .quiz-level {
      display: flex;
      gap: 6px;
    }

    .level-btn {
      padding: 4px 10px;
      border-radius: 5px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text-dim);
      font-size: .7rem;
      cursor: pointer;
      font-family: 'Syne', sans-serif;
    }

    .level-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--bg2);
    }

    .quiz-progress {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-bottom: 14px;
      overflow: hidden;
    }

    .quiz-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 2px;
      transition: width .4s;
    }

    /* ── WAVEFORM ─────────────────────────────────────────────────────────── */
    .wave-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .wave-controls label {
      font-family: 'JetBrains Mono', monospace;
      font-size: .7rem;
      color: var(--text-dim);
    }

    .wave-controls input[type=range] {
      width: 100px;
      accent-color: var(--accent);
    }

    .wave-controls select {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: .76rem;
      font-family: 'JetBrains Mono', monospace;
    }

    .wave-stat {
      font-family: 'JetBrains Mono', monospace;
      font-size: .72rem;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 3px 8px;
      color: var(--accent2);
    }

    /* ── SAVED ────────────────────────────────────────────────────────────── */
    .saved-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .saved-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 9px 12px;
      gap: 8px;
    }

    .saved-item-info {
      flex: 1;
      min-width: 0;
    }

    .saved-item-name {
      font-weight: 700;
      color: var(--text-hi);
      font-size: .84rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-item-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: .66rem;
      color: var(--text-dim);
    }

    /* ── LEARN ────────────────────────────────────────────────────────────── */
    .learn-output {
      font-size: .88rem;
      line-height: 1.75;
    }

    .learn-output h2 {
      color: var(--accent2);
      font-size: .95rem;
      margin: 13px 0 5px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 3px;
    }

    .learn-output h3 {
      color: var(--accent);
      font-size: .88rem;
      margin: 9px 0 4px;
    }

    .learn-output strong {
      color: var(--accent2);
    }

    .learn-output code {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: 'JetBrains Mono', monospace;
      font-size: .8em;
      color: var(--accent3);
    }

    .learn-output pre {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      overflow-x: auto;
      margin: 7px 0;
    }

    .learn-output pre code {
      background: none;
      border: none;
      padding: 0;
      color: var(--accent2);
    }

    .learn-output ul,
    .learn-output ol {
      padding-left: 18px;
      margin: 5px 0;
    }

    .learn-output p {
      margin: 5px 0;
    }

    /* ── META TAGS ────────────────────────────────────────────────────────── */
    .meta-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 7px;
    }

    .meta-tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: .68rem;
      font-family: 'JetBrains Mono', monospace;
    }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 4px;
      font-size: .64rem;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }

    .badge-ok {
      background: rgba(0, 240, 144, .1);
      color: var(--accent2);
      border: 1px solid rgba(0, 240, 144, .25);
    }

    .badge-warn {
      background: rgba(255, 179, 0, .1);
      color: var(--warn);
      border: 1px solid rgba(255, 179, 0, .25);
    }

    .badge-info {
      background: rgba(0, 200, 240, .1);
      color: var(--accent);
      border: 1px solid rgba(0, 200, 240, .25);
    }

    .slabel {
      font-family: 'JetBrains Mono', monospace;
      font-size: .65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 6px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 11px 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ── TEMPLATES ────────────────────────────────────────────────────────── */
    .tpl-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }

    .tpl-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      transition: all .2s;
      cursor: default;
    }

    .tpl-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0, 200, 240, .15);
    }

    .tpl-card h3 {
      color: var(--text-hi);
      font-size: .95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tpl-card p {
      font-size: .78rem;
      color: var(--text-dim);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .tpl-card .tpl-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    /* ── COMPONENT REFERENCE ──────────────────────────────────────────────── */
    .ref-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .ref-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all .15s;
    }

    .ref-card:hover {
      border-color: var(--accent);
      background: var(--bg2);
    }

    .ref-card h4 {
      font-size: .82rem;
      color: var(--text-hi);
      margin-bottom: 3px;
    }

    .ref-card .ref-formula {
      font-family: 'JetBrains Mono', monospace;
      font-size: .72rem;
      color: var(--accent2);
    }

    .ref-card .ref-vals {
      font-size: .68rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .ref-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 0;
      color: var(--accent);
      font-size: .78rem;
      font-weight: 700;
      border: none;
      background: none;
      font-family: 'Syne', sans-serif;
    }

    .ref-toggle:hover {
      color: var(--accent2);
    }

    /* ── SHORTCUTS MODAL ──────────────────────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
    }

    .modal h2 {
      color: var(--accent);
      font-size: 1.1rem;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal .close-modal {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal .close-modal:hover {
      color: var(--accent);
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: .82rem;
    }

    .shortcut-row:last-child {
      border-bottom: none;
    }

    .shortcut-key {
      display: inline-flex;
      gap: 4px;
    }

    .shortcut-key kbd {
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: 4px;
      padding: 2px 7px;
      font-family: 'JetBrains Mono', monospace;
      font-size: .72rem;
      color: var(--accent);
      min-width: 22px;
      text-align: center;
    }

    footer {
      text-align: center;
      padding: 18px 0 10px;
      color: var(--text-dim);
      font-size: .66rem;
      font-family: 'JetBrains Mono', monospace;
      border-top: 1px solid var(--border);
      margin-top: 24px;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }



    /* ── ONBOARDING TOUR ──────────────────────────────────────────────── */
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      z-index: 300;
      transition: opacity .3s;
    }

    .tour-spotlight {
      position: absolute;
      border-radius: 10px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, .6), 0 0 0 3px var(--accent), 0 0 20px var(--accent);
      transition: all .4s ease;
      z-index: 301;
    }

    .tour-tooltip {
      position: absolute;
      background: var(--panel);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 16px 20px;
      max-width: 320px;
      z-index: 302;
      box-shadow: 0 8px 32px rgba(0, 0, 0, .5);
    }

    .tour-tooltip h3 {
      font-size: .9rem;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .tour-tooltip p {
      font-size: .78rem;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .tour-tooltip .tour-btns {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .tour-tooltip .tour-btns button {
      padding: 5px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text);
      font-size: .72rem;
      cursor: pointer;
      font-family: 'Syne', sans-serif;
    }

    .tour-tooltip .tour-btns .tour-next {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 700;
    }

    .tour-step-counter {
      font-size: .64rem;
      color: var(--text-dim);
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* ── OHM'S LAW CALCULATOR ────────────────────────────────────────── */
    .ohm-calc {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-top: 12px;
    }

    .ohm-calc h4 {
      font-size: .76rem;
      color: var(--accent);
      margin-bottom: 10px;
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .ohm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .ohm-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .ohm-field label {
      font-size: .66rem;
      color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
    }

    .ohm-field input {
      padding: 7px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: .82rem;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      transition: border-color .2s;
    }

    .ohm-field input:focus {
      border-color: var(--accent);
    }

    .ohm-field input.computed {
      border-color: var(--accent2);
      background: rgba(0, 240, 144, .05);
    }

    /* ── CALCULATOR WIDGET ───────────────────────────────────────────── */
    .calc-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .calc-tab {
      padding: 4px 10px;
      font-size: .64rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg3);
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
    }

    .calc-tab.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 700;
    }

    .calc-group {
      display: none;
    }

    .calc-group.active {
      display: block;
    }

    .calc-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .calc-row .ohm-field {
      flex: 1;
    }

    .ohm-result {
      grid-column: 1/-1;
      padding: 8px;
      background: var(--bg3);
      border-radius: 6px;
      font-size: .74rem;
      color: var(--accent2);
      font-family: 'JetBrains Mono', monospace;
      text-align: center;
      min-height: 28px;
    }

    /* ── CIRCUIT HISTORY ─────────────────────────────────────────────── */
    .history-section {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }

    .history-hdr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-hdr h4 {
      font-size: .72rem;
      color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 5px;
      transition: border-color .2s;
      cursor: pointer;
    }

    .history-item:hover {
      border-color: var(--accent);
    }

    .history-item-info {
      flex: 1;
      min-width: 0;
    }

    .history-item-name {
      font-size: .78rem;
      font-weight: 600;
      color: var(--text-hi);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-time {
      font-size: .6rem;
      color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
    }

    .history-del {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: .9rem;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .history-del:hover {
      color: #ff6b6b;
      background: rgba(255, 107, 107, .1);
    }

    /* ── CONFETTI CANVAS ─────────────────────────────────────────────── */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 400;
    }

    /* ── TAB BADGES ───────────────────────────────────────────────────────── */
    .tab {
      position: relative;
    }

    .tab-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 7px;
      height: 7px;
      background: var(--accent2);
      border-radius: 50%;
      box-shadow: 0 0 6px var(--accent2);
      display: none;
      animation: badge-pulse 2s infinite;
    }

    @keyframes badge-pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: .5;
        transform: scale(1.2);
      }
    }

    /* ── MOBILE RESPONSIVE ────────────────────────────────────────────────── */
    @media (max-width: 768px) {
      .app {
        padding: 0 10px 20px;
      }

      header {
        padding: 10px 0;
      }

      .logo-info h1 {
        font-size: .95rem;
      }

      .logo-badge {
        width: 34px;
        height: 34px;
        font-size: 16px;
      }

      .hdr-right {
        gap: 5px;
      }

      .status-txt {
        display: none;
      }

      /* Hide on very small for space */

      .tabs {
        display: flex;
        overflow-x: auto;
        flex-wrap: nowrap;
        gap: 8px;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        flex: 0 0 auto;
        padding: 6px 12px;
        font-size: .7rem;
      }

      .workspace {
        min-height: 400px;
        flex-direction: column;
        gap: 15px;
      }

      .panel {
        width: 100%;
      }

      .chat-input-row {
        gap: 5px;
      }

      .btn {
        padding: 6px 12px;
        font-size: .72rem;
      }

      .project-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .project-name {
        width: 100%;
        font-size: .8rem;
      }

      .modal {
        width: 95%;
        padding: 15px;
      }

      .tour-tooltip {
        max-width: 280px;
        left: 10px !important;
        right: 10px !important;
      }
    }

    /* ── HARDWARE BRIDGE (SERIAL) ───────────────────────────────────────── */
    .serial-monitor {
      background: #05070a;
      border: 1px solid var(--border);
      border-radius: 8px;
      height: 250px;
      overflow-y: auto;
      padding: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: .75rem;
      color: var(--accent2);
      margin-top: 10px;
      white-space: pre-wrap;
    }

    .serial-controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }

    .serial-plotter {
      width: 100%;
      height: 120px;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 12px;
    }

    /* ── LAB MODE ────────────────────────────────────────────────────────── */
    body.lab-mode {
      background: #000;
      color: #fff;
      font-size: 1.2rem;
    }

    body.lab-mode .panel {
      background: #111;
      border: 2px solid #555;
    }

    body.lab-mode h1,
    body.lab-mode h2,
    body.lab-mode h3,
    body.lab-mode h4,
    body.lab-mode h5 {
      color: var(--accent2);
      font-size: 1.4rem;
    }

    body.lab-mode .tab,
    body.lab-mode .btn,
    body.lab-mode .guide-num {
      transform: scale(1.1);
      font-weight: 800;
    }

    body.lab-mode .workspace {
      gap: 30px;
    }

    body.lab-mode .guide-txt {
      font-size: 1.1rem;
      line-height: 1.6;
    }

    body.lab-mode .meta-tag {
      font-size: .9rem !important;
      padding: 4px 10px;
    }

    /* ── GALLERY ─────────────────────────────────────────────────────────── */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 10px 0;
    }

    .gallery-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: transform .2s, border-color .2s;
    }

    .gallery-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
    }

    .gallery-img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      background: #000;
      border-bottom: 1px solid var(--border);
    }

    .gallery-info {
      padding: 15px;
    }

    .gallery-title {
      font-weight: 700;
      color: var(--text-hi);
      font-size: .9rem;
      margin-bottom: 5px;
    }

    .gallery-desc {
      font-size: .7rem;
      color: var(--text-dim);
      height: 3em;
      overflow: hidden;
      margin-bottom: 12px;
    }

    @media (max-width: 480px) {
      .logo-info p {
        display: none;
      }

      .hdr-right {
        justify-content: flex-end;
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <div class="logo">
        <div class="logo-badge">⚡</div>
        <div class="logo-info">
          <h1>Circuit Copilot</h1>
          <p>v4 · AI Design Assistant</p>
        </div>
      </div>
      <div class="hdr-right">
        <div class="status-dot"></div>
        <span class="status-txt" id="status-txt">ONLINE · llama-3.3-70b</span>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          <div class="theme-icons"><span>🌙</span><span>☀️</span></div>
        </button>
        <button class="btn btn-sm btn-lab"
          style="font-size:.66rem;background:var(--bg3);border:1px solid var(--accent2);color:var(--accent2)"
          onclick="toggleLabMode()" title="Workbench Mode">🔬 LAB MODE</button>
        <button class="btn btn-sm" style="font-size:.66rem" id="btn-collab" onclick="startCollab()">🤝 Collab</button>
        <button class="btn btn-sm" style="font-size:.66rem" onclick="saveCircuit()">💾 Save</button>
        <button class="btn btn-orange" onclick="exportPDF()">📄 PDF</button>
        <button class="btn btn-sm" style="font-size:.66rem" onclick="toggleShortcuts()"
          title="Keyboard shortcuts (?)">⌨️</button>
      </div>
    </header>

    <!-- PROJECT BAR -->
    <div class="project-bar">
      <label>PROJECT:</label>
      <input type="text" id="project-name" placeholder="Untitled Circuit — click to rename" />
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab" onclick="switchTab('dashboard',this)"><span>📊</span>Dashboard<span
          class="tab-badge"></span></button>
      <button class="tab active" onclick="switchTab('schematic',this)"><span>🔌</span>Schematic<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('breadboard',this)"><span>🛠️</span>Breadboard<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('simulate',this)"><span>📊</span>Simulate<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('waveform',this)"><span>〰️</span>Waveform<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('bom',this)"><span>🧾</span>BOM<span class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('components',this)"><span>🧩</span>Parts<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('debug',this)"><span>🔍</span>Debug<span class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('arduino',this)"><span>💻</span>Arduino<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('learn',this)"><span>📚</span>Learn<span class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('quiz',this)"><span>🎯</span>Quiz & Challenges<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('templates',this)"><span>📋</span>Templates<span
          class="tab-badge"></span></button>
      <button class="tab" onclick="switchTab('saved',this)"><span>🗂️</span>Saved<span
          class="tab-badge"></span></button>
      <button class="tab" id="tab-btn-gallery" onclick="switchTab('gallery',this)"><span>🌍</span>Community<span
          class="tab-badge"></span></button>
      <button class="tab" id="tab-btn-architect" onclick="switchTab('architect',this)"><span>🧩</span>Architect<span
          class="tab-badge"></span></button>
    </div>

    <!-- ═══ DASHBOARD ════════════════════════════════════════════════════════ -->
    <div id="tab-dashboard" class="tab-content">
      <div class="workspace" style="display:block;">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// LEARNING DASHBOARD</span></div>
          <div class="panel-body">
            <div class="dash-grid">
              <div class="stat-card">
                <div class="stat-lbl">Circuits Built</div>
                <div class="stat-val" id="dash-circuits">0</div>
                <p style="font-size:.64rem;color:var(--text-dim)">Keep designing!</p>
              </div>
              <div class="stat-card">
                <div class="stat-lbl">Quiz Score</div>
                <div class="stat-val" id="dash-quiz">0</div>
                <p style="font-size:.64rem;color:var(--text-dim)">Master electronics</p>
              </div>
              <div class="stat-card">
                <div class="stat-lbl">Daily Streak</div>
                <div class="stat-val" id="dash-streak">0</div>
                <p style="font-size:.64rem;color:var(--text-dim)">Don't break the chain!</p>
              </div>
            </div>

            <div class="dash-grid" style="grid-template-columns: 1.2fr 1fr;">
              <div class="skill-box">
                <h4 style="font-size:.76rem;color:var(--accent);margin-bottom:12px;text-transform:uppercase;">Skills &
                  Proficiency</h4>
                <div class="skill-row">
                  <div class="skill-hdr"><span class="skill-name">Digital Logic</span><span class="skill-pct"
                      id="skill-digital-pct">0%</span></div>
                  <div class="skill-bar">
                    <div class="skill-fill" id="skill-digital" style="width:0%"></div>
                  </div>
                </div>
                <div class="skill-row">
                  <div class="skill-hdr"><span class="skill-name">Analog Components</span><span class="skill-pct"
                      id="skill-analog-pct">0%</span></div>
                  <div class="skill-bar">
                    <div class="skill-fill" id="skill-analog" style="width:0%"></div>
                  </div>
                </div>
                <div class="skill-row">
                  <div class="skill-hdr"><span class="skill-name">Microcontrollers</span><span class="skill-pct"
                      id="skill-mcu-pct">0%</span></div>
                  <div class="skill-bar">
                    <div class="skill-fill" id="skill-mcu" style="width:0%"></div>
                  </div>
                </div>
              </div>

              <div class="skill-box">
                <h4 style="font-size:.76rem;color:var(--accent);margin-bottom:12px;text-transform:uppercase;">
                  Achievements</h4>
                <div class="achieve-grid" id="achievements">
                  <!-- Badges will be generated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ SCHEMATIC ═══════════════════════════════════════════════════════ -->
    <div id="tab-schematic" class="tab-content active">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// DESCRIBE CIRCUIT</span></div>
          <div class="panel-body">
            <div class="slabel">Describe in English — press 🎤 to speak:</div>
            <div class="chat-area" id="sch-chat"></div>
            <div class="chat-input-row">
              <textarea id="sch-input" placeholder="e.g. LED circuit with 220Ω resistor and 9V battery"></textarea>
              <button class="voice-btn" id="sch-voice" onclick="toggleVoice('sch-input','sch-voice')">🎤</button>
              <button class="btn btn-primary" id="sch-btn" onclick="runSchematic()">⚡</button>
            </div>
            <div id="persona-row" style="margin-top:8px; display:flex; gap:6px; align-items:center;">
              <span style="font-size:.64rem;color:var(--text-dim)">AI PERSONA:</span>
              <select id="ai-persona" class="btn btn-sm"
                style="font-size:.64rem; background:var(--bg3); border-color:var(--border)">
                <option value="general">🤖 General Assistant</option>
                <option value="analog">🔈 Analog Expert</option>
                <option value="embedded">📟 Embedded Engineer</option>
                <option value="power">⚡ Power Specialist</option>
              </select>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('sch','LED with 220Ω resistor and 9V battery')">LED circuit</span>
              <span class="chip" onclick="qs('sch','LED with button switch and 5V')">+ Button</span>
              <span class="chip" onclick="qs('sch','NPN transistor switching a 12V relay')">Transistor relay</span>
              <span class="chip" onclick="qs('sch','Voltage divider 10kΩ and 4.7kΩ')">Voltage divider</span>
            </div>
            <div class="loading" id="sch-loading">
              <div class="spinner"></div>Generating...
            </div>
            <div id="sch-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr">
            <span class="panel-title">// SCHEMATIC OUTPUT</span>
            <div style="display:flex;gap:4px;flex-wrap:wrap;">
              <button class="btn btn-sm" id="sch-share" style="display:none" onclick="shareCircuit()">🔗 Share</button>
              <button class="btn btn-sm" id="sch-screenshot" style="display:none" onclick="screenshotCircuit()">📸
                Screenshot</button>
              <button class="btn btn-sm" id="sch-dl" style="display:none" onclick="dlSchematic()">↓ PNG</button>
              <button class="btn btn-sm btn-warn" id="sch-audit" style="display:none" onclick="runAudit('sch')">🔍 Scan
                for Errors</button>
              <button class="btn btn-sm" id="sch-eda" style="display:none" onclick="exportNetlist()">📦 Netlist</button>
              <button class="btn btn-sm btn-purple" id="sch-kicad" style="display:none" onclick="exportKiCad()">📐
                KiCad</button>
            </div>
          </div>
          <div class="panel-body">
            <div id="sch-ph" class="placeholder">
              <div class="placeholder-icon">📐</div>
              <p>Schematic renders here</p>
            </div>
            <img id="sch-img" class="schematic-img" style="display:none" />
            <div id="sch-meta" class="meta-tags" style="display:none"></div>
            <div id="sch-audit-out" class="audit-results" style="display:none"></div>
            <div id="sch-desc"
              style="margin-top:8px;font-size:.8rem;color:var(--text-dim);display:none;line-height:1.6;"></div>
            <div id="falstad-wrap" style="display:none" class="falstad-wrap">
              <div class="divider"></div>
              <div class="slabel">🔗 Falstad Interactive Simulator</div>
              <a id="falstad-link" class="falstad-link" href="#" target="_blank">↗ Open in Falstad</a>
              <iframe id="falstad-frame" src="" scrolling="no" title="Falstad"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ BREADBOARD ═══════════════════════════════════════════════════════ -->
    <div id="tab-breadboard" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// WIRING GUIDE</span></div>
          <div class="panel-body">
            <div id="bb-instructions">
              <div class="placeholder">
                <div class="placeholder-icon">🛠️</div>
                <p>Generate a schematic first to see wiring steps.</p>
              </div>
            </div>
            <div id="bb-loading" class="loading" style="display:none;margin-top:10px;">
              <div class="spinner"></div>Generating wiring guide...
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// VIRTUAL BREADBOARD</span></div>
          <div class="panel-body">
            <div class="bb-container">
              <div id="bb-visual" class="bb-grid">
                <!-- Javascript will populate this -->
                <p style="color:#666;font-size:.7rem;text-align:center;">Prototyping guide appears here</p>
              </div>
            </div>
            <p style="font-size:.62rem;color:var(--text-dim);margin-top:10px;text-align:center;">Standard 830-point
              Breadboard Layout (Full Size)</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ SIMULATE ════════════════════════════════════════════════════════ -->
    <div id="tab-simulate" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// DC SIMULATION</span></div>
          <div class="panel-body">
            <div class="chat-area" id="sim-chat"></div>
            <div class="chat-input-row">
              <textarea id="sim-input" placeholder="e.g. 9V battery, 220Ω resistor, red LED in series"></textarea>
              <button class="voice-btn" id="sim-voice" onclick="toggleVoice('sim-input','sim-voice')">🎤</button>
              <button class="btn btn-primary" id="sim-btn" onclick="runSimulate()">▶</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('sim','9V battery, 220Ω resistor, red LED')">LED circuit</span>
              <span class="chip" onclick="qs('sim','5V supply, 10kΩ and 4.7kΩ voltage divider')">Divider</span>
              <span class="chip" onclick="qs('sim','12V, 1kΩ base resistor, BC547, 470Ω load')">Transistor</span>
            </div>
            <div class="loading" id="sim-loading">
              <div class="spinner"></div>Running DC analysis...
            </div>
            <div id="sim-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// RESULTS</span></div>
          <div class="panel-body">
            <div id="sim-ph" class="placeholder">
              <div class="placeholder-icon">📊</div>
              <p>Results appear here</p>
            </div>
            <div id="sim-out" style="display:none">
              <div class="slabel">⚡ Current Flow</div>
              <div class="anim-wrap"><canvas id="flowCanvas" height="90"></canvas></div>
              <div id="sim-summary" class="sim-summary"></div>
              <div class="sim-grid">
                <div class="sim-card">
                  <h4>Node Voltages</h4>
                  <div id="sim-nodes"></div>
                </div>
                <div class="sim-card">
                  <h4>Power (mW)</h4>
                  <div id="sim-power"></div>
                </div>
              </div>
              <div id="sim-audit-out" class="audit-results" style="display:none"></div>
              <div class="sim-card" style="margin-bottom:10px;">
                <h4>Currents</h4>
                <div id="sim-branches"></div>
              </div>
              <div id="sim-warns"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ WAVEFORM ═════════════════════════════════════════════════════════ -->
    <div id="tab-waveform" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// WAVEFORM GENERATOR</span></div>
          <div class="panel-body">
            <div class="slabel">Configure your AC/signal waveform:</div>
            <div class="wave-controls">
              <label>Type:</label>
              <select id="w-type" onchange="drawWave()">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="triangle">Triangle</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="pwm">PWM</option>
              </select>
              <label>Freq:</label>
              <input type="range" id="w-freq" min="1" max="200" value="50" oninput="updateWaveLabel();drawWave()" />
              <span class="wave-stat" id="w-freq-lbl">50 Hz</span>
              <label>Amp:</label>
              <input type="range" id="w-amp" min="1" max="24" value="5" oninput="updateWaveLabel();drawWave()" />
              <span class="wave-stat" id="w-amp-lbl">5 V</span>
              <label>DC Offset:</label>
              <input type="range" id="w-offset" min="-12" max="12" value="0" oninput="updateWaveLabel();drawWave()" />
              <span class="wave-stat" id="w-offset-lbl">0 V</span>
              <label>Duty:</label>
              <input type="range" id="w-duty" min="5" max="95" value="50" oninput="updateWaveLabel();drawWave()" />
              <span class="wave-stat" id="w-duty-lbl">50 %</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
              <span class="wave-stat" id="w-period">Period: 20.0 ms</span>
              <span class="wave-stat" id="w-vrms">Vrms: 3.54 V</span>
              <span class="wave-stat" id="w-vpp">Vpp: 10.0 V</span>
            </div>
            <div class="slabel">Ask AI about this waveform:</div>
            <div class="chat-input-row">
              <textarea id="wave-input"
                placeholder="e.g. What happens if I apply this 50Hz signal to an RC low-pass filter?"></textarea>
              <button class="voice-btn" onclick="toggleVoice('wave-input','wave-voice')" id="wave-voice">🎤</button>
              <button class="btn btn-primary" id="wave-btn"
                onclick="runChat('components','wave','wave-output','wave-ph')">→</button>
            </div>
            <div class="loading" id="wave-loading">
              <div class="spinner"></div>Analyzing...
            </div>
            <div id="wave-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// OSCILLOSCOPE</span></div>
          <div class="panel-body">
            <div class="slabel">Live waveform preview:</div>
            <div class="anim-wrap" style="margin-bottom:12px;">
              <canvas id="waveCanvas" height="200"></canvas>
            </div>
            <div id="wave-ph" class="placeholder" style="min-height:80px;">
              <div class="placeholder-icon">〰️</div>
              <p>AI analysis appears here</p>
            </div>
            <div id="wave-output" class="msg assistant" style="display:none;max-width:100%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ BOM ══════════════════════════════════════════════════════════════ -->
    <div id="tab-bom" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// BILL OF MATERIALS</span></div>
          <div class="panel-body">
            <div class="chat-area" id="bom-chat"></div>
            <div class="chat-input-row">
              <textarea id="bom-input" placeholder="e.g. LED blinker with 555 timer, 9V battery, breadboard"></textarea>
              <button class="voice-btn" onclick="toggleVoice('bom-input','bom-voice')" id="bom-voice">🎤</button>
              <button class="btn btn-primary" id="bom-btn" onclick="runBOM()">🧾</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('bom','555 timer LED blinker on breadboard')">555 blinker</span>
              <span class="chip" onclick="qs('bom','Arduino Uno, DHT11 sensor, 16x2 LCD display')">Temp monitor</span>
              <span class="chip" onclick="qs('bom','Simple LED circuit 9V battery 220 ohm resistor')">Basic LED</span>
            </div>
            <div class="loading" id="bom-loading">
              <div class="spinner"></div>Generating BOM...
            </div>
            <div id="bom-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr">
            <span class="panel-title">// PARTS LIST</span>
            <button class="btn btn-green" id="bom-dl" style="display:none" onclick="dlBOM()">↓ CSV</button>
          </div>
          <div class="panel-body">
            <div id="bom-ph" class="placeholder">
              <div class="placeholder-icon">🧾</div>
              <p>Parts list with pricing</p>
            </div>
            <div id="bom-out" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ COMPONENTS ═══════════════════════════════════════════════════════ -->
    <div id="tab-components" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// COMPONENT ADVISOR</span></div>
          <div class="panel-body">
            <div class="chat-area" id="comp-chat"></div>
            <div class="chat-input-row">
              <textarea id="comp-input" placeholder="e.g. What resistor for a red LED on 5V?"></textarea>
              <button class="voice-btn" onclick="toggleVoice('comp-input','comp-voice')" id="comp-voice">🎤</button>
              <button class="btn btn-primary" id="comp-btn"
                onclick="runChat('components','comp','comp-out','comp-ph')">→</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('comp','Resistor for red LED on 5V')">LED resistor</span>
              <span class="chip" onclick="qs('comp','Best capacitor for 100Hz power supply filter')">Filter cap</span>
              <span class="chip" onclick="qs('comp','NPN transistor for 500mA load switching')">NPN switch</span>
            </div>
            <div class="loading" id="comp-loading">
              <div class="spinner"></div>Finding parts...
            </div>
            <div id="comp-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// RECOMMENDATIONS</span></div>
          <div class="panel-body">
            <div id="comp-ph" class="placeholder">
              <div class="placeholder-icon">🧩</div>
              <p>Recommendations here</p>
            </div>
            <div id="comp-out" class="msg assistant" style="display:none;max-width:100%;"></div>
            <div class="divider"></div>
            <button class="ref-toggle" onclick="toggleRef()" id="ref-toggle-btn">▶ Component Reference</button>
            <div id="comp-ref" style="display:none">
              <div class="ref-grid">
                <div class="ref-card" onclick="qs('comp','What resistor do I need for a red LED on 5V?')">
                  <h4>⚡ Resistor</h4>
                  <div class="ref-formula">V = I × R</div>
                  <div class="ref-vals">Common: 220Ω, 1kΩ, 4.7kΩ, 10kΩ</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Best capacitor for power supply filtering?')">
                  <h4>⚡ Capacitor</h4>
                  <div class="ref-formula">Q = C × V</div>
                  <div class="ref-vals">Common: 100nF, 10µF, 100µF, 1000µF</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Explain NPN transistor for switching a motor')">
                  <h4>🔀 Transistor (NPN)</h4>
                  <div class="ref-formula">Ic = β × Ib</div>
                  <div class="ref-vals">Common: 2N2222, BC547, TIP120</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Best LED for indicator light on 3.3V?')">
                  <h4>💡 LED</h4>
                  <div class="ref-formula">Vf ≈ 2V (red), 3.2V (blue)</div>
                  <div class="ref-vals">Typical: 20mA, 2V–3.3V forward</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Which diode for reverse polarity protection?')">
                  <h4>🔒 Diode</h4>
                  <div class="ref-formula">Vf ≈ 0.7V (silicon)</div>
                  <div class="ref-vals">Common: 1N4007, 1N5819 (Schottky)</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Best voltage regulator for 5V from 12V?')">
                  <h4>📐 Voltage Regulator</h4>
                  <div class="ref-formula">P = (Vin - Vout) × I</div>
                  <div class="ref-vals">Common: 7805, LM1117, AMS1117</div>
                </div>
                <div class="ref-card" onclick="qs('comp','What inductor for a 5V buck converter?')">
                  <h4>🌀 Inductor</h4>
                  <div class="ref-formula">V = L × dI/dt</div>
                  <div class="ref-vals">Common: 10µH, 47µH, 100µH</div>
                </div>
                <div class="ref-card" onclick="qs('comp','Best MOSFET for 12V motor control from Arduino?')">
                  <h4>🔌 MOSFET</h4>
                  <div class="ref-formula">Rds(on) × I² = Power loss</div>
                  <div class="ref-vals">Logic-level: IRLZ44N, IRF3205</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ DEBUG ════════════════════════════════════════════════════════════ -->
    <div id="tab-debug" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// CIRCUIT DEBUGGER</span></div>
          <div class="panel-body">
            <div class="chat-area" id="debug-chat"></div>
            <div class="chat-input-row">
              <textarea id="debug-input" placeholder="e.g. My LED burned out when I used 9V directly"></textarea>
              <button class="voice-btn" onclick="toggleVoice('debug-input','debug-voice')" id="debug-voice">🎤</button>
              <button class="btn btn-primary" id="debug-btn"
                onclick="runChat('debug','debug','debug-out','debug-ph')">→</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('debug','Connected 9V directly to LED, it burned')">LED burned</span>
              <span class="chip" onclick="qs('debug','Arduino resets when I run a motor on pin 9')">Arduino
                resets</span>
              <span class="chip" onclick="qs('debug','7805 voltage regulator gets extremely hot')">Hot regulator</span>
            </div>
            <div class="loading" id="debug-loading">
              <div class="spinner"></div>Diagnosing...
            </div>
            <div id="debug-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// DIAGNOSIS</span></div>
          <div class="panel-body">
            <div id="debug-ph" class="placeholder">
              <div class="placeholder-icon">🔍</div>
              <p>Diagnosis here</p>
            </div>
            <div id="debug-out" class="msg assistant" style="display:none;max-width:100%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ ARDUINO ══════════════════════════════════════════════════════════ -->
    <div id="tab-arduino" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// CODE GENERATOR</span></div>
          <div class="panel-body">
            <div class="chat-area" id="ard-chat"></div>
            <div class="chat-input-row">
              <textarea id="ard-input"
                placeholder="e.g. Blink LED on pin 13 every 500ms, faster when button pressed"></textarea>
              <button class="voice-btn" onclick="toggleVoice('ard-input','ard-voice')" id="ard-voice">🎤</button>
              <button class="btn btn-primary" id="ard-btn"
                onclick="runChat('arduino','ard','ard-out','ard-ph')">→</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('ard','Blink LED on pin 13 every 500ms')">LED blink</span>
              <span class="chip" onclick="qs('ard','Read DHT11 temp and humidity, print to serial')">DHT11</span>
              <span class="chip"
                onclick="qs('ard','HC-SR04 ultrasonic sensor, buzzer alert under 20cm')">Ultrasonic</span>
              <span class="chip" onclick="qs('ard','Servo sweep 0-180 when button pressed')">Servo</span>
            </div>
            <div class="loading" id="ard-loading">
              <div class="spinner"></div>Writing code...
            </div>
            <div id="ard-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr">
            <span class="panel-title">// GENERATED CODE</span>
            <button class="btn btn-green" id="ard-dl" style="display:none" onclick="dlArduino()">↓ .ino</button>
          </div>
          <div class="panel-body">
            <div id="ard-ph" class="placeholder">
              <div class="placeholder-icon">💻</div>
              <p>Code appears here</p>
            </div>
            <div id="ard-out" class="msg assistant" style="display:none;max-width:100%;"></div>
          </div>
        </div>
        <div class="panel" style="grid-column: 1 / -1;">
          <div class="panel-hdr">
            <span class="panel-title">// HARDWARE BRIDGE (WEB-SERIAL)</span>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-sm" id="btn-serial-connect" onclick="connectSerial()">🔌 Connect Device</button>
              <button class="btn btn-sm btn-warn" onclick="clearSerial()">🗑️ Clear</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="serial-monitor" id="serial-out">Connect a device to see serial output...</div>
            <canvas class="serial-plotter" id="serial-plot"></canvas>
            <div class="serial-controls">
              <input type="text" id="serial-input" placeholder="Type message to device..."
                style="flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;outline:none;"
                onkeydown="if(event.key==='Enter')sendSerial()" />
              <button class="btn btn-primary" onclick="sendSerial()">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ LEARN ════════════════════════════════════════════════════════════ -->
    <div id="tab-learn" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// LEARN ELECTRONICS</span></div>
          <div class="panel-body">
            <!-- FLASHCARDS -->
            <div class="panel" style="margin-top:20px;">
              <div class="panel-hdr"><span class="panel-title">// COMPONENT FLASHCARDS</span></div>
              <div class="panel-body">
                <div class="flash-wrap" id="flash-card" onclick="this.classList.toggle('flipped')">
                  <div class="flash-inner">
                    <div class="flash-face flash-front">
                      <div class="flash-sym" id="flash-sym">🔋</div>
                      <div class="flash-name" id="flash-name">Battery</div>
                      <p style="font-size:.64rem;color:var(--text-dim);margin-top:10px;">Click to reveal...</p>
                    </div>
                    <div class="flash-face flash-back">
                      <div class="flash-desc" id="flash-desc">Stores chemical energy and converts it to electrical
                        energy. Provides the voltage source for the circuit.</div>
                    </div>
                  </div>
                </div>
                <div style="display:flex;gap:10px;">
                  <button class="btn btn-secondary" style="flex:1" onclick="prevFlash()">Back</button>
                  <button class="btn btn-primary" style="flex:1" onclick="nextFlash()">Next Card</button>
                </div>
              </div>
            </div>

            <!-- GUIDED PROJECTS -->
            <div class="panel" style="margin-top:20px;">
              <div class="panel-hdr"><span class="panel-title">// GUIDED PROJECTS</span></div>
              <div class="panel-body">
                <p style="font-size:.64rem;color:var(--text-dim);margin-bottom:12px;">Step-by-step builds for common
                  circuits.</p>
                <div class="examples" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                  <button class="chip" style="text-align:left;height:auto;padding:8px;"
                    onclick="qs('learn','Guide me through building an Arduino Weather Station with DHT11')">🌡️ Project
                    1: Weather Station</button>
                  <button class="chip" style="text-align:left;height:auto;padding:8px;"
                    onclick="qs('learn','Show me how to make a 555 Timer PWM Motor Controller')">⚙️ Project 2: Motor
                    Control</button>
                  <button class="chip" style="text-align:left;height:auto;padding:8px;"
                    onclick="qs('learn','Step-by-step guide for a dark-activated night light with LDR')">🌙 Project 3:
                    Night Light</button>
                  <button class="chip" style="text-align:left;height:auto;padding:8px;"
                    onclick="qs('learn','How to build a simple Class A Audio Amplifier?')">🔊 Project 4: Audio
                    Amp</button>
                </div>
              </div>
            </div>

            <div class="chat-area" id="learn-chat"></div>
            <div class="chat-input-row">
              <textarea id="learn-input" placeholder="e.g. How does a capacitor work?"></textarea>
              <button class="voice-btn" onclick="toggleVoice('learn-input','learn-voice')" id="learn-voice">🎤</button>
              <button class="btn btn-purple" id="learn-btn"
                onclick="runChat('learn','learn','learn-out','learn-ph')">📚</button>
            </div>
            <div class="examples">
              <span class="chip" onclick="qs('learn','How does a capacitor work?')">Capacitors</span>
              <span class="chip" onclick="qs('learn','Explain Ohms Law with examples')">Ohm's Law</span>
              <span class="chip" onclick="qs('learn','What is PWM?')">PWM</span>
              <span class="chip" onclick="qs('learn','Why does a transistor act like a switch?')">Transistors</span>
              <span class="chip" onclick="qs('learn','Difference between AC and DC?')">AC vs DC</span>
            </div>
            <div class="loading" id="learn-loading">
              <div class="spinner"></div>Explaining...
            </div>
            <div id="learn-error"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// EXPLANATION</span></div>
          <div class="panel-body">
            <div id="learn-ph" class="placeholder">
              <div class="placeholder-icon">📚</div>
              <p>Explanations here</p>
            </div>
            <div id="learn-out" class="learn-output" style="display:none"></div>
            <div class="ohm-calc">
              <div class="calc-tabs">
                <div class="calc-tab active" onclick="switchCalc('ohm',this)">OHM'S LAW</div>
                <div class="calc-tab" onclick="switchCalc('led',this)">LED RESISTOR</div>
                <div class="calc-tab" onclick="switchCalc('555',this)">555 TIMER</div>
              </div>

              <!-- OHM'S LAW -->
              <div id="calc-ohm" class="calc-group active">
                <div class="ohm-grid">
                  <div class="ohm-field"><label>Voltage (V)</label><input type="number" id="ohm-v" placeholder="—"
                      oninput="calcOhm()"></div>
                  <div class="ohm-field"><label>Current (A)</label><input type="number" id="ohm-i" placeholder="—"
                      oninput="calcOhm()"></div>
                  <div class="ohm-field"><label>Resistance (Ω)</label><input type="number" id="ohm-r" placeholder="—"
                      oninput="calcOhm()"></div>
                  <div class="ohm-field"><label>Power (W)</label><input type="number" id="ohm-p" placeholder="—"
                      readonly></div>
                </div>
                <div class="ohm-result" id="ohm-result">Enter any 2 values</div>
              </div>

              <!-- LED RESISTOR -->
              <div id="calc-led" class="calc-group">
                <div class="ohm-grid">
                  <div class="ohm-field"><label>Supply (V)</label><input type="number" id="led-vs" value="5"
                      oninput="calcLED()"></div>
                  <div class="ohm-field"><label>LED Vf (V)</label><input type="number" id="led-vf" value="2"
                      oninput="calcLED()"></div>
                  <div class="ohm-field"><label>LED If (mA)</label><input type="number" id="led-if" value="20"
                      oninput="calcLED()"></div>
                  <div class="ohm-field"><label>Resistor (Ω)</label><input type="number" id="led-r" readonly></div>
                </div>
                <div class="ohm-result" id="led-result">Use 150Ω resistor</div>
              </div>

              <!-- 555 TIMER -->
              <div id="calc-555" class="calc-group">
                <div class="ohm-grid">
                  <div class="ohm-field"><label>R1 (Ω)</label><input type="number" id="555-r1" value="1000"
                      oninput="calc555()"></div>
                  <div class="ohm-field"><label>R2 (Ω)</label><input type="number" id="555-r2" value="10000"
                      oninput="calc555()"></div>
                  <div class="ohm-field"><label>Cap (µF)</label><input type="number" id="555-c" value="10"
                      oninput="calc555()"></div>
                </div>
                <div class="ohm-result" id="555-result">F: 6.8 Hz · Duty: 52%</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ QUIZ ══════════════════════════════════════════════════════════════ -->
    <div id="tab-quiz" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// CIRCUIT QUIZ</span></div>
          <div class="panel-body">
            <div class="quiz-meta">
              <span class="quiz-score" id="quiz-score">Score: 0 / 0</span>
              <div class="quiz-level">
                <button class="level-btn active" onclick="setLevel('beginner',this)">Beginner</button>
                <button class="level-btn" onclick="setLevel('intermediate',this)">Intermediate</button>
                <button class="level-btn" onclick="setLevel('advanced',this)">Advanced</button>
              </div>
              <button class="btn btn-sm" style="font-size:.62rem;color:var(--accent3);border-color:var(--accent3)"
                onclick="resetQuizStats()">↺ Reset</button>
              <button class="btn btn-sm" onclick="loadQuiz()">↺ New Question</button>
            </div>
            <div class="quiz-progress">
              <div class="quiz-progress-fill" id="quiz-prog" style="width:0%"></div>
            </div>
            <div id="quiz-area">
              <div class="placeholder">
                <div class="placeholder-icon">🎯</div>
                <p>Click "New Question" to start the quiz!</p>
              </div>
            </div>
            <div class="loading" id="quiz-loading" style="margin-top:8px;">
              <div class="spinner"></div>Loading question...
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// YOUR STATS</span></div>
          <div class="panel-body">
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div class="sim-card">
                <h4>Session Stats</h4>
                <div class="node-row"><span class="node-name">Questions answered</span><span class="node-val"
                    id="stat-total">0</span></div>
                <div class="node-row"><span class="node-name">Correct</span><span class="node-val"
                    style="color:var(--accent2)" id="stat-correct">0</span></div>
                <div class="node-row"><span class="node-name">Accuracy</span><span class="node-val"
                    id="stat-acc">—</span></div>
                <div class="node-row"><span class="node-name">Current streak</span><span class="node-val"
                    style="color:var(--warn)" id="stat-streak">0 🔥</span></div>
              </div>

              <!-- CHALLENGES -->
              <div class="panel" style="margin-top:15px; border: 1px solid var(--accent3);">
                <div class="panel-hdr"><span class="panel-title" style="color:var(--accent3)">// DESIGN
                    CHALLENGES</span></div>
                <div class="panel-body">
                  <div id="challenge-setup">
                    <p style="font-size:.7rem;color:var(--text-dim);margin-bottom:10px;">Apply your knowledge to AI
                      design prompts.</p>
                    <button class="btn btn-orange" style="width:100%;font-size:.7rem;" onclick="genChallenge()">Generate
                      Challenge</button>
                  </div>
                  <div id="challenge-box" style="display:none">
                    <div class="challenge-box">
                      <div class="challenge-title"><span>🏆</span> <span id="chall-title">Design Task</span></div>
                      <div class="challenge-desc" id="chall-desc"></div>
                      <textarea class="challenge-input" id="chall-input"
                        placeholder="Explain your solution..."></textarea>
                      <button class="btn btn-primary" style="width:100%" onclick="submitChallenge()">Submit</button>
                    </div>
                    <div id="chall-result" class="msg assistant" style="display:none;font-size:.7rem;margin-top:8px;">
                    </div>
                  </div>
                </div>
              </div>

              <div class="sim-card">
                <h4>Topic History</h4>
                <div id="quiz-history"
                  style="font-size:.76rem;color:var(--text-dim);line-height:1.8;font-family:'JetBrains Mono',monospace;">
                  No questions yet.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ TEMPLATES ═════════════════════════════════════════════════════════ -->
    <div id="tab-templates" class="tab-content">
      <div class="workspace" style="grid-template-columns:1fr;">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// CIRCUIT TEMPLATES</span></div>
          <div class="panel-body">
            <p style="font-size:.78rem;color:var(--text-dim);margin-bottom:14px;">Click any template to auto-load it
              into the Schematic tab.</p>
            <div class="tpl-grid" id="tpl-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ SAVED ═════════════════════════════════════════════════════════════ -->
    <div id="tab-saved" class="tab-content">
      <div class="workspace">
        <div class="panel">
          <div class="panel-hdr">
            <span class="panel-title">// SAVED CIRCUITS</span>
            <button class="btn btn-sm" onclick="loadSavedList()">↺ Refresh</button>
          </div>
          <div class="panel-body">
            <p style="font-size:.76rem;color:var(--text-dim);margin-bottom:11px;">Saved for this session. Export PDF for
              permanent records.</p>
            <div id="saved-list" class="saved-list">
              <div class="placeholder">
                <div class="placeholder-icon">🗂️</div>
                <p>No circuits saved yet</p>
              </div>
            </div>
            <div class="history-section">
              <div class="history-hdr">
                <h4>📋 Circuit History (Local)</h4>
                <button class="btn btn-sm" onclick="clearCircuitHistory()" style="font-size:.6rem;">Clear All</button>
              </div>
              <div id="circuit-history"></div>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// LOADED CIRCUIT</span></div>
          <div class="panel-body">
            <div id="loaded-ph" class="placeholder">
              <div class="placeholder-icon">📂</div>
              <p>Select a circuit to load</p>
            </div>
            <div id="loaded-out" style="display:none">
              <img id="loaded-img" class="schematic-img" style="margin-bottom:9px;" />
              <div id="loaded-desc" style="font-size:.8rem;color:var(--text-dim);line-height:1.6;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ ARCHITECT ═════════════════════════════════════════════════════════ -->
    <div id="tab-architect" class="tab-content">
      <div class="workspace" style="display:grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// DEFINE CUSTOM COMPONENT</span></div>
          <div class="panel-body">
            <div class="ohm-field" style="margin-bottom:12px;">
              <label>PART NAME</label>
              <input type="text" id="arc-name" placeholder="e.g. MySens-V1" />
            </div>
            <div class="ohm-field" style="margin-bottom:12px;">
              <label>CATEGORY</label>
              <select id="arc-type" class="btn"
                style="width:100%;text-align:left;background:var(--input-bg);border-color:var(--border)">
                <option value="ic">Integrated Circuit (IC)</option>
                <option value="sensor">Sensor Module</option>
                <option value="mcu">Microcontroller</option>
                <option value="transistor">Transistor / FET</option>
                <option value="other">Other / Custom</option>
              </select>
            </div>
            <div class="ohm-field" style="margin-bottom:12px;">
              <label>PINOUT (Comma-separated)</label>
              <input type="text" id="arc-pins" placeholder="VCC, GND, SDA, SCL" />
            </div>
            <div class="ohm-field" style="margin-bottom:15px;">
              <label>SPECIFICATIONS / NOTES</label>
              <textarea id="arc-specs" placeholder="Operating voltage, physical dimensions, etc."
                style="width:100%;height:80px;background:var(--input-bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:.75rem;outline:none;"></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="saveCustomPart()">✨ Register Component</button>
          </div>
        </div>
        <div class="panel">
          <div class="panel-hdr"><span class="panel-title">// YOUR CUSTOM LIBRARY</span></div>
          <div class="panel-body">
            <div id="arc-list" class="dash-grid" style="grid-template-columns: 1fr;">
              <p style="font-size:.72rem;color:var(--text-dim);text-align:center;">No custom components defined yet.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ GALLERY ═══════════════════════════════════════════════════════════ -->
    <div id="tab-gallery" class="tab-content">
      <div class="workspace" style="display:block;">
        <div class="panel">
          <div class="panel-hdr">
            <span class="panel-title">// COMMUNITY CHALLENGES & DESIGNS</span>
            <button class="btn btn-sm" onclick="loadGallery()">🔄 Refresh</button>
          </div>
          <div class="panel-body">
            <div id="gallery-list" class="gallery-grid">
              <div class="loading">
                <div class="spinner"></div>Loading Community Designs...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ SHORTCUTS MODAL ═══════════════════════════════════════════════════ -->
    <div class="modal-overlay" id="shortcuts-modal" onclick="if(event.target===this)toggleShortcuts()">
      <div class="modal" style="position:relative">
        <button class="close-modal" onclick="toggleShortcuts()">✕</button>
        <h2>⌨️ Keyboard Shortcuts</h2>
        <div class="shortcut-row"><span>Switch tabs</span><span class="shortcut-key"><kbd>1</kbd>–<kbd>0</kbd></span>
        </div>
        <div class="shortcut-row"><span>Save circuit</span><span class="shortcut-key"><kbd>Ctrl</kbd><kbd>S</kbd></span>
        </div>
        <div class="shortcut-row"><span>Export PDF</span><span class="shortcut-key"><kbd>Ctrl</kbd><kbd>E</kbd></span>
        </div>
        <div class="shortcut-row"><span>Submit input</span><span class="shortcut-key"><kbd>Ctrl</kbd><kbd>↵</kbd></span>
        </div>
        <div class="shortcut-row"><span>Toggle theme</span><span class="shortcut-key"><kbd>Ctrl</kbd><kbd>D</kbd></span>
        </div>
        <div class="shortcut-row"><span>Show shortcuts</span><span class="shortcut-key"><kbd>?</kbd></span></div>
      </div>
    </div>

    <footer>CIRCUIT COPILOT v4 · Groq LLaMA 3.3 70B · FastAPI · <a href="https://github.com/smemon819/circuit-copilot"
        target="_blank">GitHub</a> · Free &amp; Open Source · Press <kbd
        style="background:var(--bg3);border:1px solid var(--border2);border-radius:3px;padding:1px 5px;font-family:'JetBrains Mono',monospace;font-size:.6rem;">?</kbd>
      for shortcuts</footer>
  </div><!-- .app -->
  <canvas id="confetti-canvas"></canvas>
  <div id="tour-overlay"></div>
  <div id="probe-tip" class="probe-tip">
    <h6 id="probe-title">Node Probe</h6>
    <div id="probe-content">
      <div class="probe-val" id="probe-val">0.00 V</div>
    </div>
    <div class="probe-actions">
      <button class="btn btn-sm" onclick="pinToWaveform()">〰️ Pin to Waveform</button>
      <button class="btn btn-sm" onclick="closeProbe()">✕ Close</button>
    </div>
  </div>

  <script>
    // ── STATE ──────────────────────────────────────────────────────────────────
    let currentCid = null;
    let collabSocket = null;
    const S = {
      sch: { history: [], lastImage: null, lastSchema: null },
      sim: { history: [], lastSim: null },
      bom: { history: [], lastBom: null },
      comp: { history: [] }, debug: { history: [] },
      ard: { history: [], lastCode: '' },
      learn: { history: [] }, wave: { history: [] },
      breadboard: { history: [], lastGuide: null },
      probes: [], // { name: string, val: string, unit: string, color: string }
      stats: JSON.parse(localStorage.getItem('cc_stats') || 'null') || {
        circuits: 0,
        digital: 0,
        analog: 0,
        mcu: 0,
        achievements: []
      }
    };
    function saveStats() { localStorage.setItem('cc_stats', JSON.stringify(S.stats)); }
    let pdfData = {};

    // Quiz state — load from localStorage
    let quiz = JSON.parse(localStorage.getItem('cc_quiz') || 'null') || { score: 0, total: 0, streak: 0, level: 'beginner', history: [], current: null };
    function saveQuiz() { localStorage.setItem('cc_quiz', JSON.stringify({ score: quiz.score, total: quiz.total, streak: quiz.streak, level: quiz.level, history: quiz.history.slice(0, 20) })); }
    function resetQuizStats() { quiz = { score: 0, total: 0, streak: 0, level: quiz.level, history: [], current: null }; saveQuiz(); updateQuizUI(); document.getElementById('quiz-area').innerHTML = '<div class="placeholder"><div class="placeholder-icon">🎯</div><p>Stats reset! Click "New Question" to start.</p></div>'; }
    function updateQuizUI() { document.getElementById('quiz-score').textContent = `Score: ${quiz.score} / ${quiz.total}`; document.getElementById('stat-total').textContent = quiz.total; document.getElementById('stat-correct').textContent = quiz.score; document.getElementById('stat-acc').textContent = quiz.total ? Math.round((quiz.score / quiz.total) * 100) + '%' : '—'; document.getElementById('stat-streak').textContent = quiz.streak + (quiz.streak >= 3 ? ' 🔥' : ''); document.getElementById('quiz-prog').style.width = Math.min(100, quiz.total * 10) + '%'; document.getElementById('quiz-history').innerHTML = quiz.history.length ? quiz.history.slice(0, 8).map(h => `${h.correct ? '✅' : '❌'} ${h.q}`).join('<br>') : 'No questions yet.'; }
    // Restore quiz UI on load
    setTimeout(updateQuizUI, 100);

    // ── THEME ──────────────────────────────────────────────────────────────────
    function toggleTheme() {
      const html = document.documentElement;
      html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      localStorage.setItem('theme', html.getAttribute('data-theme'));
    }
    (function () { const t = localStorage.getItem('theme'); if (t) document.documentElement.setAttribute('data-theme', t); })();

    // ── TABS ───────────────────────────────────────────────────────────────────
    function switchTab(name, btn) {
      document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.getElementById('tab-' + name).classList.add('active');
      btn.classList.add('active');
      // Hide badge when visiting tab
      updateTabBadge(name, false);
      if (name === 'dashboard') renderDashboard();
      if (name === 'breadboard') initBreadboard();
      if (name === 'saved') loadSavedList();
      if (name === 'gallery') loadGallery();
      if (name === 'architect') renderArchitect();
      if (name === 'waveform') { setTimeout(() => { drawWave(); }, 100); }
    }

    // ── DASHBOARD ─────────────────────────────────────────────────────────────
    const ACHIEVEMENTS = [
      { id: 'first_cir', icon: '🔋', title: 'First Circuit', desc: 'Generate your first schematic', req: s => s.circuits >= 1 },
      { id: 'designer', icon: '🎨', title: 'Designer', desc: 'Generate 5 schematics', req: s => s.circuits >= 5 },
      { id: 'engineer', icon: '🏗️', title: 'Circuit Engineer', desc: 'Generate 20 schematics', req: s => s.circuits >= 20 },
      { id: 'quiz_intro', icon: '📝', title: 'Quizzer', desc: 'Answer 5 quiz questions', req: (s, q) => q.total >= 5 },
      { id: 'streak_3', icon: '🔥', title: 'On Fire', desc: 'Get a 3-question streak', req: (s, q) => q.streak >= 3 },
      { id: 'perfectionist', icon: '💎', title: 'Perfectionist', desc: 'Reach 100% accuracy (min 10 q)', req: (s, q) => q.total >= 10 && q.score === q.total },
      { id: 'digital_master', icon: '🎛️', title: 'Digital Master', desc: 'Get 10 digital logic questions correct', req: s => s.digital >= 10 },
      { id: 'analog_master', icon: '📈', title: 'Analog Master', desc: 'Get 10 analog questions correct', req: s => s.analog >= 10 },
      { id: 'mcu_master', icon: '💻', title: 'MCU Master', desc: 'Get 10 microcontroller questions correct', req: s => s.mcu >= 10 }
    ];

    function renderDashboard() {
      document.getElementById('dash-circuits').textContent = S.stats.circuits;
      document.getElementById('dash-quiz').textContent = quiz.score + ' / ' + quiz.total;
      document.getElementById('dash-streak').textContent = quiz.streak;

      // Skills
      const updateSkill = (id, val) => {
        const pct = Math.min(100, Math.floor((val / 10) * 100)); // 10 is "mastery" for now
        document.getElementById(`skill-${id}-pct`).textContent = pct + '%';
        document.getElementById(`skill-${id}`).style.width = pct + '%';
      };
      updateSkill('digital', S.stats.digital);
      updateSkill('analog', S.stats.analog);
      updateSkill('mcu', S.stats.mcu);

      // Achievements
      const achieveContainer = document.getElementById('achievements');
      achieveContainer.innerHTML = ACHIEVEMENTS.map(a => {
        const unlocked = S.stats.achievements.includes(a.id) || a.req(S.stats, quiz);
        if (unlocked && !S.stats.achievements.includes(a.id)) {
          S.stats.achievements.push(a.id);
          saveStats();
          showToast(`🏆 Achievement Unlocked: ${a.title}!`);
        }
        return `
          <div class="badge-icon ${unlocked ? 'unlocked' : ''}">
            ${a.icon}
            <div class="badge-tip"><strong>${a.title}</strong><br>${a.desc}</div>
          </div>
        `;
      }).join('');
    }
    setTimeout(() => {
      renderDashboard();
      renderFlash();
    }, 200);

    // ── FLASHCARDS ────────────────────────────────────────────────────────────
    const FLASH_DECK = [
      { sym: '🔋', name: 'Battery', desc: 'Voltage source. Stores energy chemically. DC power.' },
      { sym: '〰️', name: 'Resistor', desc: 'Limits current flow. Measured in Ohms (Ω). V=IR.' },
      { sym: '🎚️', name: 'Potentiometer', desc: 'Variable resistor. Used for volume, dimming, etc.' },
      { sym: '🥛', name: 'Capacitor', desc: 'Stores charge in an electric field. Blocks DC, passes AC.' },
      { sym: '🌀', name: 'Inductor', desc: 'Stores energy in a magnetic field. Resists changes in current.' },
      { sym: '🔌', name: 'Diode', desc: 'One-way valve for current. Forward voltage drop ~0.7V.' },
      { sym: '💡', name: 'LED', desc: 'Light Emitting Diode. Specialized diode that emits light.' },
      { sym: '🔀', name: 'Transistor', desc: 'Electronic switch or amplifier. NPN/PNP types.' },
      { sym: '💻', name: 'Integrated Circuit', desc: 'Miniaturized circuit containing thousands of components.' },
      { sym: '🔊', name: 'Buzzer', desc: 'Converts electrical energy to sound. Active or passive.' }
    ];
    let flashIdx = 0;
    function renderFlash() {
      const c = FLASH_DECK[flashIdx];
      document.getElementById('flash-sym').textContent = c.sym;
      document.getElementById('flash-name').textContent = c.name;
      document.getElementById('flash-desc').textContent = c.desc;
      document.getElementById('flash-card').classList.remove('flipped');
    }
    function nextFlash() { flashIdx = (flashIdx + 1) % FLASH_DECK.length; renderFlash(); }
    function prevFlash() { flashIdx = (flashIdx - 1 + FLASH_DECK.length) % FLASH_DECK.length; renderFlash(); }

    // ── CHALLENGES ────────────────────────────────────────────────────────────
    async function genChallenge() {
      const btn = document.querySelector('button[onclick="genChallenge()"]');
      btn.disabled = true; btn.textContent = 'Generating...';
      try {
        const res = await fetch('/api/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{ role: 'system', content: 'Generate a short electronics design challenge for a beginner/intermediate student. Return in format Title: [title] Description: [desc]' }],
            endpoint: 'gpt'
          })
        });
        const data = await res.json();
        const text = data.reply || '';
        const tMatch = text.match(/Title:\s*(.*)\n/i);
        const dMatch = text.match(/Description:\s*([\s\S]*)/i);
        document.getElementById('chall-title').textContent = tMatch ? tMatch[1].trim() : 'Design Task';
        document.getElementById('chall-desc').textContent = dMatch ? dMatch[1].trim() : text;
        document.getElementById('challenge-box').style.display = 'block';
        document.getElementById('chall-result').style.display = 'none';
        document.getElementById('chall-input').value = '';
      } catch (e) { showErr('challenge-box', 'Failed to generate challenge'); }
      finally { btn.disabled = false; btn.textContent = 'Generate New Challenge'; }
    }

    async function submitChallenge() {
      const ans = document.getElementById('chall-input').value.trim();
      if (!ans) return;
      const resEl = document.getElementById('chall-result');
      resEl.style.display = 'block'; resEl.innerHTML = '<div class="spinner"></div> Validating...';
      try {
        const res = await fetch('/api/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{ role: 'system', content: `Validate this design challenge submission. Challenge: ${document.getElementById('chall-desc').textContent}. Submission: ${ans}. Be encouraging but technically precise.` }],
            endpoint: 'gpt'
          })
        });
        const data = await res.json();
        resEl.innerHTML = marked.parse(data.reply || 'No response');
        fireConfetti();
        S.stats.mcu++; saveStats(); // Give XP for challenges
        renderDashboard();
      } catch (e) { resEl.textContent = 'Validation failed'; }
    }

    // ── TAB BADGES ─────────────────────────────────────────────────────────────
    function updateTabBadge(name, on) {
      const tab = document.querySelector(`.tab[onclick*="'${name}'"]`);
      if (!tab) return;
      const badge = tab.querySelector('.tab-badge');
      if (badge) badge.style.display = on ? 'block' : 'none';
    }

    // ── AUTO-SAVE DRAFTS ───────────────────────────────────────────────────────
    function initAutoSave() {
      const ids = ['sch-input', 'sim-input', 'bom-input', 'comp-input', 'debug-input', 'ard-input', 'learn-input'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => localStorage.setItem('cc_draft_' + id, el.value));
        const s = localStorage.getItem('cc_draft_' + id);
        if (s) el.value = s;
      });
      const p = document.getElementById('project-name');
      p.addEventListener('input', () => localStorage.setItem('cc_draft_pname', p.value));
      const sp = localStorage.getItem('cc_draft_pname');
      if (sp) p.value = sp;
    }
    setTimeout(initAutoSave, 500);

    // ── HELPERS ────────────────────────────────────────────────────────────────
    const esc = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    function appendMsg(chatId, role, content) {
      const chat = document.getElementById(chatId);
      if (!chat) return;
      const d = document.createElement('div');
      d.className = `msg ${role}`;
      d.innerHTML = role === 'assistant' ? marked.parse(content) : esc(content);
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }
    function setLoading(p, on) {
      const b = document.getElementById(p + '-btn'); if (b) b.disabled = on;
      const l = document.getElementById(p + '-loading'); if (l) l.classList.toggle('visible', on);
      // Show skeleton in placeholder
      const phMap = { sch: 'sch-ph', sim: 'sim-ph', bom: 'bom-ph', comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph' };
      const ph = document.getElementById(phMap[p]);
      if (ph && on) {
        ph._origHTML = ph._origHTML || ph.innerHTML;
        ph.innerHTML = `<div class="skeleton-wrap">${p === 'sch' ? '<div class="skeleton-img"></div>' : ''}<div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div><div class="skeleton-line"></div></div>`;
        ph.style.display = 'flex';
      } else if (ph && !on && ph._origHTML) {
        ph.innerHTML = ph._origHTML;
      }
    }

    // ── TOAST NOTIFICATIONS ───────────────────────────────────────────────────
    function showToast(msg, duration = 3000) {
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px;';
        document.body.appendChild(container);
      }
      const t = document.createElement('div');
      t.style.cssText = 'background:var(--panel);border:1px solid var(--accent);border-radius:8px;padding:10px 16px;font-size:.78rem;color:var(--text);font-family:Syne,sans-serif;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:skeleton-pulse .8s ease-in-out;';
      t.textContent = msg;
      container.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity .3s'; setTimeout(() => t.remove(), 300); }, duration);
    }

    // ── FETCH WITH RETRY ──────────────────────────────────────────────────────
    async function fetchWithRetry(url, options, maxRetries = 3) {
      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          const res = await fetch(url, options);
          if (res.status === 429 && attempt < maxRetries) {
            const wait = Math.pow(2, attempt + 1);
            showToast(`⏳ Rate limited — retrying in ${wait}s... (${attempt + 1}/${maxRetries})`);
            await new Promise(r => setTimeout(r, wait * 1000));
            continue;
          }
          return res;
        } catch (e) {
          if (attempt < maxRetries) {
            const wait = Math.pow(2, attempt + 1);
            showToast(`⚠ Network error — retrying in ${wait}s...`);
            await new Promise(r => setTimeout(r, wait * 1000));
            continue;
          }
          throw e;
        }
      }
    }
    function showErr(p, msg) {
      const el = document.getElementById(p + '-error');
      if (el) el.innerHTML = msg ? `<div class="error-msg">⚠ ${msg}</div>` : '';
    }
    function qs(p, text) {
      const el = document.getElementById(p + '-input'); if (!el) return;
      el.value = text;
      const dispatch = { sch: runSchematic, sim: runSimulate, bom: runBOM };
      if (dispatch[p]) dispatch[p]();
      else {
        const ep = { comp: 'components', debug: 'debug', ard: 'arduino', learn: 'learn', wave: 'components' }[p];
        const outId = { comp: 'comp-out', debug: 'debug-out', ard: 'ard-out', learn: 'learn-out', wave: 'wave-output' }[p];
        const phId = { comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph', wave: 'wave-ph' }[p];
        if (ep) runChat(ep, p, outId, phId);
      }
    }

    // ── VOICE ─────────────────────────────────────────────────────────────────
    let recog = null, activeInput = null;
    function toggleVoice(inputId, btnId) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported. Use Chrome.'); return; }
      const btn = document.getElementById(btnId);
      if (recog && activeInput === inputId) { recog.stop(); return; }
      recog = new SR(); recog.continuous = false; recog.interimResults = false; recog.lang = 'en-US';
      activeInput = inputId; btn.classList.add('recording');
      recog.onresult = e => {
        document.getElementById(inputId).value = e.results[0][0].transcript;
        btn.classList.remove('recording'); activeInput = null;
      };
      recog.onerror = recog.onend = () => { btn.classList.remove('recording'); activeInput = null; };
      recog.start();
    }

    // ── SCHEMATIC ─────────────────────────────────────────────────────────────
    async function runSchematic() {
      const input = document.getElementById('sch-input');
      const prompt = input.value.trim(); if (!prompt) return;
      appendMsg('sch-chat', 'user', prompt);
      S.sch.history.push({ role: 'user', content: prompt });
      input.value = ''; setLoading('sch', true); showErr('sch', '');
      try {
        const res = await fetchWithRetry('/api/schematic', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: S.sch.history.slice(-10) })
        });
        const data = await res.json(); if (data.error) throw new Error(data.error);
        S.sch.lastImage = data.image; S.sch.lastSchema = data.schema;
        const img = document.getElementById('sch-img');
        img.src = 'data:image/png;base64,' + data.image; img.style.display = 'block';
        document.getElementById('sch-ph').style.display = 'none';
        document.getElementById('sch-dl').style.display = 'inline-flex';
        document.getElementById('sch-share').style.display = 'inline-flex';
        document.getElementById('sch-screenshot').style.display = 'inline-flex';
        document.getElementById('sch-eda').style.display = 'inline-flex'; // Show EDA button
        const meta = document.getElementById('sch-meta'); meta.style.display = 'flex'; meta.innerHTML = '';
        if (data.difficulty) meta.innerHTML += `<span class="meta-tag badge-info">${data.difficulty}</span>`;
        if (data.use_case) meta.innerHTML += `<span class="meta-tag" style="font-size:.66rem;color:var(--text-dim);background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 7px;">${data.use_case}</span>`;
        const desc = document.getElementById('sch-desc');
        if (data.description) { desc.textContent = '► ' + data.description; desc.style.display = 'block'; }
        if (data.falstad_url) {
          document.getElementById('falstad-link').href = data.falstad_url;
          document.getElementById('falstad-frame').src = data.falstad_url;
          document.getElementById('falstad-wrap').style.display = 'block';
        }
        S.sch.history.push({ role: 'assistant', content: data.assistant_message || data.description });
        appendMsg('sch-chat', 'assistant', data.description || 'Schematic generated!');
        pdfData.schematic_image = data.image; pdfData.schematic_description = data.description;
        pdfData.components = data.schema?.components || [];
        pdfData.project_name = document.getElementById('project-name').value || 'Circuit Report';
      } catch (e) { showErr('sch', e.message); }
      finally { setLoading('sch', false); }
    }
    document.getElementById('sch-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runSchematic(); } });

    // ── SIMULATE ──────────────────────────────────────────────────────────────
    async function runSimulate() {
      const input = document.getElementById('sim-input');
      const prompt = input.value.trim(); if (!prompt) return;
      appendMsg('sim-chat', 'user', prompt);
      S.sim.history.push({ role: 'user', content: prompt });
      input.value = ''; setLoading('sim', true); showErr('sim', '');
      try {
        const res = await fetchWithRetry('/api/simulate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: S.sim.history.slice(-6) })
        });
        const data = await res.json(); if (data.error) throw new Error(data.error);
        S.sim.lastSim = data.simulation; pdfData.simulation = data.simulation;
        renderSim(data.simulation);
        appendMsg('sim-chat', 'assistant', data.simulation.summary || 'Done.');
        S.sim.history.push({ role: 'assistant', content: data.simulation.summary });
      } catch (e) { showErr('sim', e.message); }
      finally { setLoading('sim', false); }
    }
    document.getElementById('sim-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runSimulate(); } });

    function renderSim(sim) {
      document.getElementById('sim-ph').style.display = 'none';
      document.getElementById('sim-out').style.display = 'block';
      document.getElementById('sim-summary').textContent = sim.summary || '';
      document.getElementById('sim-nodes').innerHTML = (sim.nodes || []).map(n =>
        `<div class="node-row probe-node" onclick="openProbe(event, '${n.name}', '${n.voltage}', 'V')">
          <span class="node-name">${n.name}</span>
          <span class="node-val">${n.voltage} ${n.unit}</span>
        </div>`
      ).join('');
      const maxP = Math.max(...(sim.power || []).map(p => p.power), 1);
      document.getElementById('sim-power').innerHTML = (sim.power || []).map(p => {
        const pct = Math.min(100, (p.power / maxP) * 100).toFixed(1);
        const c = p.status === 'OK' ? 'var(--accent2)' : 'var(--warn)';
        return `<div class="power-bar-wrap">
      <div class="power-bar-label">
        <span style="font-size:.74rem">${p.component} <span class="badge ${p.status === 'OK' ? 'badge-ok' : 'badge-warn'}">${p.status}</span></span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:${c}">${p.power} ${p.unit}</span>
      </div>
      <div class="power-bar"><div class="power-bar-fill" style="width:${pct}%;background:${c}"></div></div>
    </div>`;
      }).join('');
      document.getElementById('sim-branches').innerHTML = (sim.branches || []).map(b =>
        `<div class="node-row probe-node" onclick="openProbe(event, '${b.name}', '${b.current}', '${b.unit}')">
          <span class="node-name">${b.name}</span>
          <span class="node-val">${b.current} ${b.unit}</span>
        </div>`
      ).join('');
      document.getElementById('sim-warns').innerHTML = (sim.warnings || []).map(w =>
        `<div class="sim-warning">⚠ ${w}</div>`).join('');
      drawFlow(sim);
    }

    function drawFlow(sim) {
      const canvas = document.getElementById('flowCanvas');
      const ctx = canvas.getContext('2d');
      const W = canvas.offsetWidth || 500; canvas.width = W; canvas.height = 90;
      const nodes = sim.nodes || [], branches = sim.branches || [];
      const current = branches[0]?.current || 0, maxV = sim.supply_voltage || 9;
      const numP = Math.min(22, Math.max(3, Math.round(current / 4)));
      let pts = Array.from({ length: numP }, (_, i) => ({ x: (i / numP) * W, s: 1.1 + (current / 60) }));
      if (window._fAnim) cancelAnimationFrame(window._fAnim);
      function draw() {
        ctx.clearRect(0, 0, W, 90);
        ctx.beginPath(); ctx.moveTo(0, 45); ctx.lineTo(W, 45); ctx.strokeStyle = '#1c3a5a'; ctx.lineWidth = 3; ctx.stroke();
        nodes.forEach((n, i) => {
          const nx = (i / Math.max(nodes.length - 1, 1)) * (W - 40) + 20;
          ctx.beginPath(); ctx.arc(nx, 45, 4.5, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(0,200,240,${.3 + (n.voltage / (maxV || 1)) * .7})`; ctx.fill();
          ctx.fillStyle = '#4a8aaa'; ctx.font = '8px JetBrains Mono,monospace';
          ctx.textAlign = 'center'; ctx.fillText(`${n.voltage}${n.unit}`, nx, 34);
        });
        pts.forEach(p => {
          const g = ctx.createRadialGradient(p.x, 45, 0, p.x, 45, 5);
          g.addColorStop(0, '#00f090'); g.addColorStop(1, 'rgba(0,240,144,0)');
          ctx.beginPath(); ctx.arc(p.x, 45, 3.5, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill();
          p.x += p.s; if (p.x > W) p.x = 0;
        });
        if (current > 0) {
          ctx.fillStyle = '#00f090'; ctx.font = 'bold 9px Syne,sans-serif';
          ctx.textAlign = 'right'; ctx.fillText(`I = ${current} ${branches[0]?.unit || 'mA'}`, W - 5, 66);
        }
        window._fAnim = requestAnimationFrame(draw);
      }
      draw();
    }
    function openProbe(event, name, val, unit) {
      const probeTip = document.getElementById('probe-tip');
      document.getElementById('probe-title').textContent = name;
      document.getElementById('probe-val').textContent = `${val} ${unit}`;
      probeTip.style.display = 'block';
      probeTip.style.left = `${event.clientX + 10}px`;
      probeTip.style.top = `${event.clientY + 10}px`;
      probeTip.dataset.probeName = name;
      probeTip.dataset.probeVal = val;
      probeTip.dataset.probeUnit = unit;
    }

    function closeProbe() {
      document.getElementById('probe-tip').style.display = 'none';
    }

    function pinToWaveform() {
      const probeTip = document.getElementById('probe-tip');
      const name = probeTip.dataset.probeName;
      const val = parseFloat(probeTip.dataset.probeVal);
      const unit = probeTip.dataset.probeUnit;

      if (!name || isNaN(val)) {
        showToast('Invalid probe data.');
        return;
      }

      // Generate a random color for the probe
      const color = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

      // Check if already pinned
      if (S.probes.some(p => p.name === name)) {
        showToast(`Probe "${name}" is already pinned.`);
        return;
      }

      S.probes.push({ name, val, unit, color });
      drawWave(); // Redraw waveform with new probe
      showToast(`Probe "${name}" pinned to waveform.`);
      closeProbe();
    }

    // ── WAVEFORM ──────────────────────────────────────────────────────────────
    function updateWaveLabel() {
      const f = +document.getElementById('w-freq').value;
      const a = +document.getElementById('w-amp').value;
      const o = +document.getElementById('w-offset').value;
      const d = +document.getElementById('w-duty').value;
      document.getElementById('w-freq-lbl').textContent = f + ' Hz';
      document.getElementById('w-amp-lbl').textContent = a + ' V';
      document.getElementById('w-offset-lbl').textContent = o + ' V';
      document.getElementById('w-duty-lbl').textContent = d + ' %';
      document.getElementById('w-period').textContent = 'Period: ' + (1000 / f).toFixed(1) + ' ms';
      const vrms = document.getElementById('w-type').value === 'sine' ? (a / Math.sqrt(2)).toFixed(2) : a.toFixed(2);
      document.getElementById('w-vrms').textContent = 'Vrms: ' + vrms + ' V';
      document.getElementById('w-vpp').textContent = 'Vpp: ' + (a * 2).toFixed(1) + ' V';
    }

    function drawWave() {
      const canvas = document.getElementById('waveCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.offsetWidth || 500; canvas.width = W; canvas.height = 200;
      const type = document.getElementById('w-type').value;
      const freq = +document.getElementById('w-freq').value;
      const amp = +document.getElementById('w-amp').value;
      const offset = +document.getElementById('w-offset').value;
      const duty = (+document.getElementById('w-duty').value) / 100;
      const theme = document.documentElement.getAttribute('data-theme');
      const bgColor = theme === 'light' ? '#ffffff' : '#060a12';
      const gridColor = theme === 'light' ? 'rgba(0,0,0,.08)' : 'rgba(0,200,240,.06)';
      const axisColor = theme === 'light' ? 'rgba(0,0,0,.2)' : 'rgba(0,200,240,.2)';

      ctx.fillStyle = bgColor; ctx.fillRect(0, 0, W, 200);

      // Grid
      ctx.strokeStyle = gridColor; ctx.lineWidth = 1;
      for (let x = 0; x < W; x += W / 10) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 200); ctx.stroke(); }
      for (let y = 0; y < 200; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

      // Axes
      ctx.strokeStyle = axisColor; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(0, 100); ctx.lineTo(W, 100); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, 200); ctx.stroke();

      // Voltage labels
      ctx.fillStyle = '#4a8aaa'; ctx.font = '9px JetBrains Mono,monospace'; ctx.textAlign = 'left';
      ctx.fillText(`+${amp}V`, 4, 14); ctx.fillText('0V', 4, 103); ctx.fillText(`-${amp}V`, 4, 196);

      // Waveform
      const cycles = 3;
      const pxPerCycle = W / cycles;
      ctx.strokeStyle = '#00c8f0'; ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(0,200,240,.5)'; ctx.shadowBlur = 6;
      ctx.beginPath();
      for (let x = 0; x < W; x++) {
        const t = (x / pxPerCycle);
        const phase = t % 1;
        let v = 0;
        if (type === 'sine') v = Math.sin(phase * Math.PI * 2) * amp;
        else if (type === 'square') v = (phase < duty ? 1 : -1) * amp;
        else if (type === 'triangle') v = (phase < 0.5 ? (4 * phase - 1) : (3 - 4 * phase)) * amp;
        else if (type === 'sawtooth') v = (2 * phase - 1) * amp;
        else if (type === 'pwm') v = (phase < duty ? 1 : -1) * amp;
        const y = 100 - ((v + offset) / (amp + Math.abs(offset) + 0.001)) * 90;
        x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
      ctx.shadowBlur = 0;

      // Draw Probes
      if (S.probes.length) {
        S.probes.forEach((p, i) => {
          // Map probe value to canvas Y coordinate
          // Assuming waveform canvas range is -amp to +amp, centered at 100px
          // And the probe value is a DC value
          const maxWaveAmp = amp + Math.abs(offset); // Max possible amplitude on display
          const yPos = 100 - (p.val / (maxWaveAmp || 1)) * 90; // Scale to 90px range above/below center

          ctx.strokeStyle = p.color; ctx.setLineDash([5, 3]); ctx.lineWidth = 1;
          ctx.beginPath(); ctx.moveTo(0, yPos); ctx.lineTo(W, yPos); ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle = p.color; ctx.font = 'bold 9px JetBrains Mono, monospace';
          ctx.fillText(`PROBE: ${p.name} (${p.val} ${p.unit})`, 10, yPos - 5);
        });
      }
      updateWaveLabel();
    }
    setTimeout(drawWave, 200);
    window.addEventListener('resize', drawWave);

    // ── BOM ───────────────────────────────────────────────────────────────────
    async function runBOM() {
      const input = document.getElementById('bom-input');
      const prompt = input.value.trim(); if (!prompt) return;
      appendMsg('bom-chat', 'user', prompt);
      S.bom.history.push({ role: 'user', content: prompt });
      input.value = ''; setLoading('bom', true); showErr('bom', '');
      try {
        const res = await fetchWithRetry('/api/bom', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: S.bom.history.slice(-6) })
        });
        const data = await res.json(); if (data.error) throw new Error(data.error);
        S.bom.lastBom = data.bom; pdfData.bom = data.bom;
        renderBOM(data.bom);
        const sum = `${data.bom.items?.length || 0} items · $${(data.bom.total_cost_usd || 0).toFixed(2)} total`;
        appendMsg('bom-chat', 'assistant', sum);
        S.bom.history.push({ role: 'assistant', content: sum });
      } catch (e) { showErr('bom', e.message); }
      finally { setLoading('bom', false); }
    }
    document.getElementById('bom-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runBOM(); } });

    function renderBOM(bom) {
      document.getElementById('bom-ph').style.display = 'none';
      document.getElementById('bom-dl').style.display = 'inline-flex';
      const items = bom.items || [];
      const rows = items.map(it => `<tr>
    <td><strong>${it.ref || ''}</strong></td>
    <td>${it.description || ''}</td>
    <td><code>${it.value || ''}</code></td>
    <td style="text-align:center">${it.quantity || 1}</td>
    <td>$${(it.unit_cost || 0).toFixed(2)}</td>
    <td><strong>$${(it.total_cost || 0).toFixed(2)}</strong></td>
    <td><a href="${it.supplier_url || '#'}" target="_blank">${it.supplier || ''}</a></td>
    <td style="font-size:.72rem;color:var(--text-dim)">${it.notes || ''}</td></tr>`).join('');
      document.getElementById('bom-out').innerHTML = `
    <table class="bom-table">
      <thead><tr><th>Ref</th><th>Description</th><th>Value</th><th>Qty</th><th>Unit$</th><th>Total</th><th>Supplier</th><th>Notes</th></tr></thead>
      <tbody>${rows}
        <tr><td colspan="5" style="text-align:right;font-weight:700">TOTAL</td>
          <td><strong style="color:var(--accent2)">$${(bom.total_cost_usd || 0).toFixed(2)}</strong></td><td colspan="2"></td></tr>
      </tbody></table>
    <div class="bom-meta">
      ${bom.difficulty ? `<span>Difficulty: <strong>${bom.difficulty}</strong></span>` : ''}
      ${bom.estimated_build_time ? `<span>Build time: <strong>${bom.estimated_build_time}</strong></span>` : ''}
      ${bom.tools_needed?.length ? `<span>Tools: <strong>${bom.tools_needed.join(', ')}</strong></span>` : ''}
    </div>`;
      document.getElementById('bom-out').style.display = 'block';
    }

    // ── GENERIC CHAT ──────────────────────────────────────────────────────────
    async function runChat(endpoint, prefix, outputId, placeholderId) {
      const input = document.getElementById(prefix + '-input');
      const prompt = input.value.trim(); if (!prompt) return;
      appendMsg(prefix + '-chat', 'user', prompt);
      S[prefix].history.push({ role: 'user', content: prompt });
      input.value = ''; setLoading(prefix, true); showErr(prefix, '');
      const outEl = document.getElementById(outputId);
      const phEl = document.getElementById(placeholderId);
      try {
        const res = await fetchWithRetry('/api/' + endpoint, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, history: S[prefix].history.slice(-10) })
        });
        const data = await res.json(); if (data.error) throw new Error(data.error);
        outEl.innerHTML = marked.parse(data.result);
        outEl.style.display = 'block';
        if (phEl) phEl.style.display = 'none';
        S[prefix].history.push({ role: 'assistant', content: data.result });
        appendMsg(prefix + '-chat', 'assistant', data.result.substring(0, 160) + (data.result.length > 160 ? '...' : ''));
        if (prefix === 'ard') {
          S.ard.lastCode = data.result; pdfData.arduino_code = data.result;
          document.getElementById('ard-dl').style.display = 'inline-flex';
          broadcastUpdate('arduino', data.result);
        }
      } catch (e) { showErr(prefix, e.message); }
      finally { setLoading(prefix, false); }
    }
    ['comp', 'debug', 'ard', 'learn'].forEach(p => {
      const el = document.getElementById(p + '-input'); if (!el) return;
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const ep = { comp: 'components', debug: 'debug', ard: 'arduino', learn: 'learn' }[p];
          const out = { comp: 'comp-out', debug: 'debug-out', ard: 'ard-out', learn: 'learn-out' }[p];
          const ph = { comp: 'comp-ph', debug: 'debug-ph', ard: 'ard-ph', learn: 'learn-ph' }[p];
          runChat(ep, p, out, ph);
        }
      });
    });

    // ── QUIZ ──────────────────────────────────────────────────────────────────
    const QUIZ_BANK = {
      beginner: [
        {
          q: "What is the purpose of a resistor in an LED circuit?",
          opts: ["Increase brightness", "Limit current to prevent LED burnout", "Store electrical charge", "Reverse current direction"],
          ans: 1, topic: 'analog', exp: "LEDs have a very low forward resistance. Without a current-limiting resistor, too much current flows and the LED burns out. Use <strong>Ohm's Law: R = (Vs - Vf) / If</strong> to calculate the right value."
        },
        { q: "What is Ohm's Law?", opts: ["V = I × R", "I = V × R", "R = V × I", "P = V × I"], ans: 0, topic: 'analog', exp: "<strong>V = I × R</strong> (Voltage = Current × Resistance) is the most fundamental law in electronics. It defines the relationship between these three quantities in any resistive circuit." },
        {
          q: "What is the unit of electrical resistance?",
          opts: ["Ampere", "Volt", "Ohm (Ω)", "Watt"],
          ans: 2, topic: 'analog', exp: "Resistance is measured in <strong>Ohms (Ω)</strong>, named after Georg Ohm. 1 Ω means 1 volt produces 1 ampere of current."
        },
        { q: "In a series circuit, how does current behave?", opts: ["It splits between components", "It is the same through all components", "It increases at each component", "It decreases at each component"], ans: 1, topic: 'analog', exp: "In a <strong>series circuit</strong>, current is the same everywhere — there's only one path for current to flow. Voltage, however, splits across each component." },
        { q: "What component stores electrical charge?", opts: ["Resistor", "Inductor", "Capacitor", "Diode"], ans: 2, topic: 'analog', exp: "A <strong>capacitor</strong> stores electrical energy as an electric field between two plates. The amount stored is Q = C × V, where C is capacitance in Farads." },
        { q: "What does an LED stand for?", opts: ["Light Emitting Diode", "Low Energy Device", "Lateral Electronic Driver", "Light Enhancing Detector"], ans: 0, topic: 'analog', exp: "<strong>Light Emitting Diode</strong> — a semiconductor device that emits light when current flows in the forward direction." },
        { q: "What is the function of a diode?", opts: ["Amplify signals", "Allow current to flow in only one direction", "Store energy", "Measure voltage"], ans: 1, topic: 'analog', exp: "A <strong>diode</strong> is a one-way valve for electric current. It allows current to flow from anode to cathode and blocks it in reverse." },
        { q: "What does 'ground' (GND) mean in a circuit?", opts: ["The Earth itself", "A dangerous connection", "The common reference point at 0V", "An insulated wire"], ans: 2, topic: 'analog', exp: "<strong>Ground (GND)</strong> is the common reference point in a circuit, defined as 0 volts." },
        { q: "What happens to total resistance when you add resistors in parallel?", opts: ["It increases", "It stays the same", "It decreases", "It doubles"], ans: 2, topic: 'analog', exp: "In <strong>parallel</strong>, total resistance <em>decreases</em>: 1/Rt = 1/R1 + 1/R2." },
        { q: "What is the purpose of a fuse in a circuit?", opts: ["Increase voltage", "Protect by breaking the circuit on overcurrent", "Store energy", "Amplify signals"], ans: 1, topic: 'analog', exp: "A <strong>fuse</strong> is a safety device that melts if too much current flows, protecting components." },
        { q: "What is the difference between AC and DC?", opts: ["AC is faster than DC", "DC changes direction, AC stays constant", "AC changes direction periodically, DC flows one way", "They are the same thing"], ans: 2, topic: 'analog', exp: "<strong>DC</strong> flows in one direction; <strong>AC</strong> periodically reverses direction." },
        { q: "What is a breadboard used for?", opts: ["Cutting bread", "Permanent circuit mounting", "Temporary prototyping without soldering", "Measuring voltage"], ans: 2, topic: 'analog', exp: "A <strong>breadboard</strong> allows you to build temporary circuits without soldering." },
      ],
      intermediate: [
        { q: "A 9V battery powers an LED (Vf=2V) with a 220Ω resistor. What is the current?", opts: ["9mA", "31.8mA", "40.9mA", "22mA"], ans: 1, topic: 'analog', exp: "I = (9 - 2) / 220 ≈ 31.8mA." },
        { q: "What is the function of a bypass capacitor?", opts: ["Amplify signal", "Filter AC noise from DC power supply", "Store energy for motors", "Block DC current"], ans: 1, topic: 'analog', exp: "Decoupling caps filter high-frequency noise." },
        { q: "In an NPN transistor, what controls the collector current?", opts: ["Emitter voltage", "Base current", "Collector voltage", "Supply voltage"], ans: 1, topic: 'analog', exp: "Small base current controls large collector current." },
        { q: "What is the voltage divider output with 10kΩ and 4.7kΩ from 5V?", opts: ["3.19V", "1.81V", "2.5V", "1.5V"], ans: 1, topic: 'analog', exp: "Vout = 5 × 4.7 / (10 + 4.7) ≈ 1.6V." },
        { q: "What does PWM stand for and what is it used for?", opts: ["Pulse Width Modulation", "Power Wave Management", "Partial Wave Modulation", "Phase Width Measurement"], ans: 0, topic: 'digital', exp: "PWM controls average power by pulsing." },
        { q: "What does Kirchhoff's Current Law (KCL) state?", opts: ["Total voltage is zero", "Current entering node equals current leaving", "Power is conserved", "Resistance increases"], ans: 1, topic: 'analog', exp: "Current sums to zero at a node." },
        { q: "What is the total capacitance of two 100µF capacitors in parallel?", opts: ["50µF", "100µF", "200µF", "10µF"], ans: 2, topic: 'analog', exp: "Parallel capacitance adds: 100+100=200." },
        { q: "What is an op-amp primarily used for?", opts: ["Power regulation", "Signal amplification", "Energy storage", "Current limiting"], ans: 1, topic: 'analog', exp: "Op-amps amplify and process analog signals." },
        { q: "A 555 timer in astable mode produces?", opts: ["DC voltage", "Single pulse", "Continuous square wave", "Sine wave"], ans: 2, topic: 'analog', exp: "Astable 555 produces square waves." },
        { q: "If you connect 3 LEDs in series (Vf=2V each) to 5V?", opts: ["They light", "Only 2 light", "None light", "They blink"], ans: 2, topic: 'analog', exp: "Needs 6V minimum; none will light." },
        { q: "What does a pull-up resistor do?", opts: ["Increases speed", "Holds pin HIGH when idle", "Reduces power", "Amplifies signal"], ans: 1, topic: 'digital', exp: "Holds pin HIGH to prevent floating." },
      ],
      advanced: [
        { q: "Why does a 7805 regulator get hot with 12V in, 500mA out?", opts: ["Faulty", "P=(12-5)×0.5=3.5W heat", "Capacitors", "Load resist"], ans: 1, topic: 'analog', exp: "Linear regulators drop excess voltage as heat." },
        { q: "-3dB frequency of 10kΩ and 10nF filter?", opts: ["15.9 kHz", "1.59 kHz", "159 Hz", "15.9 Hz"], ans: 1, topic: 'analog', exp: "f = 1/(2πRC) ≈ 1.59 kHz." },
        { q: "MOSFET gate needs 10V, Arduino is 5V. Solution?", opts: ["Logic-level MOSFET", "Pull-up", "Increase voltage", "Diode bridge"], ans: 0, topic: 'mcu', exp: "Logic-level FETs (IRLZ44N) switch at 5V." },
        { q: "What is Thévenin's theorem used for?", opts: ["Power loss", "Simplifying complex circuits", "Measuring C", "PCB design"], ans: 1, topic: 'analog', exp: "Reduces circuit to Vth and Rth." },
        { q: "Role of inductor in SMPS?", opts: ["Filter", "Store/release energy", "Amplify", "Protect"], ans: 1, topic: 'analog', exp: "Inductors smooth voltage by energy storage." },
        { q: "Gain of inverting op-amp Rf=100k, Rin=10k?", opts: ["+10", "-10", "+100", "-100"], ans: 1, topic: 'analog', exp: "Av = -Rf/Rin = -10." },
        { q: "Why flyback diode across relay coil?", opts: ["Indicator", "Protect transistor from spikes", "Speed", "Power"], ans: 1, topic: 'analog', exp: "Clamps inductive voltage spikes." },
        { q: "Resonant frequency of 10mH and 100nF?", opts: ["503 Hz", "5.03 kHz", "50.3 kHz", "503 kHz"], ans: 1, topic: 'analog', exp: "f = 1/(2π√(LC)) ≈ 5.03 kHz." },
        { q: "Advantage of differential pair?", opts: ["Power", "Common-mode rejection", "Cost", "Simple"], ans: 1, topic: 'analog', exp: "Rejects noise common to both inputs." },
      ],
    };

    function setLevel(level, btn) {
      quiz.level = level;
      document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function loadQuiz() {
      const bank = QUIZ_BANK[quiz.level];
      const q = bank[Math.floor(Math.random() * bank.length)];
      quiz.current = q;
      const area = document.getElementById('quiz-area');
      area.innerHTML = `
    <div class="quiz-card">
      <div class="quiz-q">${q.q}</div>
      <div class="quiz-options">
        ${q.opts.map((o, i) => `<button class="quiz-opt" onclick="answerQuiz(${i})">${String.fromCharCode(65 + i)}. ${o}</button>`).join('')}
      </div>
    </div>`;
      // Progress bar
      const pct = Math.min(100, quiz.total * 10);
      document.getElementById('quiz-prog').style.width = pct + '%';
    }

    function answerQuiz(idx) {
      if (!quiz.current) return;
      const q = quiz.current;
      quiz.total++;
      const opts = document.querySelectorAll('.quiz-opt');
      opts.forEach(o => o.disabled = true);
      if (idx === q.ans) {
        opts[idx].classList.add('correct');
        quiz.score++; quiz.streak++;
      } else {
        opts[idx].classList.add('wrong');
        opts[q.ans].classList.add('correct');
        quiz.streak = 0;
      }
      // Explanation
      const card = document.querySelector('.quiz-card');
      const exp = document.createElement('div');
      exp.className = 'quiz-explain';
      exp.innerHTML = (idx === q.ans ? '✅ <strong>Correct!</strong> ' : '❌ <strong>Incorrect.</strong> ') + q.exp;
      card.appendChild(exp);
      // Update stats + persist
      quiz.history.unshift({ q: q.q.substring(0, 40) + '...', correct: idx === q.ans });
      updateQuizUI();
      saveQuiz();
    }

    // ── SAVE/LOAD ─────────────────────────────────────────────────────────────
    async function saveCircuit() {
      const name = document.getElementById('project-name').value.trim() || 'Untitled Circuit';
      const is_public = confirm("🌐 Make this circuit PUBLIC in the Community Gallery?");
      const payload = {
        name, is_public,
        schematic_image: S.sch.lastImage,
        schematic_description: document.getElementById('sch-desc').textContent || '',
        components: S.sch.lastSchema?.components || [],
        simulation: S.sim.lastSim, arduino_code: S.ard.lastCode, bom: S.bom.lastBom
      };
      try {
        const res = await fetch('/api/save-circuit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        currentCid = data.id;
        const btn = document.querySelector('.btn-sm');
        const orig = btn.textContent; btn.textContent = '✅ Cloud Saved!';
        setTimeout(() => btn.textContent = orig, 2000);
        if (is_public) loadGallery();
        broadcastUpdate('rename', name);
      } catch (e) { alert('Save failed: ' + e.message); }
    }

    // ── GALLERY LOGIC ─────────────────────────────────────────────────────────
    async function loadGallery() {
      const el = document.getElementById('gallery-list');
      try {
        const res = await fetch('/api/gallery');
        const data = await res.json();
        if (!data.gallery || !data.gallery.length) {
          el.innerHTML = '<div class="placeholder"><p>No public circuits yet. Be the first to share!</p></div>';
          return;
        }
        el.innerHTML = data.gallery.map(c => `
          <div class="gallery-card">
            <img class="gallery-img" src="data:image/png;base64,${c.image}" onerror="this.src='https://via.placeholder.com/300x160/0a0f1c/00c8f0?text=Schematic'"/>
            <div class="gallery-info">
              <div class="gallery-title">⚡ ${c.name}</div>
              <div class="gallery-desc">${c.description || 'No description provided.'}</div>
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:.6rem;color:var(--text-dim)">${c.saved_at}</span>
                <button class="btn btn-sm btn-primary" onclick="loadFromGallery('${c.id}')">🍴 Fork</button>
              </div>
            </div>
          </div>`).join('');
      } catch (e) { el.innerHTML = '<p>Failed to load gallery.</p>'; }
    }

    async function loadFromGallery(id) {
      try {
        const res = await fetch(`/api/load-circuit/${id}`);
        const data = await res.json();
        S.sch.lastSchema = data.components ? { components: data.components, description: data.schematic_description, title: data.name } : null;
        S.sch.lastImage = data.schematic_image;
        document.getElementById('project-name').value = data.name + " (forked)";
        showToast('🍴 Circuit forked to your workspace!');
        switchTab('schematic', document.querySelectorAll('.tab')[1]);
        if (data.schematic_image) {
          document.getElementById('sch-img').src = 'data:image/png;base64,' + data.schematic_image;
          document.getElementById('sch-img').style.display = 'block';
          document.getElementById('sch-ph').style.display = 'none';
        }
      } catch (e) { showToast('❌ Failed to fork circuit.'); }
    }

    function toggleLabMode() {
      document.body.classList.toggle('lab-mode');
      const active = document.body.classList.contains('lab-mode');
      const btn = document.querySelector('.btn-lab');
      btn.textContent = active ? '🏠 NORMAL MODE' : '🔬 LAB MODE';
      showToast(active ? '🔬 Lab Mode Enabled: High-visibility for the workbench' : '🏠 Returning to Normal Mode');
    }

    async function loadSavedList() {
      try {
        const res = await fetch('/api/list-circuits');
        const data = await res.json();
        const el = document.getElementById('saved-list');
        if (!data.circuits.length) {
          el.innerHTML = '<div class="placeholder"><div class="placeholder-icon">🗂️</div><p>No circuits saved yet</p></div>'; return;
        }
        el.innerHTML = data.circuits.map(c => `
      <div class="saved-item">
        <div class="saved-item-info">
          <div class="saved-item-name">⚡ ${c.name}</div>
          <div class="saved-item-time">${c.saved_at}</div>
        </div>
        <button class="btn btn-sm" onclick="loadCircuit('${c.id}')">Load</button>
      </div>`).join('');
      } catch (e) { console.error(e); }
    }

    async function loadCircuit(id) {
      try {
        const res = await fetch(`/api/load-circuit/${id}`);
        const data = await res.json(); if (data.error) { alert(data.error); return; }
        document.getElementById('project-name').value = data.name || '';
        document.getElementById('loaded-ph').style.display = 'none';
        document.getElementById('loaded-out').style.display = 'block';
        const img = document.getElementById('loaded-img');
        if (data.schematic_image) { img.src = 'data:image/png;base64,' + data.schematic_image; img.style.display = 'block'; }
        document.getElementById('loaded-desc').textContent = data.schematic_description || '';
        if (data.schematic_image) { S.sch.lastImage = data.schematic_image; pdfData.schematic_image = data.schematic_image; }
        if (data.simulation) { S.sim.lastSim = data.simulation; pdfData.simulation = data.simulation; }
        if (data.arduino_code) { S.ard.lastCode = data.arduino_code; pdfData.arduino_code = data.arduino_code; }
        if (data.bom) { S.bom.lastBom = data.bom; pdfData.bom = data.bom; }
        pdfData.components = data.components || [];
      } catch (e) { alert('Load failed: ' + e.message); }
    }

    // ── DOWNLOADS ─────────────────────────────────────────────────────────────
    function dlSchematic() { if (!S.sch.lastImage) return; const a = document.createElement('a'); a.href = 'data:image/png;base64,' + S.sch.lastImage; a.download = 'schematic.png'; a.click(); }
    function exportNetlist() {
      if (!S.sch.lastSchema) return;
      const netlist = {
        project: document.getElementById('project-name').value || 'Untitled',
        version: '1.0',
        generated_by: 'Circuit Copilot',
        components: S.sch.lastSchema.components || [],
        connections: S.sch.lastSchema.connections || []
      };
      const blob = new Blob([JSON.stringify(netlist, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = (netlist.project.replace(/\s+/g, '_') || 'circuit') + '_netlist.json'; a.click();
    }
    function dlArduino() {
      const c = S.ard.lastCode; if (!c) return;
      const m = c.match(/```(?:cpp|arduino|ino)?\n([\s\S]*?)```/); const blob = new Blob([m ? m[1] : c], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sketch.ino'; a.click();
    }
    function dlBOM() { if (!S.bom.lastBom) return; const items = S.bom.lastBom.items || []; const hdr = 'Ref,Description,Value,Qty,Unit Cost,Total,Supplier,Part#,Notes\n'; const rows = items.map(i => [i.ref, i.description, i.value, i.quantity, i.unit_cost, i.total_cost, i.supplier, i.part_number || '', i.notes || ''].map(v => `"${v}"`).join(',')).join('\n'); const blob = new Blob([hdr + rows], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'bom.csv'; a.click(); }

    // ── PDF ────────────────────────────────────────────────────────────────────
    async function exportPDF() {
      if (!pdfData.schematic_image && !pdfData.simulation && !pdfData.arduino_code && !pdfData.bom) { alert('Generate at least one section first!'); return; }
      pdfData.project_name = document.getElementById('project-name').value || 'Circuit Copilot Report';
      try {
        const res = await fetch('/api/export-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pdfData) });
        if (!res.ok) throw new Error('PDF failed');
        const blob = await res.blob();
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = (pdfData.project_name.replace(/\s+/g, '_') || 'report') + '.pdf'; a.click();
      } catch (e) { alert('PDF error: ' + e.message); }
    }

    // ── TEMPLATES ─────────────────────────────────────────────────────────────
    const TEMPLATES = [
      {
        name: 'Basic LED Circuit', icon: '💡', diff: 'Beginner', color: 'accent2',
        desc: 'Simple LED with current-limiting resistor powered by 9V battery.',
        prompt: 'LED circuit with a 220 ohm resistor and a 9V battery'
      },
      {
        name: 'Voltage Divider', icon: '📐', diff: 'Beginner', color: 'accent2',
        desc: 'Two resistors splitting voltage — fundamental building block.',
        prompt: 'Voltage divider with 10kΩ and 4.7kΩ resistors from 5V supply'
      },
      {
        name: '555 Timer LED Blinker', icon: '⏱️', diff: 'Intermediate', color: 'accent',
        desc: 'Classic astable 555 timer circuit that blinks an LED at ~1Hz.',
        prompt: '555 timer in astable mode blinking an LED at 1Hz with 9V battery'
      },
      {
        name: 'Arduino Temp Sensor', icon: '🌡️', diff: 'Intermediate', color: 'accent',
        desc: 'DHT11 temperature & humidity sensor connected to Arduino Uno.',
        prompt: 'Arduino Uno with DHT11 temperature sensor, 10kΩ pull-up resistor, and 16x2 LCD display'
      },
      {
        name: 'H-Bridge Motor Driver', icon: '⚙️', diff: 'Advanced', color: 'accent3',
        desc: 'Bidirectional DC motor control using 4 transistors or L298N module.',
        prompt: 'H-bridge motor driver using 4 NPN transistors for bidirectional DC motor control with 12V supply'
      },
      {
        name: 'RC Low-Pass Filter', icon: '〰️', diff: 'Intermediate', color: 'accent',
        desc: 'Passes low frequencies, attenuates high — audio and signal filtering.',
        prompt: 'RC low-pass filter with 10kΩ resistor and 100nF capacitor'
      },
      {
        name: 'NPN Transistor Switch', icon: '🔀', diff: 'Beginner', color: 'accent2',
        desc: 'Using a transistor to switch a high-power load from a microcontroller.',
        prompt: 'NPN transistor BC547 switching a 12V relay with 1kΩ base resistor from Arduino 5V pin'
      },
      {
        name: 'LDR Light Sensor', icon: '☀️', diff: 'Beginner', color: 'accent2',
        desc: 'Light-dependent resistor controlling an LED brightness.',
        prompt: 'LDR light sensor voltage divider with 10kΩ resistor, connected to Arduino analog pin A0, controlling LED on pin 9'
      }
    ];

    function renderTemplates() {
      const grid = document.getElementById('tpl-grid');
      grid.innerHTML = TEMPLATES.map((t, i) => `
    <div class="tpl-card">
      <h3>${t.icon} ${t.name}</h3>
      <div class="tpl-meta"><span class="badge badge-${t.diff === 'Beginner' ? 'ok' : t.diff === 'Intermediate' ? 'info' : 'warn'}">${t.diff}</span></div>
      <p>${t.desc}</p>
      <button class="btn btn-primary" style="width:100%" onclick="loadTemplate(${i})">⚡ Load Template</button>
    </div>`).join('');
    }
    function loadTemplate(idx) {
      const t = TEMPLATES[idx];
      document.getElementById('sch-input').value = t.prompt;
      // Switch to schematic tab
      const tabs = document.querySelectorAll('.tab');
      switchTab('schematic', tabs[0]);
      // Flash the input
      const inp = document.getElementById('sch-input');
      inp.style.borderColor = 'var(--accent2)';
      setTimeout(() => inp.style.borderColor = '', 1500);
    }
    setTimeout(renderTemplates, 50);

    // ── COMPONENT REFERENCE TOGGLE ────────────────────────────────────────────
    function toggleRef() {
      const el = document.getElementById('comp-ref');
      const btn = document.getElementById('ref-toggle-btn');
      if (el.style.display === 'none') { el.style.display = 'block'; btn.textContent = '▼ Component Reference'; }
      else { el.style.display = 'none'; btn.textContent = '▶ Component Reference'; }
    }

    // ── SHORTCUTS MODAL ───────────────────────────────────────────────────────
    function toggleShortcuts() {
      const m = document.getElementById('shortcuts-modal');
      m.classList.toggle('visible');
    }

    // ── KEYBOARD SHORTCUTS ────────────────────────────────────────────────────
    document.getElementById('project-name').addEventListener('input', (e) => {
      broadcastUpdate('rename', e.target.value);
    });
    document.addEventListener('keydown', (e) => {
      // Don't trigger if user is typing in an input/textarea
      const active = document.activeElement;
      const isTyping = active && (active.tagName === 'TEXTAREA' || active.tagName === 'INPUT');

      // Ctrl+Enter to submit current active tab input
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) { const btn = activeTab.querySelector('.btn-primary'); if (btn && !btn.disabled) btn.click(); }
        return;
      }
      // Ctrl+S to save
      if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveCircuit(); return; }
      // Ctrl+E to export PDF
      if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportPDF(); return; }
      // Ctrl+D to toggle theme
      if (e.ctrlKey && e.key === 'd') { e.preventDefault(); toggleTheme(); return; }

      if (isTyping) return; // Below shortcuts only when not typing

      // ? to show shortcuts
      if (e.key === '?') { e.preventDefault(); toggleShortcuts(); return; }
      // Escape to close modal
      if (e.key === 'Escape') { const m = document.getElementById('shortcuts-modal'); if (m.classList.contains('visible')) { toggleShortcuts(); return; } }

      // Number keys 1-0 for tab switching
      const tabMap = {
        '1': 'schematic', '2': 'simulate', '3': 'waveform', '4': 'bom', '5': 'components',
        '6': 'debug', '7': 'arduino', '8': 'learn', '9': 'quiz', '0': 'templates'
      };
      if (tabMap[e.key]) {
        e.preventDefault();
        const tabs = document.querySelectorAll('.tab');
        const idx = Object.keys(tabMap).indexOf(e.key);
        if (tabs[idx]) switchTab(tabMap[e.key], tabs[idx]);
      }
    });

    // ── CIRCUIT SHARING ──────────────────────────────────────────────────────
    function shareCircuit() {
      if (!S.sch.lastSchema) { showToast('⚠ Generate a schematic first!'); return; }
      const data = JSON.stringify(S.sch.lastSchema);
      const encoded = btoa(unescape(encodeURIComponent(data)));
      const url = window.location.origin + window.location.pathname + '#circuit=' + encoded;
      navigator.clipboard.writeText(url).then(() => {
        showToast('🔗 Share link copied to clipboard!');
      }).catch(() => {
        prompt('Copy this share link:', url);
      });
    }

    // Auto-load shared circuit from URL hash
    function loadSharedCircuit() {
      const hash = window.location.hash;
      if (!hash.startsWith('#circuit=')) return;
      try {
        const encoded = hash.slice('#circuit='.length);
        const json = decodeURIComponent(escape(atob(encoded)));
        const schema = JSON.parse(json);
        S.sch.lastSchema = schema;
        // Populate the input with the circuit title and trigger generation
        const input = document.getElementById('sch-input');
        input.value = schema.title || 'Shared circuit';
        showToast('📋 Shared circuit loaded! Click ⚡ to generate.');
        // Switch to schematic tab
        const tabs = document.querySelectorAll('.tab');
        if (tabs[0]) switchTab('schematic', tabs[0]);
      } catch (e) {
        console.error('Failed to load shared circuit:', e);
      }
    }
    setTimeout(loadSharedCircuit, 200);

    // ── SCREENSHOT / SOCIAL SHARE ────────────────────────────────────────────
    function screenshotCircuit() {
      const img = document.getElementById('sch-img');
      if (!img || !img.src || img.style.display === 'none') {
        showToast('⚠ Generate a schematic first!'); return;
      }
      const title = S.sch.lastSchema?.title || 'Circuit Schematic';
      const desc = S.sch.lastSchema?.description || '';

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 800;
      canvas.height = 560;

      // Background
      ctx.fillStyle = '#0a0f1a';
      ctx.fillRect(0, 0, 800, 560);

      // Top bar accent
      const topGrad = ctx.createLinearGradient(0, 0, 800, 0);
      topGrad.addColorStop(0, '#00c8f0');
      topGrad.addColorStop(1, '#00f090');
      ctx.fillStyle = topGrad;
      ctx.fillRect(0, 0, 800, 4);

      // Title
      ctx.fillStyle = '#e8f0ff';
      ctx.font = 'bold 22px Syne, sans-serif';
      ctx.fillText(title, 30, 42);

      // Description
      if (desc) {
        ctx.fillStyle = '#6a8aaa';
        ctx.font = '13px Syne, sans-serif';
        const words = desc.split(' ');
        let line = '', y = 66;
        for (const w of words) {
          const test = line + w + ' ';
          if (ctx.measureText(test).width > 740) {
            ctx.fillText(line, 30, y); y += 18; line = w + ' ';
          } else { line = test; }
        }
        ctx.fillText(line, 30, y);
      }

      // Schematic image
      const sImg = new Image();
      sImg.crossOrigin = 'anonymous';
      sImg.onload = () => {
        const imgY = 90;
        const maxW = 740, maxH = 400;
        let w = sImg.width, h = sImg.height;
        const scale = Math.min(maxW / w, maxH / h);
        w *= scale; h *= scale;
        const x = (800 - w) / 2;
        ctx.drawImage(sImg, x, imgY, w, h);

        // Bottom branding bar
        ctx.fillStyle = '#0d1220';
        ctx.fillRect(0, 520, 800, 40);
        ctx.fillStyle = '#00c8f0';
        ctx.font = 'bold 13px JetBrains Mono, monospace';
        ctx.fillText('⚡ CIRCUIT COPILOT', 30, 545);
        ctx.fillStyle = '#4a6a8a';
        ctx.font = '11px JetBrains Mono, monospace';
        ctx.textAlign = 'right';
        ctx.fillText('AI-Powered Circuit Design', 770, 545);
        ctx.textAlign = 'left';

        // Download
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = (title.replace(/\s+/g, '_') || 'circuit') + '_share.png';
          a.click();
          URL.revokeObjectURL(url);
          showToast('📸 Screenshot saved!');
        });
      };
      sImg.src = img.src;
    }

    // ── FEATURE 2: CHAT HISTORY PERSISTENCE ──────────────────────────────────
    function saveChatHistory(chatId) {
      const chat = document.getElementById(chatId);
      if (!chat) return;
      const msgs = Array.from(chat.querySelectorAll('.msg')).slice(-20).map(m => ({
        role: m.classList.contains('user') ? 'user' : 'assistant',
        html: m.innerHTML
      }));
      localStorage.setItem('cc_chat_' + chatId, JSON.stringify(msgs));
    }
    function restoreChatHistory(chatId) {
      const saved = JSON.parse(localStorage.getItem('cc_chat_' + chatId) || '[]');
      const chat = document.getElementById(chatId);
      if (!chat || !saved.length) return;
      saved.forEach(m => {
        const d = document.createElement('div');
        d.className = 'msg ' + m.role;
        d.innerHTML = m.html;
        chat.appendChild(d);
      });
      chat.scrollTop = chat.scrollHeight;
    }
    function clearChatHistory(chatId) {
      const chat = document.getElementById(chatId);
      if (chat) chat.innerHTML = '';
      localStorage.removeItem('cc_chat_' + chatId);
      showToast('🗑 Chat cleared');
    }
    // Patch appendMsg to auto-save
    const _origAppendMsg = appendMsg;
    appendMsg = function (chatId, role, content) {
      _origAppendMsg(chatId, role, content);
      saveChatHistory(chatId);
    };
    // Restore all chat histories on load
    ['sch-chat', 'sim-chat', 'bom-chat', 'comp-chat', 'debug-chat', 'ard-chat', 'learn-chat'].forEach(id => restoreChatHistory(id));

    // ── FEATURE 3: CIRCUIT HISTORY (localStorage) ──────────────────────────────
    function getCircuitHistory() {
      return JSON.parse(localStorage.getItem('cc_circuit_history') || '[]');
    }
    function addToCircuitHistory(title, schema) {
      const history = getCircuitHistory();
      history.unshift({
        id: Date.now(),
        title: title || 'Untitled',
        schema: schema,
        time: new Date().toLocaleString()
      });
      // Keep last 20
      localStorage.setItem('cc_circuit_history', JSON.stringify(history.slice(0, 20)));
      renderCircuitHistory();
    }
    function renderCircuitHistory() {
      const el = document.getElementById('circuit-history');
      if (!el) return;
      const history = getCircuitHistory();
      if (!history.length) {
        el.innerHTML = '<p style="font-size:.72rem;color:var(--text-dim);text-align:center;padding:8px;">No circuit history yet</p>';
        return;
      }
      el.innerHTML = history.map(h => `
        <div class="history-item" onclick="loadFromHistory(${h.id})">
          <div class="history-item-info">
            <div class="history-item-name">⚡ ${h.title}</div>
            <div class="history-item-time">${h.time}</div>
          </div>
          <button class="history-del" onclick="event.stopPropagation();deleteFromHistory(${h.id})" title="Delete">✕</button>
        </div>`).join('');
    }
    function loadFromHistory(id) {
      const h = getCircuitHistory().find(c => c.id === id);
      if (!h) return;
      S.sch.lastSchema = h.schema;
      const input = document.getElementById('sch-input');
      input.value = h.schema.title || h.title;
      showToast('📋 Loaded: ' + h.title);
      const tabs = document.querySelectorAll('.tab');
      if (tabs[0]) switchTab('schematic', tabs[0]);
    }
    function deleteFromHistory(id) {
      const history = getCircuitHistory().filter(c => c.id !== id);
      localStorage.setItem('cc_circuit_history', JSON.stringify(history));
      renderCircuitHistory();
      showToast('🗑 Removed from history');
    }
    function clearCircuitHistory() {
      localStorage.removeItem('cc_circuit_history');
      renderCircuitHistory();
      showToast('🗑 History cleared');
    }
    // ── CALCULATORS ──────────────────────────────────────────────────────────
    function switchCalc(type, btn) {
      document.querySelectorAll('.calc-tab').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.calc-group').forEach(e => e.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('calc-' + type).classList.add('active');
    }
    function calcLED() {
      const vs = +document.getElementById('led-vs').value;
      const vf = +document.getElementById('led-vf').value;
      const im = +document.getElementById('led-if').value;
      const res = (vs - vf) / (im / 1000);
      document.getElementById('led-r').value = res > 0 ? Math.ceil(res) : 0;
      document.getElementById('led-result').textContent = res > 0 ? `Use ${Math.ceil(res)}Ω resistor (Nearest standard: ${getStandardRes(res)}Ω)` : 'Invalid values';
    }
    function getStandardRes(r) {
      const e24 = [1.0, 1.1, 1.2, 1.3, 1.5, 1.6, 1.8, 2.0, 2.2, 2.4, 2.7, 3.0, 3.3, 3.6, 3.9, 4.3, 4.7, 5.1, 5.6, 6.2, 6.8, 7.5, 8.2, 9.1];
      const mag = Math.pow(10, Math.floor(Math.log10(r)));
      const val = r / mag;
      let closest = e24[0];
      let diff = Math.abs(val - closest);
      for (let v of e24) {
        if (Math.abs(val - v) < diff) { diff = Math.abs(val - v); closest = v; }
      }
      return Math.round(closest * mag);
    }
    function calc555() {
      const r1 = +document.getElementById('555-r1').value;
      const r2 = +document.getElementById('555-r2').value;
      const c = +document.getElementById('555-c').value * 1e-6;
      if (!r1 || !r2 || !c) return;
      const freq = 1.44 / ((r1 + 2 * r2) * c);
      const duty = ((r1 + r2) / (r1 + 2 * r2)) * 100;
      document.getElementById('555-result').textContent = `Freq: ${freq < 1000 ? freq.toFixed(1) + ' Hz' : (freq / 1000).toFixed(2) + ' kHz'} · Duty: ${duty.toFixed(1)}%`;
    }

    // ── ARCHITECT LOGIC ──────────────────────────────────────────────────────
    let customParts = JSON.parse(localStorage.getItem('cc_custom_parts') || '[]');
    function saveCustomPart() {
      const name = document.getElementById('arc-name').value.trim();
      const type = document.getElementById('arc-type').value;
      const pins = document.getElementById('arc-pins').value.trim();
      const specs = document.getElementById('arc-specs').value.trim();
      if (!name || !pins) { showToast('⚠ Name and Pins are required!'); return; }

      const part = { id: Date.now(), name, type, pins, specs };
      customParts.unshift(part);
      localStorage.setItem('cc_custom_parts', JSON.stringify(customParts));
      renderArchitect();
      showToast('✨ Component added to library!');
      // Clear fields
      document.getElementById('arc-name').value = '';
      document.getElementById('arc-pins').value = '';
      document.getElementById('arc-specs').value = '';
    }
    function renderArchitect() {
      const list = document.getElementById('arc-list');
      if (!customParts.length) {
        list.innerHTML = '<p style="font-size:.72rem;color:var(--text-dim);text-align:center;">No custom components defined yet.</p>';
        return;
      }
      list.innerHTML = customParts.map(p => `
        <div class="audit-item audit-tip" style="margin-bottom:8px;border-left:4px solid var(--accent)">
          <div class="audit-icon">IC</div>
          <div class="audit-content">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h5>${p.name} <small style="color:var(--text-dim)">(${p.type})</small></h5>
              <button class="btn btn-sm" onclick="deletePart(${p.id})" style="padding:2px 6px;">✕</button>
            </div>
            <p><strong>Pins:</strong> ${p.pins}</p>
            <p style="font-style:italic;margin-top:4px;">${p.specs || 'No specs provided.'}</p>
          </div>
        </div>`).join('');
    }
    function deletePart(id) {
      customParts = customParts.filter(p => p.id !== id);
      localStorage.setItem('cc_custom_parts', JSON.stringify(customParts));
      renderArchitect();
    }
    setTimeout(renderArchitect, 250);

    // ── FUNCTION PATCHING (Inject Custom Parts into AI Prompt) ────────────────
    const _origRunSchematic = window.runSchematic;
    window.runSchematic = async function () {
      // Temporarily modify the global prompt or context if needed
      // Here we'll append the custom parts library to the user prompt internally
      const input = document.getElementById('sch-input');
      const originalVal = input.value;
      const persona = document.getElementById('ai-persona').value;
      const expertise = {
        analog: "Focus on signal integrity, analog filtering, and biasing.",
        embedded: "Focus on microcontroller pinouts, firmware compatibility, and decoupling.",
        power: "Focus on voltage regulation, current capacity, and thermal management."
      }[persona] || "";

      if (expertise) input.value += ` [PERSONA: ${persona.toUpperCase()} - ${expertise}]`;

      if (customParts.length) {
        const partsInfo = customParts.map(p => `[CUSTOM PART: Name: ${p.name}, Pins: ${p.pins}, Specs: ${p.specs}]`).join(' ');
        input.value += ` (You can use these custom components from my library: ${partsInfo})`;
      }

      await _origRunSchematic();

      input.value = originalVal; // Restore UI
      if (S.sch.lastSchema) {
        broadcastUpdate('schematic', {
          schema: S.sch.lastSchema,
          image: S.sch.lastImage,
          desc: document.getElementById('sch-desc').textContent
        });
        document.getElementById('sch-audit').style.display = 'inline-flex';
        document.getElementById('sch-eda').style.display = 'inline-flex';
        addToCircuitHistory(S.sch.lastSchema.title || document.getElementById('sch-input').value, S.sch.lastSchema);
        S.stats.circuits++;
        saveStats();
        if (document.getElementById('tab-dashboard').classList.contains('active')) renderDashboard();
        renderBreadboard(S.sch.lastSchema);
      }
      updateTabBadge('schematic', true);
    };

    // ── BREADBOARD LOGIC ──────────────────────────────────────────────────────
    function initBreadboard() {
      const visual = document.getElementById('bb-visual');
      if (visual.innerHTML.includes('bb-row')) return; // Already init
      visual.innerHTML = '';
      // Draw rails and grid
      for (let r = 0; r < 12; r++) {
        if (r === 2 || r === 9) { // Rails
          const rail = document.createElement('div');
          rail.className = r === 2 ? 'bb-rail-red' : 'bb-rail-blue';
          visual.appendChild(rail);
          continue;
        }
        const row = document.createElement('div');
        row.className = 'bb-row';
        for (let c = 0; c < 30; c++) {
          const hole = document.createElement('div');
          hole.className = 'bb-hole';
          hole.id = `bb-${r}-${c}`;
          row.appendChild(hole);
          if (c === 14) row.appendChild(document.createElement('div')).style.width = '20px';
        }
        visual.appendChild(row);
      }
    }

    async function renderBreadboard(schema) {
      document.getElementById('bb-instructions').innerHTML = '';
      document.getElementById('bb-loading').style.display = 'block';
      try {
        const res = await fetch('/api/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{ role: 'system', content: 'Act as a professional electronics instructor. Convert this schematic into step-by-step physical wiring instructions for a standard breadboard. Use coordinates like "Row A, Pin 10". Format as a JSON list of {step: string}.' },
            { role: 'user', content: JSON.stringify(schema) }],
            endpoint: 'gpt'
          })
        });
        const data = await res.json();
        const steps = JSON.parse(data.reply.match(/\[[\s\S]*\]/)?.[0] || '[]');
        const out = document.getElementById('bb-instructions');
        if (!steps.length) out.innerHTML = '<p>Could not generate steps. Try again.</p>';
        else {
          out.innerHTML = steps.map((s, i) => `
            <div class="guide-step">
              <span class="guide-num">#${i + 1}</span>
              <span class="guide-txt">${s.step}</span>
            </div>`).join('');
          // Randomly highlight some holes for visual effect
          document.querySelectorAll('.bb-hole').forEach(h => h.classList.remove('active'));
          for (let i = 0; i < 15; i++) {
            const h = document.getElementById(`bb-${Math.floor(Math.random() * 12)}-${Math.floor(Math.random() * 30)}`);
            if (h) h.classList.add('active');
          }
        }
      } catch (e) {
        document.getElementById('bb-instructions').innerHTML = '<p>Error generating wiring guide.</p>';
      } finally {
        document.getElementById('bb-loading').style.display = 'none';
      }
    }

    async function runAudit(type) {
      const out = document.getElementById(type + '-audit-out');
      const data = type === 'sch' ? S.sch.lastSchema : S.sim.lastSim;
      if (!data) return;
      out.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing design...</div>';
      out.style.display = 'block';
      try {
        const res = await fetch('/api/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{
              role: 'system',
              content: 'You are a Senior Electronics Design Engineer. Perform an "AI Design Audit" on the provided circuit. Identify: 1. Critical Errors (safety, short circuits, missing resistors), 2. Optimization Tips (better components, power efficiency). Return as JSON list of {type: "warning"|"error"|"tip", title: string, desc: string}.'
            },
            { role: 'user', content: JSON.stringify(data) }],
            endpoint: 'gpt'
          })
        });
        const json = await res.json();
        const results = JSON.parse(json.reply.match(/\[[\s\S]*\]/)?.[0] || '[]');
        if (!results.length) out.innerHTML = '<div class="audit-item audit-tip"><div class="audit-icon">✅</div><div class="audit-content"><h5>No Issues Found</h5><p>Your design follows standard best practices!</p></div></div>';
        else {
          out.innerHTML = results.map(r => `
            <div class="audit-item audit-${r.type === 'error' ? 'err' : r.type}">
              <div class="audit-icon">${r.type === 'error' ? '🚫' : r.type === 'warning' ? '⚠️' : '💡'}</div>
              <div class="audit-content">
                <h5>${r.title}</h5>
                <p>${r.desc}</p>
              </div>
            </div>`).join('');
        }
      } catch (e) { out.innerHTML = '<p style="padding:10px;font-size:.7rem;color:var(--warn);">Audit failed. AI might be busy.</p>'; }
    }
    const _oldRunSimulate = window.runSimulate;
    window.runSimulate = async function () {
      await _oldRunSimulate();
      if (S.sim.lastSim) {
        document.getElementById('sim-audit').style.display = 'inline-flex';
      }
      updateTabBadge('simulate', true);
    };
    const _oldRunBOM = window.runBOM;
    window.runBOM = async function () {
      await _oldRunBOM();
      updateTabBadge('bom', true);
    };
    const _oldRunChat = window.runChat;
    window.runChat = async function (ep, p, outId, phId) {
      await _oldRunChat(ep, p, outId, phId);
      updateTabBadge(p, true);
    };
    // Render on load
    setTimeout(renderCircuitHistory, 150);

    // ── FEATURE 5: OHM'S LAW CALCULATOR ────────────────────────────────────────
    function calcOhm() {
      const vEl = document.getElementById('ohm-v');
      const iEl = document.getElementById('ohm-i');
      const rEl = document.getElementById('ohm-r');
      const pEl = document.getElementById('ohm-p');
      const res = document.getElementById('ohm-result');
      const v = vEl.value !== '' ? parseFloat(vEl.value) : null;
      const i = iEl.value !== '' ? parseFloat(iEl.value) : null;
      const r = rEl.value !== '' ? parseFloat(rEl.value) : null;
      // Reset computed styles
      [vEl, iEl, rEl, pEl].forEach(el => el.classList.remove('computed'));
      let cv = v, ci = i, cr = r, cp = null;
      if (v !== null && i !== null) {
        cr = i !== 0 ? v / i : Infinity;
        cp = v * i;
        rEl.value = cr === Infinity ? '∞' : cr.toFixed(4);
        rEl.classList.add('computed');
      } else if (v !== null && r !== null) {
        ci = r !== 0 ? v / r : Infinity;
        cp = v * ci;
        iEl.value = ci === Infinity ? '∞' : ci.toFixed(6);
        iEl.classList.add('computed');
      } else if (i !== null && r !== null) {
        cv = i * r;
        cp = cv * i;
        vEl.value = cv.toFixed(4);
        vEl.classList.add('computed');
      } else {
        res.textContent = 'Enter any 2 values to calculate';
        pEl.value = '';
        return;
      }
      if (cp !== null) {
        pEl.value = cp.toFixed(4);
        pEl.classList.add('computed');
      }
      const formula = v !== null && i !== null ? 'V = I × R' : v !== null && r !== null ? 'I = V / R' : 'V = I × R';
      res.textContent = `${formula}  ·  P = ${cp !== null ? cp.toFixed(2) + ' W' : '—'}`;
    }

    // ── FEATURE 6: QUIZ STREAK CONFETTI ──────────────────────────────────────
    function fireConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const ctx = canvas.getContext('2d');
      const particles = [];
      const colors = ['#00c8f0', '#00f090', '#ff7043', '#a855f7', '#ffb300', '#ff69b4', '#00ff88'];
      for (let i = 0; i < 80; i++) {
        particles.push({
          x: canvas.width / 2 + (Math.random() - .5) * 200,
          y: canvas.height / 2,
          vx: (Math.random() - .5) * 12,
          vy: -Math.random() * 14 - 4,
          size: Math.random() * 6 + 3,
          color: colors[Math.floor(Math.random() * colors.length)],
          rotation: Math.random() * 360,
          rotSpeed: (Math.random() - .5) * 10,
          life: 1
        });
      }
      let frame = 0;
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let alive = false;
        particles.forEach(p => {
          if (p.life <= 0) return;
          alive = true;
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.35;
          p.rotation += p.rotSpeed;
          p.life -= 0.012;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.globalAlpha = p.life;
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * .4);
          ctx.restore();
        });
        frame++;
        if (alive && frame < 150) requestAnimationFrame(draw);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      requestAnimationFrame(draw);
    }
    // Patch answerQuiz to trigger confetti on streak >= 3
    const _origAnswerQuiz = answerQuiz;
    answerQuiz = function (idx) {
      if (!quiz.current) return;
      const q = quiz.current;
      _origAnswerQuiz(idx);
      if (idx === q.ans) {
        if (q.topic && S.stats[q.topic] !== undefined) {
          S.stats[q.topic]++;
          saveStats();
        }
        if (quiz.streak >= 3) {
          fireConfetti();
          showToast(`🔥 ${quiz.streak} streak! Keep it up!`, 2500);
        }
      }
      if (document.getElementById('tab-dashboard').classList.contains('active')) renderDashboard();
    };

    // ── HARDWARE BRIDGE (SERIAL) ──────────────────────────────────────────────
    let port, reader, writer, serialPlotData = [];
    async function connectSerial() {
      const btn = document.getElementById('btn-serial-connect');
      try {
        if (port) {
          await reader.cancel(); await port.close();
          port = null; btn.textContent = '🔌 Connect Device';
          showToast('🔌 Disconnected'); return;
        }
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        btn.textContent = '🔴 Disconnect';
        showToast('🔌 Connected to Hardware!');
        readLoop();
      } catch (e) { showToast('❌ Serial Error: ' + e.message); }
    }
    async function readLoop() {
      const out = document.getElementById('serial-out');
      while (port?.readable) {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const text = new TextDecoder().decode(value);
            out.textContent += text; out.scrollTop = out.scrollHeight;
            processPlotData(text);
          }
        } catch (e) { console.error(e); } finally { reader.releaseLock(); }
      }
    }
    async function sendSerial() {
      if (!port || !port.writable) { showToast('⚠ Device not connected'); return; }
      const input = document.getElementById('serial-input');
      const msg = input.value + '\n';
      writer = port.writable.getWriter();
      await writer.write(new TextEncoder().encode(msg));
      writer.releaseLock(); input.value = '';
    }
    function clearSerial() {
      document.getElementById('serial-out').textContent = '';
      serialPlotData = []; drawSerialPlot();
    }
    function processPlotData(text) {
      const lines = text.split('\n');
      lines.forEach(line => {
        const val = parseFloat(line.trim());
        if (!isNaN(val)) {
          serialPlotData.push(val);
          if (serialPlotData.length > 200) serialPlotData.shift();
        }
      });
      drawSerialPlot();
    }
    function drawSerialPlot() {
      const canvas = document.getElementById('serial-plot');
      const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.offsetWidth;
      const H = canvas.height = canvas.offsetHeight;
      ctx.clearRect(0, 0, W, H);
      if (serialPlotData.length < 2) return;
      const max = Math.max(...serialPlotData, 10), min = Math.min(...serialPlotData, 0);
      const range = max - min || 1;
      ctx.beginPath(); ctx.strokeStyle = '#00f090'; ctx.lineWidth = 2;
      serialPlotData.forEach((v, i) => {
        const x = (i / (serialPlotData.length - 1)) * W;
        const y = H - ((v - min) / range) * H;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    async function exportKiCad() {
      const name = document.getElementById('project-name').value.trim() || 'Circuit';
      try {
        const res = await fetch('/api/export-kicad', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, components: S.sch.lastSchema?.components || [] })
        });
        const data = await res.json();
        const blob = new Blob([data.kicad_sch], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name + '.kicad_sch'; a.click();
        showToast('📦 KiCad Schematic Downloaded!');
      } catch (e) { showToast('❌ Export failed'); }
    }

    // ── CO-PILOT LIVE (COLLABORATION) ─────────────────────────────────────────
    function startCollab() {
      if (!currentCid) {
        showToast('⚠ Please SAVE your circuit first to start collaboration.');
        return;
      }
      if (collabSocket) {
        collabSocket.close();
        collabSocket = null;
        document.getElementById('btn-collab').textContent = '🤝 Collab';
        document.getElementById('btn-collab').classList.remove('btn-green');
        showToast('🤝 Collaboration Session Ended');
        return;
      }

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/${currentCid}`;
      collabSocket = new WebSocket(wsUrl);

      collabSocket.onopen = () => {
        document.getElementById('btn-collab').textContent = '🟢 Live';
        document.getElementById('btn-collab').classList.add('btn-green');
        showToast('🟢 Co-Pilot Live Active! Others on this project will sync.');
      };

      collabSocket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        handleRemoteUpdate(data);
      };

      collabSocket.onclose = () => {
        document.getElementById('btn-collab').textContent = '🤝 Collab';
        document.getElementById('btn-collab').classList.remove('btn-green');
        collabSocket = null;
      };
    }

    function broadcastUpdate(type, payload) {
      if (collabSocket && collabSocket.readyState === WebSocket.OPEN) {
        collabSocket.send(JSON.stringify({ type, payload, timestamp: Date.now() }));
      }
    }

    function handleRemoteUpdate(data) {
      const { type, payload } = data;
      switch (type) {
        case 'rename':
          document.getElementById('project-name').value = payload;
          break;
        case 'schematic':
          S.sch.lastSchema = payload.schema;
          S.sch.lastImage = payload.image;
          if (payload.image) {
            document.getElementById('sch-img').src = 'data:image/png;base64,' + payload.image;
            document.getElementById('sch-img').style.display = 'block';
            document.getElementById('sch-ph').style.display = 'none';
          }
          document.getElementById('sch-desc').textContent = payload.desc || '';
          showToast('⚡ Schematic updated by collaborator');
          break;
        case 'arduino':
          S.ard.lastCode = payload;
          document.getElementById('ard-out').innerHTML = marked.parse(payload);
          document.getElementById('ard-out').style.display = 'block';
          document.getElementById('ard-ph').style.display = 'none';
          document.getElementById('ard-dl').style.display = 'inline-flex';
          showToast('💻 Code updated by collaborator');
          break;
      }
    }

    // ── FEATURE 4: ONBOARDING TOUR ──────────────────────────────────────────
    const TOUR_STEPS = [
      { target: '#sch-input', title: 'Describe Your Circuit', text: 'Type a circuit description in plain English — the AI will generate a schematic, simulation, and more!' },
      { target: '.tabs', title: 'Explore Tabs', text: 'Switch between Schematic, Simulate, Waveform, BOM, Components, Debug, Arduino, Learn, Quiz, and Templates.' },
      { target: '#tab-templates', title: 'Start from Templates', text: 'Don\'t know where to start? Pick a pre-built template and modify it!', tabSwitch: 'templates' },
      { target: '#tab-quiz', title: 'Test Your Knowledge', text: 'Take the electronics quiz with 41 questions across 3 difficulty levels.', tabSwitch: 'quiz' },
      { target: '.hdr-right', title: 'Status & Theme', text: 'Check API status and toggle dark/light mode. Your preference is saved!' },
      { target: 'footer', title: 'Keyboard Shortcuts', text: 'Press ? anytime to see all keyboard shortcuts. Use number keys 1-0 to switch tabs!' }
    ];
    let tourStep = 0;
    function startTour() {
      if (localStorage.getItem('cc_tour_done')) return;
      tourStep = 0;
      showTourStep();
    }
    function showTourStep() {
      const overlay = document.getElementById('tour-overlay');
      if (tourStep >= TOUR_STEPS.length) {
        overlay.innerHTML = '';
        overlay.style.display = 'none';
        localStorage.setItem('cc_tour_done', '1');
        showToast('🎉 Tour complete! Enjoy Circuit Copilot!');
        // Switch back to schematic tab
        const tabs = document.querySelectorAll('.tab');
        if (tabs[0]) switchTab('schematic', tabs[0]);
        return;
      }
      const step = TOUR_STEPS[tourStep];
      // Switch tab if needed
      if (step.tabSwitch) {
        const tabs = document.querySelectorAll('.tab');
        const tabMap = { 'schematic': 0, 'simulate': 1, 'waveform': 2, 'bom': 3, 'components': 4, 'debug': 5, 'arduino': 6, 'learn': 7, 'quiz': 8, 'templates': 9 };
        const idx = tabMap[step.tabSwitch];
        if (tabs[idx]) switchTab(step.tabSwitch, tabs[idx]);
      }
      setTimeout(() => {
        const target = document.querySelector(step.target);
        if (!target) { tourStep++; showTourStep(); return; }
        const rect = target.getBoundingClientRect();
        overlay.style.display = 'block';
        // Position tooltip below or above target
        const tooltipY = rect.bottom + 12;
        const tooltipX = Math.max(16, Math.min(rect.left, window.innerWidth - 340));
        overlay.innerHTML = `
          <div class="tour-overlay" onclick="skipTour()"></div>
          <div class="tour-spotlight" style="top:${rect.top - 6}px;left:${rect.left - 6}px;width:${rect.width + 12}px;height:${rect.height + 12}px;"></div>
          <div class="tour-tooltip" style="top:${tooltipY}px;left:${tooltipX}px;">
            <div class="tour-step-counter">Step ${tourStep + 1} of ${TOUR_STEPS.length}</div>
            <h3>${step.title}</h3>
            <p>${step.text}</p>
            <div class="tour-btns">
              <button onclick="skipTour()">Skip</button>
              <button class="tour-next" onclick="tourStep++;showTourStep()">${tourStep < TOUR_STEPS.length - 1 ? 'Next →' : 'Finish ✓'}</button>
            </div>
          </div>`;
      }, step.tabSwitch ? 200 : 50);
    }
    function skipTour() {
      const overlay = document.getElementById('tour-overlay');
      overlay.innerHTML = '';
      overlay.style.display = 'none';
      localStorage.setItem('cc_tour_done', '1');
      // Switch back to schematic tab
      const tabs = document.querySelectorAll('.tab');
      if (tabs[0]) switchTab('schematic', tabs[0]);
    }
    // Start tour on first visit (delay to let page render)
    setTimeout(startTour, 800);
  </script>
</body>

</html>